// src/screens/AccountsScreen.js - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import React, { useState } from 'react';
import { 
  View, 
  Text, 
  TouchableOpacity, 
  ScrollView, 
  StyleSheet, 
  Alert,
  Modal,
  TouchableWithoutFeedback
} from 'react-native';
import { useData } from '../context/DataContext';
import { colors } from '../theme/colors';
import { commonStyles, spacing, borderRadius } from '../theme/designSystem';
import { formatCurrency } from '../utils/currencyFormatter';

const AccountsScreen = ({ navigation }) => {
  const { accounts, getTotalBalance, deleteAccountWithCheck, archiveAccount, getAccountStats } = useData();
  const [sortBy, setSortBy] = useState('balance');
  const [sortOrder, setSortOrder] = useState('desc');
  const [filterType, setFilterType] = useState('all');
  const [showFilters, setShowFilters] = useState(false);
  
  // üîß –ù–ê–í–ò–ì–ê–¶–ò–Ø - –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º navigation –∏–∑ –ø—Ä–æ–ø—Å–æ–≤
  const handleEditAccount = (accountId) => {
    console.log('Navigating to EditAccount with accountId:', accountId);
    navigation.navigate('EditAccount', { accountId });
  };

  const handleAddAccount = () => {
    navigation.navigate('AddAccount');
  };

  const handleTransfer = () => {
    navigation.navigate('Transfer');
  };

  const handleDebts = () => {
    navigation.navigate('Debts');
  };

  const handleCredits = () => {
    navigation.navigate('Credits');
  };

  const handleBackup = () => {
    navigation.navigate('BackupSettings');
  };

  // üîß –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –¢–ò–ü–ê –°–ß–ï–¢–ê
  const getAccountTypeLabel = (type) => {
    switch (type) {
      case 'card': return '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞';
      case 'cash': return '–ù–∞–ª–∏—á–Ω—ã–µ';
      case 'savings': return '–°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç';
      case 'credit': return '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞';
      case 'investment': return '–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏';
      case 'other': return '–î—Ä—É–≥–æ–µ';
      default: return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø';
    }
  };

  const getAccountColor = (type) => {
    switch (type) {
      case 'card': return '#6C63FF';
      case 'cash': return '#4CAF50';
      case 'savings': return '#2196F3';
      case 'credit': return '#F44336';
      case 'investment': return '#FF9800';
      case 'other': return '#9C27B0';
      default: return colors.primary;
    }
  };

  const AccountCard = ({ account }) => {
    const accountColor = getAccountColor(account.type);
    const balance = account.balance || 0;
    const isNegative = balance < 0;

    return (
      <TouchableOpacity 
        style={[styles.accountCard, { borderLeftColor: accountColor }]}
        onPress={() => navigation.navigate('Transfer', { accountId: account.id })}
        onLongPress={() => handleEditAccount(account.id)}
      >
        <View style={styles.accountHeader}>
          <Text style={styles.accountIcon}>{account.icon || 'üí≥'}</Text>
          <View style={styles.accountInfo}>
            <Text style={styles.accountName}>{account.name}</Text>
            <Text style={[styles.accountType, { color: accountColor }]}>
              {getAccountTypeLabel(account.type)}
            </Text>
          </View>
        </View>
        <View style={styles.accountBalanceContainer}>
          <Text style={[
            styles.accountBalance, 
            { color: isNegative ? colors.error : accountColor }
          ]}>
            {formatCurrency(balance, false)}
          </Text>
          <TouchableOpacity 
            style={styles.editButton}
            onPress={() => handleEditAccount(account.id)}
          >
            <Text style={styles.editButtonText}>‚úèÔ∏è</Text>
          </TouchableOpacity>
        </View>
      </TouchableOpacity>
    );
  };

  const ActionButton = ({ 
    title, 
    description, 
    icon, 
    onPress, 
    color = colors.primary 
  }) => (
    <TouchableOpacity 
      style={[styles.actionButton, { borderLeftColor: color }]}
      onPress={onPress}
    >
      <Text style={styles.actionButtonIcon}>{icon}</Text>
      <View style={styles.actionButtonText}>
        <Text style={styles.actionActionTitle}>{title}</Text>
        <Text style={styles.actionButtonDescription}>{description}</Text>
      </View>
    </TouchableOpacity>
  );

  return (
    <View style={commonStyles.screen.container}>
      <View style={commonStyles.screen.header}>
        <Text style={commonStyles.screen.title}>üí≥ –°—á–µ—Ç–∞</Text>
        <Text style={commonStyles.screen.subtitle}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞–º–∏ –∏ —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏</Text>
      </View>

      <ScrollView 
        style={styles.scrollView} 
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollContent}
      >
        <View style={styles.totalBalanceCard}>
          <Text style={styles.totalBalanceLabel}>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</Text>
          <Text style={styles.totalBalanceValue}>
            {formatCurrency(getTotalBalance(), false)}
          </Text>
        </View>

        {/* üîß –°–ü–ò–°–û–ö –°–ß–ï–¢–û–í */}
        {accounts && accounts.length > 0 ? (
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>–ú–æ–∏ —Å—á–µ—Ç–∞ ({accounts.length})</Text>
            {accounts.map(account => (
              <AccountCard key={account.id} account={account} />
            ))}
          </View>
        ) : (
          <View style={styles.emptySection}>
            <Text style={styles.emptyIcon}>üí≥</Text>
            <Text style={styles.emptyTitle}>–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç —Å—á–µ—Ç–æ–≤</Text>
            <Text style={styles.emptyDescription}>
              –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—ã–π —Å—á–µ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ñ–∏–Ω–∞–Ω—Å–∞–º–∏
            </Text>
          </View>
        )}

        {/* üîß –£–ü–†–ê–í–õ–ï–ù–ò–ï */}
        <View style={styles.section}>
          <Text style={styles.sectionTitle}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</Text>
          
          <ActionButton
            title="–î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç"
            description="–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å—á–µ—Ç –∏–ª–∏ –∫–æ—à–µ–ª–µ–∫"
            icon="‚ûï"
            color="#4CAF50"
            onPress={handleAddAccount}
          />

          <ActionButton
            title="–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏"
            description="–ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏"
            icon="üîÑ"
            color="#2196F3"
            onPress={handleTransfer}
          />

          <ActionButton
            title="–î–æ–ª–≥–∏"
            description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏ –∏ –∑–∞–π–º–∞–º–∏"
            icon="ü§ù"
            color="#FF9800"
            onPress={handleDebts}
          />

          <ActionButton
            title="–ö—Ä–µ–¥–∏—Ç—ã"
            description="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞–º–∏ –∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞–º–∏"
            icon="üè¶"
            color="#9C27B0"
            onPress={handleCredits}
          />

          <ActionButton
            title="–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏"
            description="–≠–∫—Å–ø–æ—Ä—Ç –∏ –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
            icon="üíæ"
            color="#607D8B"
            onPress={handleBackup}
          />
        </View>
      </ScrollView>
    </View>
  );
};

const styles = StyleSheet.create({
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  totalBalanceCard: {
    ...commonStyles.cards.surface,
    padding: spacing.xl,
    alignItems: 'center',
    marginBottom: spacing.lg,
  },
  totalBalanceLabel: {
    fontSize: 16,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
    fontWeight: '500',
  },
  totalBalanceValue: {
    fontSize: 28,
    fontWeight: 'bold',
    color: colors.primary,
  },
  section: {
    marginBottom: spacing.xl,
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
  },
  accountCard: {
    ...commonStyles.cards.surface,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: spacing.lg,
    marginBottom: spacing.md,
    borderLeftWidth: 4,
  },
  accountHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  accountIcon: {
    fontSize: 24,
    marginRight: spacing.md,
  },
  accountInfo: {
    flex: 1,
  },
  accountName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  accountType: {
    fontSize: 14,
    fontWeight: '600',
  },
  accountBalanceContainer: {
    alignItems: 'flex-end',
  },
  accountBalance: {
    fontSize: 16,
    fontWeight: 'bold',
  },
  editButton: {
    marginTop: spacing.sm,
    padding: spacing.xs,
  },
  editButtonText: {
    fontSize: 18,
  },
  actionButton: {
    ...commonStyles.cards.surface,
    flexDirection: 'row',
    alignItems: 'center',
    padding: spacing.lg,
    marginBottom: spacing.md,
    borderLeftWidth: 4,
  },
  actionButtonIcon: {
    fontSize: 24,
    marginRight: spacing.md,
  },
  actionButtonText: {
    flex: 1,
  },
  actionActionTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  actionButtonDescription: {
    fontSize: 14,
    color: colors.textSecondary,
    lineHeight: 18,
  },
  emptySection: {
    ...commonStyles.cards.surface,
    alignItems: 'center',
    padding: spacing.xl,
    marginBottom: spacing.xl,
  },
  emptyIcon: {
    fontSize: 48,
    marginBottom: spacing.md,
  },
  emptyTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.sm,
    textAlign: 'center',
  },
  emptyDescription: {
    fontSize: 14,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 20,
  },
});

export default AccountsScreen;import React, { useState } from 'react';
import { 
  View, 
  Text, 
  TextInput, 
  TouchableOpacity, 
  StyleSheet, 
  ScrollView, 
  Alert,
  KeyboardAvoidingView,
  Platform 
} from 'react-native';
import { colors } from '../theme/colors';
import { useData } from '../context/DataContext';

// üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const AddAccountScreen = ({ navigation }) => {
  const { addAccount } = useData();
  
  const [name, setName] = useState('');
  const [balance, setBalance] = useState('');
  const [type, setType] = useState('card');
  const [selectedIcon, setSelectedIcon] = useState('üí≥');

  const accountTypes = [
    { id: 'card', name: '–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞', icon: 'üí≥', color: '#6C63FF' },
    { id: 'cash', name: '–ù–∞–ª–∏—á–Ω—ã–µ', icon: 'üí∞', color: '#4CAF50' },
    { id: 'savings', name: '–°–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π —Å—á–µ—Ç', icon: 'üè¶', color: '#2196F3' },
    { id: 'credit', name: '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞', icon: 'üìã', color: '#F44336' },
  ];

  const availableIcons = {
    card: ['üí≥', 'üí∏', 'üíé', 'üî∑'],
    cash: ['üí∞', 'üíµ', 'üí¥', 'üí∂'],
    savings: ['üè¶', 'üí∞', 'üíé', 'üîê'],
    credit: ['üìã', 'üí≥', 'üìÑ', 'üî¥']
  };

  const handleSave = () => {
    if (!name.trim()) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞');
      return;
    }

    const balanceValue = parseFloat(balance) || 0;

    try {
      addAccount({
        name: name.trim(),
        balance: balanceValue,
        type,
        color: accountTypes.find(t => t.id === type)?.color || '#6C63FF',
        icon: selectedIcon
      });

      Alert.alert('–£—Å–ø–µ—Ö', '–°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', [
        { text: 'OK', onPress: () => navigation.goBack() }
      ]);
    } catch (error) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç');
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç–∞:', error);
    }
  };

  const AccountTypeButton = ({ accountType }) => (
    <TouchableOpacity
      style={[
        styles.typeButton,
        type === accountType.id && styles.typeButtonActive,
        type === accountType.id && { backgroundColor: accountType.color }
      ]}
      onPress={() => {
        setType(accountType.id);
        setSelectedIcon(accountType.icon);
      }}
    >
      <Text style={styles.typeIcon}>{accountType.icon}</Text>
      <Text style={[
        styles.typeText,
        type === accountType.id && styles.typeTextActive
      ]}>
        {accountType.name}
      </Text>
    </TouchableOpacity>
  );

  const IconButton = ({ icon }) => (
    <TouchableOpacity
      style={[
        styles.iconButton,
        selectedIcon === icon && styles.iconButtonActive
      ]}
      onPress={() => setSelectedIcon(icon)}
    >
      <Text style={styles.iconText}>{icon}</Text>
    </TouchableOpacity>
  );

  const QuickAmountButton = ({ value }) => (
    <TouchableOpacity
      style={styles.quickAmountButton}
      onPress={() => setBalance(value.toString())}
    >
      <Text style={styles.quickAmountText}>{value}</Text>
    </TouchableOpacity>
  );

  return (
    <KeyboardAvoidingView 
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
    >
      {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –®–∞–ø–∫–∞ —ç–∫—Ä–∞–Ω–∞ */}
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>üí≥ –ù–æ–≤—ã–π —Å—á–µ—Ç</Text>
        <Text style={styles.screenSubtitle}>–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π —Å—á–µ—Ç</Text>
      </View>

      <ScrollView 
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollContent}
      >
        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞</Text>
          <TextInput
            style={styles.input}
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞, –ö–æ—à–µ–ª–µ–∫..."
            value={name}
            onChangeText={setName}
            placeholderTextColor={colors.textSecondary}
          />
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å (BYN)</Text>
          <View style={styles.amountInputContainer}>
            <Text style={styles.currencySymbol}>BYN</Text>
            <TextInput
              style={styles.amountInput}
              placeholder="0.00"
              value={balance}
              onChangeText={setBalance}
              keyboardType="numeric"
              placeholderTextColor={colors.textSecondary}
            />
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –¢–∏–ø —Å—á–µ—Ç–∞ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–¢–∏–ø —Å—á–µ—Ç–∞</Text>
          <View style={styles.typesGrid}>
            {accountTypes.map(accountType => (
              <AccountTypeButton key={accountType.id} accountType={accountType} />
            ))}
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É</Text>
          <View style={styles.iconsGrid}>
            {availableIcons[type]?.map(icon => (
              <IconButton key={icon} icon={icon} />
            ))}
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –±–∞–ª–∞–Ω—Å–∞ */}
        <View style={styles.quickAmounts}>
          <Text style={styles.quickAmountsLabel}>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥ –±–∞–ª–∞–Ω—Å–∞:</Text>
          <View style={styles.quickAmountsRow}>
            {[0, 100, 500, 1000, 5000].map(amount => (
              <QuickAmountButton key={amount} value={amount} />
            ))}
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
        <View style={styles.actionsContainer}>
          <TouchableOpacity 
            style={[
              styles.saveButton,
              !name.trim() && styles.saveButtonDisabled
            ]} 
            onPress={handleSave}
            disabled={!name.trim()}
          >
            <Text style={styles.saveButtonText}>üíæ –î–æ–±–∞–≤–∏—Ç—å —Å—á–µ—Ç</Text>
          </TouchableOpacity>

          <TouchableOpacity 
            style={styles.cancelButton} 
            onPress={() => navigation.goBack()}
          >
            <Text style={styles.cancelButtonText}>‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</Text>
          </TouchableOpacity>
        </View>
      </ScrollView>
    </KeyboardAvoidingView>
  );
};

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    ...commonStyles.screen.header,
  },
  screenTitle: {
    ...commonStyles.screen.title,
  },
  screenSubtitle: {
    ...commonStyles.screen.subtitle,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  inputSection: {
    marginBottom: spacing.xxl,
  },
  inputLabel: {
    ...commonStyles.forms.label,
  },
  // üîß –ü–æ–ª–µ –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  input: {
    ...commonStyles.forms.inputContainer,
    ...commonStyles.forms.input,
    padding: spacing.lg,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–≤–æ–¥–∞ —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  amountInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    paddingHorizontal: spacing.xl,
    ...shadows.lg,
  },
  currencySymbol: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.primary,
    marginRight: spacing.md,
  },
  amountInput: {
    flex: 1,
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: spacing.xl,
  },
  typesGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ —Ç–∏–ø–∞ —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  typeButton: {
    ...commonStyles.cards.surface,
    width: '48%',
    alignItems: 'center',
    padding: spacing.lg,
  },
  typeButtonActive: {
    ...shadows.lg,
  },
  typeIcon: {
    fontSize: 24,
    marginBottom: spacing.sm,
  },
  typeText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    textAlign: 'center',
  },
  typeTextActive: {
    color: colors.white,
    fontWeight: 'bold',
  },
  iconsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –∏–∫–æ–Ω–∫–∏ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  iconButton: {
    ...commonStyles.cards.surface,
    width: 60,
    height: 60,
    alignItems: 'center',
    justifyContent: 'center',
  },
  iconButtonActive: {
    backgroundColor: colors.primary,
    ...shadows.lg,
  },
  iconText: {
    fontSize: 24,
  },
  quickAmounts: {
    marginBottom: spacing.xxl,
  },
  quickAmountsLabel: {
    fontSize: 16,
    color: colors.textSecondary,
    marginBottom: spacing.md,
    fontWeight: '500',
  },
  quickAmountsRow: {
    flexDirection: 'row',
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–π —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  quickAmountButton: {
    ...commonStyles.cards.surface,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
  },
  quickAmountText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.primary,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
  actionsContainer: {
    gap: spacing.md,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  saveButton: {
    ...commonStyles.buttons.primary,
  },
  saveButtonDisabled: {
    backgroundColor: colors.textSecondary,
    ...shadows.sm,
  },
  saveButtonText: {
    ...commonStyles.buttons.primaryText,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  cancelButton: {
    ...commonStyles.buttons.secondary,
  },
  cancelButtonText: {
    ...commonStyles.buttons.secondaryText,
  },
});

export default AddAccountScreen;import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  KeyboardAvoidingView,
  Platform
} from 'react-native';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';
import CalendarModal from '../components/CalendarModal';

// üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const AddCreditScreen = ({ navigation }) => {
  const { accounts, addCredit } = useData();
  
  const [name, setName] = useState('');
  const [totalAmount, setTotalAmount] = useState('');
  const [interestRate, setInterestRate] = useState('');
  const [loanTerm, setLoanTerm] = useState('12');
  const [monthlyPayment, setMonthlyPayment] = useState('');
  const [endDate, setEndDate] = useState('');
  const [account, setAccount] = useState(accounts[0]?.id || '');
  const [showCalendar, setShowCalendar] = useState(false);

  const calculateAnnuityPayment = (amount, annualRate, months) => {
    const principal = parseFloat(amount);
    const monthlyRate = parseFloat(annualRate) / 100 / 12;
    const term = parseInt(months);
    
    if (isNaN(principal) || isNaN(monthlyRate) || isNaN(term) || term <= 0) {
      return 0;
    }
    
    if (monthlyRate === 0) {
      return principal / term;
    }
    
    const coefficient = (monthlyRate * Math.pow(1 + monthlyRate, term)) / 
                       (Math.pow(1 + monthlyRate, term) - 1);
    return principal * coefficient;
  };

  useEffect(() => {
    if (totalAmount && interestRate && loanTerm) {
      const payment = calculateAnnuityPayment(totalAmount, interestRate, loanTerm);
      setMonthlyPayment(payment.toFixed(2));
      
      const today = new Date();
      const endDate = new Date(today);
      endDate.setMonth(today.getMonth() + parseInt(loanTerm));
      setEndDate(endDate.toISOString().split('T')[0]);
    }
  }, [totalAmount, interestRate, loanTerm]);

  const calculateTotalInterest = () => {
    if (!monthlyPayment || !totalAmount || !loanTerm) return 0;
    
    const totalPayment = parseFloat(monthlyPayment) * parseInt(loanTerm);
    const principal = parseFloat(totalAmount);
    return totalPayment - principal;
  };

  const handleDateSelect = (date) => {
    setEndDate(date);
    setShowCalendar(false);
  };

  const handleSave = () => {
    if (!name.trim()) {
      Alert.alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', '–£–∫–∞–∂–∏—Ç–µ –ø–æ–Ω—è—Ç–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞');
      return;
    }

    if (!totalAmount || !interestRate || !loanTerm || !monthlyPayment || !endDate) {
      Alert.alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', '–í—Å–µ –ø–æ–ª—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã –¥–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è');
      return;
    }

    const total = parseFloat(totalAmount);
    const monthly = parseFloat(monthlyPayment);
    const interest = parseFloat(interestRate);
    const term = parseInt(loanTerm);

    if (isNaN(total) || total <= 0) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –∫—Ä–µ–¥–∏—Ç–∞');
      return;
    }

    if (isNaN(interest) || interest < 0 || interest > 100) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –æ—Ç 0% –¥–æ 100%');
      return;
    }

    if (isNaN(term) || term < 1 || term > 600) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ 600 –º–µ—Å—è—Ü–µ–≤');
      return;
    }

    const calculatedPayment = calculateAnnuityPayment(total, interest, term);
    const tolerance = 1;
    
    if (Math.abs(monthly - calculatedPayment) > tolerance) {
      Alert.alert(
        '–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ä–∞—Å—á–µ—Ç–∞', 
        `–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –ø–ª–∞—Ç–µ–∂: ${formatCurrency(calculatedPayment, false)}\n–•–æ—Ç–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –µ–≥–æ?`,
        [
          { text: '–ò—Å–ø—Ä–∞–≤–∏—Ç—å', onPress: () => setMonthlyPayment(calculatedPayment.toFixed(2)) },
          { text: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', onPress: () => saveCredit() }
        ]
      );
      return;
    }

    saveCredit();
  };

  const saveCredit = () => {
    const total = parseFloat(totalAmount);
    const monthly = parseFloat(monthlyPayment);
    const interest = parseFloat(interestRate);

    const selectedEndDate = new Date(endDate);
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    if (selectedEndDate <= today) {
      Alert.alert('–û—à–∏–±–∫–∞', '–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º');
      return;
    }

    try {
      addCredit({
        name: name.trim(),
        totalAmount: total,
        monthlyPayment: monthly,
        interestRate: interest,
        endDate: selectedEndDate.toISOString(),
        accountId: account,
        nextPaymentDate: new Date(Date.now() + 86400000 * 30).toISOString()
      });

      Alert.alert(
        '‚úÖ –ö—Ä–µ–¥–∏—Ç –¥–æ–±–∞–≤–ª–µ–Ω!',
        `–ö—Ä–µ–¥–∏—Ç "${name.trim()}" –Ω–∞ ${formatCurrency(total, false)} —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω\n–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: ${formatCurrency(monthly, false)}`,
        [
          { 
            text: '–û—Ç–ª–∏—á–Ω–æ!', 
            onPress: () => navigation.navigate('Credits') 
          }
        ]
      );
    } catch (error) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç');
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞:', error);
    }
  };

  const formatDisplayDate = (dateString) => {
    if (!dateString) return 'üìÖ –î–∞—Ç–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏';
    
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  };

  const QuickAmountButton = ({ value, type, label }) => (
    <TouchableOpacity
      style={styles.quickAmountButton}
      onPress={() => {
        if (type === 'total') setTotalAmount(value.toString());
        if (type === 'interest') setInterestRate(value.toString());
        if (type === 'term') setLoanTerm(value.toString());
      }}
    >
      <Text style={styles.quickAmountText}>
        {label || value}
      </Text>
    </TouchableOpacity>
  );

  const totalInterest = calculateTotalInterest();
  const totalPayment = totalInterest + parseFloat(totalAmount || 0);

  return (
    <KeyboardAvoidingView 
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
    >
      {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –®–∞–ø–∫–∞ —ç–∫—Ä–∞–Ω–∞ */}
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>üè¶ –ù–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç</Text>
        <Text style={styles.screenSubtitle}>–†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—Ä–µ–¥–∏—Ç–µ</Text>
      </View>

      <ScrollView 
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollContent}
      >
        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–ù–∞–∑–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞ *</Text>
          <TextInput
            style={styles.input}
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–ø–æ—Ç–µ–∫–∞, –ê–≤—Ç–æ–∫—Ä–µ–¥–∏—Ç, –ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞..."
            value={name}
            onChangeText={setName}
            placeholderTextColor={colors.textSecondary}
            maxLength={50}
          />
          <Text style={styles.charCounter}>{name.length}/50</Text>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>üíµ –°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞ *</Text>
          <View style={styles.amountInputContainer}>
            <Text style={styles.currencySymbol}>BYN</Text>
            <TextInput
              style={styles.amountInput}
              placeholder="0.00"
              value={totalAmount}
              onChangeText={setTotalAmount}
              keyboardType="numeric"
              placeholderTextColor={colors.textSecondary}
            />
          </View>
          
          <View style={styles.quickAmounts}>
            <Text style={styles.quickAmountsLabel}>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥:</Text>
            <View style={styles.quickAmountsRow}>
              {[1000, 5000, 10000, 50000, 100000].map(value => (
                <QuickAmountButton key={value} value={value} type="total" />
              ))}
            </View>
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>üìà –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ *</Text>
          <View style={styles.interestInputContainer}>
            <TextInput
              style={styles.interestInput}
              placeholder="0.0"
              value={interestRate}
              onChangeText={setInterestRate}
              keyboardType="numeric"
              placeholderTextColor={colors.textSecondary}
            />
            <Text style={styles.percentSymbol}>% –≥–æ–¥–æ–≤—ã—Ö</Text>
          </View>
          
          <View style={styles.quickAmounts}>
            <Text style={styles.quickAmountsLabel}>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞–≤–∫–∏:</Text>
            <View style={styles.quickAmountsRow}>
              <QuickAmountButton value={7.5} type="interest" label="7.5%" />
              <QuickAmountButton value={12.9} type="interest" label="12.9%" />
              <QuickAmountButton value={19.9} type="interest" label="19.9%" />
              <QuickAmountButton value={25} type="interest" label="25%" />
            </View>
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>‚è±Ô∏è –°—Ä–æ–∫ –∫—Ä–µ–¥–∏—Ç–∞ *</Text>
          <View style={styles.termInputContainer}>
            <TextInput
              style={styles.termInput}
              placeholder="12"
              value={loanTerm}
              onChangeText={setLoanTerm}
              keyboardType="numeric"
              placeholderTextColor={colors.textSecondary}
            />
            <Text style={styles.termSymbol}>–º–µ—Å—è—Ü–µ–≤</Text>
          </View>
          
          <View style={styles.quickAmounts}>
            <Text style={styles.quickAmountsLabel}>–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ä–æ–∫–∏:</Text>
            <View style={styles.quickAmountsRow}>
              <QuickAmountButton value={6} type="term" label="6 –º–µ—Å." />
              <QuickAmountButton value={12} type="term" label="1 –≥–æ–¥" />
              <QuickAmountButton value={24} type="term" label="2 –≥–æ–¥–∞" />
              <QuickAmountButton value={60} type="term" label="5 –ª–µ—Ç" />
            </View>
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>üí∞ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂ *</Text>
          <View style={styles.paymentDisplay}>
            <Text style={styles.currencySymbol}>BYN</Text>
            <Text style={styles.paymentValue}>
              {monthlyPayment ? formatCurrency(parseFloat(monthlyPayment), false) : '0.00'}
            </Text>
          </View>
          <Text style={styles.paymentHint}>
            üí° –ü–ª–∞—Ç–µ–∂ —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π —Ñ–æ—Ä–º—É–ª–µ
          </Text>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>üìÖ –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è *</Text>
          <TouchableOpacity 
            style={styles.dateInput}
            onPress={() => setShowCalendar(true)}
          >
            <Text style={[
              styles.dateInputText,
              !endDate && styles.dateInputPlaceholder
            ]}>
              {formatDisplayDate(endDate)}
            </Text>
            <Text style={styles.calendarIcon}>üìÖ</Text>
          </TouchableOpacity>
          <Text style={styles.dateHint}>
            üí° –î–∞—Ç–∞ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ —Å—Ä–æ–∫—É –∫—Ä–µ–¥–∏—Ç–∞
          </Text>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—á–µ—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>üí≥ –°—á–µ—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã</Text>
          <View style={styles.accountsContainer}>
            {accounts.map(acc => (
              <TouchableOpacity
                key={acc.id}
                style={[
                  styles.accountButton,
                  account === acc.id && styles.accountButtonActive
                ]}
                onPress={() => setAccount(acc.id)}
              >
                <Text style={styles.accountIcon}>{acc.icon}</Text>
                <View style={styles.accountInfo}>
                  <Text style={[
                    styles.accountText,
                    account === acc.id && styles.accountTextActive
                  ]}>
                    {acc.name}
                  </Text>
                  <Text style={styles.accountBalance}>
                    –ë–∞–ª–∞–Ω—Å: {formatCurrency(acc.balance, false)}
                  </Text>
                </View>
              </TouchableOpacity>
            ))}
          </View>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫—Ä–µ–¥–∏—Ç–∞ */}
        {monthlyPayment && totalAmount && loanTerm && (
          <View style={styles.calculationCard}>
            <Text style={styles.calculationTitle}>üìä –î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∫—Ä–µ–¥–∏—Ç–∞:</Text>
            
            <View style={styles.calculationRow}>
              <Text style={styles.calculationLabel}>–°—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞:</Text>
              <Text style={styles.calculationValue}>
                {formatCurrency(parseFloat(totalAmount), false)}
              </Text>
            </View>
            
            <View style={styles.calculationRow}>
              <Text style={styles.calculationLabel}>–°—Ä–æ–∫ –ø–æ–≥–∞—à–µ–Ω–∏—è:</Text>
              <Text style={styles.calculationValue}>
                {loanTerm} {loanTerm === '1' ? '–º–µ—Å—è—Ü' : 
                 parseInt(loanTerm) < 5 ? '–º–µ—Å—è—Ü–∞' : '–º–µ—Å—è—Ü–µ–≤'}
              </Text>
            </View>
            
            <View style={styles.calculationRow}>
              <Text style={styles.calculationLabel}>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</Text>
              <Text style={styles.calculationValue}>
                {formatCurrency(parseFloat(monthlyPayment), false)}
              </Text>
            </View>
            
            <View style={styles.calculationRow}>
              <Text style={styles.calculationLabel}>–û–±—â–∞—è –ø–µ—Ä–µ–ø–ª–∞—Ç–∞:</Text>
              <Text style={[styles.calculationValue, styles.interestValue]}>
                {formatCurrency(totalInterest, false)}
              </Text>
            </View>
            
            <View style={styles.calculationRow}>
              <Text style={styles.calculationLabel}>–í—Å–µ–≥–æ –∫ –≤—ã–ø–ª–∞—Ç–µ:</Text>
              <Text style={[styles.calculationValue, styles.totalPayment]}>
                {formatCurrency(totalPayment, false)}
              </Text>
            </View>
          </View>
        )}

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ */}
        <View style={styles.infoCard}>
          <Text style={styles.infoTitle}>üí° –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:</Text>
          <Text style={styles.infoText}>
            ‚Ä¢ üí∞ <Text style={styles.infoHighlight}>–ê–Ω–Ω—É–∏—Ç–µ—Ç–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</Text> - —Ä–∞—Å—á–µ—Ç –ø–æ –±–∞–Ω–∫–æ–≤—Å–∫–æ–π —Ñ–æ—Ä–º—É–ª–µ
          </Text>
          <Text style={styles.infoText}>
            ‚Ä¢ üìÖ <Text style={styles.infoHighlight}>–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</Text> - –¥–∞—Ç—ã –ø–ª–∞—Ç–µ–∂–µ–π —Ä–∞—Å—Å—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          </Text>
          <Text style={styles.infoText}>
            ‚Ä¢ üîî <Text style={styles.infoHighlight}>–£–º–Ω—ã–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</Text> - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∑–∞ 7, 3, 1 –¥–µ–Ω—å –¥–æ –ø–ª–∞—Ç–µ–∂–∞
          </Text>
          <Text style={styles.infoText}>
            ‚Ä¢ üìä <Text style={styles.infoHighlight}>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</Text> - –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–≥–∞—à–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞
          </Text>
        </View>

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
        <View style={styles.actionsContainer}>
          <TouchableOpacity 
            style={[
              styles.saveButton,
              (!name || !totalAmount || !interestRate || !loanTerm || !monthlyPayment) && styles.saveButtonDisabled
            ]} 
            onPress={handleSave}
            disabled={!name || !totalAmount || !interestRate || !loanTerm || !monthlyPayment}
          >
            <Text style={styles.saveButtonText}>
              üíæ –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç
            </Text>
          </TouchableOpacity>

          <TouchableOpacity 
            style={styles.cancelButton} 
            onPress={() => navigation.goBack()}
          >
            <Text style={styles.cancelButtonText}>‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞</Text>
          </TouchableOpacity>
        </View>

        <CalendarModal
          visible={showCalendar}
          onClose={() => setShowCalendar(false)}
          onDateSelect={handleDateSelect}
          selectedDate={endDate}
        />
      </ScrollView>
    </KeyboardAvoidingView>
  );
};

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    ...commonStyles.screen.header,
  },
  screenTitle: {
    ...commonStyles.screen.title,
  },
  screenSubtitle: {
    ...commonStyles.screen.subtitle,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  inputSection: {
    marginBottom: spacing.xxl,
  },
  inputLabel: {
    ...commonStyles.forms.label,
  },
  // üîß –ü–æ–ª–µ –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  input: {
    ...commonStyles.forms.inputContainer,
    ...commonStyles.forms.input,
    padding: spacing.lg,
  },
  charCounter: {
    fontSize: 12,
    color: colors.textSecondary,
    textAlign: 'right',
    marginTop: spacing.xs,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–≤–æ–¥–∞ —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  amountInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    paddingHorizontal: spacing.xl,
    ...shadows.lg,
    marginBottom: spacing.lg,
  },
  currencySymbol: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.primary,
    marginRight: spacing.md,
  },
  amountInput: {
    flex: 1,
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: spacing.xl,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–≤–æ–¥–∞ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  interestInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    paddingHorizontal: spacing.xl,
    ...shadows.md,
    marginBottom: spacing.lg,
  },
  interestInput: {
    flex: 1,
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: spacing.lg,
  },
  percentSymbol: {
    fontSize: 16,
    color: colors.textSecondary,
    fontWeight: '600',
    marginLeft: spacing.md,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–≤–æ–¥–∞ —Å—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  termInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    paddingHorizontal: spacing.xl,
    ...shadows.md,
    marginBottom: spacing.lg,
  },
  termInput: {
    flex: 1,
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: spacing.lg,
  },
  termSymbol: {
    fontSize: 16,
    color: colors.textSecondary,
    fontWeight: '600',
    marginLeft: spacing.md,
  },
  // üîß –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  paymentDisplay: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    paddingHorizontal: spacing.xl,
    paddingVertical: spacing.xl,
    ...shadows.lg,
    marginBottom: spacing.sm,
  },
  paymentValue: {
    flex: 1,
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.primary,
  },
  paymentHint: {
    fontSize: 12,
    color: colors.textSecondary,
    fontStyle: 'italic',
    textAlign: 'center',
  },
  quickAmounts: {
    marginBottom: spacing.xs,
  },
  quickAmountsLabel: {
    fontSize: 16,
    color: colors.textSecondary,
    marginBottom: spacing.md,
    fontWeight: '500',
  },
  quickAmountsRow: {
    flexDirection: 'row',
    gap: spacing.sm,
    flexWrap: 'wrap',
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–π —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  quickAmountButton: {
    ...commonStyles.cards.surface,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
  },
  quickAmountText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.primary,
  },
  // üîß –ü–æ–ª–µ –¥–∞—Ç—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  dateInput: {
    ...commonStyles.forms.inputContainer,
    padding: spacing.lg,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  dateInputText: {
    ...commonStyles.forms.input,
    flex: 1,
  },
  dateInputPlaceholder: {
    color: colors.textSecondary,
  },
  dateHint: {
    fontSize: 12,
    color: colors.textSecondary,
    fontStyle: 'italic',
    marginTop: spacing.xs,
  },
  calendarIcon: {
    fontSize: 20,
  },
  accountsContainer: {
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  accountButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    ...shadows.md,
  },
  accountButtonActive: {
    backgroundColor: colors.primary + '20',
    borderColor: colors.primary,
    borderWidth: 2,
  },
  accountIcon: {
    fontSize: 24,
    marginRight: spacing.md,
  },
  accountInfo: {
    flex: 1,
  },
  accountText: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  accountTextActive: {
    color: colors.primary,
  },
  accountBalance: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  // üîß –ö–∞—Ä—Ç–æ—á–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  calculationCard: {
    ...commonStyles.cards.surface,
    marginBottom: spacing.xl,
    borderLeftWidth: 4,
    borderLeftColor: colors.info,
  },
  calculationTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
  },
  calculationRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.sm,
  },
  calculationLabel: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  calculationValue: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
  },
  interestValue: {
    color: colors.error,
  },
  totalPayment: {
    color: colors.primary,
    fontWeight: 'bold',
  },
  // üîß –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  infoCard: {
    backgroundColor: colors.surface + '80',
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    marginBottom: spacing.xl,
    borderLeftWidth: 4,
    borderLeftColor: colors.primary,
  },
  infoTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
  },
  infoText: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
    lineHeight: 20,
  },
  infoHighlight: {
    color: colors.primary,
    fontWeight: '600',
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
  actionsContainer: {
    gap: spacing.md,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  saveButton: {
    ...commonStyles.buttons.primary,
  },
  saveButtonDisabled: {
    backgroundColor: colors.textSecondary,
    ...shadows.sm,
  },
  saveButtonText: {
    ...commonStyles.buttons.primaryText,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  cancelButton: {
    ...commonStyles.buttons.secondary,
  },
  cancelButtonText: {
    ...commonStyles.buttons.secondaryText,
  },
});

export default AddCreditScreen;import React, { useState } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  KeyboardAvoidingView,
  Platform,
  Modal,
  Keyboard
} from 'react-native';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';
import TextInput from '../components/TextInput';
import CalendarModal from '../components/CalendarModal';

// üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const AddDebtScreen = ({ navigation }) => {
  const { accounts, addDebt } = useData();
  
  const [person, setPerson] = useState('');
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [debtType, setDebtType] = useState('given');
  const [selectedAccount, setSelectedAccount] = useState(accounts[0]?.id || '');
  const [dueDate, setDueDate] = useState('');
  const [showDatePicker, setShowDatePicker] = useState(false);
  const [showCalendar, setShowCalendar] = useState(false);
  const [isKeyboardVisible, setKeyboardVisible] = useState(false);

  React.useEffect(() => {
    const keyboardDidShowListener = Keyboard.addListener(
      'keyboardDidShow',
      () => setKeyboardVisible(true)
    );
    const keyboardDidHideListener = Keyboard.addListener(
      'keyboardDidHide',
      () => setKeyboardVisible(false)
    );

    return () => {
      keyboardDidShowListener.remove();
      keyboardDidHideListener.remove();
    };
  }, []);

  const quickAmounts = [10, 20, 30, 50, 100, 200];

  const getDefaultDueDate = () => {
    const defaultDate = new Date();
    defaultDate.setDate(defaultDate.getDate() + 30);
    return defaultDate.toISOString().split('T')[0];
  };

  const validateDates = (dateGiven, dueDate) => {
    const given = new Date(dateGiven);
    const due = new Date(dueDate);
    
    if (due <= given) {
      Alert.alert('–û—à–∏–±–∫–∞', '–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–∑–∂–µ –¥–∞—Ç—ã –≤—ã–¥–∞—á–∏ –¥–æ–ª–≥–∞');
      return false;
    }
    
    const maxDueDate = new Date(given);
    maxDueDate.setFullYear(maxDueDate.getFullYear() + 10);
    
    if (due > maxDueDate) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—Ä–æ–∫ –¥–æ–ª–≥–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 10 –ª–µ—Ç');
      return false;
    }
    
    return true;
  };

  const validateAmount = (amountValue) => {
    if (amountValue <= 0) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—É–º–º–∞ –¥–æ–ª–≥–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–π');
      return false;
    }
    
    if (amountValue > 100000000) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—É–º–º–∞ –¥–æ–ª–≥–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 000 000 BYN');
      return false;
    }
    
    return true;
  };

  const handleSave = () => {
    Keyboard.dismiss();

    if (!person.trim()) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∏–º—è —á–µ–ª–æ–≤–µ–∫–∞');
      return;
    }

    if (!amount || !selectedAccount) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    const amountValue = parseFloat(amount);
    if (isNaN(amountValue)) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–æ–ª–≥–∞');
      return;
    }

    if (!validateAmount(amountValue)) {
      return;
    }

    const calculatedDueDate = dueDate || getDefaultDueDate();
    const currentDate = new Date().toISOString().split('T')[0];

    if (!validateDates(currentDate, calculatedDueDate)) {
      return;
    }

    if (debtType === 'given') {
      const selectedAccountData = accounts.find(acc => acc.id === selectedAccount);
      if (selectedAccountData.balance < amountValue) {
        Alert.alert(
          '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 
          `–ù–∞ —Å—á–µ—Ç–µ "${selectedAccountData.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤\n` +
          `–î–æ—Å—Ç—É–ø–Ω–æ: ${formatCurrency(selectedAccountData.balance, false)}\n` +
          `–¢—Ä–µ–±—É–µ—Ç—Å—è: ${formatCurrency(amountValue, false)}`
        );
        return;
      }
    }

    try {
      addDebt({
        person: person.trim(),
        amount: amountValue,
        description: description.trim() || undefined,
        type: debtType,
        accountId: selectedAccount,
        dueDate: new Date(calculatedDueDate).toISOString()
      });

      Alert.alert('–£—Å–ø–µ—Ö', '–î–æ–ª–≥ –¥–æ–±–∞–≤–ª–µ–Ω!', [
        { 
          text: 'OK', 
          onPress: () => navigation.goBack() 
        }
      ]);
    } catch (error) {
      Alert.alert('–û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥');
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –¥–æ–ª–≥–∞:', error);
    }
  };

  const handleAmountChange = (text) => {
    const cleaned = text.replace(/[^\d.]/g, '');
    const parts = cleaned.split('.');
    if (parts.length > 2) {
      return;
    }
    if (parts[1] && parts[1].length > 2) {
      return;
    }
    setAmount(cleaned);
  };

  const closeAllModals = () => {
    setShowDatePicker(false);
    setShowCalendar(false);
    Keyboard.dismiss();
  };

  const DebtTypeButton = ({ type, icon, label, description }) => (
    <TouchableOpacity
      style={[
        styles.debtTypeButton,
        debtType === type && styles.debtTypeButtonActive,
        debtType === type && type === 'given' && { borderColor: colors.error },
        debtType === type && type === 'taken' && { borderColor: colors.success }
      ]}
      onPress={() => setDebtType(type)}
    >
      <Text style={styles.debtTypeIcon}>{icon}</Text>
      <Text style={styles.debtTypeLabel}>{label}</Text>
      <Text style={styles.debtTypeDescription}>{description}</Text>
    </TouchableOpacity>
  );

  const AccountButton = ({ account }) => {
    const isSelected = selectedAccount === account.id;
    const amountValue = parseFloat(amount || 0);
    const hasInsufficientFunds = debtType === 'given' && account.balance < amountValue;
    
    return (
      <TouchableOpacity
        style={[
          styles.accountButton,
          isSelected && [
            styles.accountButtonActive,
            { 
              borderColor: getAccountColor(account.type),
              shadowColor: getAccountColor(account.type)
            }
          ],
          hasInsufficientFunds && styles.accountButtonDisabled
        ]}
        onPress={() => {
          if (!hasInsufficientFunds) {
            setSelectedAccount(account.id);
          }
        }}
        disabled={hasInsufficientFunds}
      >
        <View style={[
          styles.accountIconContainer,
          { backgroundColor: isSelected ? getAccountColor(account.type) : colors.surface },
          hasInsufficientFunds && { backgroundColor: colors.border }
        ]}>
          <Text style={[
            styles.accountIcon,
            { color: isSelected ? colors.white : getAccountColor(account.type) },
            hasInsufficientFunds && { color: colors.textSecondary }
          ]}>
            {account.icon}
          </Text>
        </View>
        
        <View style={styles.accountInfo}>
          <Text style={[
            styles.accountName,
            isSelected && { color: getAccountColor(account.type), fontWeight: '700' },
            hasInsufficientFunds && { color: colors.textSecondary }
          ]}>
            {account.name}
          </Text>
          <Text style={[
            styles.accountBalance,
            hasInsufficientFunds && { color: colors.textSecondary }
          ]}>
            –ë–∞–ª–∞–Ω—Å: {formatCurrency(account.balance, false)}
          </Text>
        </View>
        
        {isSelected && (
          <View style={[styles.selectionDot, { backgroundColor: getAccountColor(account.type) }]} />
        )}

        {hasInsufficientFunds && (
          <Text style={styles.insufficientFunds}>‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ</Text>
        )}
      </TouchableOpacity>
    );
  };

  const getAccountColor = (type) => {
    const colorsMap = {
      card: '#6C63FF',
      cash: '#4CAF50', 
      savings: '#2196F3',
      credit: '#F44336'
    };
    return colorsMap[type] || colors.primary;
  };

  const QuickAmountButton = ({ value }) => (
    <TouchableOpacity
      style={[
        styles.quickAmountButton,
        amount === value.toString() && styles.quickAmountButtonActive
      ]}
      onPress={() => {
        setAmount(value.toString());
        Keyboard.dismiss();
      }}
    >
      <Text style={[
        styles.quickAmountText,
        amount === value.toString() && styles.quickAmountTextActive
      ]}>
        {value}
      </Text>
    </TouchableOpacity>
  );

  const DateButton = ({ date, onPress }) => (
    <TouchableOpacity 
      style={styles.dateButton} 
      onPress={() => {
        Keyboard.dismiss();
        onPress();
      }}
    >
      <Text style={styles.dateButtonIcon}>üìÖ</Text>
      <Text style={styles.dateButtonText}>
        {date ? formatDisplayDate(date) : '–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø–æ–≥–∞—à–µ–Ω–∏—è'}
      </Text>
    </TouchableOpacity>
  );

  const formatDisplayDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  };

  const DateOption = ({ days, label, onPress }) => {
    const targetDate = new Date();
    targetDate.setDate(targetDate.getDate() + days);
    
    return (
      <TouchableOpacity style={styles.dateOption} onPress={onPress}>
        <Text style={styles.dateOptionLabel}>{label}</Text>
        <Text style={styles.dateOptionDate}>
          {targetDate.toLocaleDateString('ru-RU', { 
            day: 'numeric', 
            month: 'short' 
          })}
        </Text>
      </TouchableOpacity>
    );
  };

  const handleDateSelect = (dateString) => {
    const currentDate = new Date().toISOString().split('T')[0];
    
    if (dateString <= currentDate) {
      Alert.alert('–û—à–∏–±–∫–∞', '–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –≤ –±—É–¥—É—â–µ–º');
      return;
    }
    
    setDueDate(dateString);
    setShowCalendar(false);
  };

  const handleQuickDateSelect = (daysFromNow) => {
    const date = new Date();
    date.setDate(date.getDate() + daysFromNow);
    setDueDate(date.toISOString().split('T')[0]);
    setShowDatePicker(false);
  };

  return (
    <View style={styles.container}>
      {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –®–∞–ø–∫–∞ —ç–∫—Ä–∞–Ω–∞ */}
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>ü§ù –î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥</Text>
        <Text style={styles.screenSubtitle}>–£—á–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤</Text>
      </View>

      <KeyboardAvoidingView 
        style={styles.keyboardAvoidingView}
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        keyboardVerticalOffset={Platform.OS === 'ios' ? 90 : 0}
      >
        <ScrollView 
          style={styles.scrollView}
          showsVerticalScrollIndicator={false}
          contentContainerStyle={[
            styles.scrollContent,
            isKeyboardVisible && styles.scrollContentWithKeyboard
          ]}
          keyboardShouldPersistTaps="handled"
        >
          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –¢–∏–ø –¥–æ–ª–≥–∞ */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>–¢–∏–ø –¥–æ–ª–≥–∞ *</Text>
            <View style={styles.debtTypeGrid}>
              <DebtTypeButton 
                type="given"
                icon="‚û°Ô∏è"
                label="–î–∞–ª –≤ –¥–æ–ª–≥"
                description="–î–µ–Ω—å–≥–∏ —É—Ö–æ–¥—è—Ç —Å –≤–∞—à–µ–≥–æ —Å—á–µ—Ç–∞"
              />
              <DebtTypeButton 
                type="taken" 
                icon="‚¨ÖÔ∏è"
                label="–í–∑—è–ª –≤ –¥–æ–ª–≥"
                description="–î–µ–Ω—å–≥–∏ –ø—Ä–∏—Ö–æ–¥—è—Ç –Ω–∞ –≤–∞—à —Å—á–µ—Ç"
              />
            </View>
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö–æ–º—É/–æ—Ç –∫–æ–≥–æ */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>
              {debtType === 'given' ? '–ö–æ–º—É –¥–∞–ª–∏ –≤ –¥–æ–ª–≥ *' : '–û—Ç –∫–æ–≥–æ –≤–∑—è–ª–∏ –≤ –¥–æ–ª–≥ *'}
            </Text>
            <TextInput
              style={styles.textInput}
              placeholder={
                debtType === 'given' ? "–ù–∞–ø—Ä–∏–º–µ—Ä: –ò–≤–∞–Ω –ü–µ—Ç—Ä–æ–≤, –ú–∞—Ä–∏—è..." : "–ù–∞–ø—Ä–∏–º–µ—Ä: –ê–ª–µ–∫—Å–µ–π –°–º–∏—Ä–Ω–æ–≤, –û–û–û –ö–æ–º–ø–∞–Ω–∏—è..."
              }
              value={person}
              onChangeText={setPerson}
              placeholderTextColor={colors.textSecondary}
              maxLength={100}
              returnKeyType="next"
            />
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—É–º–º–∞ */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>–°—É–º–º–∞ –¥–æ–ª–≥–∞ *</Text>
            <View style={styles.amountInputContainer}>
              <Text style={styles.currencySymbol}>BYN</Text>
              <TextInput
                style={styles.amountInput}
                placeholder="0.00"
                value={amount}
                onChangeText={handleAmountChange}
                keyboardType="decimal-pad"
                placeholderTextColor={colors.textSecondary}
                returnKeyType="next"
                onSubmitEditing={() => {
                  Keyboard.dismiss();
                }}
              />
            </View>
            
            <View style={styles.quickAmounts}>
              <Text style={styles.quickAmountsLabel}>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥:</Text>
              <View style={styles.quickAmountsGrid}>
                {quickAmounts.map(value => (
                  <QuickAmountButton key={value} value={value} />
                ))}
              </View>
            </View>
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è</Text>
            <Text style={styles.dateHelpText}>
              {dueDate ? `–í—ã–±—Ä–∞–Ω–æ: ${formatDisplayDate(dueDate)}` : '–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: —á–µ—Ä–µ–∑ 30 –¥–Ω–µ–π'}
            </Text>
            <DateButton 
              date={dueDate} 
              onPress={() => setShowDatePicker(true)}
            />
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—á–µ—Ç */}
          <View style={styles.inputSection}>
            <View style={styles.sectionHeader}>
              <Text style={styles.inputLabel}>–°—á–µ—Ç *</Text>
              {selectedAccount && (
                <Text style={styles.selectedCategoryHint}>–í—ã–±—Ä–∞–Ω</Text>
              )}
            </View>
            <Text style={styles.accountHelpText}>
              {debtType === 'given' 
                ? '–î–µ–Ω—å–≥–∏ –±—É–¥—É—Ç —Å–ø–∏—Å–∞–Ω—ã —Å —ç—Ç–æ–≥–æ —Å—á–µ—Ç–∞' 
                : '–î–µ–Ω—å–≥–∏ –±—É–¥—É—Ç –∑–∞—á–∏—Å–ª–µ–Ω—ã –Ω–∞ —ç—Ç–æ—Ç —Å—á–µ—Ç'}
            </Text>
            <View style={styles.accountsList}>
              {accounts.map(account => (
                <AccountButton key={account.id} account={account} />
              ))}
            </View>
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –û–ø–∏—Å–∞–Ω–∏–µ */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Text>
            <TextInput
              style={styles.descriptionInput}
              placeholder={
                debtType === 'given' ? "–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–∞ —Ä–µ–º–æ–Ω—Ç –º–∞—à–∏–Ω—ã, –í–∑–∞–π–º—ã –¥–æ –∑–∞—Ä–ø–ª–∞—Ç—ã..." : "–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Ä–∞–±–æ—Ç—É, –ó–∞–π–º –Ω–∞ –±–∏–∑–Ω–µ—Å..."
              }
              value={description}
              onChangeText={setDescription}
              placeholderTextColor={colors.textSecondary}
              multiline
              numberOfLines={3}
              maxLength={500}
              returnKeyType="done"
              blurOnSubmit={true}
            />
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
          <View style={styles.actionsContainer}>
            <TouchableOpacity 
              style={[
                styles.saveButton,
                (!person.trim() || !amount || !selectedAccount) && styles.saveButtonDisabled
              ]} 
              onPress={handleSave}
              disabled={!person.trim() || !amount || !selectedAccount}
            >
              <Text style={styles.saveButtonText}>
                üíæ {debtType === 'given' ? '–°–æ–∑–¥–∞—Ç—å –¥–æ–ª–≥' : '–ü—Ä–∏–Ω—è—Ç—å –¥–æ–ª–≥'}
              </Text>
            </TouchableOpacity>

            <TouchableOpacity 
              style={styles.cancelButton} 
              onPress={() => {
                Keyboard.dismiss();
                navigation.goBack();
              }}
            >
              <Text style={styles.cancelButtonText}>–û—Ç–º–µ–Ω–∞</Text>
            </TouchableOpacity>
          </View>
        </ScrollView>
      </KeyboardAvoidingView>

      {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã */}
      <Modal
        visible={showDatePicker}
        transparent={true}
        animationType="slide"
        onRequestClose={closeAllModals}
      >
        <TouchableOpacity 
          style={styles.modalOverlay}
          activeOpacity={1}
          onPressOut={closeAllModals}
        >
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>üìÖ –í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –ø–æ–≥–∞—à–µ–Ω–∏—è</Text>
            
            <View style={styles.dateOptions}>
              <DateOption 
                days={7} 
                label="–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é" 
                onPress={() => handleQuickDateSelect(7)}
              />
              <DateOption 
                days={14} 
                label="–ß–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏" 
                onPress={() => handleQuickDateSelect(14)}
              />
              <DateOption 
                days={21} 
                label="–ß–µ—Ä–µ–∑ 3 –Ω–µ–¥–µ–ª–∏" 
                onPress={() => handleQuickDateSelect(21)}
              />
              <DateOption 
                days={30} 
                label="–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü" 
                onPress={() => handleQuickDateSelect(30)}
              />
            </View>

            <View style={styles.modalActions}>
              <TouchableOpacity 
                style={styles.customDateButton}
                onPress={() => {
                  setShowDatePicker(false);
                  setShowCalendar(true);
                }}
              >
                <Text style={styles.customDateButtonText}>üìÖ –ü—Ä–æ–∏–∑–≤–æ–ª—å–Ω–∞—è –¥–∞—Ç–∞...</Text>
              </TouchableOpacity>
              
              <TouchableOpacity 
                style={styles.cancelModalButton}
                onPress={closeAllModals}
              >
                <Text style={styles.cancelModalButtonText}>–û—Ç–º–µ–Ω–∞</Text>
              </TouchableOpacity>
            </View>
          </View>
        </TouchableOpacity>
      </Modal>

      <CalendarModal
        visible={showCalendar}
        onClose={() => setShowCalendar(false)}
        onDateSelect={handleDateSelect}
        selectedDate={dueDate}
        minDate={new Date(Date.now() + 86400000).toISOString().split('T')[0]}
      />
    </View>
  );
};

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    ...commonStyles.screen.header,
  },
  screenTitle: {
    ...commonStyles.screen.title,
  },
  screenSubtitle: {
    ...commonStyles.screen.subtitle,
  },
  keyboardAvoidingView: {
    flex: 1,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  scrollContentWithKeyboard: {
    paddingBottom: 100,
  },
  inputSection: {
    marginBottom: spacing.xxl,
  },
  sectionHeader: {
    ...commonStyles.sections.header,
    marginBottom: spacing.xs,
  },
  inputLabel: {
    ...commonStyles.forms.label,
  },
  selectedCategoryHint: {
    fontSize: 14,
    color: colors.success,
    fontWeight: '600',
  },
  debtTypeGrid: {
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ —Ç–∏–ø–∞ –¥–æ–ª–≥–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  debtTypeButton: {
    ...commonStyles.cards.surface,
    padding: spacing.xl,
    borderWidth: 2,
    borderColor: 'transparent',
  },
  debtTypeButtonActive: {
    ...shadows.lg,
  },
  debtTypeIcon: {
    fontSize: 24,
    marginBottom: spacing.sm,
    textAlign: 'center',
  },
  debtTypeLabel: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.xs,
  },
  debtTypeDescription: {
    fontSize: 12,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 16,
  },
  // üîß –ü–æ–ª–µ –≤–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  textInput: {
    ...commonStyles.forms.inputContainer,
    ...commonStyles.forms.input,
    padding: spacing.lg,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–≤–æ–¥–∞ —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  amountInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    paddingHorizontal: spacing.xl,
    ...shadows.lg,
    marginBottom: spacing.lg,
  },
  currencySymbol: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.primary,
    marginRight: spacing.md,
  },
  amountInput: {
    flex: 1,
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: spacing.xl,
  },
  quickAmounts: {
    marginBottom: spacing.xs,
  },
  quickAmountsLabel: {
    fontSize: 16,
    color: colors.textSecondary,
    marginBottom: spacing.md,
    fontWeight: '500',
  },
  quickAmountsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–π —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  quickAmountButton: {
    ...commonStyles.cards.surface,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    minWidth: 60,
    alignItems: 'center',
    borderWidth: 1,
    borderColor: 'transparent',
  },
  quickAmountButtonActive: {
    backgroundColor: colors.primary,
    borderColor: colors.primary,
  },
  quickAmountText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.primary,
  },
  quickAmountTextActive: {
    color: colors.white,
  },
  dateHelpText: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: spacing.sm,
    fontStyle: 'italic',
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –¥–∞—Ç—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  dateButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    padding: spacing.lg,
    borderRadius: borderRadius.lg,
    ...shadows.md,
    gap: spacing.md,
  },
  dateButtonIcon: {
    fontSize: 20,
  },
  dateButtonText: {
    fontSize: 16,
    color: colors.textPrimary,
    fontWeight: '500',
  },
  accountHelpText: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: spacing.md,
    fontStyle: 'italic',
  },
  accountsList: {
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  accountButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    ...shadows.md,
    borderWidth: 2,
    borderColor: 'transparent',
    position: 'relative',
  },
  accountButtonActive: {
    ...shadows.lg,
  },
  accountButtonDisabled: {
    opacity: 0.5,
    backgroundColor: colors.background,
  },
  accountIconContainer: {
    width: 44,
    height: 44,
    borderRadius: borderRadius.xl,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
    ...shadows.md,
  },
  accountIcon: {
    fontSize: 20,
    fontWeight: 'bold',
  },
  accountInfo: {
    flex: 1,
  },
  accountName: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  accountBalance: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  selectionDot: {
    position: 'absolute',
    top: spacing.md,
    right: spacing.md,
    width: 8,
    height: 8,
    borderRadius: borderRadius.xs,
  },
  insufficientFunds: {
    fontSize: 10,
    color: colors.error,
    fontWeight: '600',
    marginLeft: spacing.sm,
  },
  // üîß –ü–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  descriptionInput: {
    ...commonStyles.forms.inputContainer,
    ...commonStyles.forms.input,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.lg,
    textAlignVertical: 'top',
    minHeight: 100,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
  actionsContainer: {
    gap: spacing.md,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  saveButton: {
    ...commonStyles.buttons.primary,
  },
  saveButtonDisabled: {
    backgroundColor: colors.textSecondary + '40',
    ...shadows.sm,
  },
  saveButtonText: {
    ...commonStyles.buttons.primaryText,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  cancelButton: {
    ...commonStyles.buttons.secondary,
  },
  cancelButtonText: {
    ...commonStyles.buttons.secondaryText,
  },
  // üîß –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
    padding: spacing.xl,
  },
  modalContent: {
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    padding: spacing.xxl,
    width: '100%',
    ...shadows.xl,
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.xl,
  },
  dateOptions: {
    gap: spacing.sm,
    marginBottom: spacing.xl,
  },
  // üîß –û–ø—Ü–∏—è –¥–∞—Ç—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  dateOption: {
    backgroundColor: colors.background,
    padding: spacing.lg,
    borderRadius: borderRadius.md,
    ...shadows.sm,
  },
  dateOptionLabel: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.primary,
    marginBottom: spacing.xs,
  },
  dateOptionDate: {
    fontSize: 14,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  modalActions: {
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –ø—Ä–æ–∏–∑–≤–æ–ª—å–Ω–æ–π –¥–∞—Ç—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  customDateButton: {
    backgroundColor: colors.primary + '20',
    padding: spacing.lg,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    borderWidth: 2,
    borderColor: colors.primary,
  },
  customDateButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.primary,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –≤ –º–æ–¥–∞–ª–∫–µ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  cancelModalButton: {
    backgroundColor: 'transparent',
    padding: spacing.lg,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    borderWidth: 2,
    borderColor: colors.textSecondary + '30',
  },
  cancelModalButtonText: {
    color: colors.textSecondary,
    fontSize: 16,
    fontWeight: '600',
  },
});

export default AddDebtScreen;import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  KeyboardAvoidingView,
  Platform,
  ActivityIndicator,
  Keyboard
} from 'react-native';
import TextInput from '../components/TextInput';
import { colors } from '../theme/colors';
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';

const AddTransactionScreen = ({ navigation, route }) => {
  const { accounts, categories, addTransaction } = useData();
  
  const { presetType = 'expense', fromHome = false } = route.params || {};
  const [operationType, setOperationType] = useState(presetType);
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [selectedCategory, setSelectedCategory] = useState('');
  const [selectedAccount, setSelectedAccount] = useState(accounts[0]?.id || '');
  
  const amountInputRef = useRef(null);
  const descriptionInputRef = useRef(null);
  
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isKeyboardVisible, setKeyboardVisible] = useState(false);

  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
  useEffect(() => {
    const keyboardDidShowListener = Keyboard.addListener(
      'keyboardDidShow',
      () => setKeyboardVisible(true)
    );
    const keyboardDidHideListener = Keyboard.addListener(
      'keyboardDidHide',
      () => setKeyboardVisible(false)
    );

    return () => {
      keyboardDidShowListener.remove();
      keyboardDidHideListener.remove();
    };
  }, []);

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏ –∞–≤—Ç–æ—Ñ–æ–∫—É—Å
  useEffect(() => {
    const currentCategories = operationType === 'income' ? categories.income : categories.expense;
    
    if (currentCategories.length > 0 && !selectedCategory) {
      let defaultCategory = currentCategories[0].id;
      
      if (operationType === 'income') {
        defaultCategory = currentCategories.find(cat => cat.id === 'salary')?.id || currentCategories[0].id;
      } else {
        defaultCategory = currentCategories.find(cat => cat.id === 'groceries')?.id || currentCategories[0].id;
      }
      
      setSelectedCategory(defaultCategory);
    }

    if (presetType || fromHome) {
      const focusTimer = setTimeout(() => {
        amountInputRef.current?.focus();
      }, 400);

      return () => clearTimeout(focusTimer);
    }
  }, [operationType, categories, presetType, fromHome]);

  // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è presetType –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
  useEffect(() => {
    if (route.params?.presetType && route.params.presetType !== operationType) {
      setOperationType(route.params.presetType);
      setSelectedCategory('');
      
      if (route.params?.fromHome) {
        setAmount('');
      }
    }
  }, [route.params?.presetType, route.params?.fromHome]);

  // –§—É–Ω–∫—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
  const handleSave = async () => {
    Keyboard.dismiss();

    if (!amount || !selectedCategory || !selectedAccount) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    const amountValue = parseFloat(amount);
    
    if (isNaN(amountValue) || amountValue <= 0) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É');
      return;
    }

    if (amountValue > 100000000) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—É–º–º–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 000 000 BYN');
      return;
    }

    const finalAmount = operationType === 'income' ? amountValue : -amountValue;

    if (operationType === 'expense') {
      const selectedAccountData = accounts.find(acc => acc.id === selectedAccount);
      if (selectedAccountData && selectedAccountData.balance < amountValue) {
        Alert.alert(
          '–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 
          `–ù–∞ —Å—á–µ—Ç–µ "${selectedAccountData.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤\n` +
          `–î–æ—Å—Ç—É–ø–Ω–æ: ${formatCurrency(selectedAccountData.balance, false)}\n` +
          `–¢—Ä–µ–±—É–µ—Ç—Å—è: ${formatCurrency(amountValue, false)}`
        );
        return;
      }
    }

    try {
      setIsSubmitting(true);
      
      await addTransaction({
        amount: finalAmount,
        description: description.trim() || undefined,
        category: selectedCategory,
        account_id: selectedAccount,
        type: operationType,
        date: new Date().toISOString()
      });

      Alert.alert('‚úÖ –£—Å–ø–µ—Ö', '–û–ø–µ—Ä–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∞!', [
        { 
          text: 'OK', 
          onPress: () => {
            setTimeout(() => {
              setAmount('');
              setDescription('');
              setSelectedCategory('');
              if (fromHome) {
                navigation.navigate('Home');
              } else {
                navigation.goBack();
              }
            }, 100);
          }
        }
      ]);
    } catch (error) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é');
      console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å—É–º–º—ã
  const handleAmountChange = (text) => {
    const cleaned = text.replace(/[^\d.]/g, '');
    const parts = cleaned.split('.');
    if (parts.length > 2) return;
    if (parts[1] && parts[1].length > 2) return;
    setAmount(cleaned);
  };

  const CategoryButton = ({ category }) => {
    const isSelected = selectedCategory === category.id;
    
    return (
      <TouchableOpacity
        style={[
          styles.categoryButton,
          isSelected && [
            styles.categoryButtonActive,
            { 
              borderColor: category.color,
              backgroundColor: category.color + '15',
              shadowColor: category.color
            }
          ]
        ]}
        onPress={() => {
          setSelectedCategory(category.id);
          Keyboard.dismiss();
        }}
      >
        <View style={[
          styles.categoryIconContainer,
          { backgroundColor: isSelected ? category.color : colors.surface }
        ]}>
          <Text style={[
            styles.categoryIcon,
            { color: isSelected ? colors.white : category.color }
          ]}>
            {category.icon}
          </Text>
        </View>
        <Text style={[
          styles.categoryName,
          isSelected && { color: category.color, fontWeight: '700' }
        ]}>
          {category.name}
        </Text>
        {isSelected && (
          <View style={[styles.selectionDot, { backgroundColor: category.color }]} />
        )}
      </TouchableOpacity>
    );
  };

  const AccountButton = ({ account }) => {
    const isSelected = selectedAccount === account.id;
    const hasInsufficientFunds = operationType === 'expense' && account.balance < parseFloat(amount || 0);
    
    return (
      <TouchableOpacity
        style={[
          styles.accountButton,
          isSelected && [
            styles.accountButtonActive,
            { 
              borderColor: colors.primary,
              shadowColor: colors.primary
            }
          ],
          hasInsufficientFunds && styles.accountButtonDisabled
        ]}
        onPress={() => {
          if (!hasInsufficientFunds) {
            setSelectedAccount(account.id);
            Keyboard.dismiss();
          }
        }}
        disabled={hasInsufficientFunds}
      >
        <View style={[
          styles.accountIconContainer,
          { backgroundColor: isSelected ? colors.primary : colors.surface },
          hasInsufficientFunds && { backgroundColor: colors.border }
        ]}>
          <Text style={[
            styles.accountIcon,
            { color: isSelected ? colors.white : colors.textPrimary },
            hasInsufficientFunds && { color: colors.textSecondary }
          ]}>
            {account.icon}
          </Text>
        </View>
        
        <View style={styles.accountInfo}>
          <Text style={[
            styles.accountName,
            isSelected && { color: colors.primary, fontWeight: '700' },
            hasInsufficientFunds && { color: colors.textSecondary }
          ]}>
            {account.name}
          </Text>
          <Text style={[
            styles.accountBalance,
            hasInsufficientFunds && { color: colors.textSecondary }
          ]}>
            –ë–∞–ª–∞–Ω—Å: {formatCurrency(account.balance, false)}
          </Text>
          {hasInsufficientFunds && (
            <Text style={styles.insufficientFundsText}>‚ö†Ô∏è –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤</Text>
          )}
        </View>
        
        {isSelected && (
          <View style={styles.selectedCheckmark}>
            <Text style={styles.selectedCheckmarkText}>‚úì</Text>
          </View>
        )}
      </TouchableOpacity>
    );
  };

  const QuickAmountButton = ({ value }) => (
    <TouchableOpacity
      style={styles.quickAmountButton}
      onPress={() => {
        setAmount(value.toString());
        Keyboard.dismiss();
      }}
    >
      <Text style={styles.quickAmountText}>{value}</Text>
    </TouchableOpacity>
  );

  const LoadingButton = ({ 
    onPress, 
    isLoading, 
    disabled, 
    style, 
    textStyle, 
    children,
    loadingText = "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ..." 
  }) => (
    <TouchableOpacity
      style={[style, disabled && styles.buttonDisabled]}
      onPress={onPress}
      disabled={disabled || isLoading}
    >
      {isLoading ? (
        <View style={styles.loadingButtonContent}>
          <ActivityIndicator size="small" color={colors.white} />
          <Text style={[textStyle, styles.loadingButtonText]}>{loadingText}</Text>
        </View>
      ) : (
        children
      )}
    </TouchableOpacity>
  );

  const currentCategories = (operationType === 'income' ? categories.income : categories.expense)
    .filter(category => category.id !== 'debt_given');

  return (
    <View style={styles.container}>
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>
          {operationType === 'income' ? 'üíµ –î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥' : 'üí∏ –î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥'}
        </Text>
        <Text style={styles.screenSubtitle}>
          {fromHome ? `–í—ã–±—Ä–∞–Ω —Ç–∏–ø: ${operationType === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}` : 
           presetType ? `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω —Ç–∏–ø: ${operationType === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}` : 
           '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏'}
        </Text>
      </View>

      <KeyboardAvoidingView 
        style={styles.keyboardAvoidingView}
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        keyboardVerticalOffset={Platform.OS === 'ios' ? 90 : 0}
      >
        <ScrollView 
          style={styles.scrollView}
          showsVerticalScrollIndicator={false}
          contentContainerStyle={[
            styles.scrollContent,
            isKeyboardVisible && styles.scrollContentWithKeyboard
          ]}
          keyboardShouldPersistTaps="handled"
        >
          {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ */}
          <View style={styles.typeSelector}>
            <TouchableOpacity
              style={[
                styles.typeButton,
                styles.incomeTypeButton,
                operationType === 'income' && styles.typeButtonActive,
                operationType === 'income' && { 
                  backgroundColor: colors.success,
                  ...((presetType === 'income' || fromHome) && {
                    shadowColor: colors.success,
                    elevation: 12,
                  })
                }
              ]}
              onPress={() => {
                setOperationType('income');
                Keyboard.dismiss();
              }}
            >
              <Text style={[
                styles.typeButtonText,
                operationType === 'income' && styles.typeButtonTextActive,
                (presetType === 'income' || fromHome) && operationType === 'income' && { fontWeight: '900' }
              ]}>
                üíµ –î–æ—Ö–æ–¥{(presetType === 'income' || fromHome) && operationType === 'income' && ' ‚úì'}
              </Text>
            </TouchableOpacity>
            
            <TouchableOpacity
              style={[
                styles.typeButton,
                styles.expenseTypeButton,
                operationType === 'expense' && styles.typeButtonActive,
                operationType === 'expense' && { 
                  backgroundColor: colors.error,
                  ...((presetType === 'expense' || fromHome) && {
                    shadowColor: colors.error,
                    elevation: 12,
                  })
                }
              ]}
              onPress={() => {
                setOperationType('expense');
                Keyboard.dismiss();
              }}
            >
              <Text style={[
                styles.typeButtonText,
                operationType === 'expense' && styles.typeButtonTextActive,
                (presetType === 'expense' || fromHome) && operationType === 'expense' && { fontWeight: '900' }
              ]}>
                üí∏ –†–∞—Å—Ö–æ–¥{(presetType === 'expense' || fromHome) && operationType === 'expense' && ' ‚úì'}
              </Text>
            </TouchableOpacity>
          </View>

          {/* –°—É–º–º–∞ —Å –∞–≤—Ç–æ—Ñ–æ–∫—É—Å–æ–º */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>–°—É–º–º–∞ *</Text>
            <View style={styles.amountInputContainer}>
              <Text style={styles.currencySymbol}>BYN</Text>
              <TextInput
                ref={amountInputRef}
                style={styles.amountInput}
                placeholder="0.00"
                value={amount}
                onChangeText={handleAmountChange}
                keyboardType="decimal-pad"
                placeholderTextColor={colors.textSecondary}
                autoFocus={false}
                returnKeyType="next"
                onSubmitEditing={() => Keyboard.dismiss()}
              />
            </View>
            
            {/* üî• –û–ë–ù–û–í–õ–ï–ù–û: –ù–æ–≤—ã–µ –Ω–æ–º–∏–Ω–∞–ª—ã –¥–ª—è –¥–æ—Ö–æ–¥–∞ */}
            <View style={styles.quickAmounts}>
              <Text style={styles.quickAmountsLabel}>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥:</Text>
              <ScrollView 
                horizontal 
                showsHorizontalScrollIndicator={false}
                style={styles.quickAmountsScroll}
                contentContainerStyle={styles.quickAmountsRow}
              >
                {operationType === 'income' ? (
                  // üî• –ù–û–í–´–ï –ù–û–ú–ò–ù–ê–õ–´ –î–õ–Ø –î–û–•–û–î–ê: 10, 20, 50, 100, 500, 1000, 1500, 2000
                  [10, 20, 50, 100, 500, 1000, 1500, 2000].map(value => (
                    <QuickAmountButton key={value} value={value} />
                  ))
                ) : (
                  // –ù–æ–º–∏–Ω–∞–ª—ã –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –æ—Å—Ç–∞—é—Ç—Å—è –ø—Ä–µ–∂–Ω–∏–º–∏
                  [5, 10, 20, 50, 100, 200].map(value => (
                    <QuickAmountButton key={value} value={value} />
                  ))
                )}
              </ScrollView>
            </View>
          </View>

          {/* –°—á–µ—Ç */}
          <View style={styles.inputSection}>
            <View style={styles.sectionHeader}>
              <Text style={styles.inputLabel}>–°—á–µ—Ç *</Text>
              {selectedAccount && (
                <Text style={styles.selectedCategoryHint}>–í—ã–±—Ä–∞–Ω</Text>
              )}
            </View>
            <View style={styles.accountsList}>
              {accounts.map(account => (
                <AccountButton key={account.id} account={account} />
              ))}
            </View>
          </View>

          {/* –ö–∞—Ç–µ–≥–æ—Ä–∏—è */}
          <View style={styles.inputSection}>
            <View style={styles.sectionHeader}>
              <Text style={styles.inputLabel}>–ö–∞—Ç–µ–≥–æ—Ä–∏—è *</Text>
              {selectedCategory && (
                <Text style={styles.selectedCategoryHint}>
                  {(presetType || fromHome) ? '–ê–≤—Ç–æ–≤—ã–±–æ—Ä ‚úì' : '–í—ã–±—Ä–∞–Ω–æ'}
                </Text>
              )}
            </View>
            <View style={styles.categoriesGrid}>
              {currentCategories.map(category => (
                <CategoryButton key={category.id} category={category} />
              ))}
            </View>
          </View>

          {/* –û–ø–∏—Å–∞–Ω–∏–µ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏ */}
          <View style={styles.descriptionSection}>
            <Text style={styles.inputLabel}>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Text>
            <TextInput
              ref={descriptionInputRef}
              style={styles.descriptionInput}
              placeholder={
                operationType === 'income' ? 
                  "–ù–∞–ø—Ä–∏–º–µ—Ä: –ó–∞—Ä–ø–ª–∞—Ç–∞, –§—Ä–∏–ª–∞–Ω—Å, –ü–æ–¥–∞—Ä–æ–∫, –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏..." :
                  "–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–æ–¥—É–∫—Ç—ã, –ö–∞—Ñ–µ, –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç, –ö–æ–º–º—É–Ω–∞–ª–∫–∞..."
              }
              value={description}
              onChangeText={setDescription}
              placeholderTextColor={colors.textSecondary}
              returnKeyType="done"
              blurOnSubmit={true}
              multiline={true}
              numberOfLines={3}
              textAlignVertical="top"
            />
          </View>

          {/* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */}
          <View style={styles.footer}>
            <LoadingButton 
              style={[
                styles.saveButton,
                (!amount || !selectedCategory || !selectedAccount) && styles.saveButtonDisabled
              ]} 
              onPress={handleSave}
              disabled={!amount || !selectedCategory || !selectedAccount}
              isLoading={isSubmitting}
              textStyle={styles.saveButtonText}
              loadingText={operationType === 'income' ? "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–∞..." : "–î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–∞..."}
            >
              <Text style={styles.saveButtonText}>
                üíæ {operationType === 'income' ? '–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Ö–æ–¥' : '–î–æ–±–∞–≤–∏—Ç—å —Ä–∞—Å—Ö–æ–¥'}
              </Text>
            </LoadingButton>

            <TouchableOpacity 
              style={[
                styles.cancelButton,
                isSubmitting && styles.cancelButtonDisabled
              ]} 
              onPress={() => {
                Keyboard.dismiss();
                if (fromHome) {
                  navigation.navigate('Home');
                } else {
                  navigation.goBack();
                }
              }}
              disabled={isSubmitting}
            >
              <Text style={styles.cancelButtonText}>–û—Ç–º–µ–Ω–∞</Text>
            </TouchableOpacity>
          </View>

          {isKeyboardVisible && <View style={styles.keyboardSpacer} />}
        </ScrollView>
      </KeyboardAvoidingView>
    </View>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },
  screenHeader: {
    paddingTop: 60,
    paddingHorizontal: spacing.xl,
    paddingBottom: spacing.lg,
    backgroundColor: colors.background,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  screenTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.xs,
  },
  screenSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 18,
  },
  keyboardAvoidingView: {
    flex: 1,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingBottom: spacing.xxl,
    paddingTop: spacing.lg,
  },
  scrollContentWithKeyboard: {
    paddingBottom: 120,
  },
  typeSelector: {
    flexDirection: 'row',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    padding: spacing.sm,
    marginBottom: spacing.xxl,
    ...shadows.lg,
  },
  typeButton: {
    flex: 1,
    paddingVertical: spacing.lg,
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    justifyContent: 'center',
  },
  typeButtonActive: {
    ...shadows.lg,
  },
  typeButtonText: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textSecondary,
  },
  typeButtonTextActive: {
    color: colors.white,
    fontWeight: '800',
  },
  inputSection: {
    marginBottom: spacing.xxl,
  },
  descriptionSection: {
    marginBottom: spacing.xl,
  },
  sectionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.lg,
  },
  inputLabel: {
    fontSize: 18,
    fontWeight: '600',
    color: colors.textPrimary,
  },
  selectedCategoryHint: {
    fontSize: 14,
    color: colors.success,
    fontWeight: '600',
  },
  amountInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    paddingHorizontal: spacing.xl,
    ...shadows.lg,
    marginBottom: spacing.lg,
  },
  currencySymbol: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.primary,
    marginRight: spacing.md,
  },
  amountInput: {
    flex: 1,
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: spacing.xl,
  },
  quickAmounts: {
    marginBottom: spacing.sm,
  },
  quickAmountsLabel: {
    fontSize: 16,
    color: colors.textSecondary,
    marginBottom: spacing.md,
    fontWeight: '500',
  },
  quickAmountsScroll: {
    maxHeight: 60,
  },
  quickAmountsRow: {
    flexDirection: 'row',
    gap: spacing.md,
    paddingHorizontal: spacing.xs,
    paddingVertical: spacing.xs,
  },
  quickAmountButton: {
    backgroundColor: colors.surface,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.lg,
    ...shadows.md,
    minWidth: 55,
    alignItems: 'center',
    justifyContent: 'center',
    marginHorizontal: spacing.xs,
  },
  quickAmountText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.primary,
  },
  descriptionInput: {
    backgroundColor: colors.surface,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.lg,
    borderRadius: borderRadius.lg,
    fontSize: 16,
    color: colors.textPrimary,
    ...shadows.md,
    minHeight: 80,
    textAlignVertical: 'top',
    lineHeight: 20,
  },
  categoriesGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.md,
  },
  categoryButton: {
    width: '48%',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    alignItems: 'center',
    borderWidth: 2,
    borderColor: 'transparent',
    ...shadows.md,
    position: 'relative',
  },
  categoryButtonActive: {
    ...shadows.lg,
  },
  categoryIconContainer: {
    width: 50,
    height: 50,
    borderRadius: borderRadius.pill,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: spacing.md,
    ...shadows.md,
  },
  categoryIcon: {
    fontSize: 20,
    fontWeight: 'bold',
  },
  categoryName: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    textAlign: 'center',
  },
  selectionDot: {
    position: 'absolute',
    top: spacing.sm,
    right: spacing.sm,
    width: 8,
    height: 8,
    borderRadius: borderRadius.xs,
  },
  accountsList: {
    gap: spacing.md,
  },
  accountButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    ...shadows.md,
    borderWidth: 2,
    borderColor: 'transparent',
  },
  accountButtonActive: {
    ...shadows.lg,
  },
  accountButtonDisabled: {
    opacity: 0.5,
    backgroundColor: colors.background,
  },
  accountIconContainer: {
    width: 44,
    height: 44,
    borderRadius: borderRadius.pill,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
    ...shadows.md,
  },
  accountIcon: {
    fontSize: 20,
    fontWeight: 'bold',
  },
  accountInfo: {
    flex: 1,
  },
  accountName: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  accountBalance: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  insufficientFundsText: {
    fontSize: 10,
    color: colors.error,
    fontWeight: '600',
    marginTop: 2,
  },
  selectedCheckmark: {
    width: 24,
    height: 24,
    borderRadius: borderRadius.pill,
    backgroundColor: colors.success,
    alignItems: 'center',
    justifyContent: 'center',
    marginLeft: spacing.md,
  },
  selectedCheckmarkText: {
    color: colors.white,
    fontSize: 14,
    fontWeight: 'bold',
  },
  footer: {
    gap: spacing.md,
    marginTop: spacing.sm,
  },
  saveButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.xl,
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    ...shadows.xl,
    minHeight: 64,
    justifyContent: 'center',
  },
  saveButtonDisabled: {
    backgroundColor: colors.textSecondary + '40',
    ...shadows.sm,
  },
  saveButtonText: {
    color: colors.white,
    fontSize: 18,
    fontWeight: 'bold',
  },
  cancelButton: {
    backgroundColor: 'transparent',
    paddingVertical: spacing.lg,
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    borderWidth: 2,
    borderColor: colors.textSecondary + '30',
    minHeight: 56,
    justifyContent: 'center',
  },
  cancelButtonDisabled: {
    opacity: 0.5,
  },
  cancelButtonText: {
    color: colors.textSecondary,
    fontSize: 16,
    fontWeight: '600',
  },
  buttonDisabled: {
    opacity: 0.6,
  },
  loadingButtonContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: spacing.sm,
  },
  loadingButtonText: {
    fontSize: 16,
    marginLeft: spacing.xs,
  },
  keyboardSpacer: {
    height: 50,
  },
});

export default AddTransactionScreen;// services/AnalyticsService.js
import { formatCurrency } from '../utils/currencyFormatter';

class AnalyticsService {
  // üìà –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤
  compareMonths = (transactions, monthsToCompare = 2) => {
    try {
      const now = new Date();
      const comparisons = [];
      
      for (let i = 0; i < monthsToCompare; i++) {
        const month = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const nextMonth = new Date(now.getFullYear(), now.getMonth() - i + 1, 1);
        
        const monthTransactions = transactions.filter(t => {
          const transactionDate = new Date(t.date);
          return transactionDate >= month && transactionDate < nextMonth;
        });

        const income = monthTransactions
          .filter(t => t.amount > 0)
          .reduce((sum, t) => sum + t.amount, 0);

        const expense = monthTransactions
          .filter(t => t.amount < 0)
          .reduce((sum, t) => sum + Math.abs(t.amount), 0);

        const balance = income - expense;

        comparisons.push({
          period: month.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' }),
          month: month.getMonth(),
          year: month.getFullYear(),
          income,
          expense,
          balance,
          transactionCount: monthTransactions.length,
          averageTransaction: monthTransactions.length > 0 ? 
            (expense / monthTransactions.filter(t => t.amount < 0).length) : 0
        });
      }

      // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç —Å–∞–º–æ–≥–æ —Å—Ç–∞—Ä–æ–≥–æ –∫ —Å–∞–º–æ–º—É –Ω–æ–≤–æ–º—É
      comparisons.reverse();

      // –î–æ–±–∞–≤–ª—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö
      if (comparisons.length > 1) {
        for (let i = 1; i < comparisons.length; i++) {
          const current = comparisons[i];
          const previous = comparisons[i - 1];
          
          current.incomeChange = previous.income > 0 ? 
            ((current.income - previous.income) / previous.income) * 100 : 0;
          current.expenseChange = previous.expense > 0 ? 
            ((current.expense - previous.expense) / previous.expense) * 100 : 0;
          current.balanceChange = previous.balance !== 0 ? 
            ((current.balance - previous.balance) / Math.abs(previous.balance)) * 100 : 0;
        }
      }

      return comparisons;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –º–µ—Å—è—Ü–µ–≤:', error);
      return [];
    }
  };

  // üéØ –ê–Ω–∞–ª–∏–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
  analyzeRegularPayments = (transactions, categories) => {
    try {
      const regularPayments = {};
      const threeMonthsAgo = new Date();
      threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–∂–¥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤
      categories.expense.forEach(category => {
        const categoryTransactions = transactions
          .filter(t => t.category === category.id && t.amount < 0 && new Date(t.date) >= threeMonthsAgo)
          .map(t => ({
            ...t,
            amount: Math.abs(t.amount),
            month: new Date(t.date).getMonth(),
            year: new Date(t.date).getFullYear()
          }));

        if (categoryTransactions.length >= 2) {
          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Å—è—Ü–∞–º
          const monthlyData = {};
          categoryTransactions.forEach(t => {
            const key = `${t.year}-${t.month}`;
            if (!monthlyData[key]) {
              monthlyData[key] = {
                total: 0,
                count: 0,
                transactions: []
              };
            }
            monthlyData[key].total += t.amount;
            monthlyData[key].count++;
            monthlyData[key].transactions.push(t);
          });

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å (–ø–ª–∞—Ç–µ–∂–∏ –≤ –æ–¥–Ω–∏ –∏ —Ç–µ –∂–µ –¥–Ω–∏ –º–µ—Å—è—Ü–∞)
          const transactionDays = categoryTransactions.map(t => new Date(t.date).getDate());
          const uniqueDays = [...new Set(transactionDays)];
          
          // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω—é—é —Å—É–º–º—É
          const totalAmount = categoryTransactions.reduce((sum, t) => sum + t.amount, 0);
          const averageAmount = totalAmount / categoryTransactions.length;

          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç—å (–µ—Å–ª–∏ –ø–ª–∞—Ç–µ–∂–∏ –≤ –ø–æ—Ö–æ–∂–∏–µ –¥–Ω–∏ –∏ —Å—É–º–º—ã)
          const isRegular = uniqueDays.length <= 3 && categoryTransactions.length >= 2;

          if (isRegular) {
            // –ù–∞—Ö–æ–¥–∏–º –Ω–∞–∏–±–æ–ª–µ–µ —á–∞—Å—Ç—ã–π –¥–µ–Ω—å –ø–ª–∞—Ç–µ–∂–∞
            const dayCounts = {};
            transactionDays.forEach(day => {
              dayCounts[day] = (dayCounts[day] || 0) + 1;
            });
            const mostFrequentDay = parseInt(Object.keys(dayCounts).reduce((a, b) => 
              dayCounts[a] > dayCounts[b] ? a : b
            ));

            regularPayments[category.id] = {
              category: category.name,
              icon: category.icon,
              averageAmount,
              expectedDay: mostFrequentDay,
              frequency: categoryTransactions.length,
              lastTransaction: categoryTransactions[categoryTransactions.length - 1],
              monthlyData,
              confidence: Math.min(100, (categoryTransactions.length / 3) * 100) // –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –≤ —Ä–µ–≥—É–ª—è—Ä–Ω–æ—Å—Ç–∏
            };
          }
        }
      });

      return Object.values(regularPayments).sort((a, b) => b.confidence - a.confidence);
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:', error);
      return [];
    }
  };

  // üìÖ –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
  forecastNextMonth = (transactions, categories) => {
    try {
      const regularPayments = this.analyzeRegularPayments(transactions, categories);
      const now = new Date();
      const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
      
      const forecast = {
        expectedRegular: 0,
        predictedCategories: {},
        confidence: 0
      };

      // –ü—Ä–æ–≥–Ω–æ–∑ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
      regularPayments.forEach(payment => {
        forecast.expectedRegular += payment.averageAmount;
        forecast.predictedCategories[payment.category] = {
          amount: payment.averageAmount,
          confidence: payment.confidence,
          expectedDay: payment.expectedDay
        };
      });

      // –î–æ–±–∞–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ —Å—Ä–µ–¥–Ω–∏–µ –¥–ª—è –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π
      const threeMonthsAgo = new Date();
      threeMonthsAgo.setMonth(threeMonthsAgo.getMonth() - 3);

      categories.expense.forEach(category => {
        if (!forecast.predictedCategories[category.name]) {
          const categoryTransactions = transactions
            .filter(t => t.category === category.id && t.amount < 0 && new Date(t.date) >= threeMonthsAgo)
            .map(t => Math.abs(t.amount));

          if (categoryTransactions.length > 0) {
            const average = categoryTransactions.reduce((sum, amount) => sum + amount, 0) / categoryTransactions.length;
            const confidence = Math.min(70, (categoryTransactions.length / 3) * 100); // –ú–µ–Ω—å—à–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –¥–ª—è –Ω–µ—Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö
            
            forecast.predictedCategories[category.name] = {
              amount: average,
              confidence,
              expectedDay: null
            };
          }
        }
      });

      // –û–±—â–∞—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–∞
      const totalConfidence = Object.values(forecast.predictedCategories)
        .reduce((sum, cat) => sum + cat.confidence, 0);
      forecast.confidence = Object.keys(forecast.predictedCategories).length > 0 ?
        totalConfidence / Object.keys(forecast.predictedCategories).length : 0;

      return forecast;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
      return { expectedRegular: 0, predictedCategories: {}, confidence: 0 };
    }
  };

  // üìä –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
  getCategoryAnalytics = (transactions, categories, periodMonths = 3) => {
    try {
      const cutoffDate = new Date();
      cutoffDate.setMonth(cutoffDate.getMonth() - periodMonths);

      const analytics = categories.expense.map(category => {
        const categoryTransactions = transactions
          .filter(t => t.category === category.id && t.amount < 0 && new Date(t.date) >= cutoffDate)
          .map(t => ({
            ...t,
            amount: Math.abs(t.amount),
            month: new Date(t.date).getMonth(),
            year: new Date(t.date).getFullYear()
          }));

        const total = categoryTransactions.reduce((sum, t) => sum + t.amount, 0);
        const average = categoryTransactions.length > 0 ? total / categoryTransactions.length : 0;
        const count = categoryTransactions.length;

        // –¢—Ä–µ–Ω–¥ (—Å—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –ø—Ä–µ–¥—ã–¥—É—â–∏–º –ø–µ—Ä–∏–æ–¥–æ–º)
        const currentPeriod = categoryTransactions.filter(t => {
          const tDate = new Date(t.date);
          return tDate >= new Date(cutoffDate.getFullYear(), cutoffDate.getMonth() + periodMonths/2, 1);
        }).reduce((sum, t) => sum + t.amount, 0);

        const previousPeriod = categoryTransactions.filter(t => {
          const tDate = new Date(t.date);
          return tDate < new Date(cutoffDate.getFullYear(), cutoffDate.getMonth() + periodMonths/2, 1);
        }).reduce((sum, t) => sum + t.amount, 0);

        const trend = previousPeriod > 0 ? 
          ((currentPeriod - previousPeriod) / previousPeriod) * 100 : 0;

        return {
          id: category.id,
          name: category.name,
          icon: category.icon,
          color: category.color,
          total,
          average,
          count,
          trend,
          transactions: categoryTransactions
        };
      }).filter(cat => cat.count > 0)
        .sort((a, b) => b.total - a.total);

      return analytics;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏–π:', error);
      return [];
    }
  };

  // üí° –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–º–Ω—ã—Ö —Å–æ–≤–µ—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
  generateSmartTips = (transactions, categories, debts = [], credits = []) => {
    const tips = [];
    const now = new Date();

    // –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤
    const categoryAnalytics = this.getCategoryAnalytics(transactions, categories);
    const monthlyComparison = this.compareMonths(transactions);
    
    if (monthlyComparison.length >= 2) {
      const current = monthlyComparison[monthlyComparison.length - 1];
      const previous = monthlyComparison[monthlyComparison.length - 2];

      // –°–æ–≤–µ—Ç –ø–æ —Ä–æ—Å—Ç—É —Ä–∞—Å—Ö–æ–¥–æ–≤
      if (current.expenseChange > 20) {
        tips.push({
          icon: '‚ö†Ô∏è',
          title: '–†–æ—Å—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤',
          text: `–†–∞—Å—Ö–æ–¥—ã –≤—ã—Ä–æ—Å–ª–∏ –Ω–∞ ${current.expenseChange.toFixed(1)}% –ø–æ —Å—Ä–∞–≤–Ω–µ–Ω–∏—é —Å –ø—Ä–æ—à–ª—ã–º –º–µ—Å—è—Ü–µ–º`,
          type: 'warning',
          priority: 1
        });
      }

      // –°–æ–≤–µ—Ç –ø–æ —Å–Ω–∏–∂–µ–Ω–∏—é –¥–æ—Ö–æ–¥–æ–≤
      if (current.incomeChange < -15) {
        tips.push({
          icon: 'üìâ',
          title: '–°–Ω–∏–∂–µ–Ω–∏–µ –¥–æ—Ö–æ–¥–æ–≤',
          text: `–î–æ—Ö–æ–¥—ã —Å–Ω–∏–∑–∏–ª–∏—Å—å –Ω–∞ ${Math.abs(current.incomeChange).toFixed(1)}%`,
          type: 'warning',
          priority: 1
        });
      }
    }

    // –°–æ–≤–µ—Ç –ø–æ –∫—Ä—É–ø–Ω—ã–º —Ä–∞—Å—Ö–æ–¥–∞–º
    const largeExpenses = transactions
      .filter(t => t.amount < 0 && Math.abs(t.amount) > 500)
      .slice(0, 3);

    largeExpenses.forEach(expense => {
      const category = categories.expense.find(c => c.id === expense.category);
      tips.push({
        icon: 'üí∏',
        title: '–ö—Ä—É–ø–Ω—ã–π —Ä–∞—Å—Ö–æ–¥',
        text: `${formatCurrency(Math.abs(expense.amount), false)} - ${category?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è'}`,
        type: 'info',
        priority: 2
      });
    });

    // –°–æ–≤–µ—Ç –ø–æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º
    const regularPayments = this.analyzeRegularPayments(transactions, categories);
    if (regularPayments.length > 0) {
      tips.push({
        icon: 'üîÑ',
        title: '–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏',
        text: `–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ ${regularPayments.length} —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π`,
        type: 'info',
        priority: 3
      });
    }

    // –°–æ–≤–µ—Ç –ø–æ —Ç–æ–ø –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º
    if (categoryAnalytics.length > 0) {
      const topCategory = categoryAnalytics[0];
      tips.push({
        icon: 'üéØ',
        title: '–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤',
        text: `${topCategory.name}: ${formatCurrency(topCategory.total, false)} –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞`,
        type: 'info',
        priority: 2
      });
    }

    return tips.sort((a, b) => a.priority - b.priority).slice(0, 5);
  };
}

// –°–æ–∑–¥–∞–µ–º singleton —ç–∫–∑–µ–º–ø–ª—è—Ä
const analyticsService = new AnalyticsService();
export default analyticsService;// App.js - –ü–û–õ–ù–ê–Ø –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import React, { useState, useEffect } from 'react';
import { NavigationContainer } from '@react-navigation/native';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { createStackNavigator } from '@react-navigation/stack';
import { View, Text, ActivityIndicator } from 'react-native';
import { I18nextProvider } from 'react-i18next';
import i18n from './src/i18n';
import HomeScreen from './src/screens/HomeScreen';
import AddTransactionScreen from './src/screens/AddTransactionScreen';
import ReportsScreen from './src/screens/ReportsScreen';
import AccountsScreen from './src/screens/AccountsScreen';
import TransactionsScreen from './src/screens/TransactionsScreen';
import EditTransactionScreen from './src/screens/EditTransactionScreen';
import AddAccountScreen from './src/screens/AddAccountScreen';
import EditAccountScreen from './src/screens/EditAccountScreen';
import TransferScreen from './src/screens/TransferScreen';
import DebtsScreen from './src/screens/DebtsScreen';
import AddDebtScreen from './src/screens/AddDebtScreen';
import CreditsScreen from './src/screens/CreditsScreen';
import AddCreditScreen from './src/screens/AddCreditScreen';
import BackupSettingsScreen from './src/screens/BackupSettingsScreen';
import { initDatabase } from './src/database/database';
import { DataProvider } from './src/context/DataContext';
import { GlobalStylesComponent } from './src/components/GlobalStyles';

const Tab = createBottomTabNavigator();
const Stack = createStackNavigator();

function MainTabs() {
  return (
    <Tab.Navigator
      screenOptions={{
        tabBarStyle: {
          backgroundColor: '#FFFFFF',
          borderTopWidth: 1,
          borderTopColor: '#E2E8F0',
          height: 80,
          paddingBottom: 2,
          paddingTop: 12,
        },
        tabBarLabelStyle: {
          fontSize: 12,
          fontWeight: '600',
          marginTop: 8,
          marginBottom: 4,
        },
        tabBarActiveTintColor: '#6C63FF',
        tabBarInactiveTintColor: '#64748B',
        headerShown: false,
      }}
    >
      <Tab.Screen 
        name="Home" 
        component={HomeScreen}
        options={{ 
          title: '–ì–ª–∞–≤–Ω–∞—è',
          tabBarIcon: ({ focused, color, size }) => (
            <View style={{ alignItems: 'center', justifyContent: 'center', height: 30 }}>
              <Text style={{ fontSize: 28, color, lineHeight: 28 }}>üè†</Text>
            </View>
          ),
        }} 
      />
      <Tab.Screen 
        name="Add" 
        component={AddTransactionScreen}
        options={{ 
          title: '–î–æ–±–∞–≤–∏—Ç—å',
          tabBarIcon: ({ focused, color, size }) => (
            <View style={{ alignItems: 'center', justifyContent: 'center', height: 30 }}>
              <Text style={{ fontSize: 28, color, lineHeight: 28 }}>‚ûï</Text>
            </View>
          ),
        }} 
      />
      <Tab.Screen 
        name="Transactions" 
        component={TransactionsScreen}
        options={{ 
          title: '–û–ø–µ—Ä–∞—Ü–∏–∏',
          tabBarIcon: ({ focused, color, size }) => (
            <View style={{ alignItems: 'center', justifyContent: 'center', height: 30 }}>
              <Text style={{ fontSize: 28, color, lineHeight: 28 }}>üìù</Text>
            </View>
          ),
        }} 
      />
      <Tab.Screen 
        name="Reports" 
        component={ReportsScreen}
        options={{ 
          title: '–û—Ç—á–µ—Ç—ã',
          tabBarIcon: ({ focused, color, size }) => (
            <View style={{ alignItems: 'center', justifyContent: 'center', height: 30 }}>
              <Text style={{ fontSize: 28, color, lineHeight: 28 }}>üìä</Text>
            </View>
          ),
        }} 
      />
      <Tab.Screen 
        name="Accounts" 
        component={AccountsScreen}
        options={{ 
          title: '–°—á–µ—Ç–∞',
          tabBarIcon: ({ focused, color, size }) => (
            <View style={{ alignItems: 'center', justifyContent: 'center', height: 30 }}>
              <Text style={{ fontSize: 28, color, lineHeight: 28 }}>üí≥</Text>
            </View>
          ),
        }} 
      />
    </Tab.Navigator>
  );
}

function MainStack() {
  return (
    <Stack.Navigator
      screenOptions={{
        headerStyle: {
          backgroundColor: '#6C63FF',
        },
        headerTintColor: '#FFFFFF',
        headerTitleStyle: {
          fontWeight: 'bold',
        },
      }}
    >
      <Stack.Screen 
        name="MainTabs" 
        component={MainTabs}
        options={{ headerShown: false }}
      />
      
      <Stack.Screen 
        name="BackupSettings" 
        component={BackupSettingsScreen}
        options={{ 
          title: '–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏',
          headerShown: true,
        }}
      />
      
      <Stack.Screen 
        name="EditTransaction" 
        component={EditTransactionScreen}
        options={{ title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏' }}
      />
      <Stack.Screen 
        name="AddAccount" 
        component={AddAccountScreen}
        options={{ title: '–ù–æ–≤—ã–π —Å—á–µ—Ç' }}
      />
      
      <Stack.Screen 
        name="EditAccount" 
        component={EditAccountScreen}
        options={{ title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞' }}
      />
      
      <Stack.Screen 
        name="Transfer" 
        component={TransferScreen}
        options={{ title: '–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏' }}
      />
      <Stack.Screen 
        name="Debts" 
        component={DebtsScreen}
        options={{ title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏' }}
      />
      <Stack.Screen 
        name="AddDebt" 
        component={AddDebtScreen}
        options={{ title: '–ù–æ–≤—ã–π –¥–æ–ª–≥' }}
      />
      <Stack.Screen 
        name="Credits" 
        component={CreditsScreen}
        options={{ title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞–º–∏' }}
      />
      <Stack.Screen 
        name="AddCredit" 
        component={AddCreditScreen}
        options={{ title: '–ù–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç' }}
      />
    </Stack.Navigator>
  );
}

export default function App() {
  const [dbInitialized, setDbInitialized] = useState(false);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const initializeApp = async () => {
      try {
        console.log('üöÄ –ù–∞—á–∏–Ω–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...');
        await initDatabase();
        console.log('‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞');
        setDbInitialized(true);
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏:', error);
        setDbInitialized(false);
      } finally {
        setLoading(false);
      }
    };

    initializeApp();
  }, []);

  if (loading) {
    return (
      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', backgroundColor: '#F8FAFC' }}>
        <ActivityIndicator size="large" color="#6C63FF" />
        <Text style={{ marginTop: 16, fontSize: 18, fontWeight: 'bold', color: '#6C63FF' }}>
          –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è...
        </Text>
      </View>
    );
  }

  return (
    <I18nextProvider i18n={i18n}>
      <DataProvider>
        <NavigationContainer>
          <GlobalStylesComponent />
          <MainStack />
        </NavigationContainer>
      </DataProvider>
    </I18nextProvider>
  );
}{
  "expo": {
    "name": "–°–µ–º–µ–π–Ω—ã–π –ë—é–¥–∂–µ—Ç",
    "slug": "familybudgetapp",
    "version": "1.0.0",
    "orientation": "portrait",
    "icon": "./assets/icon.png",
    "userInterfaceStyle": "light",
    "splash": {
      "image": "./assets/splash.png",
      "resizeMode": "contain",
      "backgroundColor": "#ffffff"
    },
    "assetBundlePatterns": [
      "**/*"
    ],
    "ios": {
      "supportsTablet": true,
      "bundleIdentifier": "com.yourcompany.familybudget"
    },
    "android": {
      "adaptiveIcon": {
        "foregroundImage": "./assets/adaptive-icon.png",
        "backgroundColor": "#FFFFFF"
      },
      "package": "com.yourcompany.familybudget"
    },
    "web": {
      "favicon": "./assets/favicon.png"
    },
    "extra": {
      "eas": {
        "projectId": "your-project-id"
      }
    }
  }
}// src/navigation/AppNavigator.js - –ü–†–û–°–¢–û–ô –†–ê–ë–û–ß–ò–ô –í–ê–†–ò–ê–ù–¢
import React from 'react';
import { createStackNavigator } from '@react-navigation/stack';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Text } from 'react-native';
import { colors } from '../theme/colors';

// –ò–º–ø–æ—Ä—Ç –í–°–ï–• —ç–∫—Ä–∞–Ω–æ–≤
import HomeScreen from '../screens/HomeScreen';
import TransactionsScreen from '../screens/TransactionsScreen';
import AccountsScreen from '../screens/AccountsScreen';
import AddAccountScreen from '../screens/AddAccountScreen';
import EditAccountScreen from '../screens/EditAccountScreen';
import TransferScreen from '../screens/TransferScreen';
import DebtsScreen from '../screens/DebtsScreen';
import AddDebtScreen from '../screens/AddDebtScreen';
import CreditsScreen from '../screens/CreditsScreen';
import AddCreditScreen from '../screens/AddCreditScreen';
import ReportsScreen from '../screens/ReportsScreen';
import AddTransactionScreen from '../screens/AddTransactionScreen';
import BackupSettingsScreen from '../screens/BackupSettingsScreen';

const Stack = createStackNavigator();
const Tab = createBottomTabNavigator();

// üîß –ì–õ–ê–í–ù–´–ï –¢–ê–ë–´ (–±–µ–∑ –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö —Å—Ç–µ–∫–æ–≤)
function MainTabs() {
  return (
    <Tab.Navigator
      screenOptions={{
        tabBarStyle: {
          backgroundColor: colors.surface,
          borderTopColor: colors.border,
          height: 60,
          paddingBottom: 5,
        },
        tabBarActiveTintColor: colors.primary,
        tabBarInactiveTintColor: colors.textSecondary,
        headerShown: false,
      }}
    >
      <Tab.Screen 
        name="Home" 
        component={HomeScreen}
        options={{
          title: '–ì–ª–∞–≤–Ω–∞—è',
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: 24, color }}>üè†</Text>
          ),
        }}
      />
      <Tab.Screen 
        name="Transactions" 
        component={TransactionsScreen}
        options={{
          title: '–û–ø–µ—Ä–∞—Ü–∏–∏',
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: 24, color }}>üí∞</Text>
          ),
        }}
      />
      <Tab.Screen 
        name="Add" 
        component={AddTransactionScreen}
        options={{
          title: '–î–æ–±–∞–≤–∏—Ç—å',
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: 24, color }}>‚ûï</Text>
          ),
        }}
      />
      <Tab.Screen 
        name="Reports" 
        component={ReportsScreen}
        options={{
          title: '–û—Ç—á–µ—Ç—ã',
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: 24, color }}>üìä</Text>
          ),
        }}
      />
      <Tab.Screen 
        name="Accounts" 
        component={AccountsScreen}
        options={{
          title: '–°—á–µ—Ç–∞',
          tabBarIcon: ({ color, size }) => (
            <Text style={{ fontSize: 24, color }}>üí≥</Text>
          ),
        }}
      />
    </Tab.Navigator>
  );
}

// üîß –ì–õ–ê–í–ù–´–ô –ù–ê–í–ò–ì–ê–¢–û–† - –í–°–ï –≠–ö–†–ê–ù–´ –í –û–î–ù–û–ú –°–¢–ï–ö–ï
export default function AppNavigator() {
  return (
    <Stack.Navigator
      screenOptions={{
        headerStyle: {
          backgroundColor: colors.background,
        },
        headerTintColor: colors.textPrimary,
        headerTitleStyle: {
          fontWeight: 'bold',
        },
      }}
    >
      {/* üîß –û–°–ù–û–í–ù–û–ô –≠–ö–†–ê–ù –° –¢–ê–ë–ê–ú–ò */}
      <Stack.Screen 
        name="MainTabs" 
        component={MainTabs}
        options={{ headerShown: false }}
      />
      
      {/* üîß –í–°–ï –û–°–¢–ê–õ–¨–ù–´–ï –≠–ö–†–ê–ù–´ (–¥–æ—Å—Ç—É–ø–Ω—ã –∏–∑ –ª—é–±–æ–≥–æ –º–µ—Å—Ç–∞) */}
      <Stack.Screen 
        name="AddAccount" 
        component={AddAccountScreen}
        options={{ title: '–ù–æ–≤—ã–π —Å—á–µ—Ç' }}
      />
      
      {/* üîß –ö–õ–Æ–ß–ï–í–û–ô –≠–ö–†–ê–ù - –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–ï –°–ß–ï–¢–ê */}
      <Stack.Screen 
        name="EditAccount" 
        component={EditAccountScreen}
        options={{ title: '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞' }}
      />
      
      <Stack.Screen 
        name="Transfer" 
        component={TransferScreen}
        options={{ title: '–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏' }}
      />
      <Stack.Screen 
        name="Debts" 
        component={DebtsScreen}
        options={{ title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏' }}
      />
      <Stack.Screen 
        name="AddDebt" 
        component={AddDebtScreen}
        options={{ title: '–ù–æ–≤—ã–π –¥–æ–ª–≥' }}
      />
      <Stack.Screen 
        name="Credits" 
        component={CreditsScreen}
        options={{ title: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞–º–∏' }}
      />
      <Stack.Screen 
        name="AddCredit" 
        component={AddCreditScreen}
        options={{ title: '–ù–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç' }}
      />
      <Stack.Screen 
        name="BackupSettings" 
        component={BackupSettingsScreen}
        options={{ title: '–†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏' }}
      />
    </Stack.Navigator>
  );
}import { Platform } from 'react-native';
import { formatCurrency } from '../utils/currencyFormatter';

class BackupService {
  constructor() {
    this.BACKUP_VERSION = '1.0.0';
  }

  generateBackupData = (dataContext) => {
    try {
      const timestamp = new Date().toISOString();
      const backupId = `backup_${Date.now()}`;

      const backupData = {
        metadata: {
          version: this.BACKUP_VERSION,
          backupId,
          createdAt: timestamp,
          device: this.getDeviceInfo(),
          appVersion: '1.0.0'
        },
        stats: {
          totalAccounts: dataContext.accounts?.length || 0,
          totalTransactions: dataContext.transactions?.length || 0,
          totalDebts: dataContext.debts?.length || 0,
          totalCredits: dataContext.credits?.length || 0,
          totalBalance: dataContext.getTotalBalance ? dataContext.getTotalBalance() : 0,
          currency: 'BYN'
        },
        data: {
          accounts: this.sanitizeAccounts(dataContext.accounts || []),
          transactions: this.sanitizeTransactions(dataContext.transactions || []),
          debts: this.sanitizeDebts(dataContext.debts || []),
          credits: this.sanitizeCredits(dataContext.credits || []),
          categories: dataContext.categories || {}
        }
      };

      return {
        success: true,
        data: backupData,
        filename: `family_budget_backup_${this.formatDateForFilename(timestamp)}.json`
      };

    } catch (error) {
      console.error('‚ùå Error generating backup:', error);
      return {
        success: false,
        error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é'
      };
    }
  };

  exportToJson = async (dataContext) => {
    try {
      const backupResult = this.generateBackupData(dataContext);
      
      if (!backupResult.success) {
        throw new Error(backupResult.error);
      }

      const jsonString = JSON.stringify(backupResult.data, null, 2);
      
      return {
        success: true,
        data: jsonString,
        filename: backupResult.filename,
        backupInfo: this.getBackupSummary(backupResult.data)
      };

    } catch (error) {
      console.error('‚ùå Error exporting backup:', error);
      return {
        success: false,
        error: '–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ'
      };
    }
  };

  validateBackupData = (backupData) => {
    const errors = [];
    
    try {
      const data = typeof backupData === 'string' ? JSON.parse(backupData) : backupData;

      if (!data.metadata) errors.push('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ backup');
      if (!data.data) errors.push('–û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');

      return {
        isValid: errors.length === 0,
        errors,
        warnings: []
      };

    } catch (error) {
      return {
        isValid: false,
        errors: ['–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π JSON —Ñ–æ—Ä–º–∞—Ç'],
        warnings: []
      };
    }
  };

  // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã
  getDeviceInfo = () => ({
    platform: Platform.OS || 'unknown',
    version: Platform.Version || 'unknown'
  });

  formatDateForFilename = (dateString) => {
    try {
      const date = new Date(dateString);
      return date.toISOString()
        .replace(/:/g, '-')
        .replace(/\..+/, '')
        .replace('T', '_');
    } catch (error) {
      return `backup_${Date.now()}`;
    }
  };

  getBackupSummary = (backupData) => {
    try {
      const stats = backupData.stats;
      return {
        totalAccounts: stats.totalAccounts || 0,
        totalTransactions: stats.totalTransactions || 0,
        totalDebts: stats.totalDebts || 0,
        totalCredits: stats.totalCredits || 0,
        totalBalance: formatCurrency(stats.totalBalance || 0, false),
        backupDate: new Date(backupData.metadata?.createdAt || Date.now()).toLocaleDateString('ru-RU')
      };
    } catch (error) {
      return {
        totalAccounts: 0,
        totalTransactions: 0,
        totalDebts: 0,
        totalCredits: 0,
        totalBalance: '0.00 BYN',
        backupDate: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'
      };
    }
  };

  // –ú–µ—Ç–æ–¥—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö
  sanitizeAccounts = (accounts) => {
    return accounts.map(account => ({
      id: account.id,
      name: account.name,
      balance: account.balance,
      type: account.type,
      color: account.color,
      icon: account.icon,
      createdAt: account.created_at || account.createdAt,
      isActive: account.is_active !== false && account.isActive !== false
    }));
  };

  sanitizeTransactions = (transactions) => {
    return transactions.map(transaction => ({
      id: transaction.id,
      amount: transaction.amount,
      type: transaction.type,
      category: transaction.category,
      account_id: transaction.account_id,
      description: transaction.description,
      date: transaction.date,
      created_at: transaction.created_at,
      updated_at: transaction.updated_at
    }));
  };

  sanitizeDebts = (debts) => {
    return debts.map(debt => ({
      id: debt.id,
      person: debt.person,
      amount: debt.amount,
      paidAmount: debt.paid_amount || debt.paidAmount || 0,
      type: debt.type,
      description: debt.description,
      accountId: debt.account_id || debt.accountId,
      dueDate: debt.due_date || debt.dueDate,
      createdAt: debt.created_at || debt.createdAt,
      isActive: debt.is_active !== false && debt.isActive !== false
    }));
  };

  sanitizeCredits = (credits) => {
    return credits.map(credit => ({
      id: credit.id,
      name: credit.name,
      totalAmount: credit.total_amount || credit.totalAmount,
      paidAmount: credit.paid_amount || credit.paidAmount || 0,
      monthlyPayment: credit.monthly_payment || credit.monthlyPayment,
      interestRate: credit.interest_rate || credit.interestRate,
      endDate: credit.end_date || credit.endDate,
      nextPaymentDate: credit.next_payment_date || credit.nextPaymentDate,
      accountId: credit.account_id || credit.accountId,
      createdAt: credit.created_at || credit.createdAt,
      isActive: credit.is_active !== false && credit.isActive !== false
    }));
  };
}

const backupService = new BackupService();
export default backupService;// src/screens/BackupSettingsScreen.js - –õ–û–ö–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –ë–ï–ó GOOGLE
import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  Share,
  Platform,
  ActivityIndicator
} from 'react-native';
import * as DocumentPicker from 'expo-document-picker';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';
import backupService from '../services/BackupService';

import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const BackupSettingsScreen = ({ navigation }) => {
  const { getDataStats, performFullImport, accounts, transactions, debts, credits, categories, getTotalBalance, getRecentTransactions, getTransactionsByType } = useData();
  const [isLoading, setIsLoading] = useState(false);
  const [currentAction, setCurrentAction] = useState('');

  const dataStats = getDataStats();

  // üîß –≠–ö–°–ü–û–†–¢ –î–ê–ù–ù–´–•
  const handleExportBackup = async () => {
    try {
      setIsLoading(true);
      setCurrentAction('export');

      const dataContext = {
        accounts,
        transactions,
        debts,
        credits,
        categories,
        getTotalBalance,
        getRecentTransactions,
        getTransactionsByType
      };

      const exportResult = await backupService.exportToJson(dataContext);
      
      if (!exportResult.success) {
        throw new Error(exportResult.error);
      }

      // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º Share API
      if (Platform.OS !== 'web') {
        try {
          await Share.share({
            title: '–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –°–µ–º–µ–π–Ω–æ–≥–æ –ë—é–¥–∂–µ—Ç–∞',
            message: exportResult.data,
          });
        } catch (shareError) {
          Alert.alert(
            '‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞',
            `–°–∫–æ–ø–∏—Ä—É–π—Ç–µ JSON –¥–∞–Ω–Ω—ã–µ:\n\n${exportResult.data.substring(0, 500)}...`,
            [{ text: 'OK' }]
          );
        }
      } else {
        // –î–ª—è web - —Å–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        const blob = new Blob([exportResult.data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = exportResult.filename;
        link.click();
        URL.revokeObjectURL(url);
      }

      Alert.alert(
        '‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞',
        `–§–∞–π–ª: ${exportResult.filename}\n\n${exportResult.backupInfo.totalAccounts} —Å—á–µ—Ç–æ–≤, ${exportResult.backupInfo.totalTransactions} –æ–ø–µ—Ä–∞—Ü–∏–π, ${exportResult.backupInfo.totalDebts} –¥–æ–ª–≥–æ–≤, ${exportResult.backupInfo.totalCredits} –∫—Ä–µ–¥–∏—Ç–æ–≤`,
        [{ text: '–û—Ç–ª–∏—á–Ω–æ' }]
      );

    } catch (error) {
      console.error('‚ùå Error exporting backup:', error);
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é');
    } finally {
      setIsLoading(false);
      setCurrentAction('');
    }
  };

  // üîß –ò–ú–ü–û–†–¢ –î–ê–ù–ù–´–•
  const handleImportBackup = async () => {
    try {
      Alert.alert(
        '‚ö†Ô∏è –ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö',
        '–í—Å–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã –∏–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º—ã–º–∏. –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º.',
        [
          { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
          { 
            text: '–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', 
            style: 'destructive',
            onPress: async () => {
              await performImport();
            }
          }
        ]
      );
    } catch (error) {
      console.error('‚ùå Error in import confirmation:', error);
    }
  };

  const performImport = async () => {
    try {
      setIsLoading(true);
      setCurrentAction('import');

      const result = await DocumentPicker.getDocumentAsync({
        type: 'application/json',
        copyToCacheDirectory: true,
      });

      if (result.canceled) {
        console.log('üë§ User canceled document picker');
        return;
      }

      const file = result.assets[0];
      console.log('üìÅ Selected file:', file);

      // –ß—Ç–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è)
      const { readAsStringAsync } = await import('expo-file-system');
      const content = await readAsStringAsync(file.uri);
      
      if (!content) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª');
      }

      // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –∏–º–ø–æ—Ä—Ç
      const importResult = await performFullImport(content);
      
      if (!importResult.success) {
        throw new Error(importResult.error);
      }

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏–º–ø–æ—Ä—Ç–∞
      const successfulSteps = importResult.results.filter(r => r.success);
      const failedSteps = importResult.results.filter(r => !r.success);

      let message = `‚úÖ –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω\n\n`;
      message += `–£—Å–ø–µ—à–Ω–æ: ${successfulSteps.length} —à–∞–≥–æ–≤\n`;
      
      if (failedSteps.length > 0) {
        message += `\n–û—à–∏–±–∫–∏:\n`;
        failedSteps.forEach(step => {
          message += `‚Ä¢ ${step.step}: ${step.error}\n`;
        });
      }

      message += `\n–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ:\n`;
      message += `‚Ä¢ –°—á–µ—Ç–æ–≤: ${importResult.summary.accounts}\n`;
      message += `‚Ä¢ –û–ø–µ—Ä–∞—Ü–∏–π: ${importResult.summary.transactions}\n`;
      message += `‚Ä¢ –î–æ–ª–≥–æ–≤: ${importResult.summary.debts}\n`;
      message += `‚Ä¢ –ö—Ä–µ–¥–∏—Ç–æ–≤: ${importResult.summary.credits}`;

      Alert.alert('üì• –ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω', message, [
        { text: '–û—Ç–ª–∏—á–Ω–æ', onPress: () => navigation.goBack() }
      ]);

    } catch (error) {
      if (error.code !== 'DOCUMENT_PICKER_CANCELED') {
        console.error('‚ùå Error importing backup:', error);
        Alert.alert('‚ùå –û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ');
      }
    } finally {
      setIsLoading(false);
      setCurrentAction('');
    }
  };

  // üîß –ë–´–°–¢–†–û–ï –†–ï–ó–ï–†–í–ù–û–ï –ö–û–ü–ò–†–û–í–ê–ù–ò–ï
  const handleQuickBackup = async () => {
    try {
      setIsLoading(true);
      setCurrentAction('quick_backup');

      const dataContext = {
        accounts,
        transactions,
        debts,
        credits,
        categories,
        getTotalBalance,
        getRecentTransactions,
        getTransactionsByType
      };

      const backupResult = backupService.generateBackupData(dataContext);
      
      if (!backupResult.success) {
        throw new Error(backupResult.error);
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
      const saveResult = await backupService.saveLocalBackup(backupResult.data);
      
      if (saveResult.success) {
        Alert.alert(
          'üíæ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞',
          `–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞ ${new Date().toLocaleDateString('ru-RU')}`,
          [{ text: 'OK' }]
        );
      } else {
        throw new Error(saveResult.error);
      }

    } catch (error) {
      console.error('‚ùå Error in quick backup:', error);
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∫–æ–ø–∏—é');
    } finally {
      setIsLoading(false);
      setCurrentAction('');
    }
  };

  // üîß –ö–ù–û–ü–ö–ê –î–ï–ô–°–¢–í–ò–Ø
  const ActionButton = ({ 
    title, 
    description, 
    icon, 
    onPress, 
    color = colors.primary,
    disabled = false 
  }) => (
    <TouchableOpacity
      style={[
        styles.actionButton,
        { borderLeftColor: color },
        disabled && styles.actionButtonDisabled
      ]}
      onPress={onPress}
      disabled={disabled || isLoading}
    >
      <View style={styles.actionButtonContent}>
        <Text style={styles.actionButtonIcon}>{icon}</Text>
        <View style={styles.actionButtonText}>
          <Text style={styles.actionButtonTitle}>{title}</Text>
          <Text style={styles.actionButtonDescription}>{description}</Text>
        </View>
        {isLoading && currentAction === title.toLowerCase().replace(/ /g, '_') && (
          <ActivityIndicator size="small" color={color} />
        )}
      </View>
    </TouchableOpacity>
  );

  // üîß –ö–ê–†–¢–û–ß–ö–ê –°–¢–ê–¢–ò–°–¢–ò–ö–ò
  const StatCard = ({ title, value, icon }) => (
    <View style={styles.statCard}>
      <Text style={styles.statIcon}>{icon}</Text>
      <View style={styles.statText}>
        <Text style={styles.statValue}>{value}</Text>
        <Text style={styles.statTitle}>{title}</Text>
      </View>
    </View>
  );

  return (
    <View style={styles.container}>
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏</Text>
        <Text style={styles.screenSubtitle}>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</Text>
      </View>

      <ScrollView 
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollContent}
      >
        {/* üîß –°–¢–ê–¢–ò–°–¢–ò–ö–ê –î–ê–ù–ù–´–• */}
        <View style={styles.statsSection}>
          <Text style={styles.sectionTitle}>üìä –í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</Text>
          <View style={styles.statsGrid}>
            <StatCard title="–°—á–µ—Ç–∞" value={dataStats.accounts} icon="üí≥"/>
            <StatCard title="–û–ø–µ—Ä–∞—Ü–∏–∏" value={dataStats.transactions} icon="üí∞"/>
            <StatCard title="–î–æ–ª–≥–∏" value={dataStats.debts} icon="ü§ù"/>
            <StatCard title="–ö—Ä–µ–¥–∏—Ç—ã" value={dataStats.credits} icon="üè¶"/>
          </View>
          <View style={styles.totalBalance}>
            <Text style={styles.totalBalanceLabel}>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å:</Text>
            <Text style={styles.totalBalanceValue}>
              {formatCurrency(dataStats.totalBalance, false)}
            </Text>
          </View>
        </View>

        {/* üîß –î–ï–ô–°–¢–í–ò–Ø –° BACKUP */}
        <View style={styles.actionsSection}>
          <Text style={styles.sectionTitle}>üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–ø–∏—è–º–∏</Text>
          
          <ActionButton
            title="–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"
            description="–°–æ–∑–¥–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é –≤ JSON —Ñ–∞–π–ª"
            icon="üì§"
            color="#4CAF50"
            onPress={handleExportBackup}
            disabled={isLoading}
          />

          <ActionButton
            title="–ò–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö"
            description="–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ backup —Ñ–∞–π–ª–∞"
            icon="üì•"
            color="#2196F3"
            onPress={handleImportBackup}
            disabled={isLoading}
          />

          <ActionButton
            title="–ë—ã—Å—Ç—Ä–∞—è –∫–æ–ø–∏—è"
            description="–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ø–∞–º—è—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
            icon="üíæ"
            color="#FF9800"
            onPress={handleQuickBackup}
            disabled={isLoading}
          />
        </View>

        {/* üîß –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û BACKUP */}
        <View style={styles.infoSection}>
          <Text style={styles.sectionTitle}>üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</Text>
          <View style={styles.infoCard}>
            <Text style={styles.infoText}>
              ‚Ä¢ üìÖ <Text style={styles.infoHighlight}>–†–µ–≥—É–ª—è—Ä–Ω–æ —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ backup</Text> - —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é
            </Text>
            <Text style={styles.infoText}>
              ‚Ä¢ üíæ <Text style={styles.infoHighlight}>–•—Ä–∞–Ω–∏—Ç–µ –∫–æ–ø–∏–∏ –≤ –Ω–∞–¥–µ–∂–Ω–æ–º –º–µ—Å—Ç–µ</Text> - –≤–Ω–µ—à–Ω–∏–π –¥–∏—Å–∫, –æ–±–ª–∞–∫–æ
            </Text>
            <Text style={styles.infoText}>
              ‚Ä¢ üîÑ <Text style={styles.infoHighlight}>–ü–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è</Text> - —Å–æ–∑–¥–∞–π—Ç–µ backup
            </Text>
            <Text style={styles.infoText}>
              ‚Ä¢ ‚ö†Ô∏è <Text style={styles.infoHighlight}>–ò–º–ø–æ—Ä—Ç –∑–∞–º–µ–Ω—è–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ</Text> - –±—É–¥—å—Ç–µ –æ—Å—Ç–æ—Ä–æ–∂–Ω—ã
            </Text>
          </View>
        </View>

        {/* üîß –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –•–†–ê–ù–ï–ù–ò–ò */}
        <View style={styles.infoSection}>
          <Text style={styles.sectionTitle}>üíæ –ì–¥–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –∫–æ–ø–∏–∏</Text>
          <View style={styles.infoCard}>
            <Text style={styles.infoText}>
              ‚Ä¢ üì± <Text style={styles.infoHighlight}>–ë—ã—Å—Ç—Ä–∞—è –∫–æ–ø–∏—è</Text> - –≤ –ø–∞–º—è—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (–±–µ–∑–æ–ø–∞—Å–Ω–æ)
            </Text>
            <Text style={styles.infoText}>
              ‚Ä¢ üìÅ <Text style={styles.infoHighlight}>–≠–∫—Å–ø–æ—Ä—Ç –≤ —Ñ–∞–π–ª</Text> - –≤ –ø–∞–ø–∫—É –ó–∞–≥—Ä—É–∑–∫–∏/Downloads
            </Text>
            <Text style={styles.infoText}>
              ‚Ä¢ üîÑ <Text style={styles.infoHighlight}>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è</Text> - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –æ–±–∞ –º–µ—Ç–æ–¥–∞
            </Text>
          </View>
        </View>
      </ScrollView>
    </View>
  );
};

const styles = StyleSheet.create({
  container: { ...commonStyles.screen.container },
  screenHeader: { ...commonStyles.screen.header },
  screenTitle: { ...commonStyles.screen.title },
  screenSubtitle: { ...commonStyles.screen.subtitle },
  scrollView: { flex: 1 },
  scrollContent: { paddingHorizontal: spacing.xl, paddingTop: spacing.lg, paddingBottom: spacing.xxl },
  statsSection: { marginBottom: spacing.xl },
  sectionTitle: { ...commonStyles.sections.title, marginBottom: spacing.lg },
  statsGrid: { flexDirection: 'row', flexWrap: 'wrap', gap: spacing.sm, marginBottom: spacing.lg },
  statCard: { ...commonStyles.cards.surface, flexDirection: 'row', alignItems: 'center', flex: 1, minWidth: '48%', padding: spacing.md },
  statIcon: { fontSize: 20, marginRight: spacing.sm },
  statText: { flex: 1 },
  statValue: { fontSize: 18, fontWeight: 'bold', color: colors.textPrimary, marginBottom: spacing.xs },
  statTitle: { fontSize: 12, color: colors.textSecondary, fontWeight: '500' },
  totalBalance: { ...commonStyles.cards.surface, flexDirection: 'row', justifyContent: 'space-between', alignItems: 'center', padding: spacing.lg },
  totalBalanceLabel: { fontSize: 16, color: colors.textSecondary, fontWeight: '500' },
  totalBalanceValue: { fontSize: 20, fontWeight: 'bold', color: colors.primary },
  actionsSection: { marginBottom: spacing.xl },
  actionButton: { ...commonStyles.cards.surface, marginBottom: spacing.md, borderLeftWidth: 4 },
  actionButtonDisabled: { opacity: 0.5 },
  actionButtonContent: { flexDirection: 'row', alignItems: 'center', padding: spacing.lg },
  actionButtonIcon: { fontSize: 24, marginRight: spacing.md },
  actionButtonText: { flex: 1 },
  actionButtonTitle: { fontSize: 16, fontWeight: 'bold', color: colors.textPrimary, marginBottom: spacing.xs },
  actionButtonDescription: { fontSize: 14, color: colors.textSecondary, lineHeight: 18 },
  infoSection: { marginBottom: spacing.xl },
  infoCard: { ...commonStyles.cards.surface, padding: spacing.lg },
  infoText: { fontSize: 14, color: colors.textSecondary, lineHeight: 20, marginBottom: spacing.sm },
  infoHighlight: { color: colors.primary, fontWeight: '600' },
});

export default BackupSettingsScreen;import React, { useState } from 'react';
import { View, Text, TouchableOpacity, Modal, StyleSheet } from 'react-native';
import { colors } from '../theme/colors';

const CalendarModal = ({ visible, onClose, onDateSelect, selectedDate }) => {
  const [currentDate, setCurrentDate] = useState(selectedDate ? new Date(selectedDate) : new Date());
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–Ω–µ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—è
  const getCalendarDays = () => {
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    // –ü–æ–ª—É—á–∞–µ–º –¥–µ–Ω—å –Ω–µ–¥–µ–ª–∏ –ø–µ—Ä–≤–æ–≥–æ –¥–Ω—è (0 - –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 1 - –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, –∏ —Ç.–¥.)
    const firstDayOfWeek = firstDay.getDay();
    
    // –ö–û–†–†–ï–ö–¢–ù–´–ô –†–ê–°–ß–ï–¢: –î–ª—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è, –Ω–∞—á–∏–Ω–∞—é—â–µ–≥–æ—Å—è —Å –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫–∞
    // –ï—Å–ª–∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (0), —Ç–æ –Ω—É–∂–Ω–æ 6 –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫ –ø–µ—Ä–µ–¥ –Ω–∏–º
    // –ï—Å–ª–∏ –ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ (1), —Ç–æ 0 –ø—É—Å—Ç—ã—Ö —è—á–µ–µ–∫, –∏ —Ç.–¥.
    const startEmptyCells = firstDayOfWeek === 0 ? 6 : firstDayOfWeek - 1;
    
    const daysInMonth = lastDay.getDate();
    const days = [];
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ø—É—Å—Ç—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è –Ω–∞—á–∞–ª–∞ –º–µ—Å—è—Ü–∞
    for (let i = 0; i < startEmptyCells; i++) {
      days.push(null);
    }
    
    // –î–æ–±–∞–≤–ª—è–µ–º –¥–Ω–∏ –º–µ—Å—è—Ü–∞
    for (let day = 1; day <= daysInMonth; day++) {
      days.push(day);
    }
    
    return days;
  };
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ —Ä–∞–∑–±–∏–µ–Ω–∏–µ –Ω–∞ –Ω–µ–¥–µ–ª–∏
  const renderCalendar = () => {
    const days = getCalendarDays();
    const weekDays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å'];
    
    // –ü–†–ê–í–ò–õ–¨–ù–û–ï –†–ê–ó–ë–ò–ï–ù–ò–ï: –°–æ–∑–¥–∞–µ–º –Ω–µ–¥–µ–ª–∏ –ø–æ 7 –¥–Ω–µ–π
    const weeks = [];
    for (let i = 0; i < days.length; i += 7) {
      const week = days.slice(i, i + 7);
      // –£–ë–ò–†–ê–ï–ú –ü–£–°–¢–´–ï –Ø–ß–ï–ô–ö–ò –í –ö–û–ù–¶–ï: –µ—Å–ª–∏ –ø–æ—Å–ª–µ–¥–Ω—è—è –Ω–µ–¥–µ–ª—è —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ null –≤ –∫–æ–Ω—Ü–µ
      const lastWeekIndex = Math.floor(days.length / 7);
      if (i >= lastWeekIndex * 7) {
        // –î–ª—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ —É–±–∏—Ä–∞–µ–º trailing null —è—á–µ–π–∫–∏
        let trimmedWeek = [...week];
        while (trimmedWeek.length > 0 && trimmedWeek[trimmedWeek.length - 1] === null) {
          trimmedWeek.pop();
        }
        if (trimmedWeek.length > 0) {
          weeks.push(trimmedWeek);
        }
      } else {
        weeks.push(week);
      }
    }
    
    return (
      <View style={styles.calendarGrid}>
        {/* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–Ω–µ–π –Ω–µ–¥–µ–ª–∏ */}
        <View style={styles.calendarWeekDays}>
          {weekDays.map((day, index) => (
            <Text 
              key={day} 
              style={[
                styles.calendarWeekDay,
                index >= 5 && styles.calendarWeekDayWeekend
              ]}
            >
              {day}
            </Text>
          ))}
        </View>
        
        {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–µ–¥–µ–ª—å */}
        {weeks.map((week, weekIndex) => (
          <View key={`week-${weekIndex}`} style={styles.calendarWeek}>
            {week.map((day, dayIndex) => {
              const globalIndex = weekIndex * 7 + dayIndex;
              
              if (day === null) {
                return (
                  <View 
                    key={`empty-${globalIndex}`} 
                    style={styles.calendarDayEmpty} 
                  />
                );
              }
              
              const date = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
              const isToday = isSameDay(date, new Date());
              const isSelected = selectedDate && isSameDay(date, new Date(selectedDate));
              const dayOfWeek = date.getDay();
              const isWeekend = dayOfWeek === 0 || dayOfWeek === 6;
              const isPast = date < new Date().setHours(0, 0, 0, 0);
              
              return (
                <TouchableOpacity
                  key={`day-${day}-${globalIndex}`}
                  style={[
                    styles.calendarDay,
                    isToday && styles.calendarDayToday,
                    isSelected && styles.calendarDaySelected,
                    isWeekend && styles.calendarDayWeekend,
                    isPast && styles.calendarDayPast
                  ]}
                  onPress={() => !isPast && handleDateSelect(date)}
                  disabled={isPast}
                >
                  <Text style={[
                    styles.calendarDayText,
                    isToday && styles.calendarDayTextToday,
                    isSelected && styles.calendarDayTextSelected,
                    isWeekend && !isSelected && styles.calendarDayTextWeekend,
                    isPast && styles.calendarDayTextPast
                  ]}>
                    {day}
                  </Text>
                  {isToday && !isSelected && <View style={styles.todayDot} />}
                </TouchableOpacity>
              );
            })}
            
            {/* –î–û–ë–ê–í–õ–Ø–ï–ú –ü–£–°–¢–´–ï –Ø–ß–ï–ô–ö–ò –î–õ–Ø –í–´–†–ê–í–ù–ò–í–ê–ù–ò–Ø –¢–û–õ–¨–ö–û –í –ö–û–ù–¶–ï –°–¢–†–û–ö–ò */}
            {week.length < 7 && Array.from({ length: 7 - week.length }).map((_, index) => (
              <View 
                key={`trailing-empty-${weekIndex}-${index}`} 
                style={styles.calendarDayEmpty} 
              />
            ))}
          </View>
        ))}
      </View>
    );
  };
  
  const isSameDay = (date1, date2) => {
    const d1 = new Date(date1);
    const d2 = new Date(date2);
    d1.setHours(0, 0, 0, 0);
    d2.setHours(0, 0, 0, 0);
    return d1.getTime() === d2.getTime();
  };
  
  const handleDateSelect = (date) => {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    const dateString = `${year}-${month}-${day}`;
    
    onDateSelect(dateString);
    onClose();
  };
  
  const changeMonth = (direction) => {
    const newDate = new Date(currentDate);
    newDate.setMonth(currentDate.getMonth() + direction);
    setCurrentDate(newDate);
  };
  
  const getMonthYearText = () => {
    return currentDate.toLocaleDateString('ru-RU', { 
      month: 'long', 
      year: 'numeric' 
    });
  };

  // –£–õ–£–ß–®–ï–ù–ò–ï: –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –¥–∞—Ç—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –≤—ã–±–æ—Ä–∞
  const getQuickDateInfo = (daysToAdd) => {
    const targetDate = new Date();
    targetDate.setDate(targetDate.getDate() + daysToAdd);
    return targetDate.toLocaleDateString('ru-RU', { 
      day: 'numeric', 
      month: 'short' 
    });
  };

  const handleOneWeek = () => {
    const today = new Date();
    const targetDate = new Date(today);
    targetDate.setDate(today.getDate() + 7);
    handleDateSelect(targetDate);
  };

  const handleTwoWeeks = () => {
    const today = new Date();
    const targetDate = new Date(today);
    targetDate.setDate(today.getDate() + 14);
    handleDateSelect(targetDate);
  };

  const handleOneMonth = () => {
    const today = new Date();
    const targetDate = new Date(today);
    targetDate.setMonth(today.getMonth() + 1);
    handleDateSelect(targetDate);
  };

  return (
    <Modal
      visible={visible}
      animationType="fade"
      transparent={true}
      onRequestClose={onClose}
    >
      <View style={styles.calendarModal}>
        <View style={styles.calendarContainer}>
          {/* –£–õ–£–ß–®–ï–ù–ù–´–ô –ó–ê–ì–û–õ–û–í–û–ö */}
          <View style={styles.calendarHeader}>
            <TouchableOpacity 
              onPress={() => changeMonth(-1)}
              style={styles.calendarNavButton}
            >
              <Text style={styles.calendarNavText}>‚Äπ</Text>
            </TouchableOpacity>
            
            <View style={styles.calendarTitleContainer}>
              <Text style={styles.calendarTitle}>
                {getMonthYearText()}
              </Text>
              <Text style={styles.calendarSubtitle}>–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –≤–æ–∑–≤—Ä–∞—Ç–∞</Text>
            </View>
            
            <TouchableOpacity 
              onPress={() => changeMonth(1)}
              style={styles.calendarNavButton}
            >
              <Text style={styles.calendarNavText}>‚Ä∫</Text>
            </TouchableOpacity>
          </View>
          
          {/* –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–ï–¢–ö–ê –ö–ê–õ–ï–ù–î–ê–†–Ø */}
          {renderCalendar()}
          
          {/* –£–õ–£–ß–®–ï–ù–ù–´–ï –ë–´–°–¢–†–´–ï –ö–ù–û–ü–ö–ò –° –ê–ö–¢–£–ê–õ–¨–ù–´–ú–ò –î–ê–¢–ê–ú–ò */}
          <View style={styles.quickDateSection}>
            <Text style={styles.quickDateLabel}>üìÖ –ë—ã—Å—Ç—Ä—ã–π –≤—ã–±–æ—Ä:</Text>
            <View style={styles.quickDateButtons}>
              <TouchableOpacity 
                style={styles.quickDateButton}
                onPress={handleOneWeek}
              >
                <Text style={styles.quickDateText}>–ß–µ—Ä–µ–∑ –Ω–µ–¥–µ–ª—é</Text>
                <Text style={styles.quickDateHint}>{getQuickDateInfo(7)}</Text>
              </TouchableOpacity>
              
              <TouchableOpacity 
                style={styles.quickDateButton}
                onPress={handleTwoWeeks}
              >
                <Text style={styles.quickDateText}>–ß–µ—Ä–µ–∑ 2 –Ω–µ–¥–µ–ª–∏</Text>
                <Text style={styles.quickDateHint}>{getQuickDateInfo(14)}</Text>
              </TouchableOpacity>
              
              <TouchableOpacity 
                style={styles.quickDateButton}
                onPress={handleOneMonth}
              >
                <Text style={styles.quickDateText}>–ß–µ—Ä–µ–∑ –º–µ—Å—è—Ü</Text>
                <Text style={styles.quickDateHint}>{getQuickDateInfo(30)}</Text>
              </TouchableOpacity>
            </View>
          </View>
          
          {/* –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ö–ù–û–ü–ö–ê –ó–ê–ö–†–´–¢–ò–Ø */}
          <TouchableOpacity 
            style={styles.closeButton}
            onPress={onClose}
          >
            <Text style={styles.closeButtonText}>‚úï –ó–∞–∫—Ä—ã—Ç—å</Text>
          </TouchableOpacity>
        </View>
      </View>
    </Modal>
  );
};

const styles = StyleSheet.create({
  calendarModal: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.6)',
    padding: 20,
  },
  calendarContainer: {
    backgroundColor: colors.surface,
    borderRadius: 24,
    padding: 24,
    width: '100%',
    maxWidth: 400,
    elevation: 20,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 12 },
    shadowOpacity: 0.25,
    shadowRadius: 24,
  },
  calendarHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: 20,
    paddingBottom: 16,
    borderBottomWidth: 1,
    borderBottomColor: colors.background + '80',
  },
  calendarNavButton: {
    paddingHorizontal: 16,
    paddingVertical: 10,
    borderRadius: 12,
    backgroundColor: colors.primary + '15',
    minWidth: 44,
    alignItems: 'center',
  },
  calendarNavText: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.primary,
    marginTop: -2,
  },
  calendarTitleContainer: {
    alignItems: 'center',
    flex: 1,
  },
  calendarTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  calendarSubtitle: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  calendarGrid: {
    marginBottom: 20,
  },
  calendarWeekDays: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginBottom: 16,
    paddingBottom: 12,
    borderBottomWidth: 1,
    borderBottomColor: colors.background + '60',
  },
  calendarWeekDay: {
    fontSize: 13,
    fontWeight: '700',
    color: colors.textSecondary,
    width: 34,
    textAlign: 'center',
  },
  calendarWeekDayWeekend: {
    color: colors.primary,
  },
  calendarWeek: {
    flexDirection: 'row',
    justifyContent: 'space-around',
    marginBottom: 6,
  },
  calendarDayEmpty: {
    width: 34,
    height: 34,
    margin: 2,
  },
  calendarDay: {
    width: 34,
    height: 34,
    borderRadius: 17,
    justifyContent: 'center',
    alignItems: 'center',
    margin: 2,
    backgroundColor: colors.background,
    position: 'relative',
  },
  calendarDayToday: {
    backgroundColor: colors.primary + '15',
    borderColor: colors.primary,
    borderWidth: 1.5,
  },
  calendarDaySelected: {
    backgroundColor: colors.primary,
    transform: [{ scale: 1.1 }],
  },
  calendarDayWeekend: {
    backgroundColor: colors.primary + '08',
  },
  calendarDayPast: {
    opacity: 0.4,
  },
  calendarDayText: {
    fontSize: 14,
    color: colors.textPrimary,
    fontWeight: '600',
  },
  calendarDayTextToday: {
    color: colors.primary,
    fontWeight: 'bold',
  },
  calendarDayTextSelected: {
    color: colors.white,
    fontWeight: 'bold',
  },
  calendarDayTextWeekend: {
    color: colors.primary,
  },
  calendarDayTextPast: {
    color: colors.textSecondary,
  },
  todayDot: {
    position: 'absolute',
    bottom: 2,
    width: 4,
    height: 4,
    borderRadius: 2,
    backgroundColor: colors.primary,
  },
  quickDateSection: {
    marginBottom: 20,
    backgroundColor: colors.background + '80',
    borderRadius: 16,
    padding: 16,
    borderLeftWidth: 4,
    borderLeftColor: colors.primary,
  },
  quickDateLabel: {
    fontSize: 14,
    fontWeight: '700',
    color: colors.textPrimary,
    marginBottom: 12,
    textAlign: 'center',
  },
  quickDateButtons: {
    gap: 10,
  },
  quickDateButton: {
    backgroundColor: colors.surface,
    paddingVertical: 12,
    paddingHorizontal: 16,
    borderRadius: 12,
    borderWidth: 1,
    borderColor: colors.primary + '20',
    alignItems: 'center',
    elevation: 2,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.05,
    shadowRadius: 4,
  },
  quickDateText: {
    fontSize: 14,
    color: colors.primary,
    fontWeight: '700',
    marginBottom: 2,
  },
  quickDateHint: {
    fontSize: 11,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  closeButton: {
    backgroundColor: colors.textSecondary,
    paddingVertical: 14,
    borderRadius: 14,
    alignItems: 'center',
    elevation: 4,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
  },
  closeButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: '700',
  },
});

export default CalendarModal;class CloudSyncService {
  constructor() {
    this.isConfigured = false;
    this.user = null;
  }

  getSyncStatus = () => {
    return {
      isSignedIn: false,
      userEmail: '',
      lastSync: '–ù–∏–∫–æ–≥–¥–∞',
      enabled: false,
      message: '–û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ç–∫–ª—é—á–µ–Ω–∞'
    };
  };

  signInWithGoogle = async () => {
    return {
      success: false,
      error: '–§—É–Ω–∫—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞',
      message: 'Google Drive —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ'
    };
  };

  signOut = async () => {
    return {
      success: true,
      message: '–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞'
    };
  };

  uploadToGoogleDrive = async (backupData, filename) => {
    return {
      success: false,
      error: '–§—É–Ω–∫—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞',
      message: '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç'
    };
  };

  downloadFromGoogleDrive = async (fileId) => {
    return {
      success: false,
      error: '–§—É–Ω–∫—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞'
    };
  };

  getCloudBackupHistory = async () => {
    return {
      success: true,
      files: []
    };
  };

  isCloudSyncAvailable = () => {
    return {
      available: false,
      provider: 'Google Drive',
      mode: 'offline',
      message: '–û–±–ª–∞—á–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–∞'
    };
  };
}

const cloudSyncService = new CloudSyncService();
export default cloudSyncService;// src/theme/colors.js

// üîß –£–ë–ò–†–ê–ï–ú –î–£–ë–õ–ò–†–£–Æ–©–ò–ô–°–Ø –≠–ö–°–ü–û–†–¢ –í –ö–û–ù–¶–ï

export const colors = {
  // –Ø—Ä–∫–∏–µ, –Ω–æ –º—è–≥–∫–∏–µ —Ü–≤–µ—Ç–∞
  primary: '#6C63FF',     // –Ø—Ä–∫–∏–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π
  secondary: '#FF6584',   // –Ø—Ä–∫–∏–π —Ä–æ–∑–æ–≤—ã–π
  accent: '#36D1DC',      // –ì–æ–ª—É–±–æ–π
  success: '#4CAF50',     // –ó–µ–ª–µ–Ω—ã–π
  warning: '#FF9800',     // –û—Ä–∞–Ω–∂–µ–≤—ã–π
  error: '#F44336',       // –ö—Ä–∞—Å–Ω—ã–π
  info: '#2196F3',        // –°–∏–Ω–∏–π
  
  // –ù–æ–≤—ã–µ —è—Ä–∫–∏–µ —Ü–≤–µ—Ç–∞
  purple: '#9C27B0',      // –ü—É—Ä–ø—É—Ä–Ω—ã–π
  teal: '#009688',        // –ë–∏—Ä—é–∑–æ–≤—ã–π
  amber: '#FFC107',       // –Ø–Ω—Ç–∞—Ä–Ω—ã–π
  indigo: '#3F51B5',      // –ò–Ω–¥–∏–≥–æ
  brown: '#795548',       // –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π
  blueGrey: '#607D8B',    // –°–µ—Ä–æ-–≥–æ–ª—É–±–æ–π
  lightGreen: '#8BC34A',  // –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
  
  // –ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–µ —Ü–≤–µ—Ç–∞
  white: '#FFFFFF',
  background: '#F8FAFC',  // –°–≤–µ—Ç–ª—ã–π —Ñ–æ–Ω
  surface: '#FFFFFF',     // –ë–µ–ª—ã–π –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
  textPrimary: '#1E293B', // –¢–µ–º–Ω–æ-—Å–∏–Ω–∏–π –¥–ª—è —Ç–µ–∫—Å—Ç–∞
  textSecondary: '#64748B', // –°–µ—Ä—ã–π –¥–ª—è –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–≥–æ
  border: '#E2E8F0',      // –°–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π
  
  // –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã
  gradientPrimary: ['#6C63FF', '#36D1DC'],
  gradientSuccess: ['#4CAF50', '#8BC34A'],
  gradientWarning: ['#FF9800', '#FFC107'],
};

export const categoryColors = {
  salary: '#4CAF50',          // –ó–µ–ª–µ–Ω—ã–π
  freelance: '#2196F3',       // –°–∏–Ω–∏–π
  gifts: '#9C27B0',           // –ü—É—Ä–ø—É—Ä–Ω—ã–π
  investments: '#009688',     // –ë–∏—Ä—é–∑–æ–≤—ã–π
  debt_return: '#8BC34A',     // –°–≤–µ—Ç–ª–æ-–∑–µ–ª–µ–Ω—ã–π
  groceries: '#FF9800',       // –û—Ä–∞–Ω–∂–µ–≤—ã–π
  dining: '#FF6584',          // –†–æ–∑–æ–≤—ã–π
  transport: '#6C63FF',       // –§–∏–æ–ª–µ—Ç–æ–≤—ã–π
  utilities: '#36D1DC',       // –ì–æ–ª—É–±–æ–π
  rent: '#3F51B5',            // –ò–Ω–¥–∏–≥–æ
  clothing: '#E91E63',        // –ú–∞–ª–∏–Ω–æ–≤—ã–π
  entertainment: '#FFC107',   // –Ø–Ω—Ç–∞—Ä–Ω—ã–π
  health: '#00BCD4',          // –ì–æ–ª—É–±–æ–π
  alcohol: '#F44336',         // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –∞–ª–∫–æ–≥–æ–ª—è
  debt_given: '#795548',      // –ö–æ—Ä–∏—á–Ω–µ–≤—ã–π –¥–ª—è –≤—ã–¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–≥–æ–≤
  credit_payment: '#607D8B',  // –°–µ—Ä–æ-–≥–æ–ª—É–±–æ–π –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫—Ä–µ–¥–∏—Ç—É
};

export const categoryIcons = {
  salary: 'üí∞',
  freelance: 'üíª',
  gifts: 'üéÅ',
  investments: 'üìà',
  debt_return: '‚Ü©Ô∏è',
  groceries: 'üõí',
  dining: 'üçΩÔ∏è',
  transport: 'üöó',
  utilities: 'üè†',
  rent: 'üè°',
  clothing: 'üëï',
  entertainment: 'üé¨',
  health: 'üè•',
  alcohol: 'üç∑',
  debt_given: 'ü§ù',     // –ò–ó–ú–ï–ù–ï–ù–û: –Ω–æ–≤–∞—è –∏–∫–æ–Ω–∫–∞
  credit_payment: 'üè¶',
};

// üîß –£–ë–ò–†–ê–ï–ú –≠–¢–£ –°–¢–†–û–ö–£ - –æ–Ω–∞ —Å–æ–∑–¥–∞–µ—Ç –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ!
// export { colors, categoryColors, categoryIcons };import React, { useState, useRef, useEffect } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  RefreshControl,
  Animated,
  Easing,
  StatusBar,
  Platform,
  Modal,
  Share
} from 'react-native';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';
import PaymentModal from '../components/PaymentModal';

// üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const STATUS_BAR_HEIGHT = Platform.OS === 'ios' ? 44 : StatusBar.currentHeight;

const CreditsScreen = ({ navigation }) => {
  const { credits, accounts, deleteCredit, makeCreditPayment } = useData();
  const [refreshing, setRefreshing] = useState(false);
  const [paymentModalVisible, setPaymentModalVisible] = useState(false);
  const [reminderModalVisible, setReminderModalVisible] = useState(false);
  const [selectedCredit, setSelectedCredit] = useState(null);
  const fadeAnim = useRef(new Animated.Value(0)).current;

  const [reminderSettings, setReminderSettings] = useState({
    daysBefore: [7, 3, 1],
    enabled: true,
  });

  useEffect(() => {
    Animated.timing(fadeAnim, {
      toValue: 1,
      duration: 600,
      easing: Easing.out(Easing.cubic),
      useNativeDriver: true,
    }).start();
  }, []);

  const onRefresh = () => {
    setRefreshing(true);
    setTimeout(() => setRefreshing(false), 1000);
  };

  const exportCreditsData = async () => {
    try {
      const totalDebt = credits.reduce((sum, credit) => sum + (credit.totalAmount - credit.paidAmount), 0);
      const totalPaid = credits.reduce((sum, credit) => sum + credit.paidAmount, 0);
      const activeCredits = credits.filter(credit => credit.isActive).length;
      const paidCredits = credits.filter(credit => !credit.isActive).length;

      let report = `üí≥ –û–¢–ß–ï–¢ –ü–û –ö–†–ï–î–ò–¢–ê–ú\n`;
      report += `–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleDateString('ru-RU')}\n`;
      report += `–û–±—â–∏–π –¥–æ–ª–≥: ${formatCurrency(totalDebt, false)}\n`;
      report += `–í—ã–ø–ª–∞—á–µ–Ω–æ: ${formatCurrency(totalPaid, false)}\n`;
      report += `–ê–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤: ${activeCredits}\n`;
      report += `–ü–æ–≥–∞—à–µ–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤: ${paidCredits}\n\n`;
      
      report += `üìã –î–ï–¢–ê–õ–ò –ö–†–ï–î–ò–¢–û–í:\n`;
      report += `====================\n`;
      
      credits.forEach((credit, index) => {
        const progress = (credit.paidAmount / credit.totalAmount) * 100;
        const remainingAmount = credit.totalAmount - credit.paidAmount;
        const nextPayment = new Date(credit.nextPaymentDate);
        const account = accounts.find(acc => acc.id === credit.accountId);
        
        report += `\n${index + 1}. ${credit.name}\n`;
        report += `   üí∞ –û–±—â–∞—è —Å—É–º–º–∞: ${formatCurrency(credit.totalAmount, false)}\n`;
        report += `   üìà –í—ã–ø–ª–∞—á–µ–Ω–æ: ${formatCurrency(credit.paidAmount, false)} (${Math.round(progress)}%)\n`;
        report += `   üìä –û—Å—Ç–∞—Ç–æ–∫: ${formatCurrency(remainingAmount, false)}\n`;
        report += `   üóìÔ∏è –°–ª–µ–¥. –ø–ª–∞—Ç–µ–∂: ${nextPayment.toLocaleDateString('ru-RU')}\n`;
        report += `   üí∏ –ï–∂–µ–º–µ—Å. –ø–ª–∞—Ç–µ–∂: ${formatCurrency(credit.monthlyPayment, false)}\n`;
        report += `   üìà –ü—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞: ${credit.interestRate}%\n`;
        report += `   üè¶ –°—á–µ—Ç: ${account?.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}\n`;
        report += `   üìä –°—Ç–∞—Ç—É—Å: ${credit.isActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ü–æ–≥–∞—à–µ–Ω'}\n`;
      });

      Alert.alert(
        'üìÑ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö',
        '–û—Ç—á–µ—Ç –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω! –•–æ—Ç–∏—Ç–µ –ø–æ–¥–µ–ª–∏—Ç—å—Å—è –∏–º?',
        [
          { 
            text: '–ü–æ–¥–µ–ª–∏—Ç—å—Å—è', 
            onPress: () => shareReport(report) 
          },
          { 
            text: '–ü–æ–∫–∞–∑–∞—Ç—å', 
            onPress: () => showReport(report) 
          },
          { 
            text: 'OK', 
            style: 'cancel' 
          }
        ]
      );

    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞:', error);
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç');
    }
  };

  const shareReport = async (report) => {
    try {
      await Share.share({
        message: report,
        title: '–û—Ç—á–µ—Ç –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º'
      });
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—éÂàÜ‰∫´:', error);
      showReport(report);
    }
  };

  const showReport = (report) => {
    const maxLength = 2000;
    if (report.length > maxLength) {
      const part1 = report.substring(0, maxLength);
      const part2 = report.substring(maxLength);
      
      Alert.alert(
        'üìÑ –û—Ç—á–µ—Ç –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º (–ß–∞—Å—Ç—å 1/2)',
        part1,
        [{ 
          text: '–î–∞–ª–µ–µ', 
          onPress: () => Alert.alert('üìÑ –û—Ç—á–µ—Ç –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º (–ß–∞—Å—Ç—å 2/2)', part2, [{ text: 'OK' }])
        }]
      );
    } else {
      Alert.alert('üìÑ –û—Ç—á–µ—Ç –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º', report, [{ text: 'OK' }]);
    }
  };

  const toggleReminder = (day) => {
    setReminderSettings(prev => {
      const newDays = prev.daysBefore.includes(day)
        ? prev.daysBefore.filter(d => d !== day)
        : [...prev.daysBefore, day].sort((a, b) => a - b);
      
      return { ...prev, daysBefore: newDays };
    });
  };

  const saveReminderSettings = () => {
    const daysText = reminderSettings.daysBefore.length === 0 
      ? '–æ—Ç–∫–ª—é—á–µ–Ω—ã' 
      : `–∑–∞: ${reminderSettings.daysBefore.join(', ')} –¥–Ω–µ–π`;
    
    Alert.alert(
      '‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 
      `–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö ${daysText}`,
      [{ text: '–û—Ç–ª–∏—á–Ω–æ' }]
    );
    setReminderModalVisible(false);
  };

  const openPaymentModal = (credit) => {
    setSelectedCredit(credit);
    setPaymentModalVisible(true);
  };

  const closePaymentModal = () => {
    setPaymentModalVisible(false);
    setTimeout(() => {
      setSelectedCredit(null);
    }, 300);
  };

  const handleDeleteCredit = (credit) => {
    Alert.alert(
      'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –∫—Ä–µ–¥–∏—Ç?',
      `–ö—Ä–µ–¥–∏—Ç "${credit.name}" –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`,
      [
        { 
          text: '–û—Ç–º–µ–Ω–∞', 
          style: 'cancel' 
        },
        { 
          text: '–£–¥–∞–ª–∏—Ç—å', 
          style: 'destructive',
          onPress: () => {
            deleteCredit(credit.id);
            Alert.alert('‚úÖ –£–¥–∞–ª–µ–Ω–æ', `–ö—Ä–µ–¥–∏—Ç "${credit.name}" —É–¥–∞–ª–µ–Ω`);
          }
        }
      ]
    );
  };

  const CreditCard = ({ credit, index }) => {
    let nextPaymentDate;
    let daysUntilPayment = 0;
    
    try {
      nextPaymentDate = new Date(credit.nextPaymentDate);
      if (isNaN(nextPaymentDate.getTime())) {
        nextPaymentDate = new Date();
        nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
      }
      const today = new Date();
      daysUntilPayment = Math.ceil((nextPaymentDate - today) / (1000 * 60 * 60 * 24));
    } catch (error) {
      nextPaymentDate = new Date();
      nextPaymentDate.setMonth(nextPaymentDate.getMonth() + 1);
      daysUntilPayment = 30;
    }

    const progress = (credit.paidAmount / credit.totalAmount) * 100;
    const remainingAmount = credit.totalAmount - credit.paidAmount;
    const monthsRemaining = Math.ceil(remainingAmount / credit.monthlyPayment);
    
    const cardAnim = useRef(new Animated.Value(0)).current;

    useEffect(() => {
      Animated.sequence([
        Animated.delay(index * 100),
        Animated.timing(cardAnim, {
          toValue: 1,
          duration: 400,
          easing: Easing.out(Easing.cubic),
          useNativeDriver: true,
        })
      ]).start();
    }, []);

    const getStatusConfig = () => {
      if (progress >= 100) return { 
        color: colors.success, 
        text: '–ü–æ–≥–∞—à–µ–Ω üéâ', 
        emoji: 'üéâ',
        badgeStyle: styles.statusBadgeSuccess
      };
      if (daysUntilPayment <= 0) return { 
        color: colors.error, 
        text: '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω ‚ö†Ô∏è', 
        emoji: '‚ö†Ô∏è',
        badgeStyle: styles.statusBadgeError
      };
      if (daysUntilPayment <= 3) return { 
        color: colors.error, 
        text: `–ß–µ—Ä–µ–∑ ${daysUntilPayment} –¥–Ω.`, 
        emoji: 'üî¥',
        badgeStyle: styles.statusBadgeWarning
      };
      if (daysUntilPayment <= 7) return { 
        color: colors.warning, 
        text: `–ß–µ—Ä–µ–∑ ${daysUntilPayment} –¥–Ω.`, 
        emoji: 'üü°',
        badgeStyle: styles.statusBadgeWarning
      };
      if (daysUntilPayment <= 30) return { 
        color: colors.info, 
        text: `–ß–µ—Ä–µ–∑ ${daysUntilPayment} –¥–Ω.`, 
        emoji: 'üîµ',
        badgeStyle: styles.statusBadgeInfo
      };
      return { 
        color: colors.primary, 
        text: `–ü–ª–∞—Ç–µ–∂: ${nextPaymentDate.toLocaleDateString('ru-RU')}`, 
        emoji: 'üìÖ',
        badgeStyle: styles.statusBadgeNormal
      };
    };

    const status = getStatusConfig();

    return (
      <Animated.View 
        style={[
          styles.creditCard,
          {
            opacity: cardAnim,
            transform: [{
              translateY: cardAnim.interpolate({
                inputRange: [0, 1],
                outputRange: [50, 0]
              })
            }]
          }
        ]}
      >
        <View style={styles.creditHeader}>
          <View style={styles.creditTitleContainer}>
            <Text style={styles.creditName}>{credit.name}</Text>
            <View style={styles.interestBadge}>
              <Text style={styles.interestText}>üìà {credit.interestRate}% –≥–æ–¥–æ–≤—ã—Ö</Text>
            </View>
          </View>
          <View style={[styles.statusBadge, status.badgeStyle]}>
            <Text style={styles.statusEmoji}>{status.emoji}</Text>
            <Text style={[styles.statusText, { color: status.color }]}>
              {status.text}
            </Text>
          </View>
        </View>

        <View style={styles.progressSection}>
          <View style={styles.progressLabels}>
            <Text style={styles.progressLabel}>
              üí∞ –í—ã–ø–ª–∞—á–µ–Ω–æ: {formatCurrency(credit.paidAmount, false)}
            </Text>
            <Text style={styles.progressLabel}>
              üìä –û—Å—Ç–∞–ª–æ—Å—å: {formatCurrency(remainingAmount, false)}
            </Text>
          </View>
          <View style={styles.progressBar}>
            <View 
              style={[
                styles.progressFill, 
                { 
                  width: `${Math.min(progress, 100)}%`,
                  backgroundColor: status.color
                }
              ]} 
            />
          </View>
          <View style={styles.progressInfo}>
            <Text style={styles.progressPercent}>{Math.round(progress)}% –ø–æ–≥–∞—à–µ–Ω–æ</Text>
            {remainingAmount > 0 && (
              <Text style={styles.remainingText}>
                {monthsRemaining} {monthsRemaining === 1 ? '–ø–ª–∞—Ç–µ–∂' : '–ø–ª–∞—Ç–µ–∂–µ–π'} –æ—Å—Ç–∞–ª–æ—Å—å
              </Text>
            )}
          </View>
        </View>

        <View style={styles.creditDetails}>
          <View style={styles.detailRow}>
            <Text style={styles.detailLabel}>üìÖ –°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç–µ–∂:</Text>
            <Text style={styles.detailValue}>
              {nextPaymentDate.toLocaleDateString('ru-RU')}
            </Text>
          </View>
          <View style={styles.detailRow}>
            <Text style={styles.detailLabel}>üí∞ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</Text>
            <Text style={[styles.detailValue, styles.paymentValue]}>
              {formatCurrency(credit.monthlyPayment, false)}
            </Text>
          </View>
          <View style={styles.detailRow}>
            <Text style={styles.detailLabel}>üè¶ –°—á–µ—Ç –¥–ª—è –æ–ø–ª–∞—Ç—ã:</Text>
            <Text style={styles.detailValue}>
              {accounts.find(acc => acc.id === credit.accountId)?.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}
            </Text>
          </View>
        </View>

        <View style={styles.creditActions}>
          <TouchableOpacity 
            style={[
              styles.actionButton, 
              styles.payButton,
              progress >= 100 && styles.payButtonDisabled
            ]}
            onPress={() => openPaymentModal(credit)}
            disabled={progress >= 100}
            activeOpacity={0.7}
          >
            <Text style={[
              styles.payButtonText,
              progress >= 100 && styles.payButtonTextDisabled
            ]}>
              {progress >= 100 ? '‚úÖ –ü–æ–≥–∞—à–µ–Ω' : 'üí∏ –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂'}
            </Text>
          </TouchableOpacity>
          
          <TouchableOpacity 
            style={[styles.actionButton, styles.deleteButton]}
            onPress={() => handleDeleteCredit(credit)}
            activeOpacity={0.7}
          >
            <Text style={styles.deleteButtonText}>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</Text>
          </TouchableOpacity>
        </View>
      </Animated.View>
    );
  };

  const totalDebt = credits.reduce((sum, credit) => sum + (credit.totalAmount - credit.paidAmount), 0);
  const totalPaid = credits.reduce((sum, credit) => sum + credit.paidAmount, 0);
  const activeCredits = credits.filter(credit => credit.isActive).length;

  const EmptyState = () => (
    <Animated.View 
      style={[
        styles.emptyState,
        { opacity: fadeAnim }
      ]}
    >
      <Text style={styles.emptyEmoji}>üè¶</Text>
      <Text style={styles.emptyTitle}>–ö—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</Text>
      <Text style={styles.emptySubtitle}>
        –î–æ–±–∞–≤—å—Ç–µ –≤–∞—à –ø–µ—Ä–≤—ã–π –∫—Ä–µ–¥–∏—Ç –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø–ª–∞—Ç–µ–∂–µ–π –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è
      </Text>
      <TouchableOpacity 
        style={styles.addFirstButton}
        onPress={() => navigation.navigate('AddCredit')}
        activeOpacity={0.8}
      >
        <Text style={styles.addFirstButtonText}>‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç</Text>
      </TouchableOpacity>
    </Animated.View>
  );

  const ReminderModal = () => (
    <Modal
      visible={reminderModalVisible}
      animationType="slide"
      transparent={true}
      onRequestClose={() => setReminderModalVisible(false)}
    >
      <View style={styles.modalContainer}>
        <View style={styles.modalContent}>
          <Text style={styles.modalTitle}>üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –æ –ø–ª–∞—Ç–µ–∂–∞—Ö</Text>
          <Text style={styles.modalSubtitle}>–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞ —Å–∫–æ–ª—å–∫–æ –¥–Ω–µ–π —É–≤–µ–¥–æ–º–ª—è—Ç—å –æ –ø–ª–∞—Ç–µ–∂–∞—Ö</Text>
          
          <View style={styles.reminderOptions}>
            {[7, 3, 1, 0].map(day => (
              <TouchableOpacity
                key={day}
                style={[
                  styles.reminderOption,
                  reminderSettings.daysBefore.includes(day) && styles.reminderOptionActive
                ]}
                onPress={() => toggleReminder(day)}
              >
                <Text style={[
                  styles.reminderOptionText,
                  reminderSettings.daysBefore.includes(day) && styles.reminderOptionTextActive
                ]}>
                  {day === 0 ? 'üìÖ –í –¥–µ–Ω—å –ø–ª–∞—Ç–µ–∂–∞' : `‚è∞ –ó–∞ ${day} ${day === 1 ? '–¥–µ–Ω—å' : '–¥–Ω—è'}`}
                </Text>
              </TouchableOpacity>
            ))}
          </View>

          <View style={styles.modalActions}>
            <TouchableOpacity 
              style={[styles.modalButton, styles.cancelButton]}
              onPress={() => setReminderModalVisible(false)}
            >
              <Text style={styles.cancelButtonText}>–û—Ç–º–µ–Ω–∞</Text>
            </TouchableOpacity>
            
            <TouchableOpacity 
              style={[styles.modalButton, styles.confirmButton]}
              onPress={saveReminderSettings}
            >
              <Text style={styles.confirmButtonText}>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</Text>
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </Modal>
  );

  return (
    <View style={styles.container}>
      <StatusBar backgroundColor={colors.background} barStyle="dark-content" />
      
      <View style={styles.statusBarSpacer} />
      
      {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –®–∞–ø–∫–∞ —ç–∫—Ä–∞–Ω–∞ */}
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>üè¶ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–∞–º–∏</Text>
        <Text style={styles.screenSubtitle}>–û—Ç—Å–ª–µ–∂–∏–≤–∞–π—Ç–µ –ø–ª–∞—Ç–µ–∂–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–≥–∞—à–µ–Ω–∏—è</Text>
      </View>

      <ScrollView
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        refreshControl={
          <RefreshControl 
            refreshing={refreshing} 
            onRefresh={onRefresh}
            colors={[colors.primary]}
            tintColor={colors.primary}
          />
        }
        contentContainerStyle={styles.scrollContent}
      >
        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
        <View style={styles.statsContainer}>
          <View style={styles.statCard}>
            <Text style={styles.statValue}>
              {formatCurrency(totalDebt, false)}
            </Text>
            <Text style={styles.statLabel}>–û–±—â–∏–π –¥–æ–ª–≥</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={styles.statValue}>
              {formatCurrency(totalPaid, false)}
            </Text>
            <Text style={styles.statLabel}>–í—ã–ø–ª–∞—á–µ–Ω–æ</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={styles.statValue}>
              {activeCredits}
            </Text>
            <Text style={styles.statLabel}>–ê–∫—Ç–∏–≤–Ω—ã—Ö</Text>
          </View>
        </View>

        {credits.length === 0 ? (
          <EmptyState />
        ) : (
          <>
            <View style={styles.creditsList}>
              {credits.map((credit, index) => (
                <CreditCard key={credit.id} credit={credit} index={index} />
              ))}
            </View>

            <TouchableOpacity 
              style={styles.addButton}
              onPress={() => navigation.navigate('AddCredit')}
              activeOpacity={0.8}
            >
              <Text style={styles.addButtonText}>üè¶ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –∫—Ä–µ–¥–∏—Ç</Text>
            </TouchableOpacity>
          </>
        )}

        {credits.length > 0 && (
          <>
            <View style={styles.bottomActions}>
              <TouchableOpacity 
                style={[styles.bottomButton, styles.exportButton]}
                onPress={exportCreditsData}
              >
                <Text style={styles.exportButtonText}>üìÑ –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</Text>
              </TouchableOpacity>
              
              <TouchableOpacity 
                style={[styles.bottomButton, styles.reminderButton]}
                onPress={() => setReminderModalVisible(true)}
              >
                <Text style={styles.reminderButtonText}>üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</Text>
              </TouchableOpacity>
            </View>

            {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ */}
            <View style={styles.infoCard}>
              <Text style={styles.infoTitle}>üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:</Text>
              <Text style={styles.infoText}>
                ‚Ä¢ üìÑ <Text style={styles.infoHighlight}>–≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö</Text> - –≤—ã–≥—Ä—É–∑–∫–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫—Ä–µ–¥–∏—Ç–∞—Ö
              </Text>
              <Text style={styles.infoText}>
                ‚Ä¢ üîî <Text style={styles.infoHighlight}>–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è</Text> - —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –ø—Ä–µ–¥—Å—Ç–æ—è—â–∏—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö
              </Text>
              <Text style={styles.infoText}>
                ‚Ä¢ üí≥ <Text style={styles.infoHighlight}>–ü–ª–∞—Ç–µ–∂–∏</Text> - –±—ã—Å—Ç—Ä–æ–µ –≤–Ω–µ—Å–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º
              </Text>
              <Text style={styles.infoText}>
                ‚Ä¢ üìä <Text style={styles.infoHighlight}>–ü—Ä–æ–≥—Ä–µ—Å—Å</Text> - –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è
              </Text>
            </View>
          </>
        )}
      </ScrollView>

      <PaymentModal
        visible={paymentModalVisible}
        credit={selectedCredit}
        onClose={closePaymentModal}
      />

      <ReminderModal />
    </View>
  );
};

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  statusBarSpacer: {
    height: Platform.OS === 'ios' ? 44 : StatusBar.currentHeight,
    backgroundColor: colors.background,
  },
  screenHeader: {
    ...commonStyles.screen.header,
  },
  screenTitle: {
    ...commonStyles.screen.title,
  },
  screenSubtitle: {
    ...commonStyles.screen.subtitle,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  statsContainer: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    paddingVertical: spacing.xl,
    paddingHorizontal: spacing.md,
    marginTop: spacing.lg,
    marginBottom: spacing.xl,
    ...shadows.lg,
  },
  statCard: {
    alignItems: 'center',
    flex: 1,
  },
  statValue: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  statLabel: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  creditsList: {
    gap: spacing.lg,
    marginBottom: spacing.xl,
  },
  // üîß –ö–∞—Ä—Ç–æ—á–∫–∞ –∫—Ä–µ–¥–∏—Ç–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  creditCard: {
    ...commonStyles.cards.surface,
    borderWidth: 1,
    borderColor: colors.border,
  },
  creditHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: spacing.lg,
  },
  creditTitleContainer: {
    flex: 1,
  },
  creditName: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  interestBadge: {
    backgroundColor: colors.primary + '15',
    paddingHorizontal: spacing.sm,
    paddingVertical: 3,
    borderRadius: borderRadius.sm,
    alignSelf: 'flex-start',
  },
  interestText: {
    fontSize: 11,
    color: colors.primary,
    fontWeight: '600',
  },
  statusBadge: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingHorizontal: spacing.sm,
    paddingVertical: 5,
    borderRadius: borderRadius.md,
    marginLeft: spacing.sm,
    gap: spacing.xs,
  },
  statusBadgeSuccess: {
    backgroundColor: colors.success + '15',
  },
  statusBadgeError: {
    backgroundColor: colors.error + '15',
  },
  statusBadgeWarning: {
    backgroundColor: colors.warning + '15',
  },
  statusBadgeInfo: {
    backgroundColor: colors.info + '15',
  },
  statusBadgeNormal: {
    backgroundColor: colors.primary + '15',
  },
  statusEmoji: {
    fontSize: 11,
  },
  statusText: {
    fontSize: 10,
    fontWeight: 'bold',
  },
  progressSection: {
    marginBottom: spacing.lg,
  },
  progressLabels: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: spacing.sm,
  },
  progressLabel: {
    fontSize: 13,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  progressBar: {
    ...commonStyles.progress.container,
    marginBottom: spacing.xs,
  },
  progressFill: {
    ...commonStyles.progress.fill,
  },
  progressInfo: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  progressPercent: {
    fontSize: 11,
    color: colors.textSecondary,
    fontWeight: '600',
  },
  remainingText: {
    fontSize: 10,
    color: colors.textSecondary + '80',
    fontWeight: '500',
  },
  creditDetails: {
    marginBottom: spacing.lg,
  },
  detailRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.sm,
  },
  detailLabel: {
    fontSize: 13,
    color: colors.textSecondary,
    flex: 1,
  },
  detailValue: {
    fontSize: 13,
    color: colors.textPrimary,
    fontWeight: '600',
    flex: 1,
    textAlign: 'right',
  },
  paymentValue: {
    color: colors.primary,
    fontWeight: 'bold',
  },
  creditActions: {
    flexDirection: 'row',
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  actionButton: {
    flex: 1,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    justifyContent: 'center',
    minHeight: 44,
  },
  payButton: {
    ...commonStyles.buttons.primary,
  },
  payButtonDisabled: {
    backgroundColor: colors.success,
  },
  payButtonText: {
    ...commonStyles.buttons.primaryText,
  },
  payButtonTextDisabled: {
    color: colors.white,
  },
  deleteButton: {
    ...commonStyles.buttons.secondary,
  },
  deleteButtonText: {
    ...commonStyles.buttons.secondaryText,
    fontSize: 12,
  },
  emptyState: {
    alignItems: 'center',
    paddingVertical: spacing.xxxl,
    paddingHorizontal: spacing.xl,
  },
  emptyEmoji: {
    fontSize: 64,
    marginBottom: spacing.lg,
  },
  emptyTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
    textAlign: 'center',
  },
  emptySubtitle: {
    fontSize: 15,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 22,
    marginBottom: spacing.xl,
  },
  addFirstButton: {
    ...commonStyles.buttons.primary,
    paddingHorizontal: spacing.xxl,
    paddingVertical: spacing.md,
  },
  addFirstButtonText: {
    ...commonStyles.buttons.primaryText,
  },
  addButton: {
    ...commonStyles.buttons.primary,
    marginBottom: spacing.xl,
  },
  addButtonText: {
    ...commonStyles.buttons.primaryText,
    fontSize: 15,
  },
  bottomActions: {
    flexDirection: 'row',
    gap: spacing.sm,
    marginBottom: spacing.xl,
  },
  // üîß –ù–∏–∂–Ω–∏–µ –∫–Ω–æ–ø–∫–∏ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  bottomButton: {
    flex: 1,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    justifyContent: 'center',
    borderWidth: 1,
    ...shadows.sm,
  },
  exportButton: {
    ...commonStyles.buttons.secondary,
  },
  reminderButton: {
    ...commonStyles.buttons.secondary,
  },
  exportButtonText: {
    ...commonStyles.buttons.secondaryText,
    fontSize: 14,
  },
  reminderButtonText: {
    ...commonStyles.buttons.secondaryText,
    fontSize: 14,
  },
  // üîß –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  infoCard: {
    backgroundColor: colors.surface + '80',
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    borderLeftWidth: 4,
    borderLeftColor: colors.primary,
  },
  infoTitle: {
    fontSize: 15,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
  },
  infoText: {
    fontSize: 13,
    color: colors.textSecondary,
    lineHeight: 18,
    marginBottom: spacing.xs,
  },
  infoHighlight: {
    color: colors.primary,
    fontWeight: '600',
  },
  // üîß –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    padding: spacing.xl,
  },
  modalContent: {
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    padding: spacing.xxl,
    width: '100%',
    maxWidth: 400,
    ...shadows.lg,
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.xs,
  },
  modalSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
    textAlign: 'center',
    marginBottom: spacing.xl,
  },
  reminderOptions: {
    gap: spacing.sm,
    marginBottom: spacing.xl,
  },
  // üîß –û–ø—Ü–∏—è –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  reminderOption: {
    backgroundColor: colors.background,
    padding: spacing.lg,
    borderRadius: borderRadius.md,
    borderWidth: 2,
    borderColor: colors.primary + '30',
  },
  reminderOptionActive: {
    backgroundColor: colors.primary + '15',
    borderColor: colors.primary,
  },
  reminderOptionText: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textPrimary,
    textAlign: 'center',
  },
  reminderOptionTextActive: {
    color: colors.primary,
  },
  modalActions: {
    flexDirection: 'row',
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∏ –º–æ–¥–∞–ª–∫–∏ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  modalButton: {
    flex: 1,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    justifyContent: 'center',
  },
  cancelButton: {
    ...commonStyles.buttons.secondary,
  },
  cancelButtonText: {
    ...commonStyles.buttons.secondaryText,
  },
  confirmButton: {
    ...commonStyles.buttons.primary,
  },
  confirmButtonText: {
    ...commonStyles.buttons.primaryText,
  },
});

export default CreditsScreen;export const formatCurrency = (amount, withSymbol = true) => {
  const formatted = new Intl.NumberFormat('ru-RU', {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  }).format(amount);
  
  return withSymbol ? `${formatted} BYN` : formatted;
};

export const formatCurrencyShort = (amount, withSymbol = true) => {
  if (amount >= 1000000) {
    const value = (amount / 1000000).toFixed(1);
    return withSymbol ? `${value} –º–ª–Ω BYN` : `${value} –º–ª–Ω`;
  }
  if (amount >= 1000) {
    const value = (amount / 1000).toFixed(1);
    return withSymbol ? `${value} —Ç—ã—Å BYN` : `${value} —Ç—ã—Å`;
  }
  return formatCurrency(amount, withSymbol);
};// src/database/database.js
import * as SQLite from 'expo-sqlite';

// üîß –û–¢–ö–†–´–¢–ò–ï –ë–ê–ó–´ –î–ê–ù–ù–´–• –î–õ–Ø –ù–û–í–û–ì–û EXPO API
let databaseInstance = null;

const openDatabase = () => {
  try {
    if (databaseInstance) {
      return databaseInstance;
    }
    
    // –í –Ω–æ–≤—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Expo SQLite –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è —Ç–∞–∫
    databaseInstance = SQLite.openDatabaseSync('FamilyBudget.db');
    console.log('‚úÖ Database opened successfully');
    return databaseInstance;
  } catch (error) {
    console.error('‚ùå Error opening database:', error);
    throw error;
  }
};

// üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ë–ê–ó–´ –î–ê–ù–ù–´–•
export const initDatabase = () => {
  return new Promise(async (resolve, reject) => {
    try {
      console.log('üì¶ Initializing database...');
      const db = openDatabase();
      
      await createTables(db);
      await initializeDefaultData(db);
      
      console.log('‚úÖ Database initialized successfully');
      resolve(db);
    } catch (error) {
      console.error('‚ùå Error initializing database:', error);
      reject(error);
    }
  });
};

// üîß –ü–†–û–í–ï–†–ö–ê –°–£–©–ï–°–¢–í–û–í–ê–ù–ò–Ø –¢–ê–ë–õ–ò–¶–´
const tableExists = async (db, tableName) => {
  try {
    const result = await db.getFirstAsync(
      "SELECT name FROM sqlite_master WHERE type='table' AND name=?",
      [tableName]
    );
    return !!result;
  } catch (error) {
    console.error(`‚ùå Error checking table ${tableName}:`, error);
    return false;
  }
};

// üîß –°–û–ó–î–ê–ù–ò–ï –¢–ê–ë–õ–ò–¶ (–¢–û–õ–¨–ö–û –ï–°–õ–ò –ù–ï –°–£–©–ï–°–¢–í–£–Æ–¢)
const createTables = async (db) => {
  try {
    console.log('üìä Checking and creating tables...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —Å–æ–∑–¥–∞–µ–º —Ç–∞–±–ª–∏—Ü—ã —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Ö –Ω–µ—Ç
    const tables = [
      {
        name: 'accounts',
        sql: `
          CREATE TABLE accounts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            balance REAL DEFAULT 0,
            type TEXT DEFAULT 'card',
            color TEXT DEFAULT '#6C63FF',
            icon TEXT DEFAULT 'üí≥',
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            is_active BOOLEAN DEFAULT 1
          )
        `
      },
      {
        name: 'transactions',
        sql: `
          CREATE TABLE transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            amount REAL NOT NULL,
            type TEXT NOT NULL,
            category INTEGER NOT NULL,
            account_id INTEGER NOT NULL,
            description TEXT,
            date DATETIME DEFAULT CURRENT_TIMESTAMP,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (account_id) REFERENCES accounts (id)
          )
        `
      },
      {
        name: 'debts',
        sql: `
          CREATE TABLE debts (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            person TEXT NOT NULL,
            amount REAL NOT NULL,
            paid_amount REAL DEFAULT 0,
            type TEXT NOT NULL,
            description TEXT,
            account_id INTEGER NOT NULL,
            due_date DATETIME,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            is_active BOOLEAN DEFAULT 1,
            FOREIGN KEY (account_id) REFERENCES accounts (id)
          )
        `
      },
      {
        name: 'credits',
        sql: `
          CREATE TABLE credits (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            name TEXT NOT NULL,
            total_amount REAL NOT NULL,
            paid_amount REAL DEFAULT 0,
            monthly_payment REAL NOT NULL,
            interest_rate REAL DEFAULT 0,
            end_date DATETIME,
            next_payment_date DATETIME,
            account_id INTEGER NOT NULL,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            is_active BOOLEAN DEFAULT 1,
            FOREIGN KEY (account_id) REFERENCES accounts (id)
          )
        `
      },
      {
        name: 'app_settings',
        sql: `
          CREATE TABLE app_settings (
            key TEXT PRIMARY KEY,
            value TEXT,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
          )
        `
      }
    ];

    for (const table of tables) {
      const exists = await tableExists(db, table.name);
      if (!exists) {
        console.log(`üìã Creating table: ${table.name}`);
        await db.execAsync(table.sql);
        console.log(`‚úÖ Table ${table.name} created`);
      } else {
        console.log(`‚úÖ Table ${table.name} already exists`);
      }
    }

    console.log('‚úÖ All tables checked/created successfully');
  } catch (error) {
    console.error('‚ùå Error creating tables:', error);
    throw error;
  }
};

// üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –î–ê–ù–ù–´–• –ü–û –£–ú–û–õ–ß–ê–ù–ò–Æ
const initializeDefaultData = async (db) => {
  try {
    console.log('üìù Initializing default data...');
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Å—á–µ—Ç–∞
    const accounts = await db.getAllAsync('SELECT COUNT(*) as count FROM accounts');
    const count = accounts[0].count;
    
    if (count === 0) {
      // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ —Å—á–µ—Ç–∞
      const initialAccounts = [
        { name: '–ù–∞–ª–∏—á–Ω—ã–µ', balance: 0, type: 'cash', color: '#4CAF50', icon: 'üíµ' },
        { name: '–û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∞', balance: 0, type: 'card', color: '#6C63FF', icon: 'üí≥' },
        { name: '–°–±–µ—Ä–µ–∂–µ–Ω–∏—è', balance: 0, type: 'savings', color: '#FF9800', icon: 'üè¶' }
      ];

      for (const account of initialAccounts) {
        await db.runAsync(
          'INSERT INTO accounts (name, balance, type, color, icon) VALUES (?, ?, ?, ?, ?)',
          [account.name, account.balance, account.type, account.color, account.icon]
        );
      }
      console.log('‚úÖ Default accounts created');
    } else {
      console.log(`‚úÖ Accounts already exist: ${count} accounts`);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    await initializeSettings(db);
    
    console.log('‚úÖ Default data initialized');
  } catch (error) {
    console.error('‚ùå Error initializing default data:', error);
    throw error;
  }
};

// üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ù–ê–°–¢–†–û–ï–ö
const initializeSettings = async (db) => {
  try {
    const settings = [
      { key: 'currency', value: 'BYN' },
      { key: 'language', value: 'ru' },
      { key: 'date_format', value: 'dd.MM.yyyy' },
      { key: 'backup_enabled', value: 'true' },
      { key: 'auto_backup', value: 'false' },
      { key: 'last_backup', value: '' }
    ];

    for (const setting of settings) {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º INSERT OR IGNORE —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç–æ–≤
      await db.runAsync(
        'INSERT OR IGNORE INTO app_settings (key, value) VALUES (?, ?)',
        [setting.key, setting.value]
      );
    }
    console.log('‚úÖ Settings initialized');
  } catch (error) {
    console.error('‚ùå Error initializing settings:', error);
  }
};

// üîß –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ù–ê–ß–ê–õ–¨–ù–´–ú–ò –î–ê–ù–ù–´–ú–ò (alias –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
export const seedInitialData = async () => {
  try {
    const db = openDatabase();
    await initializeDefaultData(db);
    console.log('‚úÖ Seed data completed');
    return db;
  } catch (error) {
    console.error('‚ùå Error in seedInitialData:', error);
    throw error;
  }
};

// üîß –ë–ê–ó–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –° –ë–ê–ó–û–ô –î–ê–ù–ù–´–•
export const executeSql = async (db, sql, params = []) => {
  try {
    // –î–ª—è SELECT –∑–∞–ø—Ä–æ—Å–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º getAllAsync
    if (sql.trim().toUpperCase().startsWith('SELECT')) {
      return await db.getAllAsync(sql, params);
    } else {
      // –î–ª—è INSERT, UPDATE, DELETE –∏—Å–ø–æ–ª—å–∑—É–µ–º runAsync
      const result = await db.runAsync(sql, params);
      return result;
    }
  } catch (error) {
    console.error('‚ùå SQL Error:', error, 'SQL:', sql);
    throw error;
  }
};

// üîß –ü–û–õ–£–ß–ï–ù–ò–ï –í–°–ï–• –î–ê–ù–ù–´–• –î–õ–Ø CONTEXT
export const loadAllData = async (db) => {
  try {
    const [accounts, transactions, debts, credits] = await Promise.all([
      db.getAllAsync('SELECT * FROM accounts WHERE is_active = 1 ORDER BY id'),
      db.getAllAsync('SELECT * FROM transactions ORDER BY date DESC, id DESC LIMIT 1000'),
      db.getAllAsync('SELECT * FROM debts WHERE is_active = 1 ORDER BY created_at DESC'),
      db.getAllAsync('SELECT * FROM credits WHERE is_active = 1 ORDER BY created_at DESC')
    ]);

    return {
      accounts: accounts || [],
      transactions: transactions || [],
      debts: debts || [],
      credits: credits || []
    };
  } catch (error) {
    console.error('‚ùå Error loading all data:', error);
    throw error;
  }
};

// üîß –ú–ï–¢–û–î–´ –î–õ–Ø BACKUP –°–ò–°–¢–ï–ú–´

export const clearAllData = async (db) => {
  try {
    // –í—ã–ø–æ–ª–Ω—è–µ–º –æ—á–∏—Å—Ç–∫—É –≤ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    await db.execAsync(`
      BEGIN TRANSACTION;
      DELETE FROM transactions;
      DELETE FROM debts;
      DELETE FROM credits;
      DELETE FROM accounts WHERE id != 1;
      UPDATE accounts SET balance = 0 WHERE id = 1;
      COMMIT;
    `);
    console.log('‚úÖ All data cleared successfully');
  } catch (error) {
    console.error('‚ùå Error clearing data:', error);
    throw error;
  }
};

export const restoreAccounts = async (db, accountsData) => {
  try {
    await db.execAsync('DELETE FROM accounts WHERE id != 1');
    
    for (const account of accountsData) {
      if (account.id !== 1) {
        await db.runAsync(
          `INSERT INTO accounts (id, name, balance, type, color, icon, created_at, is_active) 
           VALUES (?, ?, ?, ?, ?, ?, ?, ?)`,
          [
            account.id,
            account.name,
            account.balance,
            account.type,
            account.color,
            account.icon,
            account.createdAt,
            account.isActive !== false ? 1 : 0
          ]
        );
      }
    }
    
    console.log(`‚úÖ Accounts restored: ${accountsData.length}`);
  } catch (error) {
    console.error('‚ùå Error restoring accounts:', error);
    throw error;
  }
};

export const restoreTransactions = async (db, transactionsData) => {
  try {
    await db.execAsync('DELETE FROM transactions');
    
    for (const transaction of transactionsData) {
      await db.runAsync(
        `INSERT INTO transactions (id, amount, type, category, account_id, description, date, created_at, updated_at) 
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          transaction.id,
          transaction.amount,
          transaction.type,
          transaction.category,
          transaction.account_id,
          transaction.description,
          transaction.date,
          transaction.created_at,
          transaction.updated_at
        ]
      );
    }
    
    console.log(`‚úÖ Transactions restored: ${transactionsData.length}`);
  } catch (error) {
    console.error('‚ùå Error restoring transactions:', error);
    throw error;
  }
};

export const restoreDebts = async (db, debtsData) => {
  try {
    await db.execAsync('DELETE FROM debts');
    
    for (const debt of debtsData) {
      await db.runAsync(
        `INSERT INTO debts (id, person, amount, paid_amount, type, description, account_id, due_date, created_at, is_active) 
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          debt.id,
          debt.person,
          debt.amount,
          debt.paidAmount || 0,
          debt.type,
          debt.description,
          debt.accountId,
          debt.dueDate,
          debt.createdAt,
          debt.isActive !== false ? 1 : 0
        ]
      );
    }
    
    console.log(`‚úÖ Debts restored: ${debtsData.length}`);
  } catch (error) {
    console.error('‚ùå Error restoring debts:', error);
    throw error;
  }
};

export const restoreCredits = async (db, creditsData) => {
  try {
    await db.execAsync('DELETE FROM credits');
    
    for (const credit of creditsData) {
      await db.runAsync(
        `INSERT INTO credits (id, name, total_amount, paid_amount, monthly_payment, interest_rate, end_date, next_payment_date, account_id, created_at, is_active) 
         VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)`,
        [
          credit.id,
          credit.name,
          credit.totalAmount,
          credit.paidAmount || 0,
          credit.monthlyPayment,
          credit.interestRate,
          credit.endDate,
          credit.nextPaymentDate,
          credit.accountId,
          credit.createdAt,
          credit.isActive !== false ? 1 : 0
        ]
      );
    }
    
    console.log(`‚úÖ Credits restored: ${creditsData.length}`);
  } catch (error) {
    console.error('‚ùå Error restoring credits:', error);
    throw error;
  }
};

// üîß –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –û–°–ù–û–í–ù–´–• –û–ü–ï–†–ê–¶–ò–ô

export const getAccounts = async (db) => {
  try {
    return await db.getAllAsync('SELECT * FROM accounts WHERE is_active = 1 ORDER BY id');
  } catch (error) {
    console.error('‚ùå Error getting accounts:', error);
    return [];
  }
};

export const addAccountToDB = async (db, accountData) => {
  try {
    const result = await db.runAsync(
      'INSERT INTO accounts (name, balance, type, color, icon) VALUES (?, ?, ?, ?, ?)',
      [accountData.name, accountData.balance, accountData.type, accountData.color, accountData.icon]
    );
    return result.lastInsertRowId;
  } catch (error) {
    console.error('‚ùå Error adding account:', error);
    throw error;
  }
};

export const updateAccountBalance = async (db, accountId, newBalance) => {
  try {
    await db.runAsync(
      'UPDATE accounts SET balance = ? WHERE id = ?',
      [newBalance, accountId]
    );
  } catch (error) {
    console.error('‚ùå Error updating account balance:', error);
    throw error;
  }
};

export const addTransactionToDB = async (db, transactionData) => {
  try {
    const result = await db.runAsync(
      'INSERT INTO transactions (amount, type, category, account_id, description, date) VALUES (?, ?, ?, ?, ?, ?)',
      [
        transactionData.amount,
        transactionData.type,
        transactionData.category,
        transactionData.account_id,
        transactionData.description,
        transactionData.date || new Date().toISOString()
      ]
    );
    return result.lastInsertRowId;
  } catch (error) {
    console.error('‚ùå Error adding transaction:', error);
    throw error;
  }
};

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º openDatabase –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö –º–µ—Å—Ç–∞—Ö
export { openDatabase };// src/context/DataContext.js - –ü–û–õ–ù–ê–Ø –í–ï–†–°–ò–Ø
import React, { createContext, useState, useContext, useEffect } from 'react';
import { Alert } from 'react-native';
import { initDatabase, seedInitialData, loadAllData, executeSql, clearAllData, restoreAccounts, restoreTransactions, restoreDebts, restoreCredits, addAccountToDB, addTransactionToDB, updateAccountBalance } from '../database/database';
import backupService from '../services/BackupService';
import notificationService from '../services/NotificationService';
import analyticsService from '../services/AnalyticsService';

const DataContext = createContext();

export const DataProvider = ({ children }) => {
  const [accounts, setAccounts] = useState([]);
  const [transactions, setTransactions] = useState([]);
  const [debts, setDebts] = useState([]);
  const [credits, setCredits] = useState([]);
  const [categories, setCategories] = useState({
    income: [
      { id: 1, name: 'üíº –ó–∞—Ä–ø–ª–∞—Ç–∞', icon: 'üíº', color: '#4CAF50' },
      { id: 2, name: 'üè† –ê—Ä–µ–Ω–¥–∞', icon: 'üè†', color: '#2196F3' },
      { id: 3, name: 'üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', icon: 'üìà', color: '#FF9800' },
      { id: 4, name: 'üéÅ –ü–æ–¥–∞—Ä–∫–∏', icon: 'üéÅ', color: '#9C27B0' },
      { id: 5, name: 'üîÑ –í–æ–∑–≤—Ä–∞—Ç—ã', icon: 'üîÑ', color: '#607D8B' },
      { id: 6, name: 'üí∏ –ü—Ä–æ—á–∏–µ –¥–æ—Ö–æ–¥—ã', icon: 'üí∏', color: '#795548' }
    ],
    expense: [
      { id: 7, name: 'üçî –ï–¥–∞', icon: 'üçî', color: '#FF5722' },
      { id: 8, name: 'üöó –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç', icon: 'üöó', color: '#3F51B5' },
      { id: 9, name: 'üè† –ñ–∏–ª—å–µ', icon: 'üè†', color: '#009688' },
      { id: 10, name: 'üëï –û–¥–µ–∂–¥–∞', icon: 'üëï', color: '#E91E63' },
      { id: 11, name: 'üè• –ó–¥–æ—Ä–æ–≤—å–µ', icon: 'üè•', color: '#00BCD4' },
      { id: 12, name: 'üéÆ –†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', icon: 'üéÆ', color: '#673AB7' },
      { id: 13, name: 'üìö –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ', icon: 'üìö', color: '#FFC107' },
      { id: 14, name: 'üí° –ö–æ–º—É–Ω–∞–ª—å–Ω—ã–µ', icon: 'üí°', color: '#8BC34A' },
      { id: 15, name: 'üì± –°–≤—è–∑—å', icon: 'üì±', color: '#FF9800' },
      { id: 16, name: 'üí∏ –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã', icon: 'üí∏', color: '#795548' }
    ]
  });

  // üîß –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• –ü–†–ò –ó–ê–ü–£–°–ö–ï
  useEffect(() => {
    loadInitialData();
  }, []);

  const loadInitialData = async () => {
    try {
      console.log('üì• Loading initial data...');
      
      const db = await initDatabase();
      const data = await loadAllData(db);
      
      setAccounts(data.accounts || []);
      setTransactions(data.transactions || []);
      setDebts(data.debts || []);
      setCredits(data.credits || []);
      
      console.log('‚úÖ Data loaded successfully:', {
        accounts: data.accounts?.length || 0,
        transactions: data.transactions?.length || 0,
        debts: data.debts?.length || 0,
        credits: data.credits?.length || 0
      });
      
      // üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      if (data.transactions?.length > 0) {
        schedulePaymentReminders();
      }
      
    } catch (error) {
      console.error('‚ùå Error loading initial data:', error);
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç—ã–µ –º–∞—Å—Å–∏–≤—ã –≤–º–µ—Å—Ç–æ undefined
      setAccounts([]);
      setTransactions([]);
      setDebts([]);
      setCredits([]);
    }
  };

  // üîß –°–£–©–ï–°–¢–í–£–Æ–©–ò–ï –ú–ï–¢–û–î–´
  const addAccount = async (accountData) => {
    try {
      const db = await initDatabase();
      const newAccountId = await addAccountToDB(db, accountData);
      
      const newAccount = {
        id: newAccountId,
        ...accountData,
        created_at: new Date().toISOString(),
        is_active: 1
      };
      
      setAccounts(prev => [...prev, newAccount]);
      return newAccountId;
    } catch (error) {
      console.error('‚ùå Error adding account:', error);
      throw error;
    }
  };

  // üîî –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫—Ä—É–ø–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
  const checkLargeExpense = async (transaction) => {
    if (transaction.amount < -1000) { // –ü–æ—Ä–æ–≥ –¥–ª—è –∫—Ä—É–ø–Ω–æ–≥–æ —Ä–∞—Å—Ö–æ–¥–∞
      const category = categories.expense.find(c => c.id === transaction.category);
      await notificationService.scheduleLargeExpenseAlert(
        Math.abs(transaction.amount),
        category?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è'
      );
    }
  };

  const addTransaction = async (transactionData) => {
    try {
      const db = await initDatabase();
      const newTransactionId = await addTransactionToDB(db, transactionData);
      
      const newTransaction = {
        id: newTransactionId,
        ...transactionData,
        created_at: new Date().toISOString(),
        updated_at: new Date().toISOString()
      };
      
      setTransactions(prev => [newTransaction, ...prev]);
      
      // üîî –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫—Ä—É–ø–Ω—ã–π —Ä–∞—Å—Ö–æ–¥
      if (transactionData.amount < 0) {
        await checkLargeExpense(newTransaction);
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —Å—á–µ—Ç–∞
      const account = accounts.find(acc => acc.id === transactionData.account_id);
      if (account) {
        const newBalance = transactionData.type === 'income' 
          ? (account.balance || 0) + transactionData.amount
          : (account.balance || 0) - Math.abs(transactionData.amount);
        
        await updateAccountBalance(db, transactionData.account_id, newBalance);
        
        setAccounts(prev => 
          prev.map(acc => 
            acc.id === transactionData.account_id 
              ? { ...acc, balance: newBalance }
              : acc
          )
        );
      }
      
      return newTransactionId;
    } catch (error) {
      console.error('‚ùå Error adding transaction:', error);
      throw error;
    }
  };

  const addDebt = async (debtData) => {
    try {
      const db = await initDatabase();
      const result = await executeSql(
        db,
        `INSERT INTO debts (person, amount, type, description, account_id, due_date) 
         VALUES (?, ?, ?, ?, ?, ?)`,
        [
          debtData.person,
          debtData.amount,
          debtData.type,
          debtData.description,
          debtData.accountId,
          debtData.dueDate
        ]
      );
      
      const newDebt = {
        id: result.lastInsertRowId,
        ...debtData,
        paid_amount: 0,
        created_at: new Date().toISOString(),
        is_active: 1
      };
      
      setDebts(prev => [...prev, newDebt]);
      return result.lastInsertRowId;
    } catch (error) {
      console.error('‚ùå Error adding debt:', error);
      throw error;
    }
  };

  const addCredit = async (creditData) => {
    try {
      const db = await initDatabase();
      const result = await executeSql(
        db,
        `INSERT INTO credits (name, total_amount, monthly_payment, interest_rate, end_date, account_id, next_payment_date) 
         VALUES (?, ?, ?, ?, ?, ?, ?)`,
        [
          creditData.name,
          creditData.totalAmount,
          creditData.monthlyPayment,
          creditData.interestRate,
          creditData.endDate,
          creditData.accountId,
          creditData.nextPaymentDate
        ]
      );
      
      const newCredit = {
        id: result.lastInsertRowId,
        ...creditData,
        paid_amount: 0,
        created_at: new Date().toISOString(),
        is_active: 1
      };
      
      setCredits(prev => [...prev, newCredit]);
      return result.lastInsertRowId;
    } catch (error) {
      console.error('‚ùå Error adding credit:', error);
      throw error;
    }
  };

  const deleteAccount = async (accountId) => {
    try {
      const db = await initDatabase();
      await executeSql(
        db,
        'UPDATE accounts SET is_active = 0 WHERE id = ? AND id != 1',
        [accountId]
      );
      
      setAccounts(prev => prev.filter(acc => acc.id !== accountId));
    } catch (error) {
      console.error('‚ùå Error deleting account:', error);
      throw error;
    }
  };

  // üîß –ù–û–í–´–ô –ú–ï–¢–û–î: –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ß–ï–¢–ê
  const updateAccount = async (accountId, updates) => {
    try {
      const db = await initDatabase();
      
      // –°–æ–±–∏—Ä–∞–µ–º –ø–æ–ª—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      const updateFields = [];
      const values = [];
      
      if (updates.name !== undefined) {
        updateFields.push('name = ?');
        values.push(updates.name);
      }
      
      if (updates.balance !== undefined) {
        updateFields.push('balance = ?');
        values.push(updates.balance);
      }
      
      if (updates.type !== undefined) {
        updateFields.push('type = ?');
        values.push(updates.type);
      }
      
      if (updates.color !== undefined) {
        updateFields.push('color = ?');
        values.push(updates.color);
      }
      
      if (updates.icon !== undefined) {
        updateFields.push('icon = ?');
        values.push(updates.icon);
      }
      
      if (updateFields.length === 0) {
        throw new Error('–ù–µ—Ç –ø–æ–ª–µ–π –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è');
      }
      
      // –î–æ–±–∞–≤–ª—è–µ–º accountId –≤ –∫–æ–Ω–µ—Ü –∑–Ω–∞—á–µ–Ω–∏–π
      values.push(accountId);
      
      const sql = `UPDATE accounts SET ${updateFields.join(', ')} WHERE id = ?`;
      await executeSql(db, sql, values);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setAccounts(prev => 
        prev.map(acc => 
          acc.id === accountId ? { ...acc, ...updates } : acc
        )
      );
      
      return { success: true };
    } catch (error) {
      console.error('‚ùå Error updating account:', error);
      throw error;
    }
  };

  // üîß –ù–û–í–´–ô –ú–ï–¢–û–î: –ü–†–û–í–ï–†–ö–ê –ú–û–ñ–ù–û –õ–ò –£–î–ê–õ–ò–¢–¨ –°–ß–ï–¢
  const canDeleteAccount = async (accountId) => {
    try {
      const db = await initDatabase();
      const transactions = await executeSql(
        db,
        'SELECT COUNT(*) as count FROM transactions WHERE account_id = ?',
        [accountId]
      );
      
      const hasTransactions = transactions[0]?.count > 0;
      
      // –¢–∞–∫–∂–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ–ª–≥–∏ –∏ –∫—Ä–µ–¥–∏—Ç—ã
      const debts = await executeSql(
        db,
        'SELECT COUNT(*) as count FROM debts WHERE account_id = ? AND is_active = 1',
        [accountId]
      );
      
      const credits = await executeSql(
        db,
        'SELECT COUNT(*) as count FROM credits WHERE account_id = ? AND is_active = 1',
        [accountId]
      );
      
      const hasLinkedData = debts[0]?.count > 0 || credits[0]?.count > 0;
      
      return {
        canDelete: !hasTransactions && !hasLinkedData,
        hasTransactions: hasTransactions,
        hasLinkedData: hasLinkedData
      };
    } catch (error) {
      console.error('‚ùå Error checking if account can be deleted:', error);
      return { canDelete: false, error: error.message };
    }
  };

  // üîß –ù–û–í–´–ô –ú–ï–¢–û–î: –†–ï–ê–õ–¨–ù–û–ï –£–î–ê–õ–ï–ù–ò–ï –°–ß–ï–¢–ê (—Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π)
  const deleteAccountWithCheck = async (accountId) => {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —É–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç
      const checkResult = await canDeleteAccount(accountId);
      
      if (!checkResult.canDelete) {
        let message = '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç:';
        
        if (checkResult.hasTransactions) {
          message += '\n‚Ä¢ –ï—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏';
        }
        if (checkResult.hasLinkedData) {
          message += '\n‚Ä¢ –ï—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–ª–≥–∏ –∏–ª–∏ –∫—Ä–µ–¥–∏—Ç—ã';
        }
        
        throw new Error(message);
      }
      
      // –£–¥–∞–ª—è–µ–º —Å—á–µ—Ç –∏–∑ –±–∞–∑—ã
      const db = await initDatabase();
      await executeSql(
        db,
        'DELETE FROM accounts WHERE id = ?',
        [accountId]
      );
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setAccounts(prev => prev.filter(acc => acc.id !== accountId));
      
      return { success: true, message: '–°—á–µ—Ç —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω' };
    } catch (error) {
      console.error('‚ùå Error deleting account:', error);
      throw error;
    }
  };

  // üîß –ù–û–í–´–ô –ú–ï–¢–û–î: –ê–†–•–ò–í–ò–†–û–í–ê–ù–ò–ï –°–ß–ï–¢–ê (–≤–º–µ—Å—Ç–æ —É–¥–∞–ª–µ–Ω–∏—è)
  const archiveAccount = async (accountId, isArchived = true) => {
    try {
      const db = await initDatabase();
      await executeSql(
        db,
        'UPDATE accounts SET is_active = ? WHERE id = ?',
        [isArchived ? 0 : 1, accountId]
      );
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setAccounts(prev => 
        prev.map(acc => 
          acc.id === accountId ? { ...acc, is_active: isArchived ? 0 : 1 } : acc
        )
      );
      
      return { 
        success: true, 
        message: isArchived ? '–°—á–µ—Ç –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω' : '–°—á–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' 
      };
    } catch (error) {
      console.error('‚ùå Error archiving account:', error);
      throw error;
    }
  };

  // üîß –ù–û–í–´–ô –ú–ï–¢–û–î: –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –°–ß–ï–¢–£
  const getAccountStats = (accountId) => {
    try {
      const accountTransactions = transactions.filter(t => t.account_id === accountId);
      const accountDebts = debts.filter(d => d.account_id === accountId);
      const accountCredits = credits.filter(c => c.account_id === accountId);
      
      // –†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤
      const income = accountTransactions
        .filter(t => t.type === 'income')
        .reduce((sum, t) => sum + (t.amount || 0), 0);
      
      const expense = accountTransactions
        .filter(t => t.type === 'expense')
        .reduce((sum, t) => sum + Math.abs(t.amount || 0), 0);
      
      // –ü–æ—Å–ª–µ–¥–Ω—è—è –æ–ø–µ—Ä–∞—Ü–∏—è
      const lastTransaction = accountTransactions.length > 0 
        ? accountTransactions[0]
        : null;
      
      return {
        totalTransactions: accountTransactions.length,
        income,
        expense,
        netChange: income - expense,
        lastTransaction,
        debtsCount: accountDebts.length,
        creditsCount: accountCredits.length,
        isActive: accounts.find(acc => acc.id === accountId)?.is_active !== 0
      };
    } catch (error) {
      console.error('‚ùå Error getting account stats:', error);
      return {
        totalTransactions: 0,
        income: 0,
        expense: 0,
        netChange: 0,
        lastTransaction: null,
        debtsCount: 0,
        creditsCount: 0,
        isActive: true
      };
    }
  };

  const transferBetweenAccounts = async (fromAccountId, toAccountId, amount, description) => {
    try {
      const db = await initDatabase();
      
      // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é —Å–ø–∏—Å–∞–Ω–∏—è
      await addTransaction({
        amount: amount,
        type: 'expense',
        category: 16, // –ü—Ä–æ—á–∏–µ —Ä–∞—Å—Ö–æ–¥—ã
        account_id: fromAccountId,
        description: `–ü–µ—Ä–µ–≤–æ–¥: ${description}`,
        date: new Date().toISOString()
      });
      
      // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é –∑–∞—á–∏—Å–ª–µ–Ω–∏—è
      await addTransaction({
        amount: amount,
        type: 'income',
        category: 5, // –í–æ–∑–≤—Ä–∞—Ç—ã
        account_id: toAccountId,
        description: `–ü–µ—Ä–µ–≤–æ–¥: ${description}`,
        date: new Date().toISOString()
      });
      
    } catch (error) {
      console.error('‚ùå Error transferring between accounts:', error);
      throw error;
    }
  };

  const getTotalBalance = () => {
    try {
      if (!accounts || !Array.isArray(accounts)) {
        return 0;
      }
      return accounts.reduce((total, account) => total + (account.balance || 0), 0);
    } catch (error) {
      console.error('‚ùå Error calculating total balance:', error);
      return 0;
    }
  };

  const getRecentTransactions = (limit = 10) => {
    try {
      if (!transactions || !Array.isArray(transactions)) {
        return [];
      }
      return transactions.slice(0, limit);
    } catch (error) {
      console.error('‚ùå Error getting recent transactions:', error);
      return [];
    }
  };

  const getTransactionsByType = (type) => {
    try {
      if (!transactions || !Array.isArray(transactions)) {
        return [];
      }
      return transactions.filter(transaction => transaction.type === type);
    } catch (error) {
      console.error('‚ùå Error getting transactions by type:', error);
      return [];
    }
  };

  // üîß –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø BACKUP –°–ò–°–¢–ï–ú–´

  // üóëÔ∏è –û–ß–ò–°–¢–ö–ê –í–°–ï–• –î–ê–ù–ù–´–• (–¥–ª—è –∏–º–ø–æ—Ä—Ç–∞)
  const clearAllData = async () => {
    try {
      Alert.alert(
        '‚ö†Ô∏è –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö',
        '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –í–°–ï –¥–∞–Ω–Ω—ã–µ? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
        [
          { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
          {
            text: '–£–¥–∞–ª–∏—Ç—å –≤—Å—ë',
            style: 'destructive',
            onPress: async () => {
              try {
                const db = await initDatabase();
                await clearAllData(db);
                
                // –û—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
                setAccounts([]);
                setTransactions([]);
                setDebts([]);
                setCredits([]);
                
                Alert.alert('‚úÖ –£—Å–ø–µ—Ö', '–í—Å–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω—ã');
              } catch (error) {
                console.error('‚ùå Error clearing data:', error);
                Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
              }
            }
          }
        ]
      );
    } catch (error) {
      console.error('‚ùå Error in clearAllData:', error);
      throw error;
    }
  };

  // üíæ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –°–ß–ï–¢–û–í
  const restoreAccounts = async (accountsData) => {
    try {
      if (!Array.isArray(accountsData)) {
        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —Å—á–µ—Ç–æ–≤');
      }

      const db = await initDatabase();
      await restoreAccounts(db, accountsData);

      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      const validatedAccounts = accountsData.map(account => ({
        id: account.id || Date.now() + Math.random(),
        name: account.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—á–µ—Ç',
        balance: typeof account.balance === 'number' ? account.balance : 0,
        type: account.type || 'card',
        color: account.color || '#6C63FF',
        icon: account.icon || 'üí≥',
        created_at: account.createdAt || new Date().toISOString(),
        is_active: account.isActive !== false ? 1 : 0
      }));

      setAccounts(validatedAccounts);
      console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Å—á–µ—Ç–æ–≤: ${validatedAccounts.length}`);
      return { success: true, count: validatedAccounts.length };

    } catch (error) {
      console.error('‚ùå Error restoring accounts:', error);
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç–∞: ${error.message}`);
    }
  };

  // üíæ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –¢–†–ê–ù–ó–ê–ö–¶–ò–ô
  const restoreTransactions = async (transactionsData) => {
    try {
      if (!Array.isArray(transactionsData)) {
        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
      }

      const db = await initDatabase();
      await restoreTransactions(db, transactionsData);

      const validatedTransactions = transactionsData.map(transaction => ({
        id: transaction.id || Date.now() + Math.random(),
        amount: typeof transaction.amount === 'number' ? transaction.amount : 0,
        type: transaction.type || 'expense',
        category: transaction.category || 16,
        account_id: transaction.account_id || 1,
        description: transaction.description || '',
        date: transaction.date || new Date().toISOString(),
        created_at: transaction.created_at || new Date().toISOString(),
        updated_at: transaction.updated_at || new Date().toISOString()
      }));

      setTransactions(validatedTransactions);
      console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: ${validatedTransactions.length}`);
      return { success: true, count: validatedTransactions.length };

    } catch (error) {
      console.error('‚ùå Error restoring transactions:', error);
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${error.message}`);
    }
  };

  // üíæ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –î–û–õ–ì–û–í
  const restoreDebts = async (debtsData) => {
    try {
      if (!Array.isArray(debtsData)) {
        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –¥–æ–ª–≥–æ–≤');
      }

      const db = await initDatabase();
      await restoreDebts(db, debtsData);

      const validatedDebts = debtsData.map(debt => ({
        id: debt.id || Date.now() + Math.random(),
        person: debt.person || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —á–µ–ª–æ–≤–µ–∫',
        amount: typeof debt.amount === 'number' ? debt.amount : 0,
        paid_amount: typeof debt.paidAmount === 'number' ? debt.paidAmount : 0,
        type: debt.type || 'given',
        description: debt.description || '',
        account_id: debt.accountId || 1,
        due_date: debt.dueDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
        created_at: debt.createdAt || new Date().toISOString(),
        is_active: debt.isActive !== false ? 1 : 0
      }));

      setDebts(validatedDebts);
      console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –¥–æ–ª–≥–æ–≤: ${validatedDebts.length}`);
      return { success: true, count: validatedDebts.length };

    } catch (error) {
      console.error('‚ùå Error restoring debts:', error);
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–æ–ª–≥–∏: ${error.message}`);
    }
  };

  // üíæ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–†–ï–î–ò–¢–û–í
  const restoreCredits = async (creditsData) => {
    try {
      if (!Array.isArray(creditsData)) {
        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤');
      }

      const db = await initDatabase();
      await restoreCredits(db, creditsData);

      const validatedCredits = creditsData.map(credit => ({
        id: credit.id || Date.now() + Math.random(),
        name: credit.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –∫—Ä–µ–¥–∏—Ç',
        total_amount: typeof credit.totalAmount === 'number' ? credit.totalAmount : 0,
        paid_amount: typeof credit.paidAmount === 'number' ? credit.paidAmount : 0,
        monthly_payment: typeof credit.monthlyPayment === 'number' ? credit.monthlyPayment : 0,
        interest_rate: typeof credit.interestRate === 'number' ? credit.interestRate : 0,
        end_date: credit.endDate || new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString(),
        next_payment_date: credit.nextPaymentDate || new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString(),
        account_id: credit.accountId || 1,
        created_at: credit.createdAt || new Date().toISOString(),
        is_active: credit.isActive !== false ? 1 : 0
      }));

      setCredits(validatedCredits);
      console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤: ${validatedCredits.length}`);
      return { success: true, count: validatedCredits.length };

    } catch (error) {
      console.error('‚ùå Error restoring credits:', error);
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã: ${error.message}`);
    }
  };

  // üíæ –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ö–ê–¢–ï–ì–û–†–ò–ô
  const restoreCategories = async (categoriesData) => {
    try {
      if (!categoriesData || typeof categoriesData !== 'object') {
        throw new Error('–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –∫–∞—Ç–µ–≥–æ—Ä–∏–π');
      }

      const restoredCategories = {
        income: categoriesData.income || categories.income,
        expense: categoriesData.expense || categories.expense
      };

      setCategories(restoredCategories);

      console.log(`‚úÖ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: –¥–æ—Ö–æ–¥—ã ${restoredCategories.income.length}, —Ä–∞—Å—Ö–æ–¥—ã ${restoredCategories.expense.length}`);
      return { 
        success: true, 
        incomeCount: restoredCategories.income.length,
        expenseCount: restoredCategories.expense.length
      };

    } catch (error) {
      console.error('‚ùå Error restoring categories:', error);
      throw new Error(`–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏–∏: ${error.message}`);
    }
  };

  // üîÑ –ü–û–õ–ù–´–ô –ò–ú–ü–û–†–¢ –î–ê–ù–ù–´–•
  const performFullImport = async (importData) => {
    try {
      // –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ BackupService
      const validationResult = backupService.validateBackupData(importData);
      if (!validationResult.isValid) {
        throw new Error(validationResult.errors.join(', '));
      }

      const backupData = typeof importData === 'string' ? JSON.parse(importData) : importData;
      const data = backupData.data;

      // –°–æ–∑–¥–∞–µ–º backup —Ç–µ–∫—É—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∏–º–ø–æ—Ä—Ç–æ–º
      const currentBackup = backupService.generateBackupData({
        accounts, transactions, debts, credits, categories,
        getTotalBalance, getRecentTransactions, getTransactionsByType
      });

      // –í—ã–ø–æ–ª–Ω—è–µ–º –∏–º–ø–æ—Ä—Ç –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
      const results = [];

      // 1. –û—á–∏—â–∞–µ–º —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ
      await clearAllData();

      // 2. –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      if (data.accounts) {
        const result = await restoreAccounts(data.accounts);
        results.push({ step: '–°—á–µ—Ç–∞', ...result });
      }

      if (data.categories) {
        const result = await restoreCategories(data.categories);
        results.push({ step: '–ö–∞—Ç–µ–≥–æ—Ä–∏–∏', ...result });
      }

      if (data.transactions) {
        const result = await restoreTransactions(data.transactions);
        results.push({ step: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏', ...result });
      }

      if (data.debts) {
        const result = await restoreDebts(data.debts);
        results.push({ step: '–î–æ–ª–≥–∏', ...result });
      }

      if (data.credits) {
        const result = await restoreCredits(data.credits);
        results.push({ step: '–ö—Ä–µ–¥–∏—Ç—ã', ...result });
      }

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± –∏–º–ø–æ—Ä—Ç–µ
      await backupService.saveRestoreHistory(backupData.metadata);

      return {
        success: true,
        results,
        importedAt: new Date().toISOString(),
        previousBackup: currentBackup.data,
        summary: {
          accounts: data.accounts?.length || 0,
          transactions: data.transactions?.length || 0,
          debts: data.debts?.length || 0,
          credits: data.credits?.length || 0
        }
      };

    } catch (error) {
      console.error('‚ùå Error performing full import:', error);
      return {
        success: false,
        error: `–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –∏–º–ø–æ—Ä—Ç: ${error.message}`,
        details: error.message
      };
    }
  };

  // üìä –ü–û–õ–£–ß–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –î–ê–ù–ù–´–•
  const getDataStats = () => {
    return {
      accounts: accounts?.length || 0,
      transactions: transactions?.length || 0,
      debts: debts?.length || 0,
      credits: credits?.length || 0,
      categories: {
        income: categories.income?.length || 0,
        expense: categories.expense?.length || 0
      },
      totalBalance: getTotalBalance(),
      lastTransaction: transactions?.length > 0 ? transactions[0] : null
    };
  };

  // üîî –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
  const schedulePaymentReminders = async () => {
    try {
      console.log('üîî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π –æ –ø–ª–∞—Ç–µ–∂–∞—Ö...');
      
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏
      const regularPayments = analyticsService.analyzeRegularPayments(transactions, categories);
      
      // –ü–ª–∞–Ω–∏—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
      for (const payment of regularPayments) {
        if (payment.confidence > 70) { // –¢–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–¥–µ–∂–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
          await notificationService.scheduleRegularPaymentReminder(
            payment.category,
            payment.averageAmount,
            payment.expectedDay
          );
        }
      }
      
      // –ü–ª–∞–Ω–∏—Ä—É–µ–º –µ–∂–µ–º–µ—Å—è—á–Ω—ã–π –æ—Ç—á–µ—Ç
      await notificationService.scheduleMonthlyReport();
      
      console.log('‚úÖ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–π:', error);
    }
  };

  // üìä –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò
  const getMonthlyComparison = (monthsCount = 6) => {
    return analyticsService.compareMonths(transactions, monthsCount);
  };

  const getRegularPaymentsAnalysis = () => {
    return analyticsService.analyzeRegularPayments(transactions, categories);
  };

  const getSpendingForecast = () => {
    return analyticsService.forecastNextMonth(transactions, categories);
  };

  const getEnhancedCategoryAnalytics = (periodMonths = 3) => {
    return analyticsService.getCategoryAnalytics(transactions, categories, periodMonths);
  };

  const getSmartFinancialTips = () => {
    return analyticsService.generateSmartTips(transactions, categories, debts, credits);
  };

  const value = {
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ
    accounts: accounts || [],
    transactions: transactions || [],
    debts: debts || [],
    credits: credits || [],
    categories,
    
    // –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã
    addAccount,
    addTransaction,
    addDebt,
    addCredit,
    deleteAccount,
    transferBetweenAccounts,
    getTotalBalance,
    getRecentTransactions,
    getTransactionsByType,

    // üîß –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –†–ê–ë–û–¢–´ –°–û –°–ß–ï–¢–ê–ú–ò
    updateAccount,
    canDeleteAccount,
    deleteAccountWithCheck,
    archiveAccount,
    getAccountStats,

    // üîß –ú–ï–¢–û–î–´ –î–õ–Ø BACKUP
    clearAllData,
    restoreAccounts,
    restoreTransactions,
    restoreDebts,
    restoreCredits,
    restoreCategories,
    performFullImport,
    getDataStats,

    // üîî –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô
    schedulePaymentReminders,
    
    // üìä –ù–û–í–´–ï –ú–ï–¢–û–î–´ –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò
    getMonthlyComparison,
    getRegularPaymentsAnalysis, 
    getSpendingForecast,
    getEnhancedCategoryAnalytics,
    getSmartFinancialTips,
  };

  return (
    <DataContext.Provider value={value}>
      {children}
    </DataContext.Provider>
  );
};

export const useData = () => {
  const context = useContext(DataContext);
  if (!context) {
    throw new Error('useData must be used within a DataProvider');
  }
  return context;
};

export default DataContext;import React, { useState, useRef } from 'react';
import { 
  View, 
  Text, 
  StyleSheet, 
  ScrollView, 
  TouchableOpacity, 
  Alert,
  TextInput,
  Modal,
  Animated,
  KeyboardAvoidingView,
  Platform,
  ActivityIndicator
} from 'react-native';
import { colors, categoryColors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';

// üîß –ò–ú–ü–û–†–¢ –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–´
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const DebtsScreen = ({ navigation }) => {
  const { debts, accounts, markDebtAsPaid, deleteDebt, addDebtPayment } = useData();
  const [partialPaymentModal, setPartialPaymentModal] = useState(null);
  const [fullPaymentModal, setFullPaymentModal] = useState(null);
  const [paymentAmount, setPaymentAmount] = useState('');
  const [selectedAccountId, setSelectedAccountId] = useState(null);
  
  const [isProcessingPayment, setIsProcessingPayment] = useState(false);
  const [isProcessingFullPayment, setIsProcessingFullPayment] = useState(false);
  const [isProcessingDelete, setIsProcessingDelete] = useState(false);
  const [loadingDebtId, setLoadingDebtId] = useState(null);
  
  const slideAnim = useRef(new Animated.Value(300)).current;
  const fadeAnim = useRef(new Animated.Value(0)).current;
  const scrollViewRef = useRef(null);

  // –†–∞–∑–¥–µ–ª—è–µ–º –¥–æ–ª–≥–∏ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏ –ø–æ–≥–∞—à–µ–Ω–Ω—ã–µ
  const activeDebts = debts.filter(debt => !debt.isPaid);
  const paidDebts = debts.filter(debt => debt.isPaid);

  // –†–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—É–º–º—ã –¥–æ–ª–≥–æ–≤
  const totalGiven = activeDebts
    .filter(debt => debt.type === 'given')
    .reduce((sum, debt) => sum + debt.amount, 0);
  
  const totalTaken = activeDebts
    .filter(debt => debt.type === 'taken')
    .reduce((sum, debt) => sum + debt.amount, 0);

  // –ê–Ω–∏–º–∞—Ü–∏—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const openModal = () => {
    Animated.parallel([
      Animated.timing(fadeAnim, {
        toValue: 1,
        duration: 200,
        useNativeDriver: true,
      }),
      Animated.spring(slideAnim, {
        toValue: 0,
        tension: 50,
        friction: 7,
        useNativeDriver: true,
      })
    ]).start();
  };

  // –ê–Ω–∏–º–∞—Ü–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const closeModal = () => {
    Animated.parallel([
      Animated.timing(fadeAnim, {
        toValue: 0,
        duration: 150,
        useNativeDriver: true,
      }),
      Animated.timing(slideAnim, {
        toValue: 300,
        duration: 150,
        useNativeDriver: true,
      })
    ]).start();
  };

  const showPartialPaymentModal = (debt) => {
    const availableAccounts = getAvailableAccounts(debt.type);
    if (availableAccounts.length === 0) {
      Alert.alert('–û—à–∏–±–∫–∞', `–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ –¥–ª—è ${debt.type === 'given' ? '–∑–∞—á–∏—Å–ª–µ–Ω–∏—è' : '—Å–ø–∏—Å–∞–Ω–∏—è'} —Å—Ä–µ–¥—Å—Ç–≤`);
      return;
    }
    
    setSelectedAccountId(availableAccounts[0].id);
    setPartialPaymentModal(debt);
    setPaymentAmount(debt.remainingAmount.toString());
    openModal();
    
    setTimeout(() => {
      scrollViewRef.current?.scrollToEnd({ animated: true });
    }, 500);
  };

  const showFullPaymentModal = (debt) => {
    const availableAccounts = getAvailableAccounts(debt.type);
    if (availableAccounts.length === 0) {
      Alert.alert('–û—à–∏–±–∫–∞', `–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å—á–µ—Ç–æ–≤ –¥–ª—è ${debt.type === 'given' ? '–∑–∞—á–∏—Å–ª–µ–Ω–∏—è' : '—Å–ø–∏—Å–∞–Ω–∏—è'} —Å—Ä–µ–¥—Å—Ç–≤`);
      return;
    }
    
    setSelectedAccountId(availableAccounts[0].id);
    setFullPaymentModal(debt);
    openModal();
  };

  const hideModal = () => {
    closeModal();
    setTimeout(() => {
      setPartialPaymentModal(null);
      setFullPaymentModal(null);
      setPaymentAmount('');
      setSelectedAccountId(null);
      setIsProcessingPayment(false);
      setIsProcessingFullPayment(false);
    }, 150);
  };

  // –ü–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å—á–µ—Ç–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏
  const getAvailableAccounts = (debtType) => {
    if (debtType === 'given') {
      return accounts;
    } else {
      return accounts.filter(account => account.balance > 0);
    }
  };

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ —Å—á–µ—Ç–µ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è
  const hasSufficientFunds = (accountId, amount) => {
    const account = accounts.find(acc => acc.id === accountId);
    return account && account.balance >= amount;
  };

  // üîß –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ê: –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–ª–≥–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
  const handleDeleteDebt = async (debtId, person) => {
    Alert.alert(
      '–£–¥–∞–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞',
      `–£–¥–∞–ª–∏—Ç—å –¥–æ–ª–≥ "${person}"?`,
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        {
          text: '–£–¥–∞–ª–∏—Ç—å',
          style: 'destructive',
          onPress: async () => {
            try {
              setLoadingDebtId(debtId);
              setIsProcessingDelete(true);
              await deleteDebt(debtId);
              Alert.alert('‚úÖ –£—Å–ø–µ—Ö', '–î–æ–ª–≥ —É–¥–∞–ª–µ–Ω');
            } catch (error) {
              Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –¥–æ–ª–≥');
              console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –¥–æ–ª–≥–∞:', error);
            } finally {
              setLoadingDebtId(null);
              setIsProcessingDelete(false);
            }
          }
        }
      ]
    );
  };

  // üîß –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ê: –§—É–Ω–∫—Ü–∏—è —á–∞—Å—Ç–∏—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
  const confirmPartialPayment = async () => {
    if (!partialPaymentModal || !selectedAccountId) return;

    const amountValue = parseFloat(paymentAmount);

    if (!paymentAmount || isNaN(amountValue) || amountValue <= 0) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
      return;
    }

    if (amountValue > partialPaymentModal.remainingAmount) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞');
      return;
    }

    if (partialPaymentModal.type === 'taken' && !hasSufficientFunds(selectedAccountId, amountValue)) {
      const account = accounts.find(acc => acc.id === selectedAccountId);
      Alert.alert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 
        `–ù–∞ —Å—á–µ—Ç–µ "${account?.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\n–î–æ—Å—Ç—É–ø–Ω–æ: ${formatCurrency(account?.balance || 0, false)}\n–¢—Ä–µ–±—É–µ—Ç—Å—è: ${formatCurrency(amountValue, false)}`);
      return;
    }

    try {
      setIsProcessingPayment(true);
      setLoadingDebtId(partialPaymentModal.id);
      await addDebtPayment(partialPaymentModal.id, amountValue, selectedAccountId);
      Alert.alert('‚úÖ –£—Å–ø–µ—à–Ω–æ', `–ü–ª–∞—Ç–µ–∂ –Ω–∞ ${formatCurrency(amountValue, false)} –≤–Ω–µ—Å–µ–Ω`);
      hideModal();
    } catch (error) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂');
      console.error('–û—à–∏–±–∫–∞ –≤–Ω–µ—Å–µ–Ω–∏—è –ø–ª–∞—Ç–µ–∂–∞:', error);
    } finally {
      setIsProcessingPayment(false);
      setLoadingDebtId(null);
    }
  };

  // üîß –ü–ï–†–ï–†–ê–ë–û–¢–ê–ù–ê: –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ –ø–æ–≥–∞—à–µ–Ω–∏—è —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
  const confirmFullPayment = async () => {
    if (!fullPaymentModal || !selectedAccountId) return;

    const remainingAmount = fullPaymentModal.remainingAmount;

    if (fullPaymentModal.type === 'taken' && !hasSufficientFunds(selectedAccountId, remainingAmount)) {
      const account = accounts.find(acc => acc.id === selectedAccountId);
      Alert.alert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 
        `–ù–∞ —Å—á–µ—Ç–µ "${account?.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤.\n–î–æ—Å—Ç—É–ø–Ω–æ: ${formatCurrency(account?.balance || 0, false)}\n–¢—Ä–µ–±—É–µ—Ç—Å—è: ${formatCurrency(remainingAmount, false)}`);
      return;
    }

    Alert.alert(
      '–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞',
      `–û—Ç–º–µ—Ç–∏—Ç—å –¥–æ–ª–≥ "${fullPaymentModal.person}" –∫–∞–∫ –ø–æ–≥–∞—à–µ–Ω–Ω—ã–π?`,
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        {
          text: '–ü–æ–≥–∞—Å–∏—Ç—å',
          onPress: async () => {
            try {
              setIsProcessingFullPayment(true);
              setLoadingDebtId(fullPaymentModal.id);
              await markDebtAsPaid(fullPaymentModal.id, selectedAccountId);
              hideModal();
            } catch (error) {
              Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥');
              console.error('–û—à–∏–±–∫–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–≥–∞:', error);
            } finally {
              setIsProcessingFullPayment(false);
              setLoadingDebtId(null);
            }
          }
        }
      ]
    );
  };

  const formatDate = (dateString) => {
    const date = new Date(dateString);
    return date.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'long',
      year: 'numeric'
    });
  };

  const getDaysUntilDue = (dueDate) => {
    const due = new Date(dueDate);
    const now = new Date();
    const diffTime = due - now;
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    return diffDays;
  };

  const calculateOverdueInfo = (debt) => {
    if (!debt.isPaid || !debt.datePaid) return { wasOverdue: false, daysOverdue: 0, paidEarly: false };
    
    const dueDate = new Date(debt.dueDate);
    const paidDate = new Date(debt.datePaid);
    const diffTime = paidDate - dueDate;
    const daysOverdue = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    return {
      wasOverdue: daysOverdue > 0,
      daysOverdue: Math.max(0, daysOverdue),
      paidEarly: daysOverdue < 0
    };
  };

  // üîß –î–û–ë–ê–í–õ–ï–ù: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–Ω–æ–ø–∫–∏ —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
  const LoadingButton = ({ 
    onPress, 
    isLoading, 
    disabled, 
    style, 
    textStyle, 
    children,
    loadingText = "–û–±—Ä–∞–±–æ—Ç–∫–∞..." 
  }) => (
    <TouchableOpacity
      style={[style, disabled && styles.buttonDisabled]}
      onPress={onPress}
      disabled={disabled || isLoading}
    >
      {isLoading ? (
        <View style={styles.loadingButtonContent}>
          <ActivityIndicator size="small" color={colors.white} />
          <Text style={[textStyle, styles.loadingButtonText]}>{loadingText}</Text>
        </View>
      ) : (
        children
      )}
    </TouchableOpacity>
  );

  const AccountSelector = ({ selectedAccountId, onAccountSelect, debtType }) => {
    const availableAccounts = getAvailableAccounts(debtType);
    const isIncomeOperation = debtType === 'given';
    
    return (
      <View style={styles.accountSelector}>
        <Text style={styles.accountSelectorTitle}>
          {isIncomeOperation ? '–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç –¥–ª—è –∑–∞—á–∏—Å–ª–µ–Ω–∏—è:' : '–í—ã–±–µ—Ä–∏—Ç–µ —Å—á–µ—Ç –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è:'}
        </Text>
        <ScrollView 
          style={styles.accountsScrollView}
          showsVerticalScrollIndicator={false}
        >
          {availableAccounts.map(account => (
            <TouchableOpacity
              key={account.id}
              style={[
                styles.accountOption,
                selectedAccountId === account.id && styles.accountOptionSelected,
                !isIncomeOperation && account.balance <= 0 && styles.accountOptionDisabled
              ]}
              onPress={() => onAccountSelect(account.id)}
              disabled={!isIncomeOperation && account.balance <= 0}
            >
              <View style={styles.accountIcon}>
                <Text style={styles.accountIconText}>{account.icon}</Text>
              </View>
              <View style={styles.accountInfo}>
                <Text style={styles.accountName}>{account.name}</Text>
                <Text style={styles.accountBalance}>
                  {formatCurrency(account.balance, false)}
                </Text>
                {!isIncomeOperation && account.balance <= 0 && (
                  <Text style={styles.insufficientFundsText}>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤</Text>
                )}
              </View>
              <View style={[
                styles.radioButton,
                selectedAccountId === account.id && styles.radioButtonSelected,
                !isIncomeOperation && account.balance <= 0 && styles.radioButtonDisabled
              ]}>
                {selectedAccountId === account.id && (
                  <View style={styles.radioButtonInner} />
                )}
              </View>
            </TouchableOpacity>
          ))}
        </ScrollView>
      </View>
    );
  };

  const QuickAmountButton = ({ amount, onPress }) => (
    <TouchableOpacity 
      style={styles.quickAmountButton}
      onPress={onPress}
    >
      <Text style={styles.quickAmountText}>{amount}</Text>
    </TouchableOpacity>
  );

  const DebtCard = ({ debt }) => {
    const daysUntilDue = getDaysUntilDue(debt.dueDate);
    const isOverdue = daysUntilDue < 0 && !debt.isPaid;
    const isDueSoon = daysUntilDue <= 3 && daysUntilDue >= 0 && !debt.isPaid;
    const progress = debt.amount > 0 ? (debt.paidAmount / debt.amount) * 100 : 0;
    
    const overdueInfo = debt.isPaid ? calculateOverdueInfo(debt) : null;
    const statusText = debt.isPaid ? 
      (overdueInfo.paidEarly ? '–ü–æ–≥–∞—à–µ–Ω –¥–æ—Å—Ä–æ—á–Ω–æ' : 
       overdueInfo.wasOverdue ? `–ü—Ä–æ—Å—Ä–æ—á–µ–Ω –Ω–∞ ${overdueInfo.daysOverdue} –¥–Ω.` : '–ü–æ–≥–∞—à–µ–Ω –≤–æ–≤—Ä–µ–º—è') 
      : '';

    const isDebtLoading = loadingDebtId === debt.id;

    return (
      <View style={[
        styles.debtCard,
        isDebtLoading && styles.debtCardLoading
      ]}>
        {isDebtLoading && (
          <View style={styles.debtLoadingOverlay}>
            <ActivityIndicator size="large" color={colors.primary} />
            <Text style={styles.debtLoadingText}>–û–±—Ä–∞–±–æ—Ç–∫–∞...</Text>
          </View>
        )}

        <View style={styles.debtHeader}>
          <View style={styles.debtPerson}>
            <Text style={styles.debtIcon}>
              {debt.type === 'given' ? '‚û°Ô∏è' : '‚¨ÖÔ∏è'}
            </Text>
            <View>
              <Text style={styles.debtName}>{debt.person}</Text>
              <Text style={styles.debtDescription}>
                {debt.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}
              </Text>
              <Text style={styles.debtType}>
                {debt.type === 'given' ? '–î–∞–ª –≤ –¥–æ–ª–≥' : '–í–∑—è–ª –≤ –¥–æ–ª–≥'}
              </Text>
            </View>
          </View>
          <Text style={[
            styles.debtAmount,
            debt.type === 'given' ? styles.givenAmount : styles.takenAmount
          ]}>
            {formatCurrency(debt.amount, false)}
          </Text>
        </View>

        {!debt.isPaid && debt.paidAmount > 0 && (
          <View style={styles.progressContainer}>
            <View style={styles.progressBar}>
              <View 
                style={[
                  styles.progressFill,
                  { width: `${progress}%` }
                ]} 
              />
            </View>
            <Text style={styles.progressText}>
              {formatCurrency(debt.paidAmount, false)} / {formatCurrency(debt.amount, false)}
            </Text>
          </View>
        )}

        <View style={styles.debtDetails}>
          <View style={styles.debtDetail}>
            <Text style={styles.debtDetailLabel}>–°–æ–∑–¥–∞–Ω:</Text>
            <Text style={styles.debtDetailValue}>{formatDate(debt.dateGiven)}</Text>
          </View>
          <View style={styles.debtDetail}>
            <Text style={styles.debtDetailLabel}>–í–µ—Ä–Ω—É—Ç—å –¥–æ:</Text>
            <Text style={[
              styles.debtDetailValue,
              isOverdue && styles.overdueText,
              isDueSoon && styles.dueSoonText
            ]}>
              {formatDate(debt.dueDate)} 
              {isOverdue && ` (–ü—Ä–æ—Å—Ä–æ—á–µ–Ω ${Math.abs(daysUntilDue)} –¥–Ω.)`}
              {isDueSoon && !isOverdue && ` (–ß–µ—Ä–µ–∑ ${daysUntilDue} –¥–Ω.)`}
            </Text>
          </View>
          
          {!debt.isPaid && (
            <View style={styles.debtDetail}>
              <Text style={styles.debtDetailLabel}>–û—Å—Ç–∞—Ç–æ–∫:</Text>
              <Text style={styles.debtDetailValue}>
                {formatCurrency(debt.remainingAmount, false)}
              </Text>
            </View>
          )}
          
          {debt.isPaid && statusText && (
            <View style={styles.debtDetail}>
              <Text style={styles.debtDetailLabel}>–°—Ç–∞—Ç—É—Å:</Text>
              <Text style={[
                styles.debtDetailValue,
                overdueInfo.wasOverdue ? styles.overdueText : styles.successText
              ]}>
                {statusText}
              </Text>
            </View>
          )}
        </View>

        {!debt.isPaid && (
          <View style={styles.debtActions}>
            <LoadingButton 
              style={styles.partialButton}
              isLoading={isDebtLoading && isProcessingPayment}
              disabled={isDebtLoading}
              onPress={() => showPartialPaymentModal(debt)}
              textStyle={styles.partialButtonText}
              loadingText="–ü–ª–∞—Ç–µ–∂..."
            >
              <Text style={styles.partialButtonText}>üí≥ –ß–∞—Å—Ç–∏—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂</Text>
            </LoadingButton>

            <LoadingButton 
              style={styles.paidButton}
              isLoading={isDebtLoading && isProcessingFullPayment}
              disabled={isDebtLoading}
              onPress={() => showFullPaymentModal(debt)}
              textStyle={styles.paidButtonText}
              loadingText="–ü–æ–≥–∞—à–µ–Ω–∏–µ..."
            >
              <Text style={styles.paidButtonText}>‚úÖ –ü–æ–≥–∞—à–µ–Ω</Text>
            </LoadingButton>

            <LoadingButton 
              style={styles.deleteButton}
              isLoading={isDebtLoading && isProcessingDelete}
              disabled={isDebtLoading}
              onPress={() => handleDeleteDebt(debt.id, debt.person)}
              textStyle={styles.deleteButtonText}
              loadingText="–£–¥–∞–ª–µ–Ω–∏–µ..."
            >
              <Text style={styles.deleteButtonText}>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</Text>
            </LoadingButton>
          </View>
        )}

        {debt.isPaid && (
          <View style={styles.paidStatus}>
            <Text style={styles.paidStatusText}>‚úÖ –ü–æ–≥–∞—à–µ–Ω</Text>
          </View>
        )}
      </View>
    );
  };

  const currentModal = partialPaymentModal || fullPaymentModal;
  const isPartialPayment = !!partialPaymentModal;

  return (
    <View style={styles.container}>
      {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –®–∞–ø–∫–∞ —ç–∫—Ä–∞–Ω–∞ */}
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>ü§ù –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏</Text>
        <Text style={styles.screenSubtitle}>–í–∞—à–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞</Text>
      </View>

      <ScrollView style={styles.content}>
        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
        <View style={styles.statsGrid}>
          <View style={styles.statCard}>
            <Text style={styles.statValue}>{formatCurrency(totalGiven, false)}</Text>
            <Text style={styles.statLabel}>–î–∞–ª –≤ –¥–æ–ª–≥</Text>
            <Text style={styles.statSubtext}>–î—Ä—É–≥–∏–º</Text>
          </View>
          <View style={styles.statCard}>
            <Text style={[styles.statValue, styles.takenAmount]}>{formatCurrency(totalTaken, false)}</Text>
            <Text style={styles.statLabel}>–í–∑—è–ª –≤ –¥–æ–ª–≥</Text>
            <Text style={styles.statSubtext}>–í–µ—Ä–Ω—É—Ç—å</Text>
          </View>
        </View>

        <View style={styles.section}>
          <Text style={styles.sectionTitle}>
            –ê–∫—Ç–∏–≤–Ω—ã–µ –¥–æ–ª–≥–∏ ({activeDebts.length})
          </Text>
          
          {activeDebts.length > 0 ? (
            activeDebts.map(debt => (
              <DebtCard key={debt.id} debt={debt} />
            ))
          ) : (
            <View style={styles.emptyState}>
              <Text style={styles.emptyStateIcon}>ü§ù</Text>
              <Text style={styles.emptyStateTitle}>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤</Text>
              <Text style={styles.emptyStateText}>
                –í—Å–µ –¥–æ–ª–≥–∏ –ø–æ–≥–∞—à–µ–Ω—ã –∏–ª–∏ –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã
              </Text>
            </View>
          )}
        </View>

        {paidDebts.length > 0 && (
          <View style={styles.section}>
            <Text style={styles.sectionTitle}>
              –ò—Å—Ç–æ—Ä–∏—è –¥–æ–ª–≥–æ–≤ ({paidDebts.length})
            </Text>
            {paidDebts.map(debt => (
              <DebtCard key={debt.id} debt={debt} />
            ))}
          </View>
        )}

        {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è */}
        <TouchableOpacity 
          style={styles.addButton}
          onPress={() => navigation.navigate('AddDebt')}
        >
          <Text style={styles.addButtonIcon}>‚ûï</Text>
          <Text style={styles.addButtonText}>–î–æ–±–∞–≤–∏—Ç—å –¥–æ–ª–≥</Text>
        </TouchableOpacity>
      </ScrollView>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–ª–∞—Ç–µ–∂–µ–π */}
      <Modal
        visible={!!currentModal}
        transparent={true}
        animationType="none"
        onRequestClose={hideModal}
      >
        <KeyboardAvoidingView 
          style={styles.modalContainer}
          behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
          keyboardVerticalOffset={Platform.OS === 'ios' ? 100 : 50}
        >
          <Animated.View 
            style={[
              styles.modalOverlay,
              { opacity: fadeAnim }
            ]}
          >
            <TouchableOpacity 
              style={styles.modalBackdrop}
              activeOpacity={1}
              onPress={hideModal}
            />
            
            <Animated.View 
              style={[
                styles.modalContent,
                { transform: [{ translateY: slideAnim }] }
              ]}
            >
              <View style={styles.modalHeader}>
                <Text style={styles.modalTitle}>
                  {isPartialPayment ? 'üí≥ –ß–∞—Å—Ç–∏—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂' : '‚úÖ –ü–æ–ª–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ'}
                </Text>
                <TouchableOpacity 
                  style={styles.closeButton}
                  onPress={hideModal}
                  disabled={isProcessingPayment || isProcessingFullPayment}
                >
                  <Text style={styles.closeButtonText}>‚úï</Text>
                </TouchableOpacity>
              </View>

              <ScrollView 
                ref={scrollViewRef}
                style={styles.modalScrollView}
                showsVerticalScrollIndicator={false}
                keyboardShouldPersistTaps="handled"
              >
                <View style={styles.modalBody}>
                  <Text style={styles.debtPersonName}>
                    {currentModal?.person}
                  </Text>
                  <Text style={styles.debtDescription}>
                    {currentModal?.description || '–ë–µ–∑ –æ–ø–∏—Å–∞–Ω–∏—è'}
                  </Text>
                  
                  <View style={styles.amountInfo}>
                    <Text style={styles.amountLabel}>
                      {isPartialPayment ? '–û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞:' : '–°—É–º–º–∞ –∫ –ø–æ–≥–∞—à–µ–Ω–∏—é:'}
                    </Text>
                    <Text style={styles.amountValue}>
                      {formatCurrency(
                        isPartialPayment ? currentModal?.remainingAmount : currentModal?.remainingAmount, 
                        false
                      )}
                    </Text>
                  </View>

                  <AccountSelector
                    selectedAccountId={selectedAccountId}
                    onAccountSelect={setSelectedAccountId}
                    debtType={currentModal?.type}
                  />

                  {isPartialPayment && (
                    <View style={styles.amountSection}>
                      <Text style={styles.amountInputLabel}>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:</Text>
                      <TextInput
                        style={styles.amountInput}
                        placeholder="0.00"
                        value={paymentAmount}
                        onChangeText={setPaymentAmount}
                        keyboardType="numeric"
                        placeholderTextColor={colors.textSecondary}
                        onFocus={() => {
                          setTimeout(() => {
                            scrollViewRef.current?.scrollToEnd({ animated: true });
                          }, 300);
                        }}
                        editable={!isProcessingPayment}
                      />
                      
                      <View style={styles.quickAmounts}>
                        <Text style={styles.quickAmountsLabel}>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥:</Text>
                        <View style={styles.quickAmountsRow}>
                          {[100, 500, 1000, 5000].map(amount => (
                            <QuickAmountButton
                              key={amount}
                              amount={amount}
                              onPress={() => setPaymentAmount(amount.toString())}
                            />
                          ))}
                        </View>
                      </View>
                    </View>
                  )}
                </View>
              </ScrollView>

              <View style={styles.modalFooter}>
                <LoadingButton 
                  style={[
                    styles.confirmButton,
                    (!selectedAccountId || (isPartialPayment && !paymentAmount)) && styles.confirmButtonDisabled
                  ]}
                  onPress={isPartialPayment ? confirmPartialPayment : confirmFullPayment}
                  disabled={!selectedAccountId || (isPartialPayment && !paymentAmount)}
                  isLoading={isProcessingPayment || isProcessingFullPayment}
                  textStyle={styles.confirmButtonText}
                  loadingText={isPartialPayment ? "–í–Ω–µ—Å–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞..." : "–ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞..."}
                >
                  <Text style={styles.confirmButtonText}>
                    {isPartialPayment ? '–í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂' : '–ü–æ–≥–∞—Å–∏—Ç—å –¥–æ–ª–≥'}
                  </Text>
                </LoadingButton>
                
                <TouchableOpacity 
                  style={[
                    styles.cancelButton,
                    (isProcessingPayment || isProcessingFullPayment) && styles.cancelButtonDisabled
                  ]}
                  onPress={hideModal}
                  disabled={isProcessingPayment || isProcessingFullPayment}
                >
                  <Text style={styles.cancelButtonText}>–û—Ç–º–µ–Ω–∞</Text>
                </TouchableOpacity>
              </View>
            </Animated.View>
          </Animated.View>
        </KeyboardAvoidingView>
      </Modal>
    </View>
  );
};

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    ...commonStyles.screen.header,
  },
  screenTitle: {
    ...commonStyles.screen.title,
  },
  screenSubtitle: {
    ...commonStyles.screen.subtitle,
  },
  content: {
    ...commonStyles.screen.content,
  },
  statsGrid: {
    flexDirection: 'row',
    gap: spacing.md,
    marginBottom: spacing.xxl,
  },
  statCard: {
    ...commonStyles.cards.stats,
    flex: 1,
    alignItems: 'center',
  },
  statValue: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  takenAmount: {
    color: colors.success,
  },
  givenAmount: {
    color: colors.error,
  },
  statLabel: {
    fontSize: 14,
    color: colors.textPrimary,
    fontWeight: '600',
    marginBottom: 2,
  },
  statSubtext: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  section: {
    marginBottom: spacing.xxl,
  },
  sectionTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.lg,
  },
  // üîß –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–æ–ª–≥–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  debtCard: {
    ...commonStyles.cards.surface,
    marginBottom: spacing.md,
    position: 'relative',
  },
  debtCardLoading: {
    opacity: 0.7,
  },
  debtLoadingOverlay: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: 'rgba(255, 255, 255, 0.8)',
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    justifyContent: 'center',
    zIndex: 10,
  },
  debtLoadingText: {
    marginTop: spacing.sm,
    fontSize: 14,
    color: colors.primary,
    fontWeight: '600',
  },
  debtHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: spacing.md,
  },
  debtPerson: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    gap: spacing.md,
    flex: 1,
  },
  debtIcon: {
    fontSize: 20,
    marginTop: 2,
  },
  debtName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  debtDescription: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
  },
  debtType: {
    fontSize: 12,
    color: colors.primary,
    fontWeight: '600',
  },
  debtAmount: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  progressContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: spacing.md,
    marginBottom: spacing.md,
  },
  progressBar: {
    ...commonStyles.progress.container,
    flex: 1,
  },
  progressFill: {
    ...commonStyles.progress.fill,
    backgroundColor: colors.primary,
  },
  progressText: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '600',
  },
  debtDetails: {
    marginBottom: spacing.md,
  },
  debtDetail: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.xs,
  },
  debtDetailLabel: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  debtDetailValue: {
    fontSize: 12,
    color: colors.textPrimary,
    fontWeight: '500',
  },
  overdueText: {
    color: colors.error,
    fontWeight: 'bold',
  },
  dueSoonText: {
    color: colors.warning,
    fontWeight: '600',
  },
  successText: {
    color: colors.success,
    fontWeight: '600',
  },
  debtActions: {
    flexDirection: 'row',
    gap: spacing.sm,
  },
  partialButton: {
    flex: 2,
    backgroundColor: '#ebf8ff',
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    borderWidth: 1,
    borderColor: colors.primary,
    minHeight: 40,
    justifyContent: 'center',
  },
  partialButtonText: {
    color: colors.primary,
    fontSize: 12,
    fontWeight: '600',
  },
  paidButton: {
    flex: 1,
    backgroundColor: '#f0fff4',
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    borderWidth: 1,
    borderColor: colors.success,
    minHeight: 40,
    justifyContent: 'center',
  },
  paidButtonText: {
    color: colors.success,
    fontSize: 12,
    fontWeight: '600',
  },
  deleteButton: {
    backgroundColor: '#fed7d7',
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.md,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    borderWidth: 1,
    borderColor: colors.error,
    minHeight: 40,
    justifyContent: 'center',
  },
  deleteButtonText: {
    color: colors.error,
    fontSize: 12,
    fontWeight: '600',
  },
  // üîß –°—Ç–∏–ª–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Å –∑–∞–≥—Ä—É–∑–∫–æ–π
  buttonDisabled: {
    opacity: 0.6,
  },
  loadingButtonContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: spacing.xs,
  },
  loadingButtonText: {
    fontSize: 12,
    marginLeft: spacing.xs,
  },
  paidStatus: {
    alignItems: 'center',
    paddingTop: spacing.sm,
    borderTopWidth: 1,
    borderTopColor: colors.border,
  },
  paidStatusText: {
    color: colors.success,
    fontSize: 13,
    fontWeight: '600',
  },
  emptyState: {
    alignItems: 'center',
    paddingVertical: spacing.xxxl,
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.xl,
  },
  emptyStateIcon: {
    fontSize: 48,
    marginBottom: spacing.lg,
    opacity: 0.5,
  },
  emptyStateTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
    textAlign: 'center',
  },
  emptyStateText: {
    fontSize: 14,
    color: colors.textSecondary,
    textAlign: 'center',
  },
  // üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
  addButton: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    backgroundColor: colors.primary,
    paddingVertical: spacing.lg,
    borderRadius: borderRadius.xl,
    marginBottom: spacing.xxxl,
    ...shadows.lg,
    gap: spacing.md,
  },
  addButtonIcon: {
    fontSize: 20,
    color: colors.white,
  },
  addButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },

  // –°—Ç–∏–ª–∏ –¥–ª—è –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω (–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –∫–∞–∫ –µ—Å—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏)
  modalContainer: {
    flex: 1,
  },
  modalOverlay: {
    flex: 1,
    justifyContent: 'flex-end',
  },
  modalBackdrop: {
    ...StyleSheet.absoluteFillObject,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
  },
  modalContent: {
    backgroundColor: colors.surface,
    borderTopLeftRadius: borderRadius.xxl,
    borderTopRightRadius: borderRadius.xxl,
    maxHeight: '90%',
    ...shadows.xl,
  },
  modalHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: spacing.xxl,
    paddingTop: spacing.xl,
    paddingBottom: spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  modalTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    flex: 1,
  },
  closeButton: {
    width: 32,
    height: 32,
    borderRadius: borderRadius.lg,
    backgroundColor: colors.background,
    alignItems: 'center',
    justifyContent: 'center',
  },
  closeButtonText: {
    fontSize: 16,
    color: colors.textSecondary,
    fontWeight: 'bold',
  },
  modalScrollView: {
    maxHeight: 400,
  },
  modalBody: {
    padding: spacing.xxl,
  },
  debtPersonName: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.xs,
  },
  debtDescription: {
    fontSize: 14,
    color: colors.textSecondary,
    textAlign: 'center',
    marginBottom: spacing.xl,
  },
  amountInfo: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    backgroundColor: colors.background,
    padding: spacing.lg,
    borderRadius: borderRadius.md,
    marginBottom: spacing.xl,
  },
  amountLabel: {
    fontSize: 14,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  amountValue: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
  },
  accountSelector: {
    marginBottom: spacing.xl,
  },
  accountSelectorTitle: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.md,
  },
  accountsScrollView: {
    maxHeight: 150,
  },
  accountOption: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.background,
    padding: spacing.md,
    borderRadius: borderRadius.md,
    marginBottom: spacing.sm,
    borderWidth: 2,
    borderColor: 'transparent',
  },
  accountOptionSelected: {
    backgroundColor: '#f0f9ff',
    borderColor: colors.primary,
  },
  accountOptionDisabled: {
    opacity: 0.5,
  },
  accountIcon: {
    width: 40,
    height: 40,
    borderRadius: borderRadius.md,
    backgroundColor: colors.border,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
  },
  accountIconText: {
    fontSize: 16,
  },
  accountInfo: {
    flex: 1,
  },
  accountName: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  accountBalance: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  insufficientFundsText: {
    fontSize: 10,
    color: colors.error,
    marginTop: 2,
  },
  radioButton: {
    width: 20,
    height: 20,
    borderRadius: borderRadius.pill,
    borderWidth: 2,
    borderColor: colors.border,
    alignItems: 'center',
    justifyContent: 'center',
  },
  radioButtonSelected: {
    borderColor: colors.primary,
    backgroundColor: colors.primary,
  },
  radioButtonDisabled: {
    borderColor: colors.error,
  },
  radioButtonInner: {
    width: 8,
    height: 8,
    borderRadius: borderRadius.xs,
    backgroundColor: colors.white,
  },
  amountSection: {
    marginTop: spacing.sm,
  },
  amountInputLabel: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.sm,
  },
  amountInput: {
    backgroundColor: colors.background,
    borderWidth: 2,
    borderColor: colors.border,
    borderRadius: borderRadius.md,
    padding: spacing.lg,
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.lg,
  },
  quickAmounts: {
    marginBottom: spacing.sm,
  },
  quickAmountsLabel: {
    fontSize: 12,
    color: colors.textSecondary,
    marginBottom: spacing.sm,
    textAlign: 'center',
  },
  quickAmountsRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    gap: spacing.sm,
  },
  quickAmountButton: {
    flex: 1,
    backgroundColor: colors.background,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.sm,
    alignItems: 'center',
  },
  quickAmountText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textSecondary,
  },
  modalFooter: {
    padding: spacing.xxl,
    paddingTop: 0,
    gap: spacing.md,
  },
  confirmButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.lg,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    ...shadows.lg,
    minHeight: 56,
    justifyContent: 'center',
  },
  confirmButtonDisabled: {
    backgroundColor: colors.border,
    shadowOpacity: 0,
    elevation: 0,
  },
  confirmButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },
  cancelButton: {
    backgroundColor: 'transparent',
    paddingVertical: spacing.lg,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    borderWidth: 1,
    borderColor: colors.border,
    minHeight: 52,
    justifyContent: 'center',
  },
  cancelButtonDisabled: {
    opacity: 0.5,
  },
  cancelButtonText: {
    color: colors.textSecondary,
    fontSize: 16,
    fontWeight: '600',
  },
});

export default DebtsScreen;// src/theme/designSystem.js - –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–ê–Ø –†–ê–ë–û–ß–ê–Ø –í–ï–†–°–ò–Ø
import { Dimensions, Platform } from 'react-native';
import { colors } from './colors';

const { width, height } = Dimensions.get('window');

// üîß –ë–ê–ó–û–í–´–ï –ö–û–ù–°–¢–ê–ù–¢–´
const SPACING = {
  xs: 4,
  sm: 8,
  md: 12,
  lg: 16,
  xl: 20,
  xxl: 24,
  xxxl: 32,
};

const BORDER_RADIUS = {
  xs: 4,
  sm: 8,
  md: 12,
  lg: 16,
  xl: 20,
  xxl: 24,
  pill: 50,
};

// üîß –¢–ï–ù–ò - –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û –û–ü–†–ï–î–ï–õ–ï–ù–´
const SHADOWS = {
  sm: {
    shadowColor: '#1E293B',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.08,
    shadowRadius: 4,
    elevation: 2,
  },
  md: {
    shadowColor: '#1E293B',
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
    elevation: 4,
  },
  lg: {
    shadowColor: '#1E293B',
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.12,
    shadowRadius: 12,
    elevation: 8,
  },
  xl: {
    shadowColor: '#1E293B',
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.15,
    shadowRadius: 16,
    elevation: 12,
  },
};

// üîß –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–¢–ò–õ–ï–ô
export const commonStyles = {
  // üì± –≠–ö–†–ê–ù
  screen: {
    container: {
      flex: 1,
      backgroundColor: colors.background,
    },
    header: {
      paddingTop: Platform.OS === 'ios' ? 60 : 50,
      paddingHorizontal: SPACING.xl,
      paddingBottom: SPACING.lg,
      backgroundColor: colors.background,
      borderBottomWidth: 1,
      borderBottomColor: colors.border,
    },
    title: {
      fontSize: 22,
      fontWeight: 'bold',
      color: colors.textPrimary,
      textAlign: 'center',
      marginBottom: SPACING.xs,
    },
    subtitle: {
      fontSize: 14,
      color: colors.textSecondary,
      textAlign: 'center',
      lineHeight: 18,
    },
    content: {
      flex: 1,
      paddingHorizontal: SPACING.xl,
      paddingTop: SPACING.lg,
      paddingBottom: SPACING.xxl,
    },
  },

  // üéØ –ö–ê–†–¢–û–ß–ö–ò
  cards: {
    surface: {
      backgroundColor: colors.surface,
      borderRadius: BORDER_RADIUS.lg,
      padding: SPACING.lg,
      ...SHADOWS.md,
    },
    elevated: {
      backgroundColor: colors.surface,
      borderRadius: BORDER_RADIUS.xl,
      padding: SPACING.xl,
      ...SHADOWS.lg,
    },
    stats: {
      backgroundColor: colors.surface,
      borderRadius: BORDER_RADIUS.xl,
      padding: SPACING.xl,
      ...SHADOWS.lg,
    },
  },

  // üîò –ö–ù–û–ü–ö–ò
  buttons: {
    primary: {
      backgroundColor: colors.primary,
      paddingVertical: SPACING.lg,
      paddingHorizontal: SPACING.xl,
      borderRadius: BORDER_RADIUS.lg,
      alignItems: 'center',
      justifyContent: 'center',
      ...SHADOWS.lg,
      minHeight: 56,
    },
    primaryText: {
      color: colors.white,
      fontSize: 16,
      fontWeight: 'bold',
      textAlign: 'center',
    },
    
    secondary: {
      backgroundColor: 'transparent',
      paddingVertical: SPACING.md,
      paddingHorizontal: SPACING.xl,
      borderRadius: BORDER_RADIUS.lg,
      alignItems: 'center',
      justifyContent: 'center',
      borderWidth: 2,
      borderColor: colors.border,
      minHeight: 52,
    },
    secondaryText: {
      color: colors.textSecondary,
      fontSize: 16,
      fontWeight: '600',
      textAlign: 'center',
    },
    
    danger: {
      backgroundColor: colors.error,
      paddingVertical: SPACING.lg,
      paddingHorizontal: SPACING.xl,
      borderRadius: BORDER_RADIUS.lg,
      alignItems: 'center',
      justifyContent: 'center',
      ...SHADOWS.lg,
      minHeight: 56,
    },
    dangerText: {
      color: colors.white,
      fontSize: 16,
      fontWeight: 'bold',
      textAlign: 'center',
    },
    
    quickAction: {
      backgroundColor: colors.surface,
      padding: SPACING.lg,
      borderRadius: BORDER_RADIUS.lg,
      alignItems: 'center',
      flex: 1,
      minWidth: '48%',
      ...SHADOWS.sm,
      borderLeftWidth: 4,
    },
    quickActionText: {
      fontSize: 14,
      fontWeight: '600',
      color: colors.textPrimary,
      textAlign: 'center',
      marginTop: SPACING.sm,
    },
  },

  // üìù –§–û–†–ú–´
  forms: {
    inputContainer: {
      backgroundColor: colors.surface,
      borderRadius: BORDER_RADIUS.lg,
      paddingHorizontal: SPACING.lg,
      paddingVertical: SPACING.md,
      ...SHADOWS.md,
      borderWidth: 2,
      borderColor: 'transparent',
    },
    input: {
      fontSize: 16,
      color: colors.textPrimary,
      padding: 0,
      flex: 1,
    },
    inputFocused: {
      borderColor: colors.primary,
      ...SHADOWS.lg,
    },
    label: {
      fontSize: 16,
      fontWeight: '600',
      color: colors.textPrimary,
      marginBottom: SPACING.sm,
    },
    error: {
      fontSize: 14,
      color: colors.error,
      marginTop: SPACING.xs,
      fontWeight: '500',
    },
  },

  // üìä –°–ï–ö–¶–ò–ò
  sections: {
    header: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: SPACING.lg,
    },
    title: {
      fontSize: 20,
      fontWeight: 'bold',
      color: colors.textPrimary,
    },
    subtitle: {
      fontSize: 14,
      color: colors.textSecondary,
      fontWeight: '500',
    },
  },

  // üìà –ü–†–û–ì–†–ï–°–° –ë–ê–†–´
  progress: {
    container: {
      height: 6,
      backgroundColor: colors.border,
      borderRadius: BORDER_RADIUS.pill,
      overflow: 'hidden',
    },
    fill: {
      height: '100%',
      borderRadius: BORDER_RADIUS.pill,
    },
  },

  // üé™ –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò
  special: {
    badge: {
      paddingHorizontal: SPACING.sm,
      paddingVertical: SPACING.xs,
      borderRadius: BORDER_RADIUS.pill,
      alignSelf: 'flex-start',
    },
    badgePrimary: {
      backgroundColor: colors.primary,
    },
    badgeSuccess: {
      backgroundColor: colors.success,
    },
    badgeText: {
      color: colors.white,
      fontSize: 12,
      fontWeight: '600',
    },
  },
};

// üîß –ü–†–Ø–ú–´–ï –≠–ö–°–ü–û–†–¢–´ (–±–µ–∑ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤)
export const spacing = SPACING;
export const borderRadius = BORDER_RADIUS;
export const shadows = SHADOWS;

// üîß –£–¢–ò–õ–ò–¢–´
export const createShadow = (level = 'md') => SHADOWS[level];
export const createSpacing = (vertical = 0, horizontal = 0) => ({
  paddingVertical: vertical,
  paddingHorizontal: horizontal,
});

// üîß –î–ò–ó–ê–ô–ù –°–ò–°–¢–ï–ú–ê (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
export const DESIGN_SYSTEM = {
  screen: { width, height },
  spacing: SPACING,
  borderRadius: BORDER_RADIUS,
  shadows: SHADOWS,
  animations: {
    duration: { fast: 200, normal: 300, slow: 500 },
    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
  },
};// src/screens/EditAccountScreen.js - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø –° –ü–†–ê–í–ò–õ–¨–ù–û–ô –ù–ê–í–ò–ì–ê–¶–ò–ï–ô
import React, { useState, useEffect, useRef } from 'react';
import {
  View,
  Text,
  TextInput,
  ScrollView,
  TouchableOpacity,
  Alert,
  Modal,
  SafeAreaView,
  KeyboardAvoidingView,
  Platform,
  ActivityIndicator,
  Keyboard
} from 'react-native';
import { useData } from '../context/DataContext';
import { colors } from '../theme/colors';
import { commonStyles, spacing, borderRadius } from '../theme/designSystem';
import { formatCurrency } from '../utils/currencyFormatter';

const EditAccountScreen = ({ route, navigation }) => {
  const { accountId } = route.params;
  const { 
    accounts, 
    updateAccount, 
    deleteAccountWithCheck,
    archiveAccount,
    getAccountStats,
    canDeleteAccount
  } = useData();

  // üîß –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º useEffect –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ accounts
  const account = accounts.find(acc => acc.id === accountId);
  
  // üîß –ü–†–û–°–¢–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø
  const [name, setName] = useState('');
  const [balance, setBalance] = useState('0');
  const [type, setType] = useState('card');
  const [icon, setIcon] = useState('üí≥');
  const [color, setColor] = useState('#6C63FF');
  
  const [loading, setLoading] = useState(false);
  const [showIconPicker, setShowIconPicker] = useState(false);
  const [showColorPicker, setShowColorPicker] = useState(false);
  const [showDangerActions, setShowDangerActions] = useState(false);
  const [lastAccountType, setLastAccountType] = useState(''); // üîß –ù–û–í–û–ï: –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

  // üîß REF –î–õ–Ø –ü–†–û–ö–†–£–¢–ö–ò
  const scrollViewRef = useRef(null);

  // üîß –ò–ö–û–ù–ö–ò –ò –¶–í–ï–¢–ê
  const iconList = [
    'üí≥', 'üíµ', 'üí∞', 'üè¶', 'üíé', 'üíº', 'üìä', 'üí∏', 'üè†', 'üöó',
    '‚úàÔ∏è', 'üõí', 'üçî', 'üè•', 'üéì', 'üé¨', '‚öΩ', 'üéÆ', 'üì±', 'üíª'
  ];

  const colorList = [
    '#6C63FF', '#FF6584', '#36D1DC', '#4CAF50', '#FF9800',
    '#F44336', '#2196F3', '#9C27B0', '#009688', '#FFC107'
  ];

  // üîß –¢–ò–ü–´ –°–ß–ï–¢–û–í
  const accountTypes = [
    { value: 'card', label: 'üí≥ –ö–∞—Ä—Ç–∞', color: '#6C63FF', bgColor: '#6C63FF20' },
    { value: 'cash', label: 'üíµ –ù–∞–ª–∏—á–Ω—ã–µ', color: '#4CAF50', bgColor: '#4CAF5020' },
    { value: 'savings', label: 'üí∞ –°–±–µ—Ä–µ–∂–µ–Ω–∏—è', color: '#2196F3', bgColor: '#2196F320' },
    { value: 'credit', label: 'üè¶ –ö—Ä–µ–¥–∏—Ç–Ω–∞—è', color: '#F44336', bgColor: '#F4433620' },
    { value: 'investment', label: 'üìà –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏', color: '#FF9800', bgColor: '#FF980020' },
    { value: 'other', label: 'üéØ –î—Ä—É–≥–æ–µ', color: '#9C27B0', bgColor: '#9C27B020' }
  ];

  // üîß –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• - –ö–†–ò–¢–ò–ß–ï–°–ö–û–ï –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï
  useEffect(() => {
    console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å—á–µ—Ç–∞:', {
      accountId,
      hasAccount: !!account,
      accountType: account?.type,
      lastAccountType
    });

    if (account) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∏–∑–º–µ–Ω–∏–ª—Å—è –ª–∏ —Ç–∏–ø —Å—á–µ—Ç–∞ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
      if (account.type !== lastAccountType) {
        console.log('üéØ –¢–∏–ø —Å—á–µ—Ç–∞ –∏–∑–º–µ–Ω–∏–ª—Å—è –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ!', {
          oldType: lastAccountType,
          newType: account.type
        });
        setLastAccountType(account.type);
      }

      // üîß –û–ë–ù–û–í–õ–Ø–ï–ú –õ–û–ö–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï –¢–û–õ–¨–ö–û –ï–°–õ–ò –ê–ö–ö–ê–£–ù–¢ –ò–ó–ú–ï–ù–ò–õ–°–Ø
      if (account.type !== type && account.type) {
        console.log('üîÑ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ç–∏–ø–∞:', account.type);
        setType(account.type);
      }
      
      setName(account.name || '');
      setBalance(account.balance?.toString() || '0');
      // setType —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤—ã—à–µ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
      if (account.icon) setIcon(account.icon);
      if (account.color) setColor(account.color);
    }
  }, [account, accounts]); // üîß –í–ê–ñ–ù–û: –î–æ–±–∞–≤–ª—è–µ–º accounts –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏

  // üîß –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ü–†–ò –ü–ï–†–í–û–ô –ó–ê–ì–†–£–ó–ö–ï
  useEffect(() => {
    if (account && !lastAccountType) {
      console.log('üì• –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–∞:', {
        id: account.id,
        name: account.name,
        type: account.type,
        balance: account.balance,
        icon: account.icon,
        color: account.color
      });
      
      setName(account.name || '');
      setBalance(account.balance?.toString() || '0');
      setType(account.type || 'card');
      setIcon(account.icon || 'üí≥');
      setColor(account.color || '#6C63FF');
      setLastAccountType(account.type || 'card');
    } else if (!account) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—á–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
      navigation.goBack();
    }
  }, [account]);

  // üîß –ü–†–û–°–¢–ê–Ø –ê–í–¢–û–ü–†–û–ö–†–£–¢–ö–ê
  const scrollToInput = (inputName) => {
    setTimeout(() => {
      if (scrollViewRef.current) {
        let yPosition = 0;
        
        if (inputName === 'name') {
          yPosition = 400;
        } else if (inputName === 'balance') {
          yPosition = 550;
        }
        
        scrollViewRef.current.scrollTo({
          y: yPosition,
          animated: true
        });
      }
    }, 100);
  };

  // üîß –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –ë–ê–õ–ê–ù–°–ê
  const handleBalanceChange = (text) => {
    const cleaned = text.replace(/[^\d.]/g, '');
    const parts = cleaned.split('.');
    
    if (parts.length > 2) return;
    if (parts[1] && parts[1].length > 2) return;
    
    setBalance(cleaned);
  };

  // üîß –°–û–•–†–ê–ù–ï–ù–ò–ï –° –£–í–ï–î–û–ú–õ–ï–ù–ò–ï–ú –û–ë –ò–ó–ú–ï–ù–ï–ù–ò–Ø–•
  const handleSave = async () => {
  Keyboard.dismiss();
  
  if (!name.trim()) {
    Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞');
    return;
  }

  setLoading(true);
  try {
    const updates = {
      name: name.trim(),
      balance: parseFloat(balance) || 0,
      type: type,
      icon: icon,
      color: color
    };

    console.log('üíæ –°–æ—Ö—Ä–∞–Ω—è—é —Å—á–µ—Ç:', {
      accountId,
      updates,
      currentTypeInUI: type,
      currentTypeInContext: account?.type
    });
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –±–∞–∑—É –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç
    const result = await updateAccount(accountId, updates);
    console.log('‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', result);
    
    // üîß –í–ê–ñ–ù–û: –î–∞–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç—É –≤—Ä–µ–º—è –æ–±–Ω–æ–≤–∏—Ç—å—Å—è
    await new Promise(resolve => setTimeout(resolve, 300));
    
    // üîß –í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º refetch –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–∏–ø –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏–ª—Å—è
    const refreshedAccount = accounts.find(acc => acc.id === accountId);
    console.log('üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', {
      expectedType: type,
      actualTypeInContext: refreshedAccount?.type,
      same: type === refreshedAccount?.type
    });
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    Alert.alert(
      '‚úÖ –£—Å–ø–µ—Ö', 
      `–°—á–µ—Ç "${name}" –æ–±–Ω–æ–≤–ª–µ–Ω\n–¢–∏–ø –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${type}`,
      [{ 
        text: 'OK', 
        onPress: () => {
          // üîß –í–ê–ñ–ù–û: –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –Ω–∞ —ç–∫—Ä–∞–Ω —Å—á–µ—Ç–æ–≤ —á–µ—Ä–µ–∑ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞–∑–∞–¥
          navigation.goBack();
        }
      }]
    );
    
  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
    Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç: ' + error.message);
  } finally {
    setLoading(false);
  }
};

  // üîß –£–î–ê–õ–ï–ù–ò–ï
  const handleDelete = async () => {
    Keyboard.dismiss();
    
    Alert.alert(
      '‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–∏–µ —Å—á–µ—Ç–∞',
      '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å—á–µ—Ç? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.',
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        {
          text: '–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —É–¥–∞–ª–µ–Ω–∏—è',
          onPress: async () => {
            const checkResult = await canDeleteAccount(accountId);
            
            if (checkResult.canDelete) {
              confirmDelete();
            } else {
              let message = '–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç:\n';
              if (checkResult.hasTransactions) message += '‚Ä¢ –ï—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏\n';
              if (checkResult.hasLinkedData) message += '‚Ä¢ –ï—Å—Ç—å —Å–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–ª–≥–∏ –∏–ª–∏ –∫—Ä–µ–¥–∏—Ç—ã\n\n';
              message += '–†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –∑–∞–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç.';
              
              Alert.alert(
                '–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —É–¥–∞–ª–∏—Ç—å',
                message,
                [
                  { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
                  { text: '–ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å', onPress: () => handleArchive() }
                ]
              );
            }
          }
        }
      ]
    );
  };

  const confirmDelete = async () => {
    setLoading(true);
    try {
      const result = await deleteAccountWithCheck(accountId);
      Alert.alert(
        '‚úÖ –£—Å–ø–µ—Ö',
        result.message || '–°—á–µ—Ç —É–¥–∞–ª–µ–Ω',
        [{ text: 'OK', onPress: () => navigation.goBack() }]
      );
    } catch (error) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç');
    } finally {
      setLoading(false);
    }
  };

  // üîß –ê–†–•–ò–í–ê–¶–ò–Ø
  const handleArchive = async () => {
    Keyboard.dismiss();
    
    const isArchived = !getAccountStats(accountId).isActive;
    const action = isArchived ? '–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å';
    
    Alert.alert(
      `${isArchived ? 'üìÅ –ê—Ä—Ö–∏–≤–∞—Ü–∏—è' : 'üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ'}`,
      `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ ${action} —ç—Ç–æ—Ç —Å—á–µ—Ç?`,
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        {
          text: action,
          onPress: async () => {
            setLoading(true);
            try {
              const result = await archiveAccount(accountId, isArchived);
              Alert.alert(
                '‚úÖ –£—Å–ø–µ—Ö',
                result.message,
                [{ text: 'OK', onPress: () => navigation.goBack() }]
              );
            } catch (error) {
              Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é');
            } finally {
              setLoading(false);
            }
          }
        }
      ]
    );
  };

  // üîß –°–ë–†–û–° –ë–ê–õ–ê–ù–°–ê
  const handleResetBalance = () => {
    Keyboard.dismiss();
    
    Alert.alert(
      'üîÑ –°–±—Ä–æ—Å –±–∞–ª–∞–Ω—Å–∞',
      '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å –≤ 0? –≠—Ç–æ –Ω–µ —É–¥–∞–ª–∏—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ç–æ–ª—å–∫–æ –æ–±–Ω—É–ª–∏—Ç –±–∞–ª–∞–Ω—Å.',
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        {
          text: '–°–±—Ä–æ—Å–∏—Ç—å',
          style: 'destructive',
          onPress: () => {
            setBalance('0');
          }
        }
      ]
    );
  };

  // üîß –í–´–ë–û–† –ò–ö–û–ù–ö–ò
  const IconPicker = () => (
    <Modal visible={showIconPicker} transparent animationType="slide">
      <View style={styles.modalOverlay}>
        <View style={styles.modalContent}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>–í—ã–±–µ—Ä–∏—Ç–µ –∏–∫–æ–Ω–∫—É</Text>
            <TouchableOpacity 
              onPress={() => setShowIconPicker(false)}
              hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
            >
              <Text style={styles.closeButton}>‚úï</Text>
            </TouchableOpacity>
          </View>
          <ScrollView 
            contentContainerStyle={styles.iconGrid}
            keyboardShouldPersistTaps="handled"
          >
            {iconList.map((item, index) => (
              <TouchableOpacity
                key={index}
                style={[styles.iconOption, icon === item && styles.selectedIcon]}
                onPress={() => {
                  setIcon(item);
                  setShowIconPicker(false);
                }}
              >
                <Text style={styles.iconText}>{item}</Text>
              </TouchableOpacity>
            ))}
          </ScrollView>
        </View>
      </View>
    </Modal>
  );

  // üîß –í–´–ë–û–† –¶–í–ï–¢–ê
  const ColorPicker = () => (
    <Modal visible={showColorPicker} transparent animationType="slide">
      <View style={styles.modalOverlay}>
        <View style={styles.modalContent}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>–í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç</Text>
            <TouchableOpacity 
              onPress={() => setShowColorPicker(false)}
              hitSlop={{ top: 10, bottom: 10, left: 10, right: 10 }}
            >
              <Text style={styles.closeButton}>‚úï</Text>
            </TouchableOpacity>
          </View>
          <ScrollView 
            contentContainerStyle={styles.colorGrid}
            keyboardShouldPersistTaps="handled"
          >
            {colorList.map((item, index) => (
              <TouchableOpacity
                key={index}
                style={[styles.colorOption, { backgroundColor: item }, color === item && styles.selectedColor]}
                onPress={() => {
                  setColor(item);
                  setShowColorPicker(false);
                }}
              >
                {color === item && <Text style={styles.checkIcon}>‚úì</Text>}
              </TouchableOpacity>
            ))}
          </ScrollView>
        </View>
      </View>
    </Modal>
  );

  if (!account) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" color={colors.primary} />
        <Text style={styles.loadingText}>–ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–∞...</Text>
      </View>
    );
  }

  return (
    <SafeAreaView style={styles.container}>
      <KeyboardAvoidingView
        style={{ flex: 1 }}
        behavior={Platform.OS === 'ios' ? 'padding' : undefined}
        keyboardVerticalOffset={Platform.OS === 'ios' ? 100 : 0}
      >
        <ScrollView 
          ref={scrollViewRef}
          style={styles.scrollView}
          contentContainerStyle={styles.scrollContent}
          keyboardShouldPersistTaps="handled"
          showsVerticalScrollIndicator={false}
        >
          {/* üîß –ó–ê–ì–û–õ–û–í–û–ö */}
          <View style={styles.header}>
            <Text style={styles.title}>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞</Text>
            <Text style={styles.subtitle}>
              ID: {accountId} ‚Ä¢ –¢–∏–ø: {type} {type !== account?.type && '(–∏–∑–º–µ–Ω–µ–Ω)'}
            </Text>
          </View>

          {/* üîß –ü–†–ï–í–¨–Æ */}
          <View style={[styles.previewCard, { borderLeftColor: color }]}>
            <View style={styles.previewHeader}>
              <Text style={styles.previewIcon}>{icon}</Text>
              <View style={styles.previewInfo}>
                <Text style={styles.previewName}>{name || '–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞'}</Text>
                <Text style={[
                  styles.previewType,
                  { color: accountTypes.find(t => t.value === type)?.color || colors.textSecondary }
                ]}>
                  {accountTypes.find(t => t.value === type)?.label || '–¢–∏–ø —Å—á–µ—Ç–∞'}
                  {type !== account?.type && ' (–∏–∑–º–µ–Ω–µ–Ω)'}
                </Text>
              </View>
            </View>
            <View style={styles.previewBalance}>
              <Text style={styles.previewBalanceLabel}>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</Text>
              <Text style={[
                styles.previewBalanceValue,
                { color: account.balance >= 0 ? colors.primary : colors.error }
              ]}>
                {formatCurrency(account.balance)}
              </Text>
              <Text style={styles.previewTypeInfo}>
                –ë—ã–ª–æ: {accountTypes.find(t => t.value === account?.type)?.label || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
              </Text>
            </View>
          </View>

          {/* üîß –§–û–†–ú–ê */}
          <View style={styles.formSection}>
            <Text style={styles.sectionTitle}>–û—Å–Ω–æ–≤–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã</Text>

            {/* üîß –ò–ö–û–ù–ö–ê */}
            <View style={styles.formField}>
              <Text style={styles.label}>–ò–∫–æ–Ω–∫–∞ —Å—á–µ—Ç–∞</Text>
              <TouchableOpacity
                style={styles.selectButton}
                onPress={() => {
                  Keyboard.dismiss();
                  setShowIconPicker(true);
                }}
                disabled={loading}
              >
                <Text style={styles.selectButtonIcon}>{icon}</Text>
                <View style={styles.selectButtonContent}>
                  <Text style={styles.selectButtonText}>–ò–∑–º–µ–Ω–∏—Ç—å –∏–∫–æ–Ω–∫—É</Text>
                  <Text style={styles.selectButtonArrow}>‚û§</Text>
                </View>
              </TouchableOpacity>
            </View>

            {/* üîß –¢–ò–ü –°–ß–ï–¢–ê */}
            <View style={styles.formField}>
              <Text style={styles.label}>–¢–∏–ø —Å—á–µ—Ç–∞</Text>
              <Text style={styles.typeHint}>
                –í—ã–±—Ä–∞–Ω: {type} ‚Ä¢ –ë—ã–ª–æ: {account?.type || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
              </Text>
              <ScrollView 
                horizontal 
                showsHorizontalScrollIndicator={false}
                style={styles.typeScroll}
                contentContainerStyle={styles.typeContainer}
              >
                {accountTypes.map((item) => (
                  <TouchableOpacity
                    key={item.value}
                    style={[
                      styles.typeOption,
                      { 
                        borderColor: item.color,
                        backgroundColor: type === item.value ? item.bgColor : colors.surface
                      }
                    ]}
                    onPress={() => {
                      Keyboard.dismiss();
                      console.log('üéØ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª —Ç–∏–ø:', item.value);
                      setType(item.value);
                    }}
                    disabled={loading}
                  >
                    <Text style={styles.typeIcon}>{item.label.split(' ')[0]}</Text>
                    <Text style={[
                      styles.typeText,
                      type === item.value && { color: item.color, fontWeight: '700' }
                    ]}>
                      {item.label.split(' ').slice(1).join(' ')}
                    </Text>
                  </TouchableOpacity>
                ))}
              </ScrollView>
            </View>

            {/* üîß –ù–ê–ó–í–ê–ù–ò–ï */}
            <View style={styles.formField}>
              <Text style={styles.label}>–ù–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞ *</Text>
              <TextInput
                style={styles.input}
                value={name}
                onChangeText={setName}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å—á–µ—Ç–∞"
                placeholderTextColor={colors.textSecondary}
                onFocus={() => scrollToInput('name')}
                editable={!loading}
                selectTextOnFocus={false}
              />
            </View>

            {/* üîß –ë–ê–õ–ê–ù–° */}
            <View style={styles.formField}>
              <Text style={styles.label}>–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</Text>
              <View style={styles.balanceRow}>
                <TextInput
                  style={[styles.input, styles.balanceInput]}
                  value={balance}
                  onChangeText={handleBalanceChange}
                  placeholder="0.00"
                  placeholderTextColor={colors.textSecondary}
                  keyboardType="decimal-pad"
                  onFocus={() => scrollToInput('balance')}
                  editable={!loading}
                  selectTextOnFocus={false}
                />
                <Text style={styles.currency}>BYN</Text>
                <TouchableOpacity
                  style={styles.resetButton}
                  onPress={handleResetBalance}
                  disabled={loading}
                >
                  <Text style={styles.resetIcon}>üîÑ</Text>
                </TouchableOpacity>
              </View>
            </View>

            {/* üîß –¶–í–ï–¢ */}
            <View style={styles.formField}>
              <Text style={styles.label}>–¶–≤–µ—Ç —Å—á–µ—Ç–∞</Text>
              <TouchableOpacity
                style={styles.selectButton}
                onPress={() => {
                  Keyboard.dismiss();
                  setShowColorPicker(true);
                }}
                disabled={loading}
              >
                <View style={[
                  styles.colorPreview,
                  { backgroundColor: color }
                ]} />
                <View style={styles.selectButtonContent}>
                  <Text style={styles.selectButtonText}>–í—ã–±—Ä–∞—Ç—å —Ü–≤–µ—Ç</Text>
                  <Text style={styles.selectButtonArrow}>‚û§</Text>
                </View>
              </TouchableOpacity>
            </View>
          </View>

          {/* üîß –ö–ù–û–ü–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø */}
          <TouchableOpacity
            style={[styles.saveButton, loading && styles.buttonDisabled]}
            onPress={handleSave}
            disabled={loading}
          >
            {loading ? (
              <ActivityIndicator color={colors.white} />
            ) : (
              <Text style={styles.saveButtonText}>üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</Text>
            )}
          </TouchableOpacity>

          {/* üîß –ö–ù–û–ü–ö–ê –ù–ê–ó–ê–î */}
          <TouchableOpacity
            style={[styles.backButton, loading && styles.buttonDisabled]}
            onPress={() => {
              Keyboard.dismiss();
              navigation.goBack();
            }}
            disabled={loading}
          >
            <Text style={styles.backButtonText}>‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –±–µ–∑ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</Text>
          </TouchableOpacity>

          {/* üîß –û–ü–ê–°–ù–´–ï –î–ï–ô–°–¢–í–ò–Ø */}
          <TouchableOpacity
            style={styles.dangerHeader}
            onPress={() => {
              Keyboard.dismiss();
              setShowDangerActions(!showDangerActions);
            }}
            disabled={loading}
          >
            <Text style={styles.dangerTitle}>
              {showDangerActions ? '‚ñº' : '‚ñ∂'} –û–ø–∞—Å–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è
            </Text>
          </TouchableOpacity>

          {showDangerActions && (
            <View style={styles.dangerSection}>
              <TouchableOpacity
                style={[styles.archiveButton, loading && styles.buttonDisabled]}
                onPress={handleArchive}
                disabled={loading}
              >
                <Text style={styles.archiveButtonText}>
                  {getAccountStats(accountId).isActive ? 'üìÅ –ê—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—á–µ—Ç' : 'üìÇ –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—á–µ—Ç'}
                </Text>
              </TouchableOpacity>

              <TouchableOpacity
                style={[styles.deleteButton, loading && styles.buttonDisabled]}
                onPress={handleDelete}
                disabled={loading}
              >
                <Text style={styles.deleteButtonText}>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —Å—á–µ—Ç</Text>
              </TouchableOpacity>
            </View>
          )}
        </ScrollView>
      </KeyboardAvoidingView>

      {/* üîß –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */}
      <IconPicker />
      <ColorPicker />
    </SafeAreaView>
  );
};

const styles = {
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
  },
  loadingText: {
    marginTop: spacing.md,
    fontSize: 16,
    color: colors.textSecondary,
  },
  header: {
    paddingTop: 60,
    paddingHorizontal: spacing.xl,
    paddingBottom: spacing.lg,
    backgroundColor: colors.background,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  title: {
    fontSize: 22,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
  },
  subtitle: {
    fontSize: 14,
    color: colors.primary,
    fontWeight: '600',
    textAlign: 'center',
    marginTop: 4,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  previewCard: {
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    marginBottom: spacing.xl,
    borderLeftWidth: 6,
  },
  previewHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  previewIcon: {
    fontSize: 32,
    marginRight: spacing.md,
  },
  previewInfo: {
    flex: 1,
  },
  previewName: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  previewType: {
    fontSize: 14,
    fontWeight: '600',
  },
  previewBalance: {
    backgroundColor: colors.background,
    borderRadius: borderRadius.md,
    padding: spacing.md,
  },
  previewBalanceLabel: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
  },
  previewBalanceValue: {
    fontSize: 24,
    fontWeight: 'bold',
  },
  previewTypeInfo: {
    fontSize: 12,
    color: colors.textSecondary,
    marginTop: spacing.xs,
    fontStyle: 'italic',
  },
  formSection: {
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    marginBottom: spacing.xl,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.lg,
  },
  formField: {
    marginBottom: spacing.lg,
  },
  label: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.sm,
  },
  typeHint: {
    fontSize: 12,
    color: colors.textSecondary,
    marginBottom: spacing.sm,
    fontStyle: 'italic',
  },
  selectButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderWidth: 2,
    borderColor: colors.border,
    borderRadius: borderRadius.lg,
    padding: spacing.md,
  },
  selectButtonIcon: {
    fontSize: 24,
    marginRight: spacing.md,
  },
  selectButtonContent: {
    flex: 1,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  selectButtonText: {
    fontSize: 16,
    color: colors.textPrimary,
  },
  selectButtonArrow: {
    fontSize: 16,
    color: colors.textSecondary,
  },
  colorPreview: {
    width: 24,
    height: 24,
    borderRadius: borderRadius.sm,
    marginRight: spacing.md,
  },
  typeScroll: {
    maxHeight: 100,
  },
  typeContainer: {
    paddingRight: spacing.xl,
  },
  typeOption: {
    borderWidth: 2,
    borderRadius: borderRadius.lg,
    padding: spacing.md,
    marginRight: spacing.sm,
    alignItems: 'center',
    minWidth: 90,
  },
  typeIcon: {
    fontSize: 24,
    marginBottom: spacing.xs,
  },
  typeText: {
    fontSize: 12,
    color: colors.textPrimary,
    textAlign: 'center',
    lineHeight: 14,
  },
  input: {
    backgroundColor: colors.surface,
    borderWidth: 2,
    borderColor: colors.border,
    borderRadius: borderRadius.lg,
    padding: spacing.md,
    fontSize: 16,
    color: colors.textPrimary,
  },
  balanceRow: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  balanceInput: {
    flex: 1,
    marginRight: spacing.sm,
  },
  currency: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textSecondary,
    marginRight: spacing.md,
  },
  resetButton: {
    backgroundColor: colors.background,
    borderRadius: borderRadius.sm,
    padding: spacing.sm,
  },
  resetIcon: {
    fontSize: 18,
  },
  saveButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.lg,
    borderRadius: borderRadius.lg,
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  saveButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },
  backButton: {
    backgroundColor: 'transparent',
    borderWidth: 2,
    borderColor: colors.border,
    borderRadius: borderRadius.lg,
    paddingVertical: spacing.lg,
    alignItems: 'center',
    marginBottom: spacing.lg,
  },
  backButtonText: {
    color: colors.textSecondary,
    fontSize: 16,
    fontWeight: '600',
  },
  dangerHeader: {
    backgroundColor: colors.background,
    borderWidth: 2,
    borderColor: colors.border,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    marginBottom: spacing.md,
  },
  dangerTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.error,
    textAlign: 'center',
  },
  dangerSection: {
    backgroundColor: colors.background,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    marginBottom: spacing.xl,
  },
  archiveButton: {
    backgroundColor: 'transparent',
    borderWidth: 2,
    borderColor: colors.border,
    borderRadius: borderRadius.lg,
    paddingVertical: spacing.md,
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  archiveButtonText: {
    color: colors.textSecondary,
    fontSize: 16,
    fontWeight: '600',
  },
  deleteButton: {
    backgroundColor: colors.error,
    borderRadius: borderRadius.lg,
    paddingVertical: spacing.md,
    alignItems: 'center',
  },
  deleteButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },
  buttonDisabled: {
    opacity: 0.6,
  },
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-end',
  },
  modalContent: {
    backgroundColor: colors.surface,
    borderTopLeftRadius: borderRadius.xl,
    borderTopRightRadius: borderRadius.xl,
    maxHeight: '70%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
  },
  closeButton: {
    fontSize: 20,
    color: colors.textSecondary,
    padding: spacing.xs,
  },
  iconGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    padding: spacing.lg,
  },
  iconOption: {
    width: 60,
    height: 60,
    justifyContent: 'center',
    alignItems: 'center',
    borderRadius: borderRadius.lg,
    backgroundColor: colors.background,
    margin: spacing.xs,
  },
  selectedIcon: {
    backgroundColor: colors.primary + '20',
    borderWidth: 2,
    borderColor: colors.primary,
  },
  iconText: {
    fontSize: 24,
  },
  colorGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    padding: spacing.lg,
  },
  colorOption: {
    width: 50,
    height: 50,
    borderRadius: borderRadius.lg,
    margin: spacing.xs,
    justifyContent: 'center',
    alignItems: 'center',
  },
  selectedColor: {
    borderWidth: 3,
    borderColor: colors.white,
  },
  checkIcon: {
    color: colors.white,
    fontSize: 20,
    fontWeight: 'bold',
  },
};

export default EditAccountScreen;import React, { useState, useEffect } from 'react';
import { 
  View, 
  Text, 
  TextInput, 
  TouchableOpacity, 
  StyleSheet, 
  ScrollView, 
  Alert,
  KeyboardAvoidingView,
  Platform 
} from 'react-native';
import { colors, categoryColors, categoryIcons } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';

const EditTransactionScreen = ({ route, navigation }) => {
  const { transactionId } = route.params;
  const { transactions, categories, accounts, updateTransaction, deleteTransaction } = useData();
  
  // –ù–∞—Ö–æ–¥–∏–º –æ–ø–µ—Ä–∞—Ü–∏—é –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
  const transaction = transactions.find(t => t.id === transactionId);
  
  const [type, setType] = useState(transaction?.type || 'expense');
  const [amount, setAmount] = useState(transaction ? Math.abs(transaction.amount).toString() : '');
  const [category, setCategory] = useState(transaction?.category || '');
  const [description, setDescription] = useState(transaction?.description || '');
  const [account, setAccount] = useState(transaction?.account_id || accounts[0]?.id || '');

  // –ï—Å–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞
  if (!transaction) {
    return (
      <View style={styles.container}>
        <View style={styles.header}>
          <Text style={styles.headerTitle}>–û—à–∏–±–∫–∞</Text>
          <Text style={styles.headerSubtitle}>–û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞</Text>
        </View>
        <View style={styles.content}>
          <TouchableOpacity 
            style={styles.backButton}
            onPress={() => navigation.goBack()}
          >
            <Text style={styles.backButtonText}>‚Üê –ù–∞–∑–∞–¥</Text>
          </TouchableOpacity>
        </View>
      </View>
    );
  }

  const handleUpdate = () => {
    if (!amount || !category) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Å—É–º–º—É –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é');
      return;
    }

    const amountValue = parseFloat(amount);
    if (isNaN(amountValue) || amountValue <= 0) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
      return;
    }

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ–ø–µ—Ä–∞—Ü–∏—é
    const updatedData = {
      type,
      amount: type === 'income' ? amountValue : -amountValue,
      category,
      description: description.trim(),
      account_id: account
    };

    try {
      updateTransaction(transactionId, updatedData);
      
      Alert.alert(
        '–£—Å–ø–µ—Ö', 
        '–û–ø–µ—Ä–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞!',
        [
          { 
            text: 'OK', 
            onPress: () => navigation.goBack()
          }
        ]
      );
    } catch (error) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é');
      console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏:', error);
    }
  };

  const handleDelete = () => {
    Alert.alert(
      '–£–¥–∞–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
      '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?',
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        {
          text: '–£–¥–∞–ª–∏—Ç—å',
          style: 'destructive',
          onPress: () => {
            deleteTransaction(transactionId);
            Alert.alert('–£—Å–ø–µ—Ö', '–û–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
            navigation.navigate('Transactions');
          }
        }
      ]
    );
  };

  const CategoryButton = ({ cat }) => (
    <TouchableOpacity
      style={[
        styles.categoryButton,
        category === cat.id && styles.categoryButtonActive,
        category === cat.id && { backgroundColor: categoryColors[cat.id] }
      ]}
      onPress={() => setCategory(cat.id)}
    >
      <Text style={styles.categoryIcon}>{cat.icon}</Text>
      <Text style={[
        styles.categoryText,
        category === cat.id && styles.categoryTextActive
      ]}>
        {cat.name}
      </Text>
    </TouchableOpacity>
  );

  const AccountButton = ({ acc }) => (
    <TouchableOpacity
      style={[
        styles.accountButton,
        account === acc.id && styles.accountButtonActive
      ]}
      onPress={() => setAccount(acc.id)}
    >
      <Text style={styles.accountIcon}>{acc.icon}</Text>
      <View style={styles.accountInfo}>
        <Text style={[
          styles.accountText,
          account === acc.id && styles.accountTextActive
        ]}>
          {acc.name}
        </Text>
        <Text style={styles.accountBalance}>
          {formatCurrency(acc.balance, false)}
        </Text>
      </View>
    </TouchableOpacity>
  );

  return (
    <KeyboardAvoidingView 
      style={styles.container}
      behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
    >
      <ScrollView 
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollContent}
      >
        {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ */}
        <View style={styles.header}>
          <Text style={styles.headerTitle}>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é</Text>
          <Text style={styles.headerSubtitle}>–í–Ω–µ—Å–∏—Ç–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</Text>
        </View>

        {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ç–∏–ø–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ */}
        <View style={styles.typeSelector}>
          <TouchableOpacity
            style={[
              styles.typeButton,
              type === 'expense' && styles.typeButtonActive,
              type === 'expense' && { backgroundColor: colors.error }
            ]}
            onPress={() => {
              setType('expense');
              setCategory('');
            }}
          >
            <Text style={[
              styles.typeButtonText,
              type === 'expense' && styles.typeButtonTextActive
            ]}>
              üí∏ –†–∞—Å—Ö–æ–¥
            </Text>
          </TouchableOpacity>
          <TouchableOpacity
            style={[
              styles.typeButton,
              type === 'income' && styles.typeButtonActive,
              type === 'income' && { backgroundColor: colors.success }
            ]}
            onPress={() => {
              setType('income');
              setCategory('');
            }}
          >
            <Text style={[
              styles.typeButtonText,
              type === 'income' && styles.typeButtonTextActive
            ]}>
              üíµ –î–æ—Ö–æ–¥
            </Text>
          </TouchableOpacity>
        </View>

        {/* –ü–æ–ª–µ –¥–ª—è —Å—É–º–º—ã */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–°—É–º–º–∞</Text>
          <View style={styles.amountInputContainer}>
            <Text style={styles.currencySymbol}>BYN</Text>
            <TextInput
              style={styles.amountInput}
              placeholder="0.00"
              value={amount}
              onChangeText={setAmount}
              keyboardType="numeric"
              placeholderTextColor={colors.textSecondary}
              selectionColor={colors.primary}
            />
          </View>
        </View>

        {/* –í—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</Text>
          <View style={styles.categoriesGrid}>
            {categories[type].map(cat => (
              <CategoryButton key={cat.id} cat={cat} />
            ))}
          </View>
        </View>

        {/* –í—ã–±–æ—Ä —Å—á–µ—Ç–∞ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–°—á–µ—Ç</Text>
          <View style={styles.accountsContainer}>
            {accounts.map(acc => (
              <AccountButton key={acc.id} acc={acc} />
            ))}
          </View>
        </View>

        {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
        <View style={styles.inputSection}>
          <Text style={styles.inputLabel}>–û–ø–∏—Å–∞–Ω–∏–µ</Text>
          <TextInput
            style={styles.descriptionInput}
            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏..."
            value={description}
            onChangeText={setDescription}
            multiline
            numberOfLines={3}
            placeholderTextColor={colors.textSecondary}
            selectionColor={colors.primary}
          />
        </View>

        {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏ */}
        <View style={styles.originalInfo}>
          <Text style={styles.originalInfoTitle}>–ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:</Text>
          <Text style={styles.originalInfoText}>
            –¢–∏–ø: {transaction.type === 'income' ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}
          </Text>
          <Text style={styles.originalInfoText}>
            –°—É–º–º–∞: {formatCurrency(transaction.amount, false)}
          </Text>
          <Text style={styles.originalInfoText}>
            –î–∞—Ç–∞: {new Date(transaction.date).toLocaleDateString('ru-RU')}
          </Text>
        </View>

        {/* –ö–Ω–æ–ø–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è */}
        <TouchableOpacity 
          style={[
            styles.saveButton,
            (!amount || !category) && styles.saveButtonDisabled
          ]} 
          onPress={handleUpdate}
          disabled={!amount || !category}
        >
          <Text style={styles.saveButtonText}>
            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
          </Text>
        </TouchableOpacity>

        {/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è */}
        <TouchableOpacity 
          style={styles.deleteButton} 
          onPress={handleDelete}
        >
          <Text style={styles.deleteButtonText}>
            üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é
          </Text>
        </TouchableOpacity>

        {/* –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã */}
        <TouchableOpacity 
          style={styles.cancelButton} 
          onPress={() => navigation.goBack()}
        >
          <Text style={styles.cancelButtonText}>
            ‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞
          </Text>
        </TouchableOpacity>
      </ScrollView>
    </KeyboardAvoidingView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: 20,
    paddingTop: 20,
    paddingBottom: 40,
  },
  header: {
    alignItems: 'center',
    marginBottom: 30,
    paddingTop: 10,
  },
  headerTitle: {
    fontSize: 28,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 8,
  },
  headerSubtitle: {
    fontSize: 16,
    color: colors.textSecondary,
    textAlign: 'center',
  },
  typeSelector: {
    flexDirection: 'row',
    backgroundColor: colors.surface,
    borderRadius: 20,
    padding: 6,
    marginBottom: 30,
    elevation: 8,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.1,
    shadowRadius: 12,
  },
  typeButton: {
    flex: 1,
    paddingVertical: 16,
    borderRadius: 16,
    alignItems: 'center',
    backgroundColor: colors.background,
  },
  typeButtonActive: {
    elevation: 4,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.15,
    shadowRadius: 8,
  },
  typeButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textSecondary,
  },
  typeButtonTextActive: {
    color: colors.white,
    fontWeight: 'bold',
  },
  inputSection: {
    marginBottom: 28,
  },
  inputLabel: {
    fontSize: 18,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: 12,
  },
  amountInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: 20,
    paddingHorizontal: 20,
    elevation: 6,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.08,
    shadowRadius: 8,
  },
  currencySymbol: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.primary,
    marginRight: 10,
  },
  amountInput: {
    flex: 1,
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: 20,
  },
  categoriesGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: 12,
  },
  categoryButton: {
    width: '30%',
    aspectRatio: 1,
    backgroundColor: colors.surface,
    borderRadius: 20,
    alignItems: 'center',
    justifyContent: 'center',
    padding: 12,
    elevation: 4,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 3 },
    shadowOpacity: 0.08,
    shadowRadius: 6,
  },
  categoryButtonActive: {
    elevation: 8,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.2,
    shadowRadius: 12,
  },
  categoryIcon: {
    fontSize: 24,
    marginBottom: 8,
  },
  categoryText: {
    fontSize: 12,
    fontWeight: '600',
    color: colors.textPrimary,
    textAlign: 'center',
  },
  categoryTextActive: {
    color: colors.white,
    fontWeight: 'bold',
  },
  accountsContainer: {
    gap: 12,
  },
  accountButton: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: 16,
    padding: 16,
    elevation: 4,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 3 },
    shadowOpacity: 0.08,
    shadowRadius: 6,
  },
  accountButtonActive: {
    backgroundColor: colors.primary + '20',
    borderColor: colors.primary,
    borderWidth: 2,
  },
  accountIcon: {
    fontSize: 24,
    marginRight: 12,
  },
  accountInfo: {
    flex: 1,
  },
  accountText: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: 4,
  },
  accountTextActive: {
    color: colors.primary,
  },
  accountBalance: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  descriptionInput: {
    backgroundColor: colors.surface,
    borderRadius: 20,
    paddingHorizontal: 20,
    paddingVertical: 16,
    fontSize: 16,
    color: colors.textPrimary,
    textAlignVertical: 'top',
    elevation: 4,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 3 },
    shadowOpacity: 0.06,
    shadowRadius: 6,
    minHeight: 100,
  },
  originalInfo: {
    backgroundColor: colors.surface + '80',
    borderRadius: 16,
    padding: 16,
    marginBottom: 20,
    borderLeftWidth: 4,
    borderLeftColor: colors.primary,
  },
  originalInfoTitle: {
    fontSize: 14,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 8,
  },
  originalInfoText: {
    fontSize: 12,
    color: colors.textSecondary,
    marginBottom: 4,
  },
  saveButton: {
    backgroundColor: colors.primary,
    paddingVertical: 20,
    borderRadius: 20,
    alignItems: 'center',
    marginTop: 10,
    marginBottom: 15,
    elevation: 8,
    shadowColor: colors.primary,
    shadowOffset: { width: 0, height: 8 },
    shadowOpacity: 0.3,
    shadowRadius: 16,
  },
  saveButtonDisabled: {
    backgroundColor: colors.textSecondary,
    elevation: 0,
    shadowOpacity: 0,
  },
  saveButtonText: {
    color: colors.white,
    fontSize: 18,
    fontWeight: 'bold',
  },
  deleteButton: {
    backgroundColor: colors.error,
    paddingVertical: 18,
    borderRadius: 20,
    alignItems: 'center',
    marginBottom: 15,
    elevation: 6,
    shadowColor: colors.error,
    shadowOffset: { width: 0, height: 6 },
    shadowOpacity: 0.3,
    shadowRadius: 12,
  },
  deleteButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },
  cancelButton: {
    backgroundColor: colors.textSecondary,
    paddingVertical: 16,
    borderRadius: 20,
    alignItems: 'center',
    elevation: 4,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.1,
    shadowRadius: 8,
  },
  cancelButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: '600',
  },
});

export default EditTransactionScreen;// FinancialTestsScreen.js - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import React, { useState } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  ActivityIndicator
} from 'react-native';

// üé® –ü–†–û–°–¢–´–ï –¶–í–ï–¢–ê –ë–ï–ó –ò–ú–ü–û–†–¢–ê
const colors = {
  primary: '#6C63FF',
  background: '#FFFFFF',
  surface: '#F8F9FA',
  textPrimary: '#1A1A1A',
  textSecondary: '#666666',
  success: '#4CAF50',
  error: '#F44336',
  warning: '#FF9800',
  info: '#2196F3',
  white: '#FFFFFF',
  border: '#E5E5E5',
};

const FinancialTestsScreen = ({ navigation }) => {
  const { 
    accounts, 
    credits,
    addAccount,
    addTransaction,
    addDebt,
    addCredit,
    transferBetweenAccounts,
    makeCreditPayment,
    clearAllData
  } = useData();

  const [testResults, setTestResults] = useState([]);
  const [isTesting, setIsTesting] = useState(false);
  const [testAccounts, setTestAccounts] = useState([]);

  // üîß –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –í–ê–õ–Æ–¢–´
  const formatCurrency = (amount, showSymbol = true) => {
    return `${showSymbol ? 'BYN ' : ''}${amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,')}`;
  };

  // üîß –¢–ï–°–¢–û–í–´–ï –î–ê–ù–ù–´–ï
  const createTestAccounts = async () => {
    const testAccountsData = [
      { name: 'üí≥ –¢–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞', type: 'card', balance: 50000, icon: 'üí≥' },
      { name: 'üí∞ –¢–µ—Å—Ç–æ–≤—ã–µ –Ω–∞–ª–∏—á–Ω—ã–µ', type: 'cash', balance: 10000, icon: 'üí∞' },
      { name: 'üè¶ –¢–µ—Å—Ç–æ–≤—ã–π —Å–±–µ—Ä–µ–≥–∞—Ç–µ–ª—å–Ω—ã–π', type: 'savings', balance: 100000, icon: 'üè¶' },
      { name: 'üìã –¢–µ—Å—Ç–æ–≤–∞—è –∫—Ä–µ–¥–∏—Ç–∫–∞', type: 'credit', balance: -10000, icon: 'üìã' }
    ];

    const createdAccounts = [];
    for (const acc of testAccountsData) {
      try {
        const account = await addAccount(acc);
        createdAccounts.push(account);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å—á–µ—Ç–∞:', error);
      }
    }
    
    setTestAccounts(createdAccounts);
    return createdAccounts;
  };

  // üîß –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
  const addTestResult = (testName, success, message) => {
    setTestResults(prev => [...prev, {
      id: Date.now() + Math.random(),
      name: testName,
      success,
      message,
      timestamp: new Date().toISOString()
    }]);
  };

  const getAccountBalance = (accountId) => {
    const account = accounts.find(acc => acc.id === accountId) || testAccounts.find(acc => acc.id === accountId);
    return account ? account.balance : 0;
  };

  // üß™ –ü–†–û–°–¢–û–ô –¢–ï–°–¢ - –°–û–ó–î–ê–ù–ò–ï –°–ß–ï–¢–û–í
  const runSimpleTest = async () => {
    setIsTesting(true);
    setTestResults([]);

    try {
      addTestResult('–ù–∞—á–∞–ª–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', true, 'üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Å—Ç–æ–≥–æ —Ç–µ—Å—Ç–∞...');

      // 1. –°–û–ó–î–ê–ù–ò–ï –¢–ï–°–¢–û–í–´–• –°–ß–ï–¢–û–í
      const testAccounts = await createTestAccounts();
      addTestResult('–°–æ–∑–¥–∞–Ω–∏–µ —Å—á–µ—Ç–æ–≤', true, `‚úÖ –°–æ–∑–¥–∞–Ω–æ ${testAccounts.length} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Å—á–µ—Ç–æ–≤`);

      // 2. –ü–†–û–°–¢–ê–Ø –¢–†–ê–ù–ó–ê–ö–¶–ò–Ø
      if (testAccounts.length > 0) {
        const firstAccount = testAccounts[0];
        await addTransaction({
          amount: 1000,
          type: 'income',
          category: 'salary',
          account_id: firstAccount.id,
          description: '–¢–µ—Å—Ç–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è',
          date: new Date().toISOString()
        });
        addTestResult('–¢–µ—Å—Ç–æ–≤–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è', true, '‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ');
      }

      // 3. –ü–†–û–°–¢–û–ô –ü–ï–†–ï–í–û–î
      if (testAccounts.length > 1) {
        await transferBetweenAccounts(
          testAccounts[0].id,
          testAccounts[1].id,
          500,
          '–¢–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥'
        );
        addTestResult('–¢–µ—Å—Ç–æ–≤—ã–π –ø–µ—Ä–µ–≤–æ–¥', true, '‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
      }

      addTestResult('–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', true, 'üéâ –í—Å–µ –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã!');

      Alert.alert('‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ', '–ë–∞–∑–æ–≤—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!');

    } catch (error) {
      addTestResult('–û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è', false, `‚ùå ${error.message}`);
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏');
    } finally {
      setIsTesting(false);
    }
  };

  const clearTestData = async () => {
    Alert.alert(
      '–û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö',
      '–£–¥–∞–ª–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ —Å—á–µ—Ç–∞ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏?',
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        { 
          text: '–û—á–∏—Å—Ç–∏—Ç—å', 
          onPress: async () => {
            await clearAllData();
            setTestResults([]);
            setTestAccounts([]);
            Alert.alert('‚úÖ –û—á–∏—â–µ–Ω–æ', '–í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã');
          }
        }
      ]
    );
  };

  const TestResultItem = ({ result }) => (
    <View style={[
      styles.resultItem,
      result.success ? styles.resultSuccess : styles.resultError
    ]}>
      <Text style={styles.resultIcon}>
        {result.success ? '‚úÖ' : '‚ùå'}
      </Text>
      <View style={styles.resultContent}>
        <Text style={styles.resultName}>{result.name}</Text>
        <Text style={styles.resultMessage}>{result.message}</Text>
      </View>
    </View>
  );

  return (
    <View style={styles.container}>
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ª–æ–≥–∏–∫–∏</Text>
        <Text style={styles.screenSubtitle}>–ë–∞–∑–æ–≤–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π</Text>
      </View>

      <ScrollView style={styles.scrollView}>
        <View style={styles.statsCard}>
          <Text style={styles.statsTitle}>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</Text>
          <View style={styles.statsGrid}>
            <View style={styles.statItem}>
              <Text style={styles.statValue}>{testResults.length}</Text>
              <Text style={styles.statLabel}>–í—Å–µ–≥–æ –ø—Ä–æ–≤–µ—Ä–æ–∫</Text>
            </View>
            <View style={styles.statItem}>
              <Text style={styles.statValue}>
                {testResults.filter(r => r.success).length}
              </Text>
              <Text style={styles.statLabel}>–£—Å–ø–µ—à–Ω–æ</Text>
            </View>
            <View style={styles.statItem}>
              <Text style={styles.statValue}>
                {testResults.filter(r => !r.success).length}
              </Text>
              <Text style={styles.statLabel}>–û—à–∏–±–∫–∏</Text>
            </View>
          </View>
        </View>

        <View style={styles.actionsContainer}>
          <TouchableOpacity 
            style={[
              styles.testButton,
              isTesting && styles.testButtonDisabled
            ]}
            onPress={runSimpleTest}
            disabled={isTesting}
          >
            {isTesting ? (
              <View style={styles.loadingContainer}>
                <ActivityIndicator size="small" color={colors.white} />
                <Text style={styles.testButtonText}>–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤...</Text>
              </View>
            ) : (
              <Text style={styles.testButtonText}>üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã</Text>
            )}
          </TouchableOpacity>

          <TouchableOpacity 
            style={styles.clearButton}
            onPress={clearTestData}
            disabled={isTesting}
          >
            <Text style={styles.clearButtonText}>üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ</Text>
          </TouchableOpacity>
        </View>

        <View style={styles.resultsSection}>
          <Text style={styles.resultsTitle}>–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</Text>
          {testResults.length === 0 ? (
            <View style={styles.emptyResults}>
              <Text style={styles.emptyResultsIcon}>üìã</Text>
              <Text style={styles.emptyResultsText}>
                –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ª–æ–≥–∏–∫–∏
              </Text>
            </View>
          ) : (
            <View style={styles.resultsList}>
              {testResults.map(result => (
                <TestResultItem key={result.id} result={result} />
              ))}
            </View>
          )}
        </View>
      </ScrollView>
    </View>
  );
};

// üé® –ü–†–û–°–¢–´–ï –°–¢–ò–õ–ò
const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: colors.background,
  },
  screenHeader: {
    paddingTop: 60,
    paddingHorizontal: 20,
    paddingBottom: 20,
    backgroundColor: colors.background,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  screenTitle: {
    fontSize: 22,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: 4,
  },
  screenSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
    textAlign: 'center',
  },
  scrollView: {
    flex: 1,
    padding: 20,
  },
  statsCard: {
    backgroundColor: colors.surface,
    borderRadius: 16,
    padding: 20,
    marginBottom: 20,
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  statsTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 16,
    textAlign: 'center',
  },
  statsGrid: {
    flexDirection: 'row',
    justifyContent: 'space-between',
  },
  statItem: {
    alignItems: 'center',
    flex: 1,
  },
  statValue: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.primary,
    marginBottom: 8,
  },
  statLabel: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  actionsContainer: {
    gap: 12,
    marginBottom: 20,
  },
  testButton: {
    backgroundColor: colors.primary,
    paddingVertical: 16,
    borderRadius: 12,
    alignItems: 'center',
  },
  testButtonDisabled: {
    opacity: 0.6,
  },
  testButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },
  loadingContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  clearButton: {
    backgroundColor: 'transparent',
    paddingVertical: 12,
    borderRadius: 12,
    alignItems: 'center',
    borderWidth: 1,
    borderColor: colors.border,
  },
  clearButtonText: {
    color: colors.textSecondary,
    fontSize: 14,
    fontWeight: '600',
  },
  resultsSection: {
    marginBottom: 20,
  },
  resultsTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 12,
  },
  emptyResults: {
    alignItems: 'center',
    paddingVertical: 40,
    backgroundColor: colors.surface,
    borderRadius: 12,
  },
  emptyResultsIcon: {
    fontSize: 48,
    marginBottom: 16,
    opacity: 0.5,
  },
  emptyResultsText: {
    fontSize: 16,
    color: colors.textSecondary,
    textAlign: 'center',
  },
  resultsList: {
    gap: 8,
  },
  resultItem: {
    flexDirection: 'row',
    backgroundColor: colors.surface,
    borderRadius: 12,
    padding: 12,
    borderLeftWidth: 4,
  },
  resultSuccess: {
    borderLeftColor: colors.success,
  },
  resultError: {
    borderLeftColor: colors.error,
  },
  resultIcon: {
    fontSize: 18,
    marginRight: 12,
  },
  resultContent: {
    flex: 1,
  },
  resultName: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: 4,
  },
  resultMessage: {
    fontSize: 12,
    color: colors.textSecondary,
  },
});

export default FinancialTestsScreen;// src/components/GlobalStyles.js
import React from 'react';
import { StyleSheet } from 'react-native';

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ checkbox
export const GlobalStyles = StyleSheet.create({
  // –ë–ª–æ–∫–∏—Ä—É–µ–º –ª—é–±—ã–µ –ø—Å–µ–≤–¥–æ-—ç–ª–µ–º–µ–Ω—Ç—ã —Å checkbox
  noCheckboxes: {
    // –î–ª—è React Native
  },
});

// CSS –¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏ (–µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ –±—Ä–∞—É–∑–µ—Ä–µ)
export const globalCSS = `
  /* –ë–õ–û–ö–ò–†–£–ï–ú –í–°–ï CHECKBOX-–ò–ö–û–ù–ö–ò */
  [class*="checkbox"], 
  [class*="Checkbox"],
  [class*="check"],
  [class*="Check"],
  input[type="checkbox"],
  .checkbox,
  .check,
  .selected,
  .unselected,
  [role="checkbox"],
  [aria-checked],
  ::before,
  ::after {
    /* –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ checkbox-–∏–∫–æ–Ω–∫–∏ */
    background-image: none !important;
    content: none !important;
  }
  
  /* –ë–ª–æ–∫–∏—Ä—É–µ–º –ª—é–±—ã–µ —Å–∏–º–≤–æ–ª—ã [x] –∏ [ ] */
  * {
    /* –£–±–∏—Ä–∞–µ–º –ª—é–±—ã–µ –∫–≤–∞–¥—Ä–∞—Ç–Ω—ã–µ —Å–∫–æ–±–∫–∏ —Å x –∏–ª–∏ –ø—Ä–æ–±–µ–ª–æ–º */
    text-rendering: optimizeLegibility;
    -webkit-font-feature-settings: "liga" off;
    font-feature-settings: "liga" off;
  }
  
  /* –°–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ –¥–ª—è –≤–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
  .transaction-item *,
  .category-item *,
  [class*="transaction"] *,
  [class*="category"] *,
  [class*="item"] * {
    /* –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —É–±–∏—Ä–∞–µ–º checkbox */
    background: none !important;
    content: none !important;
  }
`;

// –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö —Å—Ç–∏–ª–µ–π
export const GlobalStylesComponent = () => {
  React.useEffect(() => {
    // –ü—Ä–∏–º–µ–Ω—è–µ–º CSS –¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏
    if (typeof document !== 'undefined') {
      const style = document.createElement('style');
      style.textContent = globalCSS;
      document.head.appendChild(style);
      
      return () => {
        document.head.removeChild(style);
      };
    }
  }, []);

  return null;
};// src/screens/HomeScreen.js (–ò–î–ï–ê–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô)
import React, { useMemo } from 'react';
import { 
  View, 
  Text, 
  StyleSheet, 
  ScrollView, 
  TouchableOpacity, 
  Dimensions,
  Alert 
} from 'react-native';
import { colors } from '../theme/colors';
import { formatCurrency, formatCurrencyShort } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';

// üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const { width } = Dimensions.get('window');

const HomeScreen = ({ navigation }) => {
  const { 
    transactions, 
    accounts, 
    categories,
    getTotalBalance,
    getRecentTransactions,
    getTransactionsByType 
  } = useData();

  // üîß –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ê–°–ß–ï–¢ –î–ê–ù–ù–´–•
  const { totalIncome, totalExpense, netFlow, categorySpending, recentTransactions, balanceDetails } = useMemo(() => {
    const incomeTransactions = getTransactionsByType('income');
    const expenseTransactions = getTransactionsByType('expense');
    
    const totalIncome = incomeTransactions.reduce((sum, transaction) => sum + transaction.amount, 0);
    const totalExpense = expenseTransactions.reduce((sum, transaction) => sum + Math.abs(transaction.amount), 0);
    const netFlow = totalIncome - totalExpense;

    // üîß –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ê–°–ß–ï–¢ –ë–ê–õ–ê–ù–°–û–í
    const balanceDetails = {
      total: 0,
      cards: 0,
      cash: 0
    };

    if (accounts && Array.isArray(accounts)) {
      accounts.forEach(account => {
        if (account.is_active !== 0) {
          const balance = account.balance || 0;
          balanceDetails.total += balance;
          
          if (account.type === 'card') {
            balanceDetails.cards += balance;
          } else if (account.type === 'cash') {
            balanceDetails.cash += balance;
          }
        }
      });
    }

    // üîß –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ê–°–ß–ï–¢ –ö–ê–¢–ï–ì–û–†–ò–ô
    const categorySpending = categories.expense.map(category => {
      const amount = transactions
        .filter(t => t.type === 'expense' && t.category === category.id)
        .reduce((sum, t) => sum + Math.abs(t.amount), 0);
      
      return {
        ...category,
        amount
      };
    })
    .filter(cat => cat.amount > 0)
    .sort((a, b) => b.amount - a.amount)
    .slice(0, 4); // üîß –û–ì–†–ê–ù–ò–ß–ò–õ–ò –î–û 4 –ö–ê–¢–ï–ì–û–†–ò–ô –î–õ–Ø –ö–û–ú–ü–ê–ö–¢–ù–û–°–¢–ò

    const recentTransactions = getRecentTransactions(5); // üîß –û–ì–†–ê–ù–ò–ß–ò–õ–ò –î–û 5 –û–ü–ï–†–ê–¶–ò–ô

    return {
      totalIncome,
      totalExpense,
      netFlow,
      categorySpending,
      recentTransactions,
      balanceDetails
    };
  }, [transactions, accounts, categories, getTransactionsByType, getRecentTransactions]);

  const getAccountInfo = (accountId) => {
    return accounts.find(acc => acc.id === accountId) || { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—á–µ—Ç' };
  };

  const getCategoryInfo = (categoryId) => {
    const allCategories = [...categories.income, ...categories.expense];
    return allCategories.find(cat => cat.id === categoryId) || { 
      name: '–î—Ä—É–≥–æ–µ', 
      icon: 'üíº',
      color: colors.textSecondary 
    };
  };

  const formatTimeAgo = (dateString) => {
    const date = new Date(dateString);
    const now = new Date();
    const diffMs = now - date;
    const diffMins = Math.floor(diffMs / 60000);
    const diffHours = Math.floor(diffMs / 3600000);
    const diffDays = Math.floor(diffMs / 86400000);

    if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
    if (diffMins < 60) return `${diffMins} –º–∏–Ω`;
    if (diffHours < 24) return `${diffHours} —á`;
    if (diffDays === 1) return '–≤—á–µ—Ä–∞';
    if (diffDays < 7) return `${diffDays} –¥–Ω`;
    
    return date.toLocaleDateString('ru-RU', {
      day: 'numeric',
      month: 'short'
    });
  };

  const handleTransactionPress = (transaction) => {
    const category = getCategoryInfo(transaction.category);
    const account = getAccountInfo(transaction.account_id);
    
    Alert.alert(
      '–î–µ—Ç–∞–ª–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏',
      `üí≥ ${formatCurrency(Math.abs(transaction.amount), false)}\nüìÇ ${category.name}\nüè¶ ${account.name}\n‚è∞ ${formatTimeAgo(transaction.date)}${transaction.description ? `\nüìù ${transaction.description}` : ''}`,
      [{ text: '–ü–æ–Ω—è—Ç–Ω–æ', style: 'default' }]
    );
  };

  // üîß –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ï–ù–î–ï–†–ò–ù–ì –û–ü–ï–†–ê–¶–ò–ô
  const renderTransactionItem = (transaction, index) => {
    const category = getCategoryInfo(transaction.category);
    const isLast = index === recentTransactions.length - 1;
    
    return (
      <TouchableOpacity 
        key={transaction.id} 
        style={[
          styles.transactionItem,
          isLast && styles.lastTransactionItem
        ]}
        onPress={() => handleTransactionPress(transaction)}
        activeOpacity={0.7}
      >
        <View style={[styles.transactionIcon, { backgroundColor: category.color + '20' }]}>
          <Text style={styles.transactionIconText}>{category.icon}</Text>
        </View>
        
        <View style={styles.transactionInfo}>
          <Text style={styles.transactionDescription} numberOfLines={1}>
            {transaction.description || category.name}
          </Text>
          <Text style={styles.transactionMeta}>
            {category.name} ‚Ä¢ {formatTimeAgo(transaction.date)}
          </Text>
        </View>
        
        <Text style={[
          styles.transactionAmount,
          transaction.amount > 0 ? styles.incomeAmount : styles.expenseAmount
        ]}>
          {transaction.amount > 0 ? '+' : ''}{formatCurrency(transaction.amount, false)}
        </Text>
      </TouchableOpacity>
    );
  };

  // üîß –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ô –†–ï–ù–î–ï–†–ò–ù–ì –ö–ê–¢–ï–ì–û–†–ò–ô
  const renderCategoryProgress = (category, index) => {
    const maxAmount = Math.max(...categorySpending.map(c => c.amount), 1);
    const progress = (category.amount / maxAmount) * (width - spacing.xxl * 2);
    const percentage = Math.round((category.amount / maxAmount) * 100);
    
    return (
      <View key={category.id} style={styles.categoryProgressItem}>
        <View style={styles.categoryHeader}>
          <View style={styles.categoryTitle}>
            <Text style={styles.categoryIcon}>{category.icon}</Text>
            <Text style={styles.categoryName} numberOfLines={1}>
              {category.name}
            </Text>
          </View>
          <View style={styles.categoryAmountContainer}>
            <Text style={styles.categoryAmount}>
              {formatCurrency(category.amount, false)}
            </Text>
            <Text style={styles.categoryPercentage}>
              {percentage}%
            </Text>
          </View>
        </View>
        <View style={styles.progressBar}>
          <View 
            style={[
              styles.progressFill, 
              { 
                width: progress,
                backgroundColor: category.color
              }
            ]} 
          />
        </View>
      </View>
    );
  };

  // üîß –£–õ–£–ß–®–ï–ù–ù–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢ –ë–´–°–¢–†–´–• –ö–ù–û–ü–û–ö
  const QuickActionButton = ({ icon, label, onPress, color }) => (
    <TouchableOpacity 
      style={[styles.actionButton, { backgroundColor: color }]}
      onPress={onPress}
      activeOpacity={0.8}
    >
      <View style={styles.actionButtonContent}>
        <Text style={styles.actionButtonIcon}>{icon}</Text>
        <Text style={styles.actionButtonText} numberOfLines={1}>{label}</Text>
      </View>
    </TouchableOpacity>
  );

  // üîß –£–õ–£–ß–®–ï–ù–ù–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢ –ö–ê–†–¢–û–ß–ö–ò –ë–ê–õ–ê–ù–°–ê
  const BalanceCard = ({ icon, title, amount, color = colors.textPrimary }) => (
    <View style={styles.balanceDetailCard}>
      <View style={styles.balanceDetailHeader}>
        <Text style={styles.balanceDetailIcon}>{icon}</Text>
        <Text style={styles.balanceDetailTitle}>{title}</Text>
      </View>
      <Text style={[styles.balanceDetailAmount, { color }]}>
        {formatCurrency(amount)}
      </Text>
    </View>
  );

  // üîß –£–õ–£–ß–®–ï–ù–ù–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢ –°–¢–ê–¢–ò–°–¢–ò–ö–ò
  const StatCard = ({ title, value, subtitle, color = colors.textPrimary }) => (
    <View style={styles.statCard}>
      <Text style={styles.statTitle}>{title}</Text>
      <Text style={[styles.statValue, { color }]}>{value}</Text>
      {subtitle && <Text style={styles.statSubtitle}>{subtitle}</Text>}
    </View>
  );

  return (
    <View style={styles.container}>
      {/* üîß –®–ê–ü–ö–ê –≠–ö–†–ê–ù–ê –ß–ï–†–ï–ó –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–£ */}
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>üè† –ì–ª–∞–≤–Ω–∞—è</Text>
        <Text style={styles.screenSubtitle}>–û–±–∑–æ—Ä –≤–∞—à–∏—Ö —Ñ–∏–Ω–∞–Ω—Å–æ–≤</Text>
      </View>

      {/* üîß SCROLLVIEW –° –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ú –ö–û–ù–¢–ï–ù–¢–û–ú */}
      <ScrollView 
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollContent}
      >
        {/* üîß –ö–ê–†–¢–û–ß–ö–ê –ë–ê–õ–ê–ù–°–ê */}
        <View style={styles.balanceCard}>
          <View style={styles.balanceHeader}>
            <Text style={styles.balanceLabel}>–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</Text>
            <Text style={styles.balanceAmount}>{formatCurrency(balanceDetails.total)}</Text>
          </View>
          
          {/* üîß –î–ï–¢–ê–õ–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –ë–ê–õ–ê–ù–°–´ */}
          <View style={styles.balanceDetails}>
            <BalanceCard 
              icon="üí≥" 
              title="–ù–∞ –∫–∞—Ä—Ç–∞—Ö" 
              amount={balanceDetails.cards}
              color={colors.primary}
            />
            <BalanceCard 
              icon="üíµ" 
              title="–ù–∞–ª–∏—á–Ω—ã–º–∏" 
              amount={balanceDetails.cash}
              color={colors.success}
            />
          </View>

          {/* üîß –°–¢–ê–¢–ò–°–¢–ò–ö–ê */}
          <View style={styles.balanceStats}>
            <StatCard 
              title="–î–æ—Ö–æ–¥—ã" 
              value={`+${formatCurrencyShort(totalIncome, false)}`} 
              color={colors.success}
            />
            <StatCard 
              title="–†–∞—Å—Ö–æ–¥—ã" 
              value={`-${formatCurrencyShort(totalExpense, false)}`} 
              color={colors.error}
            />
            <StatCard 
              title="–ë–∞–ª–∞–Ω—Å" 
              value={formatCurrencyShort(netFlow, false)} 
              subtitle="–∑–∞ –≤—Å–µ –≤—Ä–µ–º—è"
              color={netFlow >= 0 ? colors.success : colors.error}
            />
          </View>
        </View>

        {/* üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø –° –ü–†–ê–í–ò–õ–¨–ù–û–ô –ù–ê–í–ò–ì–ê–¶–ò–ï–ô */}
        <View style={styles.actionSection}>
          <Text style={styles.sectionTitle}>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</Text>
          <View style={styles.actionButtons}>
            <QuickActionButton 
              icon="üíµ" 
              label="–î–æ—Ö–æ–¥" 
              onPress={() => navigation.navigate('Add', { 
                presetType: 'income', 
                fromHome: true 
              })}
              color={colors.success}
            />
            <QuickActionButton 
              icon="üí∏" 
              label="–†–∞—Å—Ö–æ–¥" 
              onPress={() => navigation.navigate('Add', { 
                presetType: 'expense', 
                fromHome: true 
              })}
              color={colors.error}
            />
          </View>
        </View>

        {/* üîß –¢–û–ü –ö–ê–¢–ï–ì–û–†–ò–ô –†–ê–°–•–û–î–û–í */}
        {categorySpending.length > 0 && (
          <View style={styles.section}>
            <View style={styles.sectionHeader}>
              <Text style={styles.sectionTitle}>üìä –¢–æ–ø —Ä–∞—Å—Ö–æ–¥–æ–≤</Text>
              <Text style={styles.sectionSubtitle}>–ó–∞ –≤—Å–µ –≤—Ä–µ–º—è</Text>
            </View>
            <View style={styles.categoriesProgress}>
              {categorySpending.map(renderCategoryProgress)}
            </View>
          </View>
        )}

        {/* üîß –ü–û–°–õ–ï–î–ù–ò–ï –û–ü–ï–†–ê–¶–ò–ò */}
        <View style={styles.section}>
          <View style={styles.sectionHeaderWithButton}>
            <View style={styles.sectionHeaderText}>
              <Text style={styles.sectionTitle}>üïê –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏</Text>
              <Text style={styles.sectionSubtitle}>–ù–µ–¥–∞–≤–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</Text>
            </View>
            {recentTransactions.length > 0 && (
              <TouchableOpacity 
                style={styles.seeAllButton}
                onPress={() => navigation.navigate('Transactions')}
                activeOpacity={0.7}
              >
                <Text style={styles.seeAllText}>–í—Å–µ</Text>
              </TouchableOpacity>
            )}
          </View>
          
          <View style={styles.transactionsList}>
            {recentTransactions.length > 0 ? (
              recentTransactions.map(renderTransactionItem)
            ) : (
              <View style={styles.emptyState}>
                <Text style={styles.emptyStateIcon}>üí∏</Text>
                <Text style={styles.emptyStateTitle}>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</Text>
                <Text style={styles.emptyStateText}>
                  –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã
                </Text>
              </View>
            )}
          </View>
        </View>

        {/* üîß –û–¢–°–¢–£–ü –î–õ–Ø –°–ö–†–û–õ–õ–ê */}
        <View style={styles.bottomSpacer} />
      </ScrollView>
    </View>
  );
};

// üîß –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ù–´–ï –°–¢–ò–õ–ò –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    ...commonStyles.screen.header,
  },
  screenTitle: {
    ...commonStyles.screen.title,
  },
  screenSubtitle: {
    ...commonStyles.screen.subtitle,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  
  // üîß –ö–ê–†–¢–û–ß–ö–ê –ë–ê–õ–ê–ù–°–ê
  balanceCard: {
    ...commonStyles.cards.elevated,
    marginBottom: spacing.xl,
  },
  balanceHeader: {
    marginBottom: spacing.lg,
  },
  balanceLabel: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
    fontWeight: '500',
  },
  balanceAmount: {
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.textPrimary,
  },
  balanceDetails: {
    flexDirection: 'row',
    gap: spacing.sm,
    marginBottom: spacing.lg,
  },
  balanceDetailCard: {
    flex: 1,
    backgroundColor: colors.background,
    padding: spacing.md,
    borderRadius: borderRadius.md,
    borderWidth: 1,
    borderColor: colors.border,
  },
  balanceDetailHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: spacing.xs,
    marginBottom: spacing.xs,
  },
  balanceDetailIcon: {
    fontSize: 16,
  },
  balanceDetailTitle: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  balanceDetailAmount: {
    fontSize: 16,
    fontWeight: 'bold',
  },
  balanceStats: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    gap: spacing.sm,
  },
  statCard: {
    flex: 1,
    alignItems: 'center',
    minHeight: 50,
  },
  statTitle: {
    fontSize: 11,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
    fontWeight: '500',
  },
  statValue: {
    fontSize: 14,
    fontWeight: 'bold',
    marginBottom: 2,
  },
  statSubtitle: {
    fontSize: 9,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  
  // üîß –°–ï–ö–¶–ò–ò –ò –ó–ê–ì–û–õ–û–í–ö–ò
  section: {
    marginBottom: spacing.xxl,
  },
  actionSection: {
    marginBottom: spacing.xxl,
  },
  sectionHeader: {
    marginBottom: spacing.lg,
  },
  sectionHeaderWithButton: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: spacing.lg,
  },
  sectionHeaderText: {
    flex: 1,
  },
  sectionTitle: {
    ...commonStyles.sections.title,
    marginBottom: spacing.xs,
  },
  sectionSubtitle: {
    ...commonStyles.sections.subtitle,
  },
  
  // üîß –ë–´–°–¢–†–´–ï –î–ï–ô–°–¢–í–ò–Ø
  actionButtons: {
    flexDirection: 'row',
    gap: spacing.sm,
  },
  actionButton: {
    flex: 1,
    borderRadius: borderRadius.lg,
    ...shadows.lg,
    minHeight: 80,
  },
  actionButtonContent: {
    flex: 1,
    alignItems: 'center',
    justifyContent: 'center',
    paddingVertical: spacing.lg,
    gap: spacing.xs,
  },
  actionButtonIcon: {
    fontSize: 24,
    color: colors.white,
  },
  actionButtonText: {
    color: colors.white,
    fontSize: 13,
    fontWeight: 'bold',
    textAlign: 'center',
  },
  
  // üîß –ö–ù–û–ü–ö–ê "–í–°–ï"
  seeAllButton: {
    backgroundColor: colors.primary + '15',
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    marginLeft: spacing.md,
  },
  seeAllText: {
    color: colors.primary,
    fontWeight: '600',
    fontSize: 13,
  },
  
  // üîß –ö–ê–¢–ï–ì–û–†–ò–ò –†–ê–°–•–û–î–û–í
  categoriesProgress: {
    ...commonStyles.cards.surface,
  },
  categoryProgressItem: {
    marginBottom: spacing.lg,
  },
  categoryHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.xs,
  },
  categoryTitle: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: spacing.sm,
    flex: 1,
  },
  categoryIcon: {
    fontSize: 16,
  },
  categoryName: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    flex: 1,
  },
  categoryAmountContainer: {
    alignItems: 'flex-end',
  },
  categoryAmount: {
    fontSize: 14,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  categoryPercentage: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '500',
  },
  progressBar: {
    ...commonStyles.progress.container,
  },
  progressFill: {
    ...commonStyles.progress.fill,
  },
  
  // üîß –°–ü–ò–°–û–ö –û–ü–ï–†–ê–¶–ò–ô
  transactionsList: {
    ...commonStyles.cards.surface,
    overflow: 'hidden',
  },
  transactionItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: spacing.lg,
    paddingHorizontal: spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
    minHeight: 70,
  },
  lastTransactionItem: {
    borderBottomWidth: 0,
  },
  transactionIcon: {
    width: 40,
    height: 40,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
  },
  transactionIconText: {
    fontSize: 18,
  },
  transactionInfo: {
    flex: 1,
  },
  transactionDescription: {
    fontSize: 15,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  transactionMeta: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  transactionAmount: {
    fontSize: 15,
    fontWeight: 'bold',
    marginLeft: spacing.sm,
  },
  incomeAmount: {
    color: colors.success,
  },
  expenseAmount: {
    color: colors.error,
  },
  
  // üîß –ü–£–°–¢–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
  emptyState: {
    paddingVertical: spacing.xxxl,
    alignItems: 'center',
    justifyContent: 'center',
  },
  emptyStateIcon: {
    fontSize: 40,
    marginBottom: spacing.lg,
    opacity: 0.5,
  },
  emptyStateTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
    textAlign: 'center',
  },
  emptyStateText: {
    fontSize: 13,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 18,
    paddingHorizontal: spacing.lg,
  },
  
  // üîß –û–¢–°–¢–£–ü
  bottomSpacer: {
    height: spacing.xl,
  },
});

export default HomeScreen;import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

const resources = {
  en: {
    translation: {
      home: 'Home',
      addTransaction: 'Add Transaction',
      transactions: 'Transactions',
      reports: 'Reports',
      balance: 'Balance',
      income: 'Income',
      expense: 'Expense',
      amount: 'Amount',
      category: 'Category',
      date: 'Date',
      description: 'Description',
      save: 'Save',
      recentTransactions: 'Recent Transactions',
      noTransactions: 'No transactions yet'
    }
  },
  ru: {
    translation: {
      home: '–ì–ª–∞–≤–Ω–∞—è',
      addTransaction: '–î–æ–±–∞–≤–∏—Ç—å –æ–ø–µ—Ä–∞—Ü–∏—é',
      transactions: '–û–ø–µ—Ä–∞—Ü–∏–∏',
      reports: '–û—Ç—á–µ—Ç—ã',
      balance: '–ë–∞–ª–∞–Ω—Å',
      income: '–î–æ—Ö–æ–¥',
      expense: '–†–∞—Å—Ö–æ–¥',
      amount: '–°—É–º–º–∞',
      category: '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
      date: '–î–∞—Ç–∞',
      description: '–û–ø–∏—Å–∞–Ω–∏–µ',
      save: '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å',
      recentTransactions: '–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
      noTransactions: '–ü–æ–∫–∞ –Ω–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π'
    }
  }
};

i18n
  .use(initReactI18next)
  .init({
    resources,
    lng: 'ru',
    fallbackLng: 'en',
    interpolation: {
      escapeValue: false
    }
  });

export default i18n;// services/NotificationService.js
import * as Notifications from 'expo-notifications';
import * as Device from 'expo-device';
import { Platform } from 'react-native';

// –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
Notifications.setNotificationHandler({
  handleNotification: async () => ({
    shouldShowAlert: true,
    shouldPlaySound: true,
    shouldSetBadge: true,
  }),
});

class NotificationService {
  constructor() {
    this.isConfigured = false;
    this.notificationListeners = [];
  }

  // üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  configureNotifications = async () => {
    try {
      if (!Device.isDevice) {
        console.log('üì± –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç–∞—é—Ç —Ç–æ–ª—å–∫–æ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö');
        return false;
      }

      // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è
      const { status: existingStatus } = await Notifications.getPermissionsAsync();
      let finalStatus = existingStatus;
      
      if (existingStatus !== 'granted') {
        const { status } = await Notifications.requestPermissionsAsync();
        finalStatus = status;
      }
      
      if (finalStatus !== 'granted') {
        console.log('‚ùå –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ');
        return false;
      }

      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è Android
      if (Platform.OS === 'android') {
        await Notifications.setNotificationChannelAsync('default', {
          name: 'default',
          importance: Notifications.AndroidImportance.MAX,
          vibrationPattern: [0, 250, 250, 250],
          lightColor: '#6C63FF',
          sound: 'default',
        });
      }

      this.isConfigured = true;
      console.log('‚úÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã');
      return true;

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      return false;
    }
  };

  // üîî –°–æ–∑–¥–∞–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  scheduleNotification = async (title, body, trigger = null, data = {}) => {
    try {
      if (!this.isConfigured) {
        await this.configureNotifications();
      }

      const notificationId = await Notifications.scheduleNotificationAsync({
        content: {
          title,
          body,
          sound: true,
          priority: Notifications.AndroidNotificationPriority.HIGH,
          data,
        },
        trigger: trigger || { seconds: 2 }, // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
      });

      console.log('üìÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ:', notificationId);
      return notificationId;

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
      return null;
    }
  };

  // üìÖ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–∞—Ö (–Ω–∞ –æ—Å–Ω–æ–≤–µ –∏—Å—Ç–æ—Ä–∏–∏)
  scheduleRegularPaymentReminder = async (categoryName, averageAmount, dayOfMonth) => {
    try {
      const now = new Date();
      const triggerDate = new Date(now.getFullYear(), now.getMonth(), dayOfMonth, 9, 0, 0);
      
      // –ï—Å–ª–∏ –¥–µ–Ω—å —É–∂–µ –ø—Ä–æ—à–µ–ª –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ, –ø–ª–∞–Ω–∏—Ä—É–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü
      if (triggerDate < now) {
        triggerDate.setMonth(triggerDate.getMonth() + 1);
      }

      const notificationId = await this.scheduleNotification(
        'üí≥ –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ —Ä–µ–≥—É–ª—è—Ä–Ω–æ–º –ø–ª–∞—Ç–µ–∂–µ',
        `–û–∂–∏–¥–∞–µ—Ç—Å—è –ø–ª–∞—Ç–µ–∂ –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}" ~${averageAmount} BYN`,
        { date: triggerDate },
        { type: 'regular_payment', category: categoryName }
      );

      return notificationId;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Ä–µ–≥—É–ª—è—Ä–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞:', error);
      return null;
    }
  };

  // üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –∫—Ä—É–ø–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–∞—Ö
  scheduleLargeExpenseAlert = async (amount, categoryName) => {
    const notificationId = await this.scheduleNotification(
      '‚ö†Ô∏è –ö—Ä—É–ø–Ω—ã–π —Ä–∞—Å—Ö–æ–¥',
      `–ó–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –∫—Ä—É–ø–Ω—ã–π —Ä–∞—Å—Ö–æ–¥: ${amount} BYN –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ "${categoryName}"`,
      null,
      { type: 'large_expense', amount, category: categoryName }
    );

    return notificationId;
  };

  // üìä –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–º –æ—Ç—á–µ—Ç–µ
  scheduleMonthlyReport = async () => {
    try {
      const now = new Date();
      const firstDayNextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1, 10, 0, 0);
      
      const notificationId = await this.scheduleNotification(
        'üìà –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç',
        '–í–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç –∑–∞ –º–µ—Å—è—Ü –≥–æ—Ç–æ–≤! –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É.',
        { date: firstDayNextMonth },
        { type: 'monthly_report' }
      );

      return notificationId;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞:', error);
      return null;
    }
  };

  // üéØ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –±—é–¥–∂–µ—Ç–∞
  scheduleBudgetExceededAlert = async (categoryName, spent, budget) => {
    const notificationId = await this.scheduleNotification(
      'üö® –ü—Ä–µ–≤—ã—à–µ–Ω–∏–µ –±—é–¥–∂–µ—Ç–∞',
      `–ö–∞—Ç–µ–≥–æ—Ä–∏—è "${categoryName}": –ø–æ—Ç—Ä–∞—á–µ–Ω–æ ${spent} –∏–∑ ${budget} BYN`,
      null,
      { type: 'budget_exceeded', category: categoryName, spent, budget }
    );

    return notificationId;
  };

  // ‚ùå –û—Ç–º–µ–Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  cancelNotification = async (notificationId) => {
    try {
      await Notifications.cancelScheduledNotificationAsync(notificationId);
      console.log('‚ùå –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ:', notificationId);
      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', error);
      return false;
    }
  };

  // ‚ùå –û—Ç–º–µ–Ω–∞ –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  cancelAllNotifications = async () => {
    try {
      await Notifications.cancelAllScheduledNotificationsAsync();
      console.log('‚ùå –í—Å–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã');
      return true;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –≤—Å–µ—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      return false;
    }
  };

  // üìã –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  getAllScheduledNotifications = async () => {
    try {
      const notifications = await Notifications.getAllScheduledNotificationsAsync();
      return notifications;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:', error);
      return [];
    }
  };

  // üëÇ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  addNotificationListener = (listener) => {
    const subscription = Notifications.addNotificationReceivedListener(listener);
    this.notificationListeners.push(subscription);
    return subscription;
  };

  // üëÇ –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–ª—É—à–∞—Ç–µ–ª—è –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  addNotificationResponseListener = (listener) => {
    const subscription = Notifications.addNotificationResponseReceivedListener(listener);
    this.notificationListeners.push(subscription);
    return subscription;
  };

  // üßπ –û—á–∏—Å—Ç–∫–∞ —Å–ª—É—à–∞—Ç–µ–ª–µ–π
  cleanupListeners = () => {
    this.notificationListeners.forEach(subscription => subscription.remove());
    this.notificationListeners = [];
  };

  // üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
  getPermissionStatus = async () => {
    try {
      const { status } = await Notifications.getPermissionsAsync();
      return status;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:', error);
      return 'undetermined';
    }
  };

  // üì± –ü–æ–ª—É—á–µ–Ω–∏–µ push token
  getExpoPushToken = async () => {
    try {
      if (!this.isConfigured) {
        await this.configureNotifications();
      }

      const token = await Notifications.getExpoPushTokenAsync({
        projectId: 'your-project-id', // –ù—É–∂–Ω–æ –±—É–¥–µ—Ç –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –¥–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
      });

      return token;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è push token:', error);
      return null;
    }
  };
}

// –°–æ–∑–¥–∞–µ–º singleton —ç–∫–∑–µ–º–ø–ª—è—Ä
const notificationService = new NotificationService();
export default notificationService;{
  "name": "familybudgetapp",
  "license": "0BSD",
  "version": "1.0.0",
  "main": "index.ts",
  "scripts": {
    "start": "expo start",
    "android": "expo run:android",
    "ios": "expo run:ios",
    "web": "expo start --web"
  },
  "dependencies": {
    "@react-native-async-storage/async-storage": "2.2.0",
    "@react-navigation/bottom-tabs": "^7.8.4",
    "@react-navigation/native": "^7.1.19",
    "@react-navigation/stack": "^7.6.3",
    "expo": "~54.0.23",
    "expo-device": "~8.0.9",
    "expo-document-picker": "~14.0.7",
    "expo-notifications": "~0.32.13",
    "expo-sqlite": "~16.0.9",
    "expo-status-bar": "~3.0.8",
    "i18next": "^25.6.2",
    "react": "19.1.0",
    "react-i18next": "^16.2.4",
    "react-native": "0.81.5",
    "react-native-chart-kit": "^6.12.0",
    "react-native-safe-area-context": "~5.6.0",
    "react-native-screens": "~4.16.0",
    "react-native-svg": "15.12.1",
    "victory-native": "^41.20.2"
  },
  "devDependencies": {
    "@types/react": "~19.1.0",
    "typescript": "~5.9.2"
  },
  "private": true
}import React, { useState, useRef, useEffect } from 'react';
import {
  View,
  Text,
  TextInput,
  TouchableOpacity,
  StyleSheet,
  Modal,
  KeyboardAvoidingView,
  Platform,
  Alert,
} from 'react-native';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';

const PaymentModal = ({ visible, credit, onClose }) => {
  const { makeCreditPayment } = useData();
  const [paymentAmount, setPaymentAmount] = useState('');
  const amountInputRef = useRef(null);

  // –°–ë–†–û–° –°–û–°–¢–û–Ø–ù–ò–Ø –ü–†–ò –û–¢–ö–†–´–¢–ò–ò/–ó–ê–ö–†–´–¢–ò–ò
  useEffect(() => {
    if (visible && credit) {
      const defaultAmount = Math.min(credit.monthlyPayment, credit.totalAmount - credit.paidAmount);
      setPaymentAmount(defaultAmount.toString());
      
      // –§–æ–∫—É—Å –Ω–∞ –∏–Ω–ø—É—Ç —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
      setTimeout(() => {
        if (amountInputRef.current) {
          amountInputRef.current.focus();
        }
      }, 100);
    } else {
      setPaymentAmount('');
    }
  }, [visible, credit]);

  if (!credit) return null;

  const remainingAmount = credit.totalAmount - credit.paidAmount;

  // –û–ë–†–ê–ë–û–¢–ö–ê –ë–´–°–¢–†–û–ô –ö–ù–û–ü–ö–ò –°–£–ú–ú–´
  const handleQuickAmount = (amount) => {
    setPaymentAmount(amount.toString());
  };

  // –í–´–ü–û–õ–ù–ï–ù–ò–ï –ü–õ–ê–¢–ï–ñ–ê
  const executePayment = async () => {
    const cleanAmount = paymentAmount.replace(',', '.').replace(/\s/g, '');
    const paymentValue = parseFloat(cleanAmount);

    if (isNaN(paymentValue) || paymentValue <= 0) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É\n–ù–∞–ø—Ä–∏–º–µ—Ä: 15000 –∏–ª–∏ 15000.50');
      return;
    }

    if (paymentValue > remainingAmount) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', `–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å –æ—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞\n–ú–∞–∫—Å–∏–º—É–º: ${formatCurrency(remainingAmount, false)}`);
      return;
    }

    try {
      await makeCreditPayment(credit.id, paymentValue);
      Alert.alert(
        '‚úÖ –ü–ª–∞—Ç–µ–∂ –ø—Ä–∏–Ω—è—Ç!', 
        `–û–ø–ª–∞—á–µ–Ω–æ: ${formatCurrency(paymentValue, false)}\n` +
        `–ù–æ–≤—ã–π –æ—Å—Ç–∞—Ç–æ–∫: ${formatCurrency(remainingAmount - paymentValue, false)}`
      );
      onClose();
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–ª–∞—Ç–µ–∂–∞:', error);
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
    }
  };

  return (
    <Modal
      visible={visible}
      animationType="slide"
      transparent={true}
      onRequestClose={onClose}
      statusBarTranslucent={true}
    >
      <KeyboardAvoidingView 
        style={styles.modalContainer}
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
      >
        <View style={styles.modalContent}>
          <Text style={styles.modalTitle}>üí∏ –í–Ω–µ—Å—Ç–∏ –ø–ª–∞—Ç–µ–∂</Text>
          <Text style={styles.modalSubtitle}>{credit.name}</Text>
          
          <View style={styles.modalInfo}>
            <Text style={styles.modalInfoText}>
              üìÖ –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂: {formatCurrency(credit.monthlyPayment, false)}
            </Text>
            <Text style={styles.modalInfoText}>
              üíé –û—Å—Ç–∞—Ç–æ–∫ –¥–æ–ª–≥–∞: {formatCurrency(remainingAmount, false)}
            </Text>
          </View>

          <View style={styles.amountInputContainer}>
            <Text style={styles.amountLabel}>–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞:</Text>
            <View style={styles.amountInputWrapper}>
              <Text style={styles.currencySymbol}>BYN</Text>
              <TextInput
                ref={amountInputRef}
                style={styles.amountInput}
                value={paymentAmount}
                onChangeText={setPaymentAmount}
                keyboardType="numeric"
                placeholder="0.00"
                placeholderTextColor={colors.textSecondary + '80'}
              />
            </View>
          </View>

          <View style={styles.quickAmounts}>
            <Text style={styles.quickAmountsLabel}>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥:</Text>
            <View style={styles.quickAmountsRow}>
              {[100, 500, 1000, 5000].map(value => (
                <TouchableOpacity
                  key={value}
                  style={[
                    styles.quickAmountButton,
                    paymentAmount === value.toString() && styles.quickAmountButtonActive
                  ]}
                  onPress={() => handleQuickAmount(value)}
                >
                  <Text style={[
                    styles.quickAmountText,
                    paymentAmount === value.toString() && styles.quickAmountTextActive
                  ]}>
                    {value}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
            <View style={styles.quickAmountsRow}>
              {[credit.monthlyPayment, Math.floor(remainingAmount / 2), remainingAmount].map(value => (
                <TouchableOpacity
                  key={value}
                  style={[
                    styles.quickAmountButton,
                    styles.quickAmountButtonLarge,
                    paymentAmount === value.toString() && styles.quickAmountButtonActive
                  ]}
                  onPress={() => handleQuickAmount(value)}
                >
                  <Text style={[
                    styles.quickAmountText,
                    styles.quickAmountTextLarge,
                    paymentAmount === value.toString() && styles.quickAmountTextActive
                  ]}>
                    {value === credit.monthlyPayment ? '–ï–∂–µ–º–µ—Å.' : 
                     value === remainingAmount ? '–í–µ—Å—å –¥–æ–ª–≥' : 
                     '–ü–æ–ª–æ–≤–∏–Ω–∞'}
                  </Text>
                  <Text style={styles.quickAmountHint}>
                    {formatCurrency(value, false)}
                  </Text>
                </TouchableOpacity>
              ))}
            </View>
          </View>

          <View style={styles.modalActions}>
            <TouchableOpacity 
              style={[styles.modalButton, styles.cancelButton]}
              onPress={onClose}
            >
              <Text style={styles.cancelButtonText}>–û—Ç–º–µ–Ω–∞</Text>
            </TouchableOpacity>
            
            <TouchableOpacity 
              style={[
                styles.modalButton, 
                styles.confirmButton,
                !paymentAmount && styles.confirmButtonDisabled
              ]}
              onPress={executePayment}
              disabled={!paymentAmount}
            >
              <Text style={styles.confirmButtonText}>
                {paymentAmount ? 'üí∏ –û–ø–ª–∞—Ç–∏—Ç—å' : '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É'}
              </Text>
            </TouchableOpacity>
          </View>
        </View>
      </KeyboardAvoidingView>
    </Modal>
  );
};

const styles = StyleSheet.create({
  modalContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    padding: 20,
  },
  modalContent: {
    backgroundColor: colors.surface,
    borderRadius: 20,
    padding: 24,
    width: '100%',
    maxWidth: 400,
    elevation: 8,
    shadowColor: colors.textPrimary,
    shadowOffset: { width: 0, height: 4 },
    shadowOpacity: 0.2,
    shadowRadius: 12,
  },
  modalTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: 8,
  },
  modalSubtitle: {
    fontSize: 18,
    color: colors.primary,
    textAlign: 'center',
    marginBottom: 20,
    fontWeight: '600',
  },
  modalInfo: {
    backgroundColor: colors.background,
    borderRadius: 12,
    padding: 16,
    marginBottom: 20,
  },
  modalInfoText: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: 6,
    fontWeight: '500',
  },
  amountInputContainer: {
    marginBottom: 20,
  },
  amountLabel: {
    fontSize: 16,
    color: colors.textPrimary,
    marginBottom: 12,
    fontWeight: '600',
  },
  amountInputWrapper: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.background,
    borderRadius: 16,
    paddingHorizontal: 16,
    borderWidth: 2,
    borderColor: colors.primary,
  },
  currencySymbol: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.primary,
    marginRight: 8,
  },
  amountInput: {
    flex: 1,
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: 14,
  },
  quickAmounts: {
    marginBottom: 24,
  },
  quickAmountsLabel: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: 12,
    fontWeight: '500',
  },
  quickAmountsRow: {
    flexDirection: 'row',
    gap: 8,
    marginBottom: 12,
  },
  quickAmountButton: {
    backgroundColor: colors.primary + '15',
    paddingHorizontal: 12,
    paddingVertical: 8,
    borderRadius: 10,
    borderWidth: 1,
    borderColor: colors.primary + '30',
    flex: 1,
    alignItems: 'center',
  },
  quickAmountButtonLarge: {
    paddingVertical: 10,
  },
  quickAmountButtonActive: {
    backgroundColor: colors.primary,
    borderColor: colors.primary,
  },
  quickAmountText: {
    fontSize: 12,
    fontWeight: '600',
    color: colors.primary,
  },
  quickAmountTextLarge: {
    fontSize: 11,
  },
  quickAmountTextActive: {
    color: colors.white,
  },
  quickAmountHint: {
    fontSize: 10,
    color: colors.textSecondary,
    marginTop: 2,
  },
  modalActions: {
    flexDirection: 'row',
    gap: 12,
  },
  modalButton: {
    flex: 1,
    paddingVertical: 16,
    borderRadius: 14,
    alignItems: 'center',
    justifyContent: 'center',
  },
  cancelButton: {
    backgroundColor: colors.textSecondary,
  },
  cancelButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: '600',
  },
  confirmButton: {
    backgroundColor: colors.primary,
  },
  confirmButtonDisabled: {
    backgroundColor: colors.textSecondary,
    opacity: 0.6,
  },
  confirmButtonText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },
});

export default PaymentModal;// screens/ReportsScreen.js - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import React, { useState, useMemo } from 'react';
import { 
  View, 
  Text, 
  StyleSheet, 
  ScrollView, 
  TouchableOpacity, 
  Dimensions,
  Alert,
  Share,
  RefreshControl,
  Modal
} from 'react-native';
import { LineChart, BarChart } from 'react-native-chart-kit';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const { width } = Dimensions.get('window');

const ReportsScreen = () => {
  const { 
    transactions, 
    categories, 
    getMonthlyComparison,
    getRegularPaymentsAnalysis,
    getSpendingForecast,
    getEnhancedCategoryAnalytics,
    getSmartFinancialTips
  } = useData();
  
  const [activeTab, setActiveTab] = useState('overview');
  const [refreshing, setRefreshing] = useState(false);
  const [selectedPeriod, setSelectedPeriod] = useState('3m');
  const [showPeriodSelector, setShowPeriodSelector] = useState(false);
  const [expandedPayment, setExpandedPayment] = useState(null);
  const [showRegularDetails, setShowRegularDetails] = useState(false);

  // üìä –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ê
  const monthlyComparison = useMemo(() => 
    getMonthlyComparison(6), [getMonthlyComparison, transactions]
  );

  const regularPayments = useMemo(() => 
    getRegularPaymentsAnalysis(), [getRegularPaymentsAnalysis, transactions]
  );

  const spendingForecast = useMemo(() => 
    getSpendingForecast(), [getSpendingForecast, transactions]
  );

  const categoryAnalytics = useMemo(() => 
    getEnhancedCategoryAnalytics(3), [getEnhancedCategoryAnalytics, transactions]
  );

  const smartTips = useMemo(() => 
    getSmartFinancialTips(), [getSmartFinancialTips]
  );

  // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  const onRefresh = React.useCallback(() => {
    setRefreshing(true);
    setTimeout(() => setRefreshing(false), 1000);
  }, []);

  // üìà –î–∞–Ω–Ω—ã–µ –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤
  const chartData = useMemo(() => {
    if (monthlyComparison.length === 0) return null;

    return {
      labels: monthlyComparison.map(m => 
        m.period.split(' ')[0].substring(0, 3).toUpperCase()
      ),
      datasets: [
        {
          data: monthlyComparison.map(m => m.income),
          color: (opacity = 1) => `rgba(76, 175, 80, ${opacity})`,
          strokeWidth: 3,
        },
        {
          data: monthlyComparison.map(m => m.expense),
          color: (opacity = 1) => `rgba(244, 67, 54, ${opacity})`,
          strokeWidth: 3,
        },
      ],
    };
  }, [monthlyComparison]);

  const chartConfig = {
    backgroundColor: colors.surface,
    backgroundGradientFrom: colors.surface,
    backgroundGradientTo: colors.surface,
    decimalPlaces: 0,
    color: (opacity = 1) => `rgba(108, 99, 255, ${opacity})`,
    labelColor: (opacity = 1) => `rgba(30, 41, 59, ${opacity})`,
    style: {
      borderRadius: borderRadius.lg,
    },
    propsForDots: {
      r: '5',
      strokeWidth: '2',
      stroke: colors.primary,
    },
  };

  // üì§ –§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –æ—Ç—á–µ—Ç–∞
  const exportEnhancedReport = async () => {
    try {
      const reportData = `
üìä –†–ê–°–®–ò–†–ï–ù–ù–´–ô –§–ò–ù–ê–ù–°–û–í–´–ô –û–¢–ß–ï–¢
–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}

–°–†–ê–í–ù–ï–ù–ò–ï –ü–û –ú–ï–°–Ø–¶–ê–ú:
${monthlyComparison.map(month => `
${month.period}:
  üìà –î–æ—Ö–æ–¥—ã: ${formatCurrency(month.income, false)}
  üìâ –†–∞—Å—Ö–æ–¥—ã: ${formatCurrency(month.expense, false)} 
  üí∞ –ë–∞–ª–∞–Ω—Å: ${formatCurrency(month.balance, false)}
  üî¢ –û–ø–µ—Ä–∞—Ü–∏–π: ${month.transactionCount}
`).join('')}

–†–ï–ì–£–õ–Ø–†–ù–´–ï –ü–õ–ê–¢–ï–ñ–ò:
${regularPayments.map(payment => `
üîÑ ${payment.category}: ~${formatCurrency(payment.averageAmount, false)} 
   (–∫–∞–∂–¥–æ–µ ${payment.expectedDay}-–µ —á–∏—Å–ª–æ, —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: ${payment.confidence.toFixed(0)}%)
`).join('')}

–ü–†–û–ì–ù–û–ó –ù–ê –°–õ–ï–î–£–Æ–©–ò–ô –ú–ï–°–Ø–¶:
üîÆ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: ${formatCurrency(spendingForecast.expectedRegular, false)}
üéØ –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–≥–Ω–æ–∑–∞: ${spendingForecast.confidence.toFixed(0)}%

–¢–û–ü –ö–ê–¢–ï–ì–û–†–ò–ò –†–ê–°–•–û–î–û–í (–∑–∞ 3 –º–µ—Å—è—Ü–∞):
${categoryAnalytics.slice(0, 5).map(cat => `
üè∑Ô∏è ${cat.name}: ${formatCurrency(cat.total, false)} 
   (${cat.count} –æ–ø–µ—Ä–∞—Ü–∏–π, —Å—Ä–µ–¥–Ω–µ–µ: ${formatCurrency(cat.average, true)})
`).join('')}

–£–ú–ù–´–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
${smartTips.map(tip => `${tip.icon} ${tip.title}: ${tip.text}`).join('\n')}

---
–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –≤ FamilyBudget App
      `.trim();

      await Share.share({
        title: '–ú–æ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ—Ç—á–µ—Ç',
        message: reportData,
      });
    } catch (error) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç—á–µ—Ç');
    }
  };

  // üìä –ö–û–ú–ü–û–ù–ï–ù–¢: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –º–µ—Å—è—Ü–µ–≤
  const MonthlyComparisonCard = () => (
    <View style={styles.analyticsCard}>
      <View style={styles.cardHeader}>
        <Text style={styles.sectionTitle}>üìÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–æ –º–µ—Å—è—Ü–∞–º</Text>
        <TouchableOpacity 
          style={styles.periodSelector}
          onPress={() => setShowPeriodSelector(true)}
        >
          <Text style={styles.periodText}>{selectedPeriod === '3m' ? '3 –º–µ—Å' : '6 –º–µ—Å'}</Text>
          <Text style={styles.periodIcon}>‚åÑ</Text>
        </TouchableOpacity>
      </View>
      
      {monthlyComparison.length > 0 ? (
        monthlyComparison.map((month, index) => (
          <View key={index} style={styles.monthRow}>
            <View style={styles.monthInfo}>
              <Text style={styles.monthName}>{month.period}</Text>
              <Text style={styles.monthStats}>
                {month.transactionCount} –æ–ø–µ—Ä–∞—Ü–∏–π
              </Text>
            </View>
            
            <View style={styles.monthAmounts}>
              <View style={styles.amountRow}>
                <Text style={styles.amountLabel}>–î–æ—Ö–æ–¥—ã:</Text>
                <Text style={styles.incomeText}>
                  {formatCurrency(month.income, false)}
                </Text>
              </View>
              
              <View style={styles.amountRow}>
                <Text style={styles.amountLabel}>–†–∞—Å—Ö–æ–¥—ã:</Text>
                <Text style={styles.expenseText}>
                  {formatCurrency(month.expense, false)}
                </Text>
              </View>
              
              <View style={styles.amountRow}>
                <Text style={styles.amountLabel}>–ë–∞–ª–∞–Ω—Å:</Text>
                <Text style={[
                  styles.balanceText,
                  { color: month.balance >= 0 ? colors.success : colors.error }
                ]}>
                  {formatCurrency(month.balance, false)}
                </Text>
              </View>
            </View>

            {month.incomeChange !== undefined && (
              <View style={[
                styles.changeIndicator,
                { backgroundColor: month.incomeChange >= 0 ? 
                  `${colors.success}20` : `${colors.error}20` }
              ]}>
                <Text style={[
                  styles.changeText,
                  { color: month.incomeChange >= 0 ? colors.success : colors.error }
                ]}>
                  {month.incomeChange >= 0 ? '‚Üó' : '‚Üò'} {Math.abs(month.incomeChange).toFixed(1)}%
                </Text>
              </View>
            )}
          </View>
        ))
      ) : (
        <Text style={styles.noDataText}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</Text>
      )}
    </View>
  );

  // üîÑ –ö–û–ú–ü–û–ù–ï–ù–¢: –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ (–£–õ–£–ß–®–ï–ù–ù–´–ô)
  const RegularPaymentsCard = () => (
    <View style={styles.analyticsCard}>
      <View style={styles.cardHeader}>
        <Text style={styles.sectionTitle}>üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</Text>
        {regularPayments.length > 0 && (
          <TouchableOpacity 
            style={styles.detailsButton}
            onPress={() => setShowRegularDetails(true)}
          >
            <Text style={styles.detailsButtonText}>–ü–æ–¥—Ä–æ–±–Ω–µ–µ</Text>
          </TouchableOpacity>
        )}
      </View>
      
      {regularPayments.length > 0 ? (
        <>
          <Text style={styles.regularSubtitle}>
            –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ {regularPayments.length} —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
          </Text>
          
          {regularPayments.slice(0, 3).map((payment, index) => (
            <TouchableOpacity 
              key={index} 
              style={styles.paymentRow}
              onPress={() => setExpandedPayment(expandedPayment === index ? null : index)}
            >
              <View style={styles.paymentIcon}>
                <Text style={styles.paymentIconText}>{payment.icon}</Text>
              </View>
              
              <View style={styles.paymentInfo}>
                <Text style={styles.paymentName}>{payment.category}</Text>
                <Text style={styles.paymentDetails}>
                  ~{formatCurrency(payment.averageAmount, false)} ‚Ä¢ {payment.expectedDay}-–µ —á–∏—Å–ª–æ
                </Text>
                
                {expandedPayment === index && (
                  <View style={styles.paymentExpanded}>
                    <Text style={styles.expandedText}>
                      –ß–∞—Å—Ç–æ—Ç–∞: {payment.frequency} —Ä–∞–∑(–∞) –∑–∞ 3 –º–µ—Å—è—Ü–∞
                    </Text>
                    <Text style={styles.expandedText}>
                      –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {payment.confidence.toFixed(0)}%
                    </Text>
                    {payment.lastTransaction && (
                      <Text style={styles.expandedText}>
                        –ü–æ—Å–ª–µ–¥–Ω–∏–π: {new Date(payment.lastTransaction.date).toLocaleDateString('ru-RU')}
                      </Text>
                    )}
                  </View>
                )}
              </View>
              
              <View style={styles.paymentConfidenceBadge}>
                <Text style={styles.confidenceText}>
                  {payment.confidence.toFixed(0)}%
                </Text>
              </View>
            </TouchableOpacity>
          ))}
          
          {regularPayments.length > 3 && (
            <TouchableOpacity 
              style={styles.showMoreButton}
              onPress={() => setShowRegularDetails(true)}
            >
              <Text style={styles.showMoreText}>
                –ü–æ–∫–∞–∑–∞—Ç—å –µ—â–µ {regularPayments.length - 3} –ø–ª–∞—Ç–µ–∂–µ–π...
              </Text>
            </TouchableOpacity>
          )}
        </>
      ) : (
        <Text style={styles.noDataText}>–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã</Text>
      )}
    </View>
  );

  // üîÆ –ö–û–ú–ü–û–ù–ï–ù–¢: –ü—Ä–æ–≥–Ω–æ–∑ —Ä–∞—Å—Ö–æ–¥–æ–≤ (–£–õ–£–ß–®–ï–ù–ù–´–ô)
  const SpendingForecastCard = () => {
    const confidenceColor = spendingForecast.confidence > 70 ? colors.success : 
                           spendingForecast.confidence > 40 ? colors.warning : colors.error;

    return (
      <View style={styles.analyticsCard}>
        <Text style={styles.sectionTitle}>üîÆ –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –º–µ—Å—è—Ü</Text>
        
        <View style={styles.forecastHeader}>
          <View style={styles.forecastAmountContainer}>
            <Text style={styles.forecastAmount}>
              {formatCurrency(spendingForecast.expectedRegular, false)}
            </Text>
            <Text style={styles.forecastLabel}>–æ–∂–∏–¥–∞–µ–º—ã–µ —Ä–∞—Å—Ö–æ–¥—ã</Text>
          </View>
          
          <View style={[
            styles.confidenceBadge,
            { backgroundColor: `${confidenceColor}20` }
          ]}>
            <Text style={[styles.confidenceText, { color: confidenceColor }]}>
              –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {spendingForecast.confidence.toFixed(0)}%
            </Text>
          </View>
        </View>

        <Text style={styles.forecastSubtitle}>–û–∂–∏–¥–∞–µ–º—ã–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:</Text>
        
        {Object.entries(spendingForecast.predictedCategories).slice(0, 5).map(([category, data], index) => (
          <View key={index} style={styles.forecastRow}>
            <View style={styles.forecastCategory}>
              <View style={styles.categoryDot} />
              <Text style={styles.forecastCategoryName}>{category}</Text>
            </View>
            <View style={styles.forecastDetails}>
              <Text style={styles.forecastPrediction}>
                {formatCurrency(data.amount, false)}
              </Text>
              <View style={styles.probabilityBadge}>
                <Text style={styles.probabilityText}>
                  {data.confidence.toFixed(0)}%
                </Text>
              </View>
            </View>
          </View>
        ))}
        
        {Object.keys(spendingForecast.predictedCategories).length > 5 && (
          <Text style={styles.moreCategoriesText}>
            ...–∏ –µ—â–µ {Object.keys(spendingForecast.predictedCategories).length - 5} –∫–∞—Ç–µ–≥–æ—Ä–∏–π
          </Text>
        )}
      </View>
    );
  };

  // üí° –ö–û–ú–ü–û–ù–ï–ù–¢: –£–º–Ω—ã–µ —Å–æ–≤–µ—Ç—ã (–£–õ–£–ß–®–ï–ù–ù–´–ô)
  const SmartTipsCard = () => (
    <View style={styles.analyticsCard}>
      <Text style={styles.sectionTitle}>üí° –£–º–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</Text>
      
      {smartTips.length > 0 ? (
        smartTips.map((tip, index) => (
          <TouchableOpacity 
            key={index} 
            style={[
              styles.tipCard,
              { 
                borderLeftColor: 
                  tip.type === 'warning' ? colors.error :
                  tip.priority === 1 ? colors.warning : colors.primary
              }
            ]}
          >
            <Text style={styles.tipIcon}>{tip.icon}</Text>
            <View style={styles.tipContent}>
              <View style={styles.tipHeader}>
                <Text style={styles.tipTitle}>{tip.title}</Text>
                {tip.type === 'warning' && (
                  <View style={styles.warningBadge}>
                    <Text style={styles.warningText}>–í–Ω–∏–º–∞–Ω–∏–µ</Text>
                  </View>
                )}
              </View>
              <Text style={styles.tipText}>{tip.text}</Text>
            </View>
          </TouchableOpacity>
        ))
      ) : (
        <Text style={styles.noDataText}>–ü–æ–∫–∞ –Ω–µ—Ç —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π</Text>
      )}
    </View>
  );

  // üìä –ö–û–ú–ü–û–ù–ï–ù–¢: –ì—Ä–∞—Ñ–∏–∫ –¥–∏–Ω–∞–º–∏–∫–∏
  const ChartSection = () => (
    <View style={styles.chartSection}>
      <Text style={styles.sectionTitle}>–î–∏–Ω–∞–º–∏–∫–∞ –¥–æ—Ö–æ–¥–æ–≤ –∏ —Ä–∞—Å—Ö–æ–¥–æ–≤</Text>
      {chartData ? (
        <>
          <LineChart
            data={chartData}
            width={width - spacing.xl * 2}
            height={240}
            chartConfig={chartConfig}
            bezier
            style={styles.chart}
          />
          <View style={styles.legend}>
            <View style={styles.legendItem}>
              <View style={[styles.legendDot, { backgroundColor: colors.success }]} />
              <Text style={styles.legendText}>–î–æ—Ö–æ–¥—ã</Text>
            </View>
            <View style={styles.legendItem}>
              <View style={[styles.legendDot, { backgroundColor: colors.error }]} />
              <Text style={styles.legendText}>–†–∞—Å—Ö–æ–¥—ã</Text>
            </View>
          </View>
        </>
      ) : (
        <View style={styles.noChartData}>
          <Text style={styles.noChartText}>–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞</Text>
          <Text style={styles.noChartSubtext}>–î–æ–±–∞–≤—å—Ç–µ –±–æ–ª—å—à–µ –æ–ø–µ—Ä–∞—Ü–∏–π</Text>
        </View>
      )}
    </View>
  );

  // –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –î–µ—Ç–∞–ª–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π
  const RegularPaymentsModal = () => (
    <Modal
      visible={showRegularDetails}
      transparent
      animationType="slide"
      onRequestClose={() => setShowRegularDetails(false)}
    >
      <View style={styles.modalOverlay}>
        <View style={styles.modalContent}>
          <View style={styles.modalHeader}>
            <Text style={styles.modalTitle}>–í—Å–µ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏</Text>
            <TouchableOpacity 
              onPress={() => setShowRegularDetails(false)}
              style={styles.closeButton}
            >
              <Text style={styles.closeButtonText}>‚úï</Text>
            </TouchableOpacity>
          </View>
          
          <ScrollView style={styles.modalScroll}>
            {regularPayments.map((payment, index) => (
              <View key={index} style={styles.detailedPaymentRow}>
                <View style={styles.detailedPaymentHeader}>
                  <Text style={styles.detailedPaymentIcon}>{payment.icon}</Text>
                  <View style={styles.detailedPaymentInfo}>
                    <Text style={styles.detailedPaymentName}>{payment.category}</Text>
                    <Text style={styles.detailedPaymentDate}>
                      {payment.expectedDay}-–µ —á–∏—Å–ª–æ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
                    </Text>
                  </View>
                  <View style={styles.detailedPaymentConfidence}>
                    <Text style={styles.detailedConfidenceText}>
                      {payment.confidence.toFixed(0)}%
                    </Text>
                  </View>
                </View>
                
                <View style={styles.detailedPaymentStats}>
                  <View style={styles.statItem}>
                    <Text style={styles.statLabel}>–°—Ä–µ–¥–Ω—è—è —Å—É–º–º–∞:</Text>
                    <Text style={styles.statValue}>
                      {formatCurrency(payment.averageAmount, false)}
                    </Text>
                  </View>
                  <View style={styles.statItem}>
                    <Text style={styles.statLabel}>–ß–∞—Å—Ç–æ—Ç–∞:</Text>
                    <Text style={styles.statValue}>
                      {payment.frequency} —Ä–∞–∑(–∞) –∑–∞ 3 –º–µ—Å—è—Ü–∞
                    </Text>
                  </View>
                  <View style={styles.statItem}>
                    <Text style={styles.statLabel}>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–ª–∞—Ç–µ–∂:</Text>
                    <Text style={styles.statValue}>
                      {payment.lastTransaction ? 
                        new Date(payment.lastTransaction.date).toLocaleDateString('ru-RU') : 
                        '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'}
                    </Text>
                  </View>
                </View>
              </View>
            ))}
          </ScrollView>
          
          <View style={styles.modalFooter}>
            <TouchableOpacity 
              style={styles.modalActionButton}
              onPress={() => setShowRegularDetails(false)}
            >
              <Text style={styles.modalActionText}>–ó–∞–∫—Ä—ã—Ç—å</Text>
            </TouchableOpacity>
          </View>
        </View>
      </View>
    </Modal>
  );

  // –ü–ï–†–ò–û–î–´
  const PeriodSelectorModal = () => (
    <Modal
      visible={showPeriodSelector}
      transparent
      animationType="fade"
      onRequestClose={() => setShowPeriodSelector(false)}
    >
      <TouchableOpacity 
        style={styles.modalOverlay}
        activeOpacity={1}
        onPress={() => setShowPeriodSelector(false)}
      >
        <View style={styles.periodModalContent}>
          {['3m', '6m'].map(period => (
            <TouchableOpacity
              key={period}
              style={[
                styles.periodOption,
                selectedPeriod === period && styles.periodOptionActive
              ]}
              onPress={() => {
                setSelectedPeriod(period);
                setShowPeriodSelector(false);
              }}
            >
              <Text style={[
                styles.periodOptionText,
                selectedPeriod === period && styles.periodOptionTextActive
              ]}>
                {period === '3m' ? '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 3 –º–µ—Å—è—Ü–∞' : '–ü–æ—Å–ª–µ–¥–Ω–∏–µ 6 –º–µ—Å—è—Ü–µ–≤'}
              </Text>
            </TouchableOpacity>
          ))}
        </View>
      </TouchableOpacity>
    </Modal>
  );

  return (
    <View style={styles.container}>
      {/* –®–ê–ü–ö–ê –≠–ö–†–ê–ù–ê */}
      <View style={styles.screenHeader}>
        <View style={styles.headerContent}>
          <Text style={styles.screenTitle}>üìä –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞</Text>
          <Text style={styles.screenSubtitle}>–ì–ª—É–±–æ–∫–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –ø—Ä–æ–≥–Ω–æ–∑—ã</Text>
        </View>
        
        <TouchableOpacity style={styles.exportButton} onPress={exportEnhancedReport}>
          <Text style={styles.exportButtonText}>üì§ –≠–∫—Å–ø–æ—Ä—Ç</Text>
        </TouchableOpacity>
      </View>

      {/* –í–ö–õ–ê–î–ö–ò –ù–ê–í–ò–ì–ê–¶–ò–ò (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï) */}
      <View style={styles.tabContainer}>
        <ScrollView 
          horizontal 
          showsHorizontalScrollIndicator={false}
          contentContainerStyle={styles.tabScrollContent}
        >
          {[
            { id: 'overview', label: 'üìà –û–±–∑–æ—Ä', icon: 'üìà' },
            { id: 'comparison', label: 'üìÖ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ', icon: 'üìÖ' },
            { id: 'regular', label: 'üîÑ –†–µ–≥—É–ª—è—Ä–Ω—ã–µ', icon: 'üîÑ' },
            { id: 'forecast', label: 'üîÆ –ü—Ä–æ–≥–Ω–æ–∑', icon: 'üîÆ' },
            { id: 'tips', label: 'üí° –°–æ–≤–µ—Ç—ã', icon: 'üí°' },
          ].map(tab => (
            <TouchableOpacity
              key={tab.id}
              style={[
                styles.tabItem,
                activeTab === tab.id && styles.tabItemActive
              ]}
              onPress={() => setActiveTab(tab.id)}
            >
              <Text style={[
                styles.tabIcon,
                activeTab === tab.id && styles.tabIconActive
              ]}>
                {tab.icon}
              </Text>
              <Text style={[
                styles.tabLabel,
                activeTab === tab.id && styles.tabLabelActive
              ]}>
                {tab.label.replace(tab.icon + ' ', '')}
              </Text>
              {activeTab === tab.id && <View style={styles.tabIndicator} />}
            </TouchableOpacity>
          ))}
        </ScrollView>
      </View>

      <ScrollView 
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        contentContainerStyle={styles.scrollContent}
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />
        }
      >
        {/* –û–ë–ó–û–† */}
        {activeTab === 'overview' && (
          <>
            <ChartSection />
            <MonthlyComparisonCard />
            <RegularPaymentsCard />
            <SmartTipsCard />
          </>
        )}

        {/* –°–†–ê–í–ù–ï–ù–ò–ï */}
        {activeTab === 'comparison' && (
          <>
            <MonthlyComparisonCard />
            <SpendingForecastCard />
          </>
        )}

        {/* –†–ï–ì–£–õ–Ø–†–ù–´–ï –ü–õ–ê–¢–ï–ñ–ò */}
        {activeTab === 'regular' && (
          <RegularPaymentsCard />
        )}

        {/* –ü–†–û–ì–ù–û–ó */}
        {activeTab === 'forecast' && (
          <>
            <SpendingForecastCard />
            <SmartTipsCard />
          </>
        )}

        {/* –°–û–í–ï–¢–´ */}
        {activeTab === 'tips' && (
          <SmartTipsCard />
        )}

        {/* –ü–£–°–¢–û–ï –°–û–°–¢–û–Ø–ù–ò–ï */}
        {transactions.length === 0 && (
          <View style={styles.emptyState}>
            <Text style={styles.emptyStateIcon}>üìä</Text>
            <Text style={styles.emptyStateTitle}>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏</Text>
            <Text style={styles.emptyStateText}>
              –î–æ–±–∞–≤—å—Ç–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —á—Ç–æ–±—ã —É–≤–∏–¥–µ—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
            </Text>
          </View>
        )}
      </ScrollView>

      {/* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */}
      <RegularPaymentsModal />
      <PeriodSelectorModal />
    </View>
  );
};

// üé® –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    paddingTop: 60,
    paddingHorizontal: spacing.xl,
    paddingBottom: spacing.lg,
    backgroundColor: colors.background,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  headerContent: {
    flex: 1,
  },
  screenTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  screenSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  exportButton: {
    backgroundColor: colors.primary,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    ...shadows.sm,
  },
  exportButtonText: {
    color: colors.white,
    fontSize: 14,
    fontWeight: '600',
  },
  // –í–ö–õ–ê–î–ö–ò –ù–ê–í–ò–ì–ê–¶–ò–ò
  tabContainer: {
    backgroundColor: colors.surface,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  tabScrollContent: {
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.sm,
  },
  tabItem: {
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    marginRight: spacing.sm,
    alignItems: 'center',
    minWidth: 80,
  },
  tabItemActive: {
    backgroundColor: `${colors.primary}10`,
    borderRadius: borderRadius.lg,
  },
  tabIcon: {
    fontSize: 20,
    marginBottom: spacing.xs,
    color: colors.textSecondary,
  },
  tabIconActive: {
    color: colors.primary,
  },
  tabLabel: {
    fontSize: 12,
    fontWeight: '600',
    color: colors.textSecondary,
  },
  tabLabelActive: {
    color: colors.primary,
    fontWeight: 'bold',
  },
  tabIndicator: {
    position: 'absolute',
    bottom: -spacing.sm,
    left: '20%',
    right: '20%',
    height: 3,
    backgroundColor: colors.primary,
    borderRadius: borderRadius.xs,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxxl,
  },
  analyticsCard: {
    ...commonStyles.cards.elevated,
    marginBottom: spacing.xl,
    padding: spacing.lg,
  },
  cardHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.lg,
  },
  sectionTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
  },
  periodSelector: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.background,
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.xs,
    borderRadius: borderRadius.sm,
    borderWidth: 1,
    borderColor: colors.border,
  },
  periodText: {
    fontSize: 12,
    color: colors.textSecondary,
    marginRight: spacing.xs,
  },
  periodIcon: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  detailsButton: {
    backgroundColor: colors.background,
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.xs,
    borderRadius: borderRadius.sm,
    borderWidth: 1,
    borderColor: colors.border,
  },
  detailsButtonText: {
    fontSize: 12,
    color: colors.primary,
    fontWeight: '500',
  },
  // –°–¢–ò–õ–ò –î–õ–Ø –°–†–ê–í–ù–ï–ù–ò–Ø –ú–ï–°–Ø–¶–ï–í
  monthRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  monthInfo: {
    flex: 1,
  },
  monthName: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  monthStats: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  monthAmounts: {
    alignItems: 'flex-end',
    marginRight: spacing.md,
  },
  amountRow: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 2,
  },
  amountLabel: {
    fontSize: 11,
    color: colors.textSecondary,
    marginRight: spacing.xs,
  },
  incomeText: {
    fontSize: 12,
    color: colors.success,
    fontWeight: '600',
  },
  expenseText: {
    fontSize: 12,
    color: colors.error,
    fontWeight: '600',
  },
  balanceText: {
    fontSize: 12,
    fontWeight: 'bold',
  },
  changeIndicator: {
    paddingHorizontal: spacing.sm,
    paddingVertical: spacing.xs,
    borderRadius: borderRadius.sm,
  },
  changeText: {
    fontSize: 10,
    fontWeight: 'bold',
  },
  // –°–¢–ò–õ–ò –î–õ–Ø –†–ï–ì–£–õ–Ø–†–ù–´–• –ü–õ–ê–¢–ï–ñ–ï–ô
  regularSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
    marginBottom: spacing.lg,
  },
  paymentRow: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  paymentIcon: {
    width: 40,
    height: 40,
    borderRadius: borderRadius.md,
    backgroundColor: colors.background,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
  },
  paymentIconText: {
    fontSize: 18,
  },
  paymentInfo: {
    flex: 1,
  },
  paymentName: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  paymentDetails: {
    fontSize: 12,
    color: colors.textSecondary,
    marginBottom: 2,
  },
  paymentExpanded: {
    marginTop: spacing.sm,
    padding: spacing.sm,
    backgroundColor: colors.background,
    borderRadius: borderRadius.sm,
  },
  expandedText: {
    fontSize: 11,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
  },
  paymentConfidenceBadge: {
    backgroundColor: colors.primary,
    paddingHorizontal: spacing.sm,
    paddingVertical: spacing.xs,
    borderRadius: borderRadius.sm,
  },
  confidenceText: {
    color: colors.white,
    fontSize: 11,
    fontWeight: 'bold',
  },
  showMoreButton: {
    padding: spacing.md,
    alignItems: 'center',
    marginTop: spacing.sm,
  },
  showMoreText: {
    color: colors.primary,
    fontSize: 13,
    fontWeight: '500',
  },
  // –°–¢–ò–õ–ò –î–õ–Ø –ü–†–û–ì–ù–û–ó–ê
  forecastHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.lg,
    paddingBottom: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  forecastAmountContainer: {
    alignItems: 'flex-start',
  },
  forecastAmount: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  forecastLabel: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  confidenceBadge: {
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.xs,
    borderRadius: borderRadius.sm,
  },
  forecastSubtitle: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: spacing.md,
  },
  forecastRow: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: spacing.sm,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  forecastCategory: {
    flexDirection: 'row',
    alignItems: 'center',
    flex: 1,
  },
  categoryDot: {
    width: 8,
    height: 8,
    borderRadius: 4,
    backgroundColor: colors.primary,
    marginRight: spacing.sm,
  },
  forecastCategoryName: {
    fontSize: 14,
    color: colors.textPrimary,
  },
  forecastDetails: {
    alignItems: 'flex-end',
  },
  forecastPrediction: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    marginBottom: 2,
  },
  probabilityBadge: {
    backgroundColor: colors.background,
    paddingHorizontal: spacing.sm,
    paddingVertical: 2,
    borderRadius: borderRadius.xs,
  },
  probabilityText: {
    fontSize: 10,
    color: colors.textSecondary,
  },
  moreCategoriesText: {
    fontSize: 12,
    color: colors.textSecondary,
    textAlign: 'center',
    marginTop: spacing.sm,
    fontStyle: 'italic',
  },
  // –°–¢–ò–õ–ò –î–õ–Ø –ì–†–ê–§–ò–ö–ê
  chartSection: {
    ...commonStyles.cards.elevated,
    marginBottom: spacing.xl,
    padding: spacing.lg,
  },
  chart: {
    borderRadius: borderRadius.lg,
    marginVertical: spacing.sm,
  },
  legend: {
    flexDirection: 'row',
    justifyContent: 'center',
    marginTop: spacing.md,
  },
  legendItem: {
    flexDirection: 'row',
    alignItems: 'center',
    marginHorizontal: spacing.md,
  },
  legendDot: {
    width: 12,
    height: 12,
    borderRadius: 6,
    marginRight: spacing.xs,
  },
  legendText: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  noChartData: {
    height: 200,
    justifyContent: 'center',
    alignItems: 'center',
  },
  noChartText: {
    fontSize: 16,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
  },
  noChartSubtext: {
    fontSize: 14,
    color: colors.textSecondary,
    opacity: 0.7,
  },
  // –°–¢–ò–õ–ò –î–õ–Ø –°–û–í–ï–¢–û–í
  tipCard: {
    flexDirection: 'row',
    alignItems: 'flex-start',
    padding: spacing.md,
    marginBottom: spacing.md,
    backgroundColor: colors.surface,
    borderRadius: borderRadius.md,
    borderLeftWidth: 4,
    ...shadows.sm,
  },
  tipIcon: {
    fontSize: 20,
    marginRight: spacing.md,
    marginTop: spacing.xs,
  },
  tipContent: {
    flex: 1,
  },
  tipHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.xs,
  },
  tipTitle: {
    fontSize: 14,
    fontWeight: 'bold',
    color: colors.textPrimary,
    flex: 1,
  },
  warningBadge: {
    backgroundColor: colors.error,
    paddingHorizontal: spacing.sm,
    paddingVertical: 2,
    borderRadius: borderRadius.xs,
    marginLeft: spacing.sm,
  },
  warningText: {
    color: colors.white,
    fontSize: 10,
    fontWeight: 'bold',
  },
  tipText: {
    fontSize: 13,
    color: colors.textSecondary,
    lineHeight: 18,
  },
  // –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'flex-end',
  },
  modalContent: {
    backgroundColor: colors.surface,
    borderTopLeftRadius: borderRadius.xl,
    borderTopRightRadius: borderRadius.xl,
    maxHeight: '80%',
  },
  modalHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    padding: spacing.lg,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
  },
  closeButton: {
    width: 32,
    height: 32,
    borderRadius: 16,
    backgroundColor: colors.background,
    alignItems: 'center',
    justifyContent: 'center',
  },
  closeButtonText: {
    fontSize: 18,
    color: colors.textSecondary,
  },
  modalScroll: {
    padding: spacing.lg,
  },
  detailedPaymentRow: {
    backgroundColor: colors.background,
    borderRadius: borderRadius.md,
    padding: spacing.md,
    marginBottom: spacing.md,
  },
  detailedPaymentHeader: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  detailedPaymentIcon: {
    fontSize: 24,
    marginRight: spacing.md,
  },
  detailedPaymentInfo: {
    flex: 1,
  },
  detailedPaymentName: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  detailedPaymentDate: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  detailedPaymentConfidence: {
    backgroundColor: colors.primary,
    paddingHorizontal: spacing.sm,
    paddingVertical: spacing.xs,
    borderRadius: borderRadius.sm,
  },
  detailedConfidenceText: {
    color: colors.white,
    fontSize: 12,
    fontWeight: 'bold',
  },
  detailedPaymentStats: {
    borderTopWidth: 1,
    borderTopColor: colors.border,
    paddingTop: spacing.md,
  },
  statItem: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    marginBottom: spacing.sm,
  },
  statLabel: {
    fontSize: 13,
    color: colors.textSecondary,
  },
  statValue: {
    fontSize: 13,
    fontWeight: '600',
    color: colors.textPrimary,
  },
  modalFooter: {
    padding: spacing.lg,
    borderTopWidth: 1,
    borderTopColor: colors.border,
  },
  modalActionButton: {
    backgroundColor: colors.primary,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    alignItems: 'center',
  },
  modalActionText: {
    color: colors.white,
    fontSize: 16,
    fontWeight: 'bold',
  },
  periodModalContent: {
    position: 'absolute',
    top: 120,
    right: spacing.xl,
    backgroundColor: colors.surface,
    borderRadius: borderRadius.md,
    ...shadows.xl,
    minWidth: 180,
  },
  periodOption: {
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
  },
  periodOptionActive: {
    backgroundColor: `${colors.primary}10`,
  },
  periodOptionText: {
    fontSize: 14,
    color: colors.textPrimary,
  },
  periodOptionTextActive: {
    color: colors.primary,
    fontWeight: 'bold',
  },
  noDataText: {
    textAlign: 'center',
    color: colors.textSecondary,
    fontStyle: 'italic',
    padding: spacing.xl,
  },
  emptyState: {
    alignItems: 'center',
    paddingVertical: spacing.xxxl,
  },
  emptyStateIcon: {
    fontSize: 48,
    marginBottom: spacing.lg,
    opacity: 0.5,
  },
  emptyStateTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
    textAlign: 'center',
  },
  emptyStateText: {
    fontSize: 16,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 22,
  },
});

export default ReportsScreen;import { Dimensions, Platform } from 'react-native';
import { colors } from './colors';

const { width, height } = Dimensions.get('window');

// üîß –û–°–ù–û–í–ù–´–ï –ö–û–ù–°–¢–ê–ù–¢–´ –î–ò–ó–ê–ô–ù–ê
export const DESIGN_SYSTEM = {
  // –†–∞–∑–º–µ—Ä—ã —ç–∫—Ä–∞–Ω–∞
  screen: {
    width,
    height,
  },
  
  // –û—Ç—Å—Ç—É–ø—ã –∏ spacing
  spacing: {
    xs: 4,
    sm: 8,
    md: 12,
    lg: 16,
    xl: 20,
    xxl: 24,
    xxxl: 32,
  },
  
  // –†–∞–¥–∏—É—Å—ã —Å–∫—Ä—É–≥–ª–µ–Ω–∏—è
  borderRadius: {
    xs: 4,
    sm: 8,
    md: 12,
    lg: 16,
    xl: 20,
    xxl: 24,
    pill: 50,
  },
  
  // –¢–µ–Ω–∏ (–µ–¥–∏–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞)
  shadows: {
    sm: {
      shadowColor: colors.textPrimary,
      shadowOffset: { width: 0, height: 2 },
      shadowOpacity: 0.08,
      shadowRadius: 4,
      elevation: 2,
    },
    md: {
      shadowColor: colors.textPrimary,
      shadowOffset: { width: 0, height: 4 },
      shadowOpacity: 0.1,
      shadowRadius: 8,
      elevation: 4,
    },
    lg: {
      shadowColor: colors.textPrimary,
      shadowOffset: { width: 0, height: 6 },
      shadowOpacity: 0.12,
      shadowRadius: 12,
      elevation: 8,
    },
    xl: {
      shadowColor: colors.textPrimary,
      shadowOffset: { width: 0, height: 8 },
      shadowOpacity: 0.15,
      shadowRadius: 16,
      elevation: 12,
    },
  },
  
  // –ê–Ω–∏–º–∞—Ü–∏–∏
  animations: {
    duration: {
      fast: 200,
      normal: 300,
      slow: 500,
    },
    easing: 'cubic-bezier(0.4, 0, 0.2, 1)',
  },
};

// üîß –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ï –ö–û–ú–ü–û–ù–ï–ù–¢–´ –°–¢–ò–õ–ï–ô
export const commonStyles = {
  // üì± –≠–ö–†–ê–ù - –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤
  screen: {
    container: {
      flex: 1,
      backgroundColor: colors.background,
    },
    header: {
      paddingTop: Platform.OS === 'ios' ? 60 : 50,
      paddingHorizontal: DESIGN_SYSTEM.spacing.xl,
      paddingBottom: DESIGN_SYSTEM.spacing.lg,
      backgroundColor: colors.background,
      borderBottomWidth: 1,
      borderBottomColor: colors.border,
    },
    title: {
      fontSize: 22,
      fontWeight: 'bold',
      color: colors.textPrimary,
      textAlign: 'center',
      marginBottom: DESIGN_SYSTEM.spacing.xs,
    },
    subtitle: {
      fontSize: 14,
      color: colors.textSecondary,
      textAlign: 'center',
      lineHeight: 18,
    },
    content: {
      flex: 1,
      paddingHorizontal: DESIGN_SYSTEM.spacing.xl,
      paddingTop: DESIGN_SYSTEM.spacing.lg,
      paddingBottom: DESIGN_SYSTEM.spacing.xxl,
    },
  },

  // üéØ –ö–ê–†–¢–û–ß–ö–ò - –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫
  cards: {
    surface: {
      backgroundColor: colors.surface,
      borderRadius: DESIGN_SYSTEM.borderRadius.lg,
      padding: DESIGN_SYSTEM.spacing.lg,
      ...DESIGN_SYSTEM.shadows.md,
    },
    elevated: {
      backgroundColor: colors.surface,
      borderRadius: DESIGN_SYSTEM.borderRadius.xl,
      padding: DESIGN_SYSTEM.spacing.xl,
      ...DESIGN_SYSTEM.shadows.lg,
    },
    stats: {
      backgroundColor: colors.surface,
      borderRadius: DESIGN_SYSTEM.borderRadius.xl,
      padding: DESIGN_SYSTEM.spacing.xl,
      ...DESIGN_SYSTEM.shadows.lg,
    },
  },

  // üîò –ö–ù–û–ü–ö–ò - –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –∫–Ω–æ–ø–æ–∫
  buttons: {
    primary: {
      backgroundColor: colors.primary,
      paddingVertical: DESIGN_SYSTEM.spacing.lg,
      paddingHorizontal: DESIGN_SYSTEM.spacing.xl,
      borderRadius: DESIGN_SYSTEM.borderRadius.lg,
      alignItems: 'center',
      justifyContent: 'center',
      ...DESIGN_SYSTEM.shadows.lg,
      minHeight: 56,
    },
    primaryText: {
      color: colors.white,
      fontSize: 16,
      fontWeight: 'bold',
      textAlign: 'center',
    },
    
    secondary: {
      backgroundColor: 'transparent',
      paddingVertical: DESIGN_SYSTEM.spacing.md,
      paddingHorizontal: DESIGN_SYSTEM.spacing.xl,
      borderRadius: DESIGN_SYSTEM.borderRadius.lg,
      alignItems: 'center',
      justifyContent: 'center',
      borderWidth: 2,
      borderColor: colors.border,
      minHeight: 52,
    },
    secondaryText: {
      color: colors.textSecondary,
      fontSize: 16,
      fontWeight: '600',
      textAlign: 'center',
    },
    
    danger: {
      backgroundColor: colors.error,
      paddingVertical: DESIGN_SYSTEM.spacing.lg,
      paddingHorizontal: DESIGN_SYSTEM.spacing.xl,
      borderRadius: DESIGN_SYSTEM.borderRadius.lg,
      alignItems: 'center',
      justifyContent: 'center',
      ...DESIGN_SYSTEM.shadows.lg,
      minHeight: 56,
    },
    dangerText: {
      color: colors.white,
      fontSize: 16,
      fontWeight: 'bold',
      textAlign: 'center',
    },
    
    // –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π
    quickAction: {
      backgroundColor: colors.surface,
      padding: DESIGN_SYSTEM.spacing.lg,
      borderRadius: DESIGN_SYSTEM.borderRadius.lg,
      alignItems: 'center',
      flex: 1,
      minWidth: '48%',
      ...DESIGN_SYSTEM.shadows.sm,
      borderLeftWidth: 4,
    },
    quickActionText: {
      fontSize: 14,
      fontWeight: '600',
      color: colors.textPrimary,
      textAlign: 'center',
      marginTop: DESIGN_SYSTEM.spacing.sm,
    },
  },

  // üìù –§–û–†–ú–´ - –µ–¥–∏–Ω—ã–π —Å—Ç–∏–ª—å –¥–ª—è –≤—Å–µ—Ö –∏–Ω–ø—É—Ç–æ–≤
  forms: {
    inputContainer: {
      backgroundColor: colors.surface,
      borderRadius: DESIGN_SYSTEM.borderRadius.lg,
      paddingHorizontal: DESIGN_SYSTEM.spacing.lg,
      paddingVertical: DESIGN_SYSTEM.spacing.md,
      ...DESIGN_SYSTEM.shadows.md,
      borderWidth: 2,
      borderColor: 'transparent',
    },
    input: {
      fontSize: 16,
      color: colors.textPrimary,
      padding: 0,
      flex: 1,
    },
    inputFocused: {
      borderColor: colors.primary,
      ...DESIGN_SYSTEM.shadows.lg,
    },
    label: {
      fontSize: 16,
      fontWeight: '600',
      color: colors.textPrimary,
      marginBottom: DESIGN_SYSTEM.spacing.sm,
    },
    error: {
      fontSize: 14,
      color: colors.error,
      marginTop: DESIGN_SYSTEM.spacing.xs,
      fontWeight: '500',
    },
  },

  // üìä –°–ï–ö–¶–ò–ò –ò –ó–ê–ì–û–õ–û–í–ö–ò
  sections: {
    header: {
      flexDirection: 'row',
      justifyContent: 'space-between',
      alignItems: 'center',
      marginBottom: DESIGN_SYSTEM.spacing.lg,
    },
    title: {
      fontSize: 20,
      fontWeight: 'bold',
      color: colors.textPrimary,
    },
    subtitle: {
      fontSize: 14,
      color: colors.textSecondary,
      fontWeight: '500',
    },
  },

  // üìà –ü–†–û–ì–†–ï–°–° –ë–ê–†–´
  progress: {
    container: {
      height: 6,
      backgroundColor: colors.border,
      borderRadius: DESIGN_SYSTEM.borderRadius.pill,
      overflow: 'hidden',
    },
    fill: {
      height: '100%',
      borderRadius: DESIGN_SYSTEM.borderRadius.pill,
    },
  },

  // üé™ –°–ü–ï–¶–ò–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò
  special: {
    // –ì—Ä–∞–¥–∏–µ–Ω—Ç–Ω—ã–µ —Ñ–æ–Ω—ã
    gradientPrimary: {
      backgroundGradient: 'linear',
      backgroundGradientColors: colors.gradientPrimary,
    },
    gradientSuccess: {
      backgroundGradient: 'linear', 
      backgroundGradientColors: colors.gradientSuccess,
    },
    
    // –ë–µ–π–¥–∂–∏ –∏ –º–µ—Ç–∫–∏
    badge: {
      paddingHorizontal: DESIGN_SYSTEM.spacing.sm,
      paddingVertical: DESIGN_SYSTEM.spacing.xs,
      borderRadius: DESIGN_SYSTEM.borderRadius.pill,
      alignSelf: 'flex-start',
    },
    badgePrimary: {
      backgroundColor: colors.primary,
    },
    badgeSuccess: {
      backgroundColor: colors.success,
    },
    badgeText: {
      color: colors.white,
      fontSize: 12,
      fontWeight: '600',
    },
  },
};

// üîß –£–¢–ò–õ–ò–¢–´ –î–õ–Ø –ë–´–°–¢–†–û–ì–û –î–û–°–¢–£–ü–ê
export const spacing = DESIGN_SYSTEM.spacing;
export const borderRadius = DESIGN_SYSTEM.borderRadius;
export const shadows = DESIGN_SYSTEM.shadows;

// üîß –ö–û–ú–ü–û–ù–ï–ù–¢–´-–•–ï–õ–ü–ï–†–´ –î–õ–Ø –ë–´–°–¢–†–û–ì–û –°–û–ó–î–ê–ù–ò–Ø –°–¢–ò–õ–ï–ô
export const createShadow = (level = 'md') => DESIGN_SYSTEM.shadows[level];
export const createSpacing = (vertical = 0, horizontal = 0) => ({
  paddingVertical: vertical,
  paddingHorizontal: horizontal,
});

// üîß –ê–î–ê–ü–¢–ò–í–ù–´–ï –°–¢–ò–õ–ò –î–õ–Ø –†–ê–ó–ù–´–• –£–°–¢–†–û–ô–°–¢–í
export const responsive = {
  // –î–ª—è –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤
  small: {
    screenPadding: DESIGN_SYSTEM.spacing.lg,
    cardPadding: DESIGN_SYSTEM.spacing.md,
  },
  // –î–ª—è –±–æ–ª—å—à–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤  
  large: {
    screenPadding: DESIGN_SYSTEM.spacing.xl,
    cardPadding: DESIGN_SYSTEM.spacing.lg,
  },
};

export default {
  DESIGN_SYSTEM,
  commonStyles,
  spacing,
  borderRadius,
  shadows,
  responsive,
};import React from 'react';
import { Platform } from 'react-native';

// –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π TextInput –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –¥–ª—è –≤—Å–µ—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
const TextInput = (props) => {
  // –î–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º input, –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö - TextInput –∏–∑ react-native
  if (Platform.OS === 'web') {
    const { style, placeholderTextColor, multiline, numberOfLines, ...webProps } = props;
    
    const webStyle = {
      // –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –≤–µ–±-–≤–µ—Ä—Å–∏–∏
      border: 'none',
      outline: 'none',
      backgroundColor: 'transparent',
      fontSize: 16,
      color: '#1a202c',
      width: '100%',
      padding: 0,
      margin: 0,
      // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º React Native —Å—Ç–∏–ª–∏ –≤ CSS
      ...(style && convertRNStyles(style))
    };

    return (
      <input
        {...webProps}
        style={webStyle}
        placeholder={props.placeholder}
        type={props.keyboardType === 'numeric' ? 'number' : 'text'}
        rows={multiline ? (numberOfLines || 3) : undefined}
      />
    );
  } else {
    // –î–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–π TextInput
    const RNTextInput = require('react-native').TextInput;
    return <RNTextInput {...props} />;
  }
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏ React Native —Å—Ç–∏–ª–µ–π –≤ CSS
const convertRNStyles = (rnStyle) => {
  const style = Array.isArray(rnStyle) ? Object.assign({}, ...rnStyle) : rnStyle;
  const cssStyle = {};
  
  if (style.backgroundColor) cssStyle.backgroundColor = style.backgroundColor;
  if (style.color) cssStyle.color = style.color;
  if (style.fontSize) cssStyle.fontSize = style.fontSize;
  if (style.fontWeight) cssStyle.fontWeight = style.fontWeight;
  if (style.padding) cssStyle.padding = typeof style.padding === 'number' ? `${style.padding}px` : style.padding;
  if (style.paddingHorizontal) cssStyle.paddingLeft = style.paddingHorizontal;
  if (style.paddingHorizontal) cssStyle.paddingRight = style.paddingHorizontal;
  if (style.paddingVertical) cssStyle.paddingTop = style.paddingVertical;
  if (style.paddingVertical) cssStyle.paddingBottom = style.paddingVertical;
  if (style.borderRadius) cssStyle.borderRadius = style.borderRadius;
  if (style.textAlign) cssStyle.textAlign = style.textAlign;
  if (style.height) cssStyle.height = style.height;
  if (style.minHeight) cssStyle.minHeight = style.minHeight;
  
  return cssStyle;
};

export default TextInput;// src/screens/TransactionsScreen.js - –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø
import React, { useState, useMemo, useRef } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  FlatList,
  Modal,
  ScrollView,
  Dimensions,
  Alert,
  Share,
  Animated,
  RefreshControl
} from 'react-native';
import { Swipeable } from 'react-native-gesture-handler';
import TextInput from '../components/TextInput';
import { useData } from '../context/DataContext';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const { width, height } = Dimensions.get('window');

// üîß –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –í–ù–ï –ö–û–ú–ü–û–ù–ï–ù–¢–ê (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º —Å useMemo)
const createHelperFunctions = (categories, accounts) => {
  const getCategoryInfo = (categoryId) => {
    if (!categories) return { name: '–î—Ä—É–≥–æ–µ', icon: 'üíº', color: colors.textSecondary };
    
    const allCategories = [
      ...(categories.income || []),
      ...(categories.expense || [])
    ];
    
    const category = allCategories.find(cat => cat.id === categoryId);
    return category || { 
      name: '–î—Ä—É–≥–æ–µ', 
      icon: 'üíº',
      color: colors.textSecondary 
    };
  };

  const getAccountInfo = (accountId) => {
    return (accounts || []).find(acc => acc.id === accountId) || { 
      name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å—á–µ—Ç',
      icon: 'üí≥'
    };
  };

  const formatDate = (dateString) => {
    try {
      const date = new Date(dateString);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return '–°–µ–≥–æ–¥–Ω—è';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return '–í—á–µ—Ä–∞';
      } else {
        return date.toLocaleDateString('ru-RU', {
          day: 'numeric',
          month: 'long',
          year: 'numeric'
        });
      }
    } catch (error) {
      return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–∞—Ç–∞';
    }
  };

  const formatTime = (dateString) => {
    try {
      return new Date(dateString).toLocaleTimeString('ru-RU', {
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (error) {
      return '--:--';
    }
  };

  const formatGroupDate = (dateString) => {
    try {
      const date = new Date(dateString);
      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      if (date.toDateString() === today.toDateString()) {
        return '–°–µ–≥–æ–¥–Ω—è';
      } else if (date.toDateString() === yesterday.toDateString()) {
        return '–í—á–µ—Ä–∞';
      } else {
        return date.toLocaleDateString('ru-RU', {
          weekday: 'long',
          day: 'numeric',
          month: 'long',
          year: date.getFullYear() !== today.getFullYear() ? 'numeric' : undefined
        });
      }
    } catch (error) {
      return '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –¥–∞—Ç–∞';
    }
  };

  const getPeriodDates = (periodType) => {
    const now = new Date();
    const start = new Date();
    const end = new Date();
    
    const periods = {
      today: () => {
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      yesterday: () => {
        start.setDate(now.getDate() - 1);
        start.setHours(0, 0, 0, 0);
        end.setDate(now.getDate() - 1);
        end.setHours(23, 59, 59, 999);
      },
      thisWeek: () => {
        const day = now.getDay();
        const diff = now.getDate() - day + (day === 0 ? -6 : 1);
        start.setDate(diff);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      lastWeek: () => {
        start.setDate(now.getDate() - 7 - now.getDay() + 1);
        end.setDate(now.getDate() - now.getDay());
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      thisMonth: () => {
        start.setDate(1);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      lastMonth: () => {
        start.setMonth(now.getMonth() - 1, 1);
        end.setMonth(now.getMonth(), 0);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      '3months': () => {
        start.setMonth(now.getMonth() - 3);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      '6months': () => {
        start.setMonth(now.getMonth() - 6);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      thisYear: () => {
        start.setMonth(0, 1);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
      lastYear: () => {
        start.setFullYear(now.getFullYear() - 1, 0, 1);
        end.setFullYear(now.getFullYear() - 1, 11, 31);
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 999);
      },
    };
    
    if (periods[periodType]) {
      periods[periodType]();
      return { start, end };
    }
    
    return null;
  };

  const getPeriodLabel = (periodType) => {
    const labels = {
      all: '–í–µ—Å—å –ø–µ—Ä–∏–æ–¥',
      today: '–°–µ–≥–æ–¥–Ω—è',
      yesterday: '–í—á–µ—Ä–∞',
      thisWeek: '–≠—Ç–∞ –Ω–µ–¥–µ–ª—è',
      lastWeek: '–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è',
      thisMonth: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü',
      lastMonth: '–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü',
      '3months': '3 –º–µ—Å—è—Ü–∞',
      '6months': '6 –º–µ—Å—è—Ü–µ–≤',
      thisYear: '–≠—Ç–æ—Ç –≥–æ–¥',
      lastYear: '–ü—Ä–æ—à–ª—ã–π –≥–æ–¥'
    };
    return labels[periodType] || '–í–µ—Å—å –ø–µ—Ä–∏–æ–¥';
  };

  return {
    getCategoryInfo,
    getAccountInfo,
    formatDate,
    formatTime,
    formatGroupDate,
    getPeriodDates,
    getPeriodLabel
  };
};

const TransactionsScreen = ({ navigation, route }) => {
  const { transactions = [], categories, accounts = [] } = useData();
  const [filter, setFilter] = useState('all');
  const [searchQuery, setSearchQuery] = useState('');
  const [period, setPeriod] = useState('all');
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [showPeriodMenu, setShowPeriodMenu] = useState(false);
  const [showCategoryMenu, setShowCategoryMenu] = useState(false);
  const [selectedTransactions, setSelectedTransactions] = useState([]);
  const [isSelectionMode, setIsSelectionMode] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [showStats, setShowStats] = useState(true);

  const accountFilter = route.params?.accountFilter;
  const swipeableRefs = useRef({});

  // üîß –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  const helpers = useMemo(() => createHelperFunctions(categories, accounts), [categories, accounts]);

  // üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  const onRefresh = React.useCallback(() => {
    setRefreshing(true);
    setTimeout(() => setRefreshing(false), 1000);
  }, []);

  // üîß –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –û–ü–ï–†–ê–¶–ò–ô
  const filteredTransactions = useMemo(() => {
    if (!transactions || !Array.isArray(transactions)) {
      return [];
    }

    let filtered = [...transactions];

    // –§–∏–ª—å—Ç—Ä –ø–æ —Å—á–µ—Ç—É
    if (accountFilter) {
      filtered = filtered.filter(t => t.account_id === accountFilter);
    }

    // üîß –§–ò–õ–¨–¢–† –ü–û –ü–ï–†–ò–û–î–£
    if (period !== 'all') {
      const periodDates = helpers.getPeriodDates(period);
      if (periodDates) {
        const { start, end } = periodDates;
        filtered = filtered.filter(t => {
          try {
            const transactionDate = new Date(t.date);
            return transactionDate >= start && transactionDate <= end;
          } catch (error) {
            return false;
          }
        });
      }
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –æ–ø–µ—Ä–∞—Ü–∏–∏
    switch (filter) {
      case 'income':
        filtered = filtered.filter(t => t.amount > 0);
        break;
      case 'expense':
        filtered = filtered.filter(t => t.amount < 0);
        break;
      default:
        break;
    }

    // –§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    if (selectedCategory) {
      filtered = filtered.filter(t => t.category === selectedCategory.id);
    }

    // –ü–æ–∏—Å–∫
    if (searchQuery.trim()) {
      const query = searchQuery.toLowerCase();
      filtered = filtered.filter(t => {
        const category = helpers.getCategoryInfo(t.category);
        const account = helpers.getAccountInfo(t.account_id);
        
        return (
          t.description?.toLowerCase().includes(query) ||
          category.name.toLowerCase().includes(query) ||
          account.name.toLowerCase().includes(query) ||
          formatCurrency(t.amount, false).toLowerCase().includes(query)
        );
      });
    }

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –¥–∞—Ç–µ (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
    filtered.sort((a, b) => new Date(b.date) - new Date(a.date));

    return filtered;
  }, [transactions, filter, searchQuery, accountFilter, period, selectedCategory, helpers]);

  // üîß –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –ø–æ –¥–Ω—è–º
  const groupedTransactions = useMemo(() => {
    const filtered = filteredTransactions;
    
    const groups = {};
    filtered.forEach(transaction => {
      const dateKey = new Date(transaction.date).toDateString();
      
      if (!groups[dateKey]) {
        groups[dateKey] = {
          date: transaction.date,
          transactions: [],
          total: 0,
          income: 0,
          expense: 0
        };
      }
      
      groups[dateKey].transactions.push(transaction);
      groups[dateKey].total += transaction.amount;
      
      if (transaction.amount > 0) {
        groups[dateKey].income += transaction.amount;
      } else {
        groups[dateKey].expense += Math.abs(transaction.amount);
      }
    });
    
    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –¥–Ω–∏ (—Å–Ω–∞—á–∞–ª–∞ –Ω–æ–≤—ã–µ)
    return Object.entries(groups)
      .sort(([aKey], [bKey]) => new Date(bKey) - new Date(aKey))
      .map(([key, data]) => ({
        date: key,
        ...data
      }));
  }, [filteredTransactions]);

  // üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  const stats = useMemo(() => {
    const filtered = filteredTransactions;
    
    const today = new Date();
    today.setHours(0, 0, 0, 0);
    
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    const thisWeek = new Date(today);
    thisWeek.setDate(thisWeek.getDate() - today.getDay() + 1);
    
    return {
      total: filtered.reduce((sum, t) => sum + t.amount, 0),
      income: filtered.filter(t => t.amount > 0).reduce((sum, t) => sum + t.amount, 0),
      expense: filtered.filter(t => t.amount < 0).reduce((sum, t) => sum + Math.abs(t.amount), 0),
      count: filtered.length,
      today: filtered.filter(t => new Date(t.date) >= today).reduce((sum, t) => sum + t.amount, 0),
      yesterday: filtered.filter(t => {
        const date = new Date(t.date);
        return date >= yesterday && date < today;
      }).reduce((sum, t) => sum + t.amount, 0),
      thisWeek: filtered.filter(t => new Date(t.date) >= thisWeek).reduce((sum, t) => sum + t.amount, 0),
    };
  }, [filteredTransactions]);

  // üîÑ –í—ã–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π
  const toggleTransactionSelection = (transactionId) => {
    setSelectedTransactions(prev => {
      if (prev.includes(transactionId)) {
        return prev.filter(id => id !== transactionId);
      } else {
        return [...prev, transactionId];
      }
    });
  };

  const toggleSelectionMode = () => {
    setIsSelectionMode(!isSelectionMode);
    if (isSelectionMode) {
      setSelectedTransactions([]);
    }
  };

  // üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (–≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
  const exportSelectedTransactions = async () => {
    if (selectedTransactions.length === 0) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞');
      return;
    }

    try {
      const selectedData = transactions.filter(t => selectedTransactions.includes(t.id));
      
      const exportData = selectedData.map(t => {
        const category = helpers.getCategoryInfo(t.category);
        const account = helpers.getAccountInfo(t.account_id);
        
        return `${helpers.formatDate(t.date)} | ${formatCurrency(t.amount, false)} | ${t.amount > 0 ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'} | ${category.name.replace(/^[^\s]+\s/, '')} | ${account.name}`;
      }).join('\n');

      const reportData = `
üìä –í–´–ë–†–ê–ù–ù–´–ï –û–ü–ï–†–ê–¶–ò–ò
–î–∞—Ç–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${selectedTransactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π
–û–±—â–∞—è —Å—É–º–º–∞: ${formatCurrency(selectedData.reduce((sum, t) => sum + t.amount, 0), false)}

${exportData}

---
–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ –∏–∑ FamilyBudget App
      `.trim();

      await Share.share({
        title: `–ú–æ–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ (${selectedTransactions.length})`,
        message: reportData,
      });
    } catch (error) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏');
    }
  };

  // üóëÔ∏è –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
  const deleteSelectedTransactions = () => {
    if (selectedTransactions.length === 0) return;

    Alert.alert(
      '–£–¥–∞–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–π',
      `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${selectedTransactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π?`,
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        {
          text: '–£–¥–∞–ª–∏—Ç—å',
          style: 'destructive',
          onPress: () => {
            // –ó–¥–µ—Å—å –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –ª–æ–≥–∏–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
            Alert.alert('–£—Å–ø–µ—Ö', `–£–¥–∞–ª–µ–Ω–æ ${selectedTransactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π`);
            setSelectedTransactions([]);
            setIsSelectionMode(false);
          }
        }
      ]
    );
  };

  // üîß –ö–û–ú–ü–û–ù–ï–ù–¢ –û–ü–ï–†–ê–¶–ò–ò
  const TransactionItem = React.memo(({ 
    transaction, 
    isSelected, 
    onSelect, 
    isSelectionMode,
    navigation
  }) => {
    const category = helpers.getCategoryInfo(transaction.category);
    const account = helpers.getAccountInfo(transaction.account_id);
    
    const categoryNameWithoutEmoji = category.name.replace(/^[^\s]+\s/, '');

    // üì± –ë–´–°–¢–†–û–ï –ú–ï–ù–Æ (—Ç—Ä–∏ —Ç–æ—á–∫–∏)
    const showQuickMenu = () => {
      Alert.alert(
        transaction.description || categoryNameWithoutEmoji,
        `${formatCurrency(transaction.amount, false)} ‚Ä¢ ${helpers.formatDate(transaction.date)}`,
        [
          { 
            text: '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å', 
            onPress: () => navigation.navigate('EditTransaction', { transactionId: transaction.id }) 
          },
          { 
            text: 'üóëÔ∏è –£–¥–∞–ª–∏—Ç—å', 
            style: 'destructive',
            onPress: () => {
              Alert.alert(
                '–£–¥–∞–ª–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏',
                '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –æ–ø–µ—Ä–∞—Ü–∏—é?',
                [
                  { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
                  { 
                    text: '–£–¥–∞–ª–∏—Ç—å', 
                    style: 'destructive',
                    onPress: () => {
                      Alert.alert('–£—Å–ø–µ—Ö', '–û–ø–µ—Ä–∞—Ü–∏—è —É–¥–∞–ª–µ–Ω–∞');
                    }
                  }
                ]
              );
            }
          },
          { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' }
        ]
      );
    };

    return (
      <TouchableOpacity 
        style={[
          styles.transactionItem,
          isSelected && styles.transactionItemSelected
        ]}
        onPress={() => {
          if (isSelectionMode) {
            onSelect(transaction.id);
          }
          // ‚úÖ –£–ë–†–ê–õ–ò –¢–ê–ü –î–õ–Ø –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø
        }}
        onLongPress={() => {
          if (!isSelectionMode) {
            setIsSelectionMode(true);
            onSelect(transaction.id);
          }
        }}
        delayLongPress={500}
      >
        {/* –ß–µ–∫–±–æ–∫—Å –≤—ã–±–æ—Ä–∞ */}
        {isSelectionMode && (
          <View style={styles.selectionCheckbox}>
            <View style={[
              styles.checkbox,
              isSelected && styles.checkboxSelected
            ]}>
              {isSelected && <Text style={styles.checkboxIcon}>‚úì</Text>}
            </View>
          </View>
        )}

        {/* –ò–∫–æ–Ω–∫–∞ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ */}
        <View style={[
          styles.transactionIcon,
          { backgroundColor: `${category.color}20` }
        ]}>
          <Text style={styles.transactionIconText}>{category.icon}</Text>
        </View>
        
        {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
        <View style={styles.transactionMainInfo}>
          <View style={styles.transactionHeader}>
            <Text style={styles.transactionDescription} numberOfLines={1}>
              {transaction.description || categoryNameWithoutEmoji}
            </Text>
            <Text style={[
              styles.transactionAmount,
              transaction.amount > 0 ? styles.incomeAmount : styles.expenseAmount
            ]}>
              {transaction.amount > 0 ? '+' : ''}{formatCurrency(transaction.amount, false)}
            </Text>
          </View>
          
          <View style={styles.transactionMeta}>
            <Text style={styles.transactionCategory} numberOfLines={1}>
              {categoryNameWithoutEmoji}
            </Text>
            <Text style={styles.transactionAccount} numberOfLines={1}>
              {account.name}
            </Text>
          </View>
          
          <View style={styles.transactionDateContainer}>
            <Text style={styles.transactionTime}>{helpers.formatTime(transaction.date)}</Text>
          </View>
        </View>

        {/* –ë—ã—Å—Ç—Ä–æ–µ –º–µ–Ω—é (—Ç—Ä–∏ —Ç–æ—á–∫–∏) */}
        <TouchableOpacity 
          style={styles.quickMenuButton}
          onPress={showQuickMenu}
        >
          <Text style={styles.quickMenuIcon}>‚ãØ</Text>
        </TouchableOpacity>
      </TouchableOpacity>
    );
  });

  // üîß –†–ï–ù–î–ï–† –ì–†–£–ü–ü–´ –û–ü–ï–†–ê–¶–ò–ô
  const renderDayGroup = ({ item }) => (
    <View style={styles.dayGroup}>
      <View style={styles.dayHeader}>
        <Text style={styles.dayDate}>{helpers.formatGroupDate(item.date)}</Text>
        <View style={styles.dayStats}>
          <Text style={[
            styles.dayTotal,
            { color: item.total > 0 ? colors.success : colors.error }
          ]}>
            {item.total > 0 ? '+' : ''}{formatCurrency(item.total, false)}
          </Text>
          <Text style={styles.dayCount}>
            {item.transactions.length} –æ–ø–µ—Ä–∞—Ü–∏–π
          </Text>
        </View>
      </View>
      
      <View style={styles.dayTransactions}>
        {item.transactions.map(transaction => (
          <TransactionItem 
            key={transaction.id} 
            transaction={transaction}
            isSelected={selectedTransactions.includes(transaction.id)}
            onSelect={toggleTransactionSelection}
            isSelectionMode={isSelectionMode}
            navigation={navigation}
          />
        ))}
      </View>
    </View>
  );

  // üìä –ö–û–ú–ü–û–ù–ï–ù–¢: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
  const StatsCard = () => (
    <View style={styles.statsCard}>
      <View style={styles.statsHeader}>
        <Text style={styles.statsTitle}>üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</Text>
        <TouchableOpacity onPress={() => setShowStats(!showStats)}>
          <Text style={styles.statsToggle}>
            {showStats ? '–°–∫—Ä—ã—Ç—å' : '–ü–æ–∫–∞–∑–∞—Ç—å'}
          </Text>
        </TouchableOpacity>
      </View>
      
      {showStats && (
        <>
          <View style={styles.statsGrid}>
            <View style={styles.statItem}>
              <Text style={styles.statLabel}>–û–±—â–∞—è —Å—É–º–º–∞</Text>
              <Text style={[
                styles.statValue,
                { color: stats.total > 0 ? colors.success : colors.error }
              ]}>
                {formatCurrency(stats.total, false)}
              </Text>
            </View>
            
            <View style={styles.statItem}>
              <Text style={styles.statLabel}>–î–æ—Ö–æ–¥—ã</Text>
              <Text style={[styles.statValue, { color: colors.success }]}>
                {formatCurrency(stats.income, false)}
              </Text>
            </View>
            
            <View style={styles.statItem}>
              <Text style={styles.statLabel}>–†–∞—Å—Ö–æ–¥—ã</Text>
              <Text style={[styles.statValue, { color: colors.error }]}>
                {formatCurrency(stats.expense, false)}
              </Text>
            </View>
            
            <View style={styles.statItem}>
              <Text style={styles.statLabel}>–û–ø–µ—Ä–∞—Ü–∏–π</Text>
              <Text style={[styles.statValue, { color: colors.primary }]}>
                {stats.count}
              </Text>
            </View>
          </View>
          
          <View style={styles.periodStats}>
            <View style={styles.periodStat}>
              <Text style={styles.periodStatLabel}>–°–µ–≥–æ–¥–Ω—è:</Text>
              <Text style={[
                styles.periodStatValue,
                { color: stats.today > 0 ? colors.success : colors.error }
              ]}>
                {formatCurrency(stats.today, true)}
              </Text>
            </View>
            
            <View style={styles.periodStat}>
              <Text style={styles.periodStatLabel}>–≠—Ç–∞ –Ω–µ–¥–µ–ª—è:</Text>
              <Text style={[
                styles.periodStatValue,
                { color: stats.thisWeek > 0 ? colors.success : colors.error }
              ]}>
                {formatCurrency(stats.thisWeek, true)}
              </Text>
            </View>
          </View>
        </>
      )}
    </View>
  );

  // üì± –ö–û–ú–ü–û–ù–ï–ù–¢: –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
  const SelectionActionBar = () => {
    if (!isSelectionMode || selectedTransactions.length === 0) return null;

    return (
      <View style={styles.selectionActionBar}>
        <Text style={styles.selectionCount}>
          –í—ã–±—Ä–∞–Ω–æ: {selectedTransactions.length}
        </Text>
        
        <View style={styles.selectionActions}>
          {/* ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç —Å—Ç–∞–ª –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π */}
          <TouchableOpacity 
            style={[styles.selectionAction, styles.secondaryAction]}
            onPress={exportSelectedTransactions}
          >
            <Text style={styles.selectionActionText}>üì§ –≠–∫—Å–ø–æ—Ä—Ç</Text>
          </TouchableOpacity>
          
          <TouchableOpacity 
            style={[styles.selectionAction, styles.deleteAction]}
            onPress={deleteSelectedTransactions}
          >
            <Text style={styles.selectionActionText}>üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</Text>
          </TouchableOpacity>
        </View>
      </View>
    );
  };

  // –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê
  const PeriodModal = () => {
    const periods = [
      { type: 'all', label: '–í–µ—Å—å –ø–µ—Ä–∏–æ–¥' },
      { type: 'today', label: '–°–µ–≥–æ–¥–Ω—è' },
      { type: 'yesterday', label: '–í—á–µ—Ä–∞' },
      { type: 'thisWeek', label: '–≠—Ç–∞ –Ω–µ–¥–µ–ª—è' },
      { type: 'lastWeek', label: '–ü—Ä–æ—à–ª–∞—è –Ω–µ–¥–µ–ª—è' },
      { type: 'thisMonth', label: '–≠—Ç–æ—Ç –º–µ—Å—è—Ü' },
      { type: 'lastMonth', label: '–ü—Ä–æ—à–ª—ã–π –º–µ—Å—è—Ü' },
      { type: '3months', label: '3 –º–µ—Å—è—Ü–∞' },
      { type: '6months', label: '6 –º–µ—Å—è—Ü–µ–≤' },
      { type: 'thisYear', label: '–≠—Ç–æ—Ç –≥–æ–¥' },
      { type: 'lastYear', label: '–ü—Ä–æ—à–ª—ã–π –≥–æ–¥' }
    ];

    return (
      <Modal
        visible={showPeriodMenu}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setShowPeriodMenu(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥</Text>
            
            <ScrollView 
              style={styles.modalScrollView}
              contentContainerStyle={styles.modalScrollContent}
              showsVerticalScrollIndicator={true}
            >
              {periods.map((item) => (
                <TouchableOpacity
                  key={item.type}
                  style={[
                    styles.modalItem,
                    period === item.type && styles.modalItemActive
                  ]}
                  onPress={() => {
                    setPeriod(item.type);
                    setShowPeriodMenu(false);
                  }}
                >
                  <Text style={[
                    styles.modalItemText,
                    period === item.type && styles.modalItemTextActive
                  ]}>
                    {item.label}
                  </Text>
                </TouchableOpacity>
              ))}
            </ScrollView>

            <TouchableOpacity 
              style={styles.modalCloseButton}
              onPress={() => setShowPeriodMenu(false)}
            >
              <Text style={styles.modalCloseButtonText}>–ó–∞–∫—Ä—ã—Ç—å</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    );
  };

  const CategoryModal = () => {
    const incomeCategories = categories?.income || [];
    const expenseCategories = categories?.expense || [];
    const allCategories = [...incomeCategories, ...expenseCategories];
    
    return (
      <Modal
        visible={showCategoryMenu}
        transparent={true}
        animationType="fade"
        onRequestClose={() => setShowCategoryMenu(false)}
      >
        <View style={styles.modalOverlay}>
          <View style={styles.modalContent}>
            <Text style={styles.modalTitle}>–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é</Text>
            
            <ScrollView 
              style={styles.modalScrollView}
              contentContainerStyle={styles.modalScrollContent}
              showsVerticalScrollIndicator={true}
            >
              <TouchableOpacity
                style={[
                  styles.modalItem,
                  !selectedCategory && styles.modalItemActive
                ]}
                onPress={() => {
                  setSelectedCategory(null);
                  setShowCategoryMenu(false);
                }}
              >
                <Text style={[
                  styles.modalItemText,
                  !selectedCategory && styles.modalItemTextActive
                ]}>
                  üìÇ –í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
                </Text>
              </TouchableOpacity>

              <View style={styles.modalDivider} />

              {allCategories.map(category => (
                <TouchableOpacity
                  key={category.id}
                  style={[
                    styles.modalItem,
                    selectedCategory?.id === category.id && styles.modalItemActive
                  ]}
                  onPress={() => {
                    setSelectedCategory(category);
                    setShowCategoryMenu(false);
                  }}
                >
                  <Text style={[
                    styles.modalItemText,
                    selectedCategory?.id === category.id && styles.modalItemTextActive
                  ]}>
                    {category.icon} {category.name}
                  </Text>
                </TouchableOpacity>
              ))}
            </ScrollView>

            <TouchableOpacity 
              style={styles.modalCloseButton}
              onPress={() => setShowCategoryMenu(false)}
            >
              <Text style={styles.modalCloseButtonText}>–ó–∞–∫—Ä—ã—Ç—å</Text>
            </TouchableOpacity>
          </View>
        </View>
      </Modal>
    );
  };

  return (
    <View style={styles.container}>
      {/* –®–ê–ü–ö–ê –≠–ö–†–ê–ù–ê */}
      <View style={styles.screenHeader}>
        <View style={styles.headerLeft}>
          <Text style={styles.screenTitle}>üìã –û–ø–µ—Ä–∞—Ü–∏–∏</Text>
          <Text style={styles.screenSubtitle}>
            {accountFilter 
              ? `–°—á–µ—Ç: ${helpers.getAccountInfo(accountFilter).name}`
              : `–í—Å–µ–≥–æ: ${transactions?.length || 0}`
            }
          </Text>
        </View>
        
        <TouchableOpacity 
          style={styles.selectionModeButton}
          onPress={toggleSelectionMode}
        >
          <Text style={styles.selectionModeText}>
            {isSelectionMode ? '‚úï –û—Ç–º–µ–Ω–∞' : 'üìã –í—ã–±—Ä–∞—Ç—å'}
          </Text>
        </TouchableOpacity>
      </View>

      <ScrollView 
        style={styles.scrollView}
        showsVerticalScrollIndicator={false}
        refreshControl={
          <RefreshControl refreshing={refreshing} onRefresh={onRefresh} />
        }
      >
        {/* –ü–û–ò–°–ö –ò –§–ò–õ–¨–¢–†–´ */}
        <View style={styles.controlsSection}>
          <View style={styles.searchContainer}>
            <TextInput
              style={styles.searchInput}
              placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –æ–ø–∏—Å–∞–Ω–∏—é, —Å—É–º–º–µ, –∫–∞—Ç–µ–≥–æ—Ä–∏–∏..."
              value={searchQuery}
              onChangeText={setSearchQuery}
              placeholderTextColor={colors.textSecondary}
            />
            {searchQuery ? (
              <TouchableOpacity 
                style={styles.clearSearchButton} 
                onPress={() => setSearchQuery('')}
              >
                <Text style={styles.clearSearchText}>‚úï</Text>
              </TouchableOpacity>
            ) : null}
          </View>
          
          <View style={styles.filterRow}>
            <TouchableOpacity 
              style={styles.periodButton}
              onPress={() => setShowPeriodMenu(true)}
            >
              <Text style={styles.periodButtonText}>
                üìÖ {helpers.getPeriodLabel(period)}
              </Text>
            </TouchableOpacity>

            <TouchableOpacity 
              style={styles.categoryButton}
              onPress={() => setShowCategoryMenu(true)}
            >
              <Text style={styles.categoryButtonText}>
                üè∑Ô∏è {selectedCategory ? selectedCategory.name.replace(/^[^\s]+\s/, '').substring(0, 10) + '...' : '–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏'}
              </Text>
            </TouchableOpacity>
          </View>

          {/* –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */}
          <View style={styles.quickFilters}>
            <TouchableOpacity
              style={[
                styles.quickFilter,
                filter === 'all' && styles.quickFilterActive
              ]}
              onPress={() => setFilter('all')}
            >
              <Text style={[
                styles.quickFilterText,
                filter === 'all' && styles.quickFilterTextActive
              ]}>
                –í—Å–µ
              </Text>
            </TouchableOpacity>
            
            <TouchableOpacity
              style={[
                styles.quickFilter,
                filter === 'income' && [styles.quickFilterActive, styles.incomeFilterActive]
              ]}
              onPress={() => setFilter('income')}
            >
              <Text style={[
                styles.quickFilterText,
                filter === 'income' && styles.quickFilterTextActive
              ]}>
                üìà –î–æ—Ö–æ–¥—ã
              </Text>
            </TouchableOpacity>
            
            <TouchableOpacity
              style={[
                styles.quickFilter,
                filter === 'expense' && [styles.quickFilterActive, styles.expenseFilterActive]
              ]}
              onPress={() => setFilter('expense')}
            >
              <Text style={[
                styles.quickFilterText,
                filter === 'expense' && styles.quickFilterTextActive
              ]}>
                üìâ –†–∞—Å—Ö–æ–¥—ã
              </Text>
            </TouchableOpacity>
          </View>
        </View>

        {/* –°–¢–ê–¢–ò–°–¢–ò–ö–ê */}
        {!isSelectionMode && <StatsCard />}

        {/* –°–ü–ò–°–û–ö –û–ü–ï–†–ê–¶–ò–ô */}
        {groupedTransactions.length > 0 ? (
          <FlatList
            data={groupedTransactions}
            renderItem={renderDayGroup}
            keyExtractor={item => item.date}
            scrollEnabled={false}
            contentContainerStyle={styles.transactionsList}
          />
        ) : (
          <View style={styles.emptyState}>
            <Text style={styles.emptyStateIcon}>
              {searchQuery ? 'üîç' : 'üí∏'}
            </Text>
            <Text style={styles.emptyStateTitle}>
              {searchQuery ? '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ' :
               selectedCategory ? `–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π –≤ "${selectedCategory?.name.replace(/^[^\s]+\s/, '')}"` :
               filter === 'all' ? '–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π' : 
               filter === 'income' ? '–ù–µ—Ç –¥–æ—Ö–æ–¥–æ–≤' : '–ù–µ—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤'}
            </Text>
            <Text style={styles.emptyStateText}>
              {searchQuery ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å' :
               selectedCategory ? '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é' :
               filter === 'all' ? '–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –æ–ø–µ—Ä–∞—Ü–∏—é —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —Ñ–∏–Ω–∞–Ω—Å—ã' :
               filter === 'income' ? '–î–æ—Ö–æ–¥—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∫–æ–≥–¥–∞ –≤—ã –∏—Ö –¥–æ–±–∞–≤–∏—Ç–µ' :
               '–†–∞—Å—Ö–æ–¥—ã –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∫–æ–≥–¥–∞ –≤—ã –∏—Ö –¥–æ–±–∞–≤–∏—Ç–µ'}
            </Text>
          </View>
        )}
      </ScrollView>

      {/* –ü–ê–ù–ï–õ–¨ –î–ï–ô–°–¢–í–ò–ô –ü–†–ò –í–´–ë–û–†–ï */}
      <SelectionActionBar />

      {/* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê */}
      <PeriodModal />
      <CategoryModal />
    </View>
  );
};

// üé® –°–¢–ò–õ–ò
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    paddingTop: 60,
    paddingHorizontal: spacing.xl,
    paddingBottom: spacing.lg,
    backgroundColor: colors.background,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
  },
  headerLeft: {
    flex: 1,
  },
  screenTitle: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.xs,
  },
  screenSubtitle: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  selectionModeButton: {
    backgroundColor: colors.primary,
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.sm,
    borderRadius: borderRadius.md,
    ...shadows.sm,
  },
  selectionModeText: {
    color: colors.white,
    fontSize: 13,
    fontWeight: '600',
  },
  scrollView: {
    flex: 1,
  },
  controlsSection: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
  },
  searchContainer: {
    position: 'relative',
    marginBottom: spacing.md,
  },
  searchInput: {
    ...commonStyles.forms.inputContainer,
    paddingRight: 45,
    fontSize: 15,
    paddingVertical: spacing.md,
  },
  clearSearchButton: {
    position: 'absolute',
    right: spacing.sm,
    top: 14,
    width: 28,
    height: 28,
    borderRadius: 14,
    backgroundColor: colors.textSecondary + '20',
    alignItems: 'center',
    justifyContent: 'center',
  },
  clearSearchText: {
    fontSize: 14,
    color: colors.textSecondary,
    fontWeight: 'bold',
  },
  filterRow: {
    flexDirection: 'row',
    gap: spacing.sm,
    marginBottom: spacing.md,
  },
  periodButton: {
    ...commonStyles.cards.surface,
    flex: 1,
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.md,
    alignItems: 'center',
    ...shadows.sm,
  },
  periodButtonText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    textAlign: 'center',
  },
  categoryButton: {
    ...commonStyles.cards.surface,
    flex: 1,
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.md,
    alignItems: 'center',
    ...shadows.sm,
  },
  categoryButtonText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    textAlign: 'center',
  },
  quickFilters: {
    flexDirection: 'row',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    padding: spacing.xs,
    marginBottom: spacing.xl,
    ...shadows.md,
  },
  quickFilter: {
    flex: 1,
    paddingVertical: spacing.sm,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    justifyContent: 'center',
  },
  quickFilterActive: {
    backgroundColor: colors.primary,
    ...shadows.sm,
  },
  incomeFilterActive: {
    backgroundColor: colors.success,
  },
  expenseFilterActive: {
    backgroundColor: colors.error,
  },
  quickFilterText: {
    fontSize: 13,
    fontWeight: '600',
    color: colors.textSecondary,
    textAlign: 'center',
  },
  quickFilterTextActive: {
    color: colors.white,
  },
  // –°–¢–ê–¢–ò–°–¢–ò–ö–ê
  statsCard: {
    ...commonStyles.cards.elevated,
    marginHorizontal: spacing.xl,
    marginBottom: spacing.xl,
    padding: spacing.lg,
  },
  statsHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.md,
  },
  statsTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
  },
  statsToggle: {
    fontSize: 13,
    color: colors.primary,
    fontWeight: '600',
  },
  statsGrid: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    marginBottom: spacing.lg,
  },
  statItem: {
    width: '50%',
    paddingVertical: spacing.md,
    alignItems: 'center',
  },
  statLabel: {
    fontSize: 12,
    color: colors.textSecondary,
    marginBottom: spacing.xs,
  },
  statValue: {
    fontSize: 16,
    fontWeight: 'bold',
  },
  periodStats: {
    borderTopWidth: 1,
    borderTopColor: colors.border,
    paddingTop: spacing.md,
  },
  periodStat: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.sm,
  },
  periodStatLabel: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  periodStatValue: {
    fontSize: 14,
    fontWeight: '600',
  },
  // –ì–†–£–ü–ü–´ –û–ü–ï–†–ê–¶–ò–ô
  dayGroup: {
    marginHorizontal: spacing.xl,
    marginBottom: spacing.xl,
  },
  dayHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    marginBottom: spacing.sm,
    paddingHorizontal: spacing.sm,
  },
  dayDate: {
    fontSize: 15,
    fontWeight: 'bold',
    color: colors.textPrimary,
  },
  dayStats: {
    alignItems: 'flex-end',
  },
  dayTotal: {
    fontSize: 14,
    fontWeight: 'bold',
    marginBottom: 2,
  },
  dayCount: {
    fontSize: 12,
    color: colors.textSecondary,
  },
  dayTransactions: {
    backgroundColor: colors.surface,
    borderRadius: borderRadius.lg,
    overflow: 'hidden',
    ...shadows.sm,
  },
  // –û–¢–î–ï–õ–¨–ù–ê–Ø –û–ü–ï–†–ê–¶–ò–Ø
  transactionItem: {
    flexDirection: 'row',
    alignItems: 'center',
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.md,
    borderBottomWidth: 1,
    borderBottomColor: colors.border,
    backgroundColor: colors.white,
  },
  transactionItemSelected: {
    backgroundColor: `${colors.primary}10`,
  },
  selectionCheckbox: {
    width: 40,
    alignItems: 'center',
    justifyContent: 'center',
  },
  checkbox: {
    width: 22,
    height: 22,
    borderRadius: 11,
    borderWidth: 2,
    borderColor: colors.primary,
    alignItems: 'center',
    justifyContent: 'center',
  },
  checkboxSelected: {
    backgroundColor: colors.primary,
  },
  checkboxIcon: {
    color: colors.white,
    fontSize: 12,
    fontWeight: 'bold',
  },
  transactionIcon: {
    width: 40,
    height: 40,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    justifyContent: 'center',
    marginRight: spacing.md,
    marginLeft: spacing.xs,
  },
  transactionIconText: {
    fontSize: 18,
  },
  transactionMainInfo: {
    flex: 1,
  },
  transactionHeader: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'flex-start',
    marginBottom: spacing.xs,
  },
  transactionDescription: {
    fontSize: 15,
    fontWeight: '600',
    color: colors.textPrimary,
    flex: 1,
    marginRight: spacing.md,
  },
  transactionAmount: {
    fontSize: 15,
    fontWeight: 'bold',
    flexShrink: 0,
  },
  transactionMeta: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: spacing.xs,
  },
  transactionCategory: {
    fontSize: 13,
    color: colors.textSecondary,
    backgroundColor: colors.background,
    paddingHorizontal: spacing.sm,
    paddingVertical: 2,
    borderRadius: borderRadius.xs,
    marginRight: spacing.sm,
    flexShrink: 1,
  },
  transactionAccount: {
    fontSize: 13,
    color: colors.textSecondary,
    backgroundColor: colors.background,
    paddingHorizontal: spacing.sm,
    paddingVertical: 2,
    borderRadius: borderRadius.xs,
    flexShrink: 1,
  },
  transactionDateContainer: {
    flexDirection: 'row',
    alignItems: 'center',
  },
  transactionTime: {
    fontSize: 12,
    color: colors.textSecondary + '80',
  },
  quickMenuButton: {
    paddingLeft: spacing.sm,
    paddingRight: spacing.xs,
  },
  quickMenuIcon: {
    fontSize: 20,
    color: colors.textSecondary,
    transform: [{ rotate: '90deg' }],
  },
  incomeAmount: {
    color: colors.success,
  },
  expenseAmount: {
    color: colors.error,
  },
  // –ü–ê–ù–ï–õ–¨ –í–´–ë–û–†–ê
  selectionActionBar: {
    position: 'absolute',
    bottom: 0,
    left: 0,
    right: 0,
    backgroundColor: colors.surface,
    borderTopWidth: 1,
    borderTopColor: colors.border,
    paddingVertical: spacing.md,
    paddingHorizontal: spacing.xl,
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    ...shadows.lg,
  },
  selectionCount: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
  },
  selectionActions: {
    flexDirection: 'row',
    gap: spacing.sm,
  },
  selectionAction: {
    paddingHorizontal: spacing.md,
    paddingVertical: spacing.sm,
    borderRadius: borderRadius.sm,
    ...shadows.sm,
  },
  // ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç - –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞
  secondaryAction: {
    backgroundColor: colors.warning,
  },
  deleteAction: {
    backgroundColor: colors.error,
  },
  selectionActionText: {
    color: colors.white,
    fontSize: 13,
    fontWeight: '600',
  },
  // –ü–£–°–¢–û–ï –°–û–°–¢–û–Ø–ù–ò–ï
  emptyState: {
    alignItems: 'center',
    paddingVertical: spacing.xxxl,
    paddingHorizontal: spacing.xl,
  },
  emptyStateIcon: {
    fontSize: 48,
    marginBottom: spacing.lg,
    opacity: 0.5,
  },
  emptyStateTitle: {
    fontSize: 20,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
    textAlign: 'center',
  },
  emptyStateText: {
    fontSize: 16,
    color: colors.textSecondary,
    textAlign: 'center',
    lineHeight: 22,
  },
  // –ú–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
  modalOverlay: {
    flex: 1,
    backgroundColor: 'rgba(0, 0, 0, 0.5)',
    justifyContent: 'center',
    alignItems: 'center',
  },
  modalContent: {
    ...commonStyles.cards.elevated,
    width: width * 0.85,
    height: height * 0.7,
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
  },
  modalTitle: {
    fontSize: 18,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.lg,
    textAlign: 'center',
  },
  modalScrollView: {
    flex: 1,
  },
  modalScrollContent: {
    paddingBottom: spacing.md,
  },
  modalItem: {
    paddingVertical: spacing.lg,
    paddingHorizontal: spacing.lg,
    borderRadius: borderRadius.md,
    marginBottom: spacing.xs,
  },
  modalItemActive: {
    backgroundColor: colors.primary,
  },
  modalItemText: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textPrimary,
  },
  modalItemTextActive: {
    color: colors.white,
  },
  modalDivider: {
    height: 1,
    backgroundColor: colors.border,
    marginVertical: spacing.sm,
  },
  modalCloseButton: {
    backgroundColor: colors.background,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    alignItems: 'center',
    marginTop: spacing.md,
  },
  modalCloseButtonText: {
    fontSize: 16,
    fontWeight: '600',
    color: colors.textSecondary,
  },
});

export default TransactionsScreen;import React, { useState, useEffect } from 'react';
import {
  View,
  Text,
  TouchableOpacity,
  StyleSheet,
  ScrollView,
  Alert,
  KeyboardAvoidingView,
  Platform,
  ActivityIndicator,
  Keyboard
} from 'react-native';
import TextInput from '../components/TextInput';
import { colors } from '../theme/colors';
import { formatCurrency } from '../utils/currencyFormatter';
import { useData } from '../context/DataContext';

// üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê
import { commonStyles, spacing, borderRadius, shadows } from '../theme/designSystem';

const TransferScreen = ({ navigation, route }) => {
  const { accounts, transferBetweenAccounts } = useData();
  
  const [fromAccount, setFromAccount] = useState(route.params?.fromAccount?.id || '');
  const [toAccount, setToAccount] = useState('');
  const [amount, setAmount] = useState('');
  const [description, setDescription] = useState('');
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [isKeyboardVisible, setKeyboardVisible] = useState(false);

  useEffect(() => {
    const keyboardDidShowListener = Keyboard.addListener(
      'keyboardDidShow',
      () => setKeyboardVisible(true)
    );
    const keyboardDidHideListener = Keyboard.addListener(
      'keyboardDidHide',
      () => setKeyboardVisible(false)
    );

    return () => {
      keyboardDidShowListener.remove();
      keyboardDidHideListener.remove();
    };
  }, []);

  const getAvailableFromAccounts = () => {
    return accounts.filter(acc => {
      if (acc.type === 'credit') {
        const availableCredit = 50000 + acc.balance;
        return availableCredit > 0;
      }
      return acc.balance > 0;
    });
  };

  const getAvailableToAccounts = () => {
    return accounts.filter(acc => acc.id !== fromAccount);
  };

  const handleTransfer = () => {
    Keyboard.dismiss();

    if (!fromAccount || !toAccount || !amount) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è');
      return;
    }

    if (fromAccount === toAccount) {
      Alert.alert('–û—à–∏–±–∫–∞', '–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å –Ω–∞ —Ç–æ—Ç –∂–µ —Å—á–µ—Ç');
      return;
    }

    const amountValue = parseFloat(amount);
    if (isNaN(amountValue) || amountValue <= 0) {
      Alert.alert('–û—à–∏–±–∫–∞', '–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –ø–µ—Ä–µ–≤–æ–¥–∞');
      return;
    }

    if (amountValue > 100000000) {
      Alert.alert('–û—à–∏–±–∫–∞', '–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–µ–≤—ã—à–∞—Ç—å 100 000 000 BYN');
      return;
    }

    const selectedFromAccount = accounts.find(acc => acc.id === fromAccount);
    
    if (selectedFromAccount.type === 'credit') {
      const availableCredit = 50000 + selectedFromAccount.balance;
      if (amountValue > availableCredit) {
        Alert.alert(
          '–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç', 
          `–î–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞: ${formatCurrency(availableCredit, false)}\n` +
          `–õ–∏–º–∏—Ç –∫—Ä–µ–¥–∏—Ç–Ω–æ–π –∫–∞—Ä—Ç—ã: 50,000.00 BYN\n` +
          `–¢–µ–∫—É—â–∏–π –¥–æ–ª–≥: ${formatCurrency(Math.abs(selectedFromAccount.balance), false)}`
        );
        return;
      }
    } else if (selectedFromAccount.balance < amountValue) {
      Alert.alert('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤', 
        `–ù–∞ —Å—á–µ—Ç–µ "${selectedFromAccount.name}" –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤\n` +
        `–î–æ—Å—Ç—É–ø–Ω–æ: ${formatCurrency(selectedFromAccount.balance, false)}\n` +
        `–¢—Ä–µ–±—É–µ—Ç—Å—è: ${formatCurrency(amountValue, false)}`);
      return;
    }

    Alert.alert(
      '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–µ—Ä–µ–≤–æ–¥',
      `${formatCurrency(amountValue, false)}\n` +
      `–°: ${selectedFromAccount.name}\n` +
      `–ù–∞: ${accounts.find(acc => acc.id === toAccount)?.name}` +
      (fee > 0 ? `\nüí∏ –ö–æ–º–∏—Å—Å–∏—è: ${formatCurrency(fee, false)}` : ''),
      [
        { text: '–û—Ç–º–µ–Ω–∞', style: 'cancel' },
        { 
          text: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', 
          style: 'default',
          onPress: executeTransfer
        }
      ]
    );
  };

  const executeTransfer = async () => {
    const amountValue = parseFloat(amount);
    
    try {
      setIsSubmitting(true);
      
      await transferBetweenAccounts(
        fromAccount, 
        toAccount, 
        amountValue, 
        description.trim() || `–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏`
      );

      Alert.alert('‚úÖ –£—Å–ø–µ—Ö', '–ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!', [
        { 
          text: 'OK', 
          onPress: () => {
            setTimeout(() => {
              setAmount('');
              setDescription('');
              setFromAccount('');
              setToAccount('');
              navigation.goBack();
            }, 100);
          }
        }
      ]);
    } catch (error) {
      Alert.alert('‚ùå –û—à–∏–±–∫–∞', error.message || '–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥');
      console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
    } finally {
      setIsSubmitting(false);
    }
  };

  const handleAmountChange = (text) => {
    const cleaned = text.replace(/[^\d.]/g, '');
    const parts = cleaned.split('.');
    if (parts.length > 2) {
      return;
    }
    if (parts[1] && parts[1].length > 2) {
      return;
    }
    setAmount(cleaned);
  };

  const AccountSelector = ({ title, selectedAccount, onSelect, type }) => {
    const availableAccounts = type === 'from' ? getAvailableFromAccounts() : getAvailableToAccounts();
    const selectedAccountData = accounts.find(acc => acc.id === selectedAccount);

    return (
      <View style={styles.inputSection}>
        <View style={styles.sectionHeader}>
          <Text style={styles.inputLabel}>{title}</Text>
          {selectedAccountData && (
            <Text style={styles.selectedCategoryHint}>
              –ë–∞–ª–∞–Ω—Å: {formatCurrency(selectedAccountData.balance, false)}
            </Text>
          )}
        </View>
        
        <ScrollView 
          horizontal 
          showsHorizontalScrollIndicator={false}
          style={styles.accountsScroll}
        >
          <View style={styles.accountsRow}>
            {availableAccounts.map(acc => {
              const isSelected = selectedAccount === acc.id;
              const isCredit = acc.type === 'credit';
              
              return (
                <TouchableOpacity
                  key={acc.id}
                  style={[
                    styles.accountOption,
                    isSelected && [
                      styles.accountOptionActive,
                      { 
                        borderColor: getAccountColor(acc.type),
                        shadowColor: getAccountColor(acc.type)
                      }
                    ],
                    isCredit && styles.creditAccount
                  ]}
                  onPress={() => {
                    onSelect(acc.id);
                    Keyboard.dismiss();
                  }}
                >
                  <View style={[
                    styles.accountIconContainer,
                    { 
                      backgroundColor: isSelected ? getAccountColor(acc.type) : colors.surface,
                      borderColor: getAccountColor(acc.type)
                    }
                  ]}>
                    <Text style={[
                      styles.accountOptionIcon,
                      { color: isSelected ? colors.white : getAccountColor(acc.type) }
                    ]}>
                      {acc.icon}
                    </Text>
                  </View>
                  
                  <Text style={[
                    styles.accountOptionName,
                    isSelected && { color: getAccountColor(acc.type), fontWeight: '700' }
                  ]} numberOfLines={1}>
                    {acc.name}
                  </Text>
                  
                  <Text style={[
                    styles.accountOptionBalance,
                    acc.balance < 0 && styles.negativeBalance
                  ]}>
                    {formatCurrency(acc.balance, false)}
                  </Text>
                  
                  {isSelected && (
                    <View style={[styles.selectionDot, { backgroundColor: getAccountColor(acc.type) }]} />
                  )}

                  {type === 'from' && !isCredit && acc.balance < 1000 && (
                    <Text style={styles.lowBalanceWarning}>‚ö†Ô∏è –ú–∞–ª–æ —Å—Ä–µ–¥—Å—Ç–≤</Text>
                  )}
                  {type === 'from' && isCredit && (
                    <Text style={styles.creditInfo}>
                      –õ–∏–º–∏—Ç: {formatCurrency(50000, false)}
                    </Text>
                  )}
                </TouchableOpacity>
              );
            })}
          </View>
        </ScrollView>
      </View>
    );
  };

  const getAccountColor = (type) => {
    const colorsMap = {
      card: '#6C63FF',
      cash: '#4CAF50', 
      savings: '#2196F3',
      credit: '#F44336'
    };
    return colorsMap[type] || colors.primary;
  };

  const QuickAmountButton = ({ value }) => (
    <TouchableOpacity
      style={styles.quickAmountButton}
      onPress={() => {
        setAmount(value.toString());
        Keyboard.dismiss();
      }}
    >
      <Text style={styles.quickAmountText}>{value}</Text>
    </TouchableOpacity>
  );

  const LoadingButton = ({ 
    onPress, 
    isLoading, 
    disabled, 
    style, 
    textStyle, 
    children,
    loadingText = "–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞..." 
  }) => (
    <TouchableOpacity
      style={[style, disabled && styles.buttonDisabled]}
      onPress={onPress}
      disabled={disabled || isLoading}
    >
      {isLoading ? (
        <View style={styles.loadingButtonContent}>
          <ActivityIndicator size="small" color={colors.white} />
          <Text style={[textStyle, styles.loadingButtonText]}>{loadingText}</Text>
        </View>
      ) : (
        children
      )}
    </TouchableOpacity>
  );

  const getTransferFee = () => {
    const fromAcc = accounts.find(acc => acc.id === fromAccount);
    const toAcc = accounts.find(acc => acc.id === toAccount);
    
    if (fromAcc?.type === 'credit' && toAcc?.type !== 'credit') {
      return parseFloat(amount || 0) * 0.03;
    }
    return 0;
  };

  const fee = getTransferFee();
  const totalAmount = fee > 0 ? parseFloat(amount || 0) + fee : parseFloat(amount || 0);

  return (
    <View style={styles.container}>
      {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –®–∞–ø–∫–∞ —ç–∫—Ä–∞–Ω–∞ */}
      <View style={styles.screenHeader}>
        <Text style={styles.screenTitle}>üîÑ –ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏</Text>
        <Text style={styles.screenSubtitle}>–ë—ã—Å—Ç—Ä–æ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ</Text>
      </View>

      <KeyboardAvoidingView 
        style={styles.keyboardAvoidingView}
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        keyboardVerticalOffset={Platform.OS === 'ios' ? 90 : 0}
      >
        <ScrollView 
          style={styles.scrollView}
          showsVerticalScrollIndicator={false}
          contentContainerStyle={[
            styles.scrollContent,
            isKeyboardVisible && styles.scrollContentWithKeyboard
          ]}
          keyboardShouldPersistTaps="handled"
        >
          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –û—Ç–∫—É–¥–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º */}
          <AccountSelector
            title="–°–æ —Å—á–µ—Ç–∞ *"
            selectedAccount={fromAccount}
            onSelect={setFromAccount}
            type="from"
          />

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö—É–¥–∞ –ø–µ—Ä–µ–≤–æ–¥–∏–º */}
          <AccountSelector
            title="–ù–∞ —Å—á–µ—Ç *"
            selectedAccount={toAccount}
            onSelect={setToAccount}
            type="to"
          />

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ *</Text>
            <View style={styles.amountInputContainer}>
              <Text style={styles.currencySymbol}>BYN</Text>
              <TextInput
                style={styles.amountInput}
                placeholder="0.00"
                value={amount}
                onChangeText={handleAmountChange}
                keyboardType="decimal-pad"
                placeholderTextColor={colors.textSecondary}
                selectionColor={colors.primary}
                autoFocus={!fromAccount}
                returnKeyType="next"
                onSubmitEditing={() => {
                  Keyboard.dismiss();
                }}
              />
            </View>
            
            <View style={styles.quickAmounts}>
              <Text style={styles.quickAmountsLabel}>–ë—ã—Å—Ç—Ä—ã–π –≤–≤–æ–¥:</Text>
              <View style={styles.quickAmountsRow}>
                {[5, 10, 20, 50, 100, 200].map(value => (
                  <QuickAmountButton key={value} value={value} />
                ))}
              </View>
            </View>

            {fee > 0 && (
              <View style={styles.feeWarning}>
                <Text style={styles.feeWarningText}>
                  ‚ö†Ô∏è –ö–æ–º–∏—Å—Å–∏—è 3%: {formatCurrency(fee, false)}
                </Text>
                <Text style={styles.feeWarningText}>
                  üí∞ –ò—Ç–æ–≥–æ –∫ —Å–ø–∏—Å–∞–Ω–∏—é: {formatCurrency(totalAmount, false)}
                </Text>
              </View>
            )}
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –û–ø–∏—Å–∞–Ω–∏–µ */}
          <View style={styles.inputSection}>
            <Text style={styles.inputLabel}>–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Text>
            <TextInput
              style={styles.descriptionInput}
              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è, –ü–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞..."
              value={description}
              onChangeText={setDescription}
              multiline
              numberOfLines={2}
              placeholderTextColor={colors.textSecondary}
              selectionColor={colors.primary}
              returnKeyType="done"
              blurOnSubmit={true}
            />
          </View>

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –î–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞ */}
          {fromAccount && toAccount && amount && (
            <View style={styles.transferInfo}>
              <Text style={styles.transferInfoTitle}>üìä –î–µ—Ç–∞–ª–∏ –ø–µ—Ä–µ–≤–æ–¥–∞:</Text>
              <View style={styles.transferDetail}>
                <Text style={styles.transferDetailLabel}>–û—Ç–∫—É–¥–∞:</Text>
                <Text style={styles.transferDetailValue}>
                  {accounts.find(acc => acc.id === fromAccount)?.name}
                </Text>
              </View>
              <View style={styles.transferDetail}>
                <Text style={styles.transferDetailLabel}>–ö—É–¥–∞:</Text>
                <Text style={styles.transferDetailValue}>
                  {accounts.find(acc => acc.id === toAccount)?.name}
                </Text>
              </View>
              <View style={styles.transferDetail}>
                <Text style={styles.transferDetailLabel}>–°—É–º–º–∞:</Text>
                <Text style={styles.transferDetailValue}>
                  {formatCurrency(parseFloat(amount), false)}
                </Text>
              </View>
              {fee > 0 && (
                <>
                  <View style={styles.transferDetail}>
                    <Text style={styles.transferDetailLabel}>–ö–æ–º–∏—Å—Å–∏—è:</Text>
                    <Text style={[styles.transferDetailValue, styles.feeText]}>
                      {formatCurrency(fee, false)}
                    </Text>
                  </View>
                  <View style={styles.transferDetail}>
                    <Text style={styles.transferDetailLabel}>–ò—Ç–æ–≥–æ:</Text>
                    <Text style={[styles.transferDetailValue, styles.totalText]}>
                      {formatCurrency(totalAmount, false)}
                    </Text>
                  </View>
                </>
              )}
            </View>
          )}

          {/* üîß –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–ê: –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
          <View style={styles.actionsContainer}>
            <LoadingButton 
              style={[
                styles.transferButton,
                (!fromAccount || !toAccount || !amount) && styles.transferButtonDisabled
              ]} 
              onPress={handleTransfer}
              disabled={!fromAccount || !toAccount || !amount}
              isLoading={isSubmitting}
              textStyle={styles.transferButtonText}
              loadingText="–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—Ä–µ–≤–æ–¥–∞..."
            >
              <Text style={styles.transferButtonText}>
                üîÑ –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥
              </Text>
              {fee > 0 && (
                <Text style={styles.transferButtonSubtext}>
                  –í–∫–ª—é—á–∞—è –∫–æ–º–∏—Å—Å–∏—é {formatCurrency(fee, false)}
                </Text>
              )}
            </LoadingButton>

            <TouchableOpacity 
              style={[
                styles.cancelButton,
                isSubmitting && styles.cancelButtonDisabled
              ]} 
              onPress={() => {
                Keyboard.dismiss();
                navigation.navigate('AccountsMain');
              }}
              disabled={isSubmitting}
            >
              <Text style={styles.cancelButtonText}>–û—Ç–º–µ–Ω–∞</Text>
            </TouchableOpacity>
          </View>

          {isKeyboardVisible && <View style={styles.keyboardSpacer} />}
        </ScrollView>
      </KeyboardAvoidingView>
    </View>
  );
};

// üîß –û–ë–ù–û–í–õ–ï–ù–ù–´–ï –°–¢–ò–õ–ò –° –î–ò–ó–ê–ô–ù-–°–ò–°–¢–ï–ú–û–ô
const styles = StyleSheet.create({
  container: {
    ...commonStyles.screen.container,
  },
  screenHeader: {
    ...commonStyles.screen.header,
  },
  screenTitle: {
    ...commonStyles.screen.title,
  },
  screenSubtitle: {
    ...commonStyles.screen.subtitle,
  },
  keyboardAvoidingView: {
    flex: 1,
  },
  scrollView: {
    flex: 1,
  },
  scrollContent: {
    paddingHorizontal: spacing.xl,
    paddingTop: spacing.lg,
    paddingBottom: spacing.xxl,
  },
  scrollContentWithKeyboard: {
    paddingBottom: 120,
  },
  inputSection: {
    marginBottom: spacing.xxl,
  },
  sectionHeader: {
    ...commonStyles.sections.header,
    marginBottom: spacing.lg,
  },
  inputLabel: {
    ...commonStyles.forms.label,
  },
  selectedCategoryHint: {
    fontSize: 14,
    color: colors.success,
    fontWeight: '600',
  },
  accountsScroll: {
    marginHorizontal: -spacing.xs,
  },
  accountsRow: {
    flexDirection: 'row',
    paddingHorizontal: spacing.xs,
    gap: spacing.sm,
  },
  // üîß –û–ø—Ü–∏—è —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  accountOption: {
    ...commonStyles.cards.surface,
    width: 140,
    padding: spacing.lg,
    alignItems: 'center',
    borderWidth: 2,
    borderColor: 'transparent',
    position: 'relative',
  },
  accountOptionActive: {
    ...shadows.lg,
  },
  creditAccount: {
    borderLeftWidth: 3,
    borderLeftColor: colors.error,
  },
  accountIconContainer: {
    width: 44,
    height: 44,
    borderRadius: borderRadius.xl,
    alignItems: 'center',
    justifyContent: 'center',
    marginBottom: spacing.sm,
    borderWidth: 2,
    ...shadows.md,
  },
  accountOptionIcon: {
    fontSize: 18,
    fontWeight: 'bold',
  },
  accountOptionName: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
    textAlign: 'center',
    marginBottom: spacing.xs,
  },
  accountOptionBalance: {
    fontSize: 12,
    color: colors.textSecondary,
    fontWeight: '500',
    marginBottom: spacing.xs,
  },
  negativeBalance: {
    color: colors.error,
    fontWeight: '600',
  },
  selectionDot: {
    position: 'absolute',
    top: spacing.sm,
    right: spacing.sm,
    width: 8,
    height: 8,
    borderRadius: borderRadius.xs,
  },
  lowBalanceWarning: {
    fontSize: 10,
    color: colors.warning,
    marginTop: spacing.xs,
    fontWeight: '500',
  },
  creditInfo: {
    fontSize: 10,
    color: colors.info,
    fontWeight: '500',
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –≤–≤–æ–¥–∞ —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  amountInputContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    backgroundColor: colors.surface,
    borderRadius: borderRadius.xl,
    paddingHorizontal: spacing.xl,
    ...shadows.lg,
    marginBottom: spacing.lg,
  },
  currencySymbol: {
    fontSize: 24,
    fontWeight: 'bold',
    color: colors.primary,
    marginRight: spacing.md,
  },
  amountInput: {
    flex: 1,
    fontSize: 32,
    fontWeight: 'bold',
    color: colors.textPrimary,
    paddingVertical: spacing.xl,
  },
  quickAmounts: {
    marginBottom: spacing.sm,
  },
  quickAmountsLabel: {
    fontSize: 16,
    color: colors.textSecondary,
    marginBottom: spacing.md,
    fontWeight: '500',
  },
  quickAmountsRow: {
    flexDirection: 'row',
    flexWrap: 'wrap',
    gap: spacing.sm,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–π —Å—É–º–º—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  quickAmountButton: {
    ...commonStyles.cards.surface,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.md,
    borderRadius: borderRadius.md,
    minWidth: 50,
    alignItems: 'center',
  },
  quickAmountText: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.primary,
  },
  feeWarning: {
    backgroundColor: colors.warning + '20',
    padding: spacing.md,
    borderRadius: borderRadius.md,
    marginTop: spacing.sm,
    borderLeftWidth: 4,
    borderLeftColor: colors.warning,
  },
  feeWarningText: {
    fontSize: 14,
    color: colors.warning,
    fontWeight: '500',
    marginBottom: spacing.xs,
  },
  // üîß –ü–æ–ª–µ –æ–ø–∏—Å–∞–Ω–∏—è —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  descriptionInput: {
    ...commonStyles.forms.inputContainer,
    ...commonStyles.forms.input,
    paddingHorizontal: spacing.lg,
    paddingVertical: spacing.lg,
    textAlignVertical: 'top',
    minHeight: 80,
  },
  // üîß –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–µ—Ä–µ–≤–æ–¥–µ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  transferInfo: {
    backgroundColor: colors.surface + '80',
    borderRadius: borderRadius.lg,
    padding: spacing.lg,
    marginBottom: spacing.xl,
    borderLeftWidth: 4,
    borderLeftColor: colors.primary,
  },
  transferInfoTitle: {
    fontSize: 16,
    fontWeight: 'bold',
    color: colors.textPrimary,
    marginBottom: spacing.md,
  },
  transferDetail: {
    flexDirection: 'row',
    justifyContent: 'space-between',
    alignItems: 'center',
    paddingVertical: spacing.xs,
  },
  transferDetailLabel: {
    fontSize: 14,
    color: colors.textSecondary,
  },
  transferDetailValue: {
    fontSize: 14,
    fontWeight: '600',
    color: colors.textPrimary,
  },
  feeText: {
    color: colors.warning,
  },
  totalText: {
    color: colors.primary,
    fontWeight: 'bold',
  },
  // üîß –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–Ω–æ–ø–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π
  actionsContainer: {
    gap: spacing.md,
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞ —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  transferButton: {
    ...commonStyles.buttons.primary,
    minHeight: 64,
    justifyContent: 'center',
  },
  transferButtonDisabled: {
    backgroundColor: colors.textSecondary + '40',
    ...shadows.sm,
  },
  transferButtonText: {
    ...commonStyles.buttons.primaryText,
    marginBottom: spacing.xs,
  },
  transferButtonSubtext: {
    color: colors.white + 'CC',
    fontSize: 12,
    fontWeight: '500',
  },
  // üîß –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã —á–µ—Ä–µ–∑ –¥–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º—É
  cancelButton: {
    ...commonStyles.buttons.secondary,
    minHeight: 56,
    justifyContent: 'center',
  },
  cancelButtonDisabled: {
    opacity: 0.5,
  },
  cancelButtonText: {
    ...commonStyles.buttons.secondaryText,
  },
  buttonDisabled: {
    opacity: 0.6,
  },
  loadingButtonContent: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'center',
    gap: spacing.sm,
  },
  loadingButtonText: {
    fontSize: 16,
    marginLeft: spacing.xs,
  },
  keyboardSpacer: {
    height: 50,
  },
});

export default TransferScreen;
